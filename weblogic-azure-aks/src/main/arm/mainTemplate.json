{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.11.1.770",
      "templateHash": "3968674792660088593"
    }
  },
  "parameters": {
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "[deployment().properties.templateLink.uri]"
    },
    "_artifactsLocationSasToken": {
      "type": "secureString",
      "defaultValue": ""
    },
    "aciResourcePermissions": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "true to use resource or workspace permissions. false to require workspace permissions."
      }
    },
    "aciRetentionInDays": {
      "type": "int",
      "defaultValue": 120,
      "metadata": {
        "description": "Number of days to retain data in Azure Monitor workspace."
      }
    },
    "aciWorkspaceSku": {
      "type": "string",
      "defaultValue": "pergb2018",
      "metadata": {
        "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
      }
    },
    "acrName": {
      "type": "string",
      "defaultValue": "acr-contoso"
    },
    "acrResourceGroupName": {
      "type": "string",
      "defaultValue": "acr-contoso-rg"
    },
    "aksAgentPoolName": {
      "type": "string",
      "defaultValue": "agentpool",
      "metadata": {
        "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
      },
      "minLength": 1,
      "maxLength": 12
    },
    "aksAgentPoolNodeCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
      },
      "minValue": 1,
      "maxValue": 10000
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_DS2_v2",
      "metadata": {
        "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
      }
    },
    "aksClusterNamePrefix": {
      "type": "string",
      "defaultValue": "wlsonaks",
      "metadata": {
        "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
      }
    },
    "aksClusterRGName": {
      "type": "string",
      "defaultValue": "aks-contoso-rg",
      "metadata": {
        "description": "Resource group name of an existing AKS cluster."
      }
    },
    "aksClusterName": {
      "type": "string",
      "defaultValue": "aks-contoso",
      "metadata": {
        "description": "Name of an existing AKS cluster."
      }
    },
    "aksVersion": {
      "type": "string",
      "defaultValue": "default",
      "metadata": {
        "description": "The AKS version."
      }
    },
    "appGatewayCertificateOption": {
      "type": "string",
      "defaultValue": "haveCert",
      "metadata": {
        "description": "Three scenarios we support for deploying app gateway"
      },
      "allowedValues": [
        "haveCert",
        "haveKeyVault",
        "generateCert"
      ]
    },
    "appGatewayPublicIPAddressName": {
      "type": "string",
      "defaultValue": "gwip",
      "metadata": {
        "description": "Public IP Name for the Application Gateway"
      }
    },
    "appGatewaySSLBackendRootCertData": {
      "type": "string",
      "defaultValue": "appgw-ssl-backend-data",
      "metadata": {
        "description": "The one-line, base64 string of the backend SSL root certificate data."
      }
    },
    "appGatewaySSLCertData": {
      "type": "string",
      "defaultValue": "appgw-ssl-data",
      "metadata": {
        "description": "The one-line, base64 string of the SSL certificate data."
      }
    },
    "appGatewaySSLCertPassword": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The value of the password for the SSL Certificate"
      }
    },
    "appgwForAdminServer": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Create Application Gateway ingress for admin console."
      }
    },
    "appgwForRemoteConsole": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Create Application Gateway ingress for remote console."
      }
    },
    "appgwUsePrivateIP": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, configure Azure Application Gateway frontend IP with private IP."
      }
    },
    "appPackageUrls": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Urls of Java EE application packages."
      }
    },
    "appReplicas": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The number of managed server to start."
      }
    },
    "createACR": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to create a new Azure Container Registry."
      }
    },
    "createAKSCluster": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "true to create a new AKS cluster."
      }
    },
    "createDNSZone": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, the template will update records to the existing DNS Zone. If false, the template will create a new DNS Zone."
      }
    },
    "databaseType": {
      "type": "string",
      "defaultValue": "oracle",
      "metadata": {
        "description": "One of the supported database types"
      },
      "allowedValues": [
        "oracle",
        "postgresql",
        "sqlserver",
        "mysql",
        "otherdb"
      ]
    },
    "dbConfigurationType": {
      "type": "string",
      "defaultValue": "createOrUpdate",
      "metadata": {
        "description": "createOrUpdate: create a new data source connection, or update an existing data source connection. delete: delete an existing data source connection"
      },
      "allowedValues": [
        "createOrUpdate",
        "delete"
      ]
    },
    "dbDriverLibrariesUrls": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Urls of datasource drivers, must be specified if database type is otherdb"
      }
    },
    "dbDriverName": {
      "type": "string",
      "defaultValue": "org.contoso.Driver",
      "metadata": {
        "description": "Datasource driver name, must be specified if database type is otherdb"
      }
    },
    "dbGlobalTranPro": {
      "type": "string",
      "defaultValue": "EmulateTwoPhaseCommit",
      "metadata": {
        "description": "Determines the transaction protocol (global transaction processing behavior) for the data source."
      }
    },
    "dbIdentity": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Managed identity that has access to database"
      }
    },
    "dbPassword": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Password for Database"
      }
    },
    "dbTestTableName": {
      "type": "string",
      "defaultValue": "Null",
      "metadata": {
        "description": "The name of the database table to use when testing physical database connections. This name is required when you specify a Test Frequency and enable Test Reserved Connections."
      }
    },
    "dbUser": {
      "type": "string",
      "defaultValue": "contosoDbUser",
      "metadata": {
        "description": "User id of Database"
      }
    },
    "dnsNameforApplicationGateway": {
      "type": "string",
      "defaultValue": "wlsgw",
      "metadata": {
        "description": "DNS prefix for ApplicationGateway"
      }
    },
    "dnszoneAdminConsoleLabel": {
      "type": "string",
      "defaultValue": "admin",
      "metadata": {
        "description": "Specify a label used to generate subdomain of Admin server. The final subdomain name will be label.dnszoneName, e.g. admin.contoso.xyz"
      }
    },
    "dnszoneAdminT3ChannelLabel": {
      "type": "string",
      "defaultValue": "admin-t3",
      "metadata": {
        "description": "Specify a label used to generate subdomain of Admin server T3 channel. The final subdomain name will be label.dnszoneName, e.g. admin-t3.contoso.xyz"
      }
    },
    "dnszoneClusterLabel": {
      "type": "string",
      "defaultValue": "www",
      "metadata": {
        "description": "Specify a label used to generate subdomain of WebLogic cluster. The final subdomain name will be label.dnszoneName, e.g. applications.contoso.xyz"
      }
    },
    "dnszoneClusterT3ChannelLabel": {
      "type": "string",
      "defaultValue": "cluster-t3"
    },
    "dnszoneName": {
      "type": "string",
      "defaultValue": "contoso.xyz",
      "metadata": {
        "description": "Azure DNS Zone name."
      }
    },
    "dnszoneRGName": {
      "type": "string",
      "defaultValue": "dns-contoso-rg"
    },
    "dsConnectionURL": {
      "type": "string",
      "defaultValue": "jdbc:postgresql://contoso.postgres.database.azure.com:5432/postgres",
      "metadata": {
        "description": "JDBC Connection String"
      }
    },
    "enableAppGWIngress": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to set up Application Gateway ingress."
      }
    },
    "enableAzureMonitoring": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
      }
    },
    "enableAzureFileShare": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to create persistent volume using file share."
      }
    },
    "enableCookieBasedAffinity": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to enable cookie based affinity."
      }
    },
    "enableCustomSSL": {
      "type": "bool",
      "defaultValue": false
    },
    "enableDB": {
      "type": "bool",
      "defaultValue": false
    },
    "enableDNSConfiguration": {
      "type": "bool",
      "defaultValue": false
    },
    "enableAdminT3Tunneling": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Configure a custom channel in Admin Server for the T3 protocol that enables HTTP tunneling"
      }
    },
    "enableClusterT3Tunneling": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Configure a custom channel in WebLogic cluster for the T3 protocol that enables HTTP tunneling"
      }
    },
    "enablePswlessConnection": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable passwordless datasource connection."
      }
    },
    "isSSOSupportEntitled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Is the specified SSO account associated with an active Oracle support contract?"
      }
    },
    "jdbcDataSourceName": {
      "type": "string",
      "defaultValue": "jdbc/contoso",
      "metadata": {
        "description": "JNDI Name for JDBC Datasource"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "kv-contoso",
      "metadata": {
        "description": "Existing Key Vault Name"
      }
    },
    "keyVaultResourceGroup": {
      "type": "string",
      "defaultValue": "kv-contoso-rg",
      "metadata": {
        "description": "Resource group name in current subscription containing the KeyVault"
      }
    },
    "keyVaultSku": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "Price tier for Key Vault."
      }
    },
    "keyVaultSSLBackendRootCertDataSecretName": {
      "type": "string",
      "defaultValue": "kv-ssl-backend-data",
      "metadata": {
        "description": "The name of the secret in the specified KeyVault whose value is the SSL Root Certificate Data for Appliation Gateway backend TLS/SSL."
      }
    },
    "keyVaultSSLCertDataSecretName": {
      "type": "string",
      "defaultValue": "kv-ssl-data",
      "metadata": {
        "description": "The name of the secret in the specified KeyVault whose value is the SSL Certificate Data for Appliation Gateway frontend TLS/SSL."
      }
    },
    "keyVaultSSLCertPasswordSecretName": {
      "type": "string",
      "defaultValue": "kv-ssl-psw",
      "metadata": {
        "description": "The name of the secret in the specified KeyVault whose value is the password for the SSL Certificate of Appliation Gateway frontend TLS/SSL"
      }
    },
    "location": {
      "type": "string"
    },
    "lbSvcValues": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Object array to define Load Balancer service, each object must include service name, service target[admin-server or cluster-1], port."
      }
    },
    "managedServerPrefix": {
      "type": "string",
      "defaultValue": "managed-server",
      "metadata": {
        "description": "Name prefix of managed server."
      }
    },
    "newOrExistingVnetForApplicationGateway": {
      "type": "string",
      "defaultValue": "new",
      "metadata": {
        "description": "To mitigate ARM-TTK error: Control Named vnetForApplicationGateway must output the newOrExisting property when hideExisting is false"
      }
    },
    "ocrSSOPSW": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Password of Oracle SSO account."
      }
    },
    "ocrSSOUser": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "User name of Oracle SSO account."
      }
    },
    "sslConfigurationAccessOption": {
      "type": "string",
      "defaultValue": "uploadConfig",
      "metadata": {
        "description": "Two scenarios to refer to WebLogic Server TLS/SSL certificates."
      },
      "allowedValues": [
        "uploadConfig",
        "keyVaultStoredConfig"
      ]
    },
    "sslKeyVaultCustomIdentityKeyStoreDataSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-identity-data",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Identity Keystore Data"
      }
    },
    "sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-identity-psw",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Identity Keystore Passphrase"
      }
    },
    "sslKeyVaultCustomIdentityKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "Weblogic Custom Identity Keystore type"
      }
    },
    "sslKeyVaultCustomTrustKeyStoreDataSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-trust-data",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Trust Store Data"
      }
    },
    "sslKeyVaultCustomTrustKeyStorePassPhraseSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-trust-psw",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Trust Store Passphrase"
      }
    },
    "sslKeyVaultCustomTrustKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "WWeblogic Custom Trust Store type"
      }
    },
    "sslKeyVaultName": {
      "type": "string",
      "defaultValue": "kv-wls-ssl-name",
      "metadata": {
        "description": "Resource group containing Weblogic SSL certificates"
      }
    },
    "sslKeyVaultPrivateKeyAliasSecretName": {
      "type": "string",
      "defaultValue": "contoso",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Server private key alias"
      }
    },
    "sslKeyVaultPrivateKeyPassPhraseSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-ssl-alias",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Server private key passphrase"
      }
    },
    "sslKeyVaultResourceGroup": {
      "type": "string",
      "defaultValue": "rg-kv-wls-ssl-name",
      "metadata": {
        "description": "Keyvault name containing Weblogic SSL certificates"
      }
    },
    "sslUploadedCustomIdentityKeyStoreData": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Identity Store Data"
      }
    },
    "sslUploadedCustomIdentityKeyStorePassphrase": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Identity Store passphrase"
      }
    },
    "sslUploadedCustomIdentityKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "Weblogic Custom Identity Store Type"
      }
    },
    "sslUploadedCustomTrustKeyStoreData": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Trust Store data"
      }
    },
    "sslUploadedCustomTrustKeyStorePassPhrase": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Trust Store passphrase"
      }
    },
    "sslUploadedCustomTrustKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "Weblogic Custom Trust Store Type"
      }
    },
    "sslUploadedPrivateKeyAlias": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Alias of the private key"
      }
    },
    "sslUploadedPrivateKeyPassPhrase": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Password of the private key"
      }
    },
    "t3ChannelAdminPort": {
      "type": "int",
      "defaultValue": 7005,
      "metadata": {
        "description": "Public port of the custom T3 channel in admin server"
      }
    },
    "t3ChannelClusterPort": {
      "type": "int",
      "defaultValue": 8011,
      "metadata": {
        "description": "Public port of the custom T3 channel in WebLoigc cluster"
      }
    },
    "useLatestSupportedAksVersion": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "True to use latest supported Kubernetes version."
      }
    },
    "useInternalLB": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "True to set up internal load balancer service."
      }
    },
    "utcValue": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "ture to upload Java EE applications and deploy the applications to WebLogic domain."
      }
    },
    "userProvidedAcr": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "User provided ACR for base image"
      }
    },
    "userProvidedAcrRgName": {
      "type": "string",
      "defaultValue": "null"
    },
    "userProvidedImagePath": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "User provided base image path"
      }
    },
    "useOracleImage": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Use Oracle images or user provided patched images"
      }
    },
    "validateApplications": {
      "type": "bool",
      "defaultValue": false
    },
    "vnetForApplicationGateway": {
      "type": "object",
      "defaultValue": {
        "name": "wlsaks-app-gateway-vnet",
        "resourceGroup": "[resourceGroup().name]",
        "addressPrefixes": [
          "172.16.0.0/24"
        ],
        "addressPrefix": "172.16.0.0/24",
        "newOrExisting": "new",
        "subnets": {
          "gatewaySubnet": {
            "name": "wlsaks-gateway-subnet",
            "addressPrefix": "172.16.0.0/24",
            "startAddress": "172.16.0.4"
          }
        }
      },
      "metadata": {
        "description": "VNET for Application Gateway."
      }
    },
    "vnetRGNameForApplicationGateway": {
      "type": "string",
      "defaultValue": "vnet-contoso-rg-name",
      "metadata": {
        "description": "To mitigate ARM-TTK error: Control Named vnetForApplicationGateway must output the resourceGroup property when hideExisting is false"
      }
    },
    "wdtRuntimePassword": {
      "type": "secureString",
      "metadata": {
        "description": "Password for model WebLogic Deploy Tooling runtime encrytion."
      }
    },
    "wlsClusterSize": {
      "type": "int",
      "defaultValue": 5,
      "metadata": {
        "description": "Maximum cluster size."
      }
    },
    "wlsCPU": {
      "type": "string",
      "defaultValue": "200m",
      "metadata": {
        "description": "Requests for CPU resources for admin server and managed server."
      }
    },
    "wlsDomainName": {
      "type": "string",
      "defaultValue": "domain1",
      "metadata": {
        "description": "Name of WebLogic domain to create."
      }
    },
    "wlsDomainUID": {
      "type": "string",
      "defaultValue": "sample-domain1",
      "metadata": {
        "description": "UID of WebLogic domain, used in WebLogic Operator."
      }
    },
    "wlsImageTag": {
      "type": "string",
      "defaultValue": "12.2.1.4",
      "metadata": {
        "description": "Docker tag that comes after \"container-registry.oracle.com/middleware/weblogic:\""
      }
    },
    "wlsJavaOption": {
      "type": "string",
      "defaultValue": "null"
    },
    "wlsMemory": {
      "type": "string",
      "defaultValue": "1.5Gi",
      "metadata": {
        "description": "Memory requests for admin server and managed server."
      }
    },
    "wlsPassword": {
      "type": "secureString"
    },
    "wlsUserName": {
      "type": "string",
      "defaultValue": "weblogic",
      "metadata": {
        "description": "User name for WebLogic Administrator."
      }
    }
  },
  "variables": {
    "_enableCustomSSL": "[parameters('enableCustomSSL')]",
    "_enableAppGWIngress": "[parameters('enableAppGWIngress')]",
    "_useExistingAppGatewaySSLCertificate": "[if(equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveCert')), true(), false())]",
    "const_appGatewaySSLCertOptionHaveCert": "haveCert",
    "const_appGatewaySSLCertOptionHaveKeyVault": "haveKeyVault",
    "const_azcliVersion": "2.41.0",
    "const_azureSubjectName": "[format('{0}.{1}.{2}', variables('name_domainLabelforApplicationGateway'), parameters('location'), 'cloudapp.azure.com')]",
    "const_hasTags": "[contains(resourceGroup(), 'tags')]",
    "const_bCreateNewKeyVault": "[and(or(or(not(variables('const_hasTags')), not(contains(resourceGroup().tags, variables('name_tagNameForKeyVault')))), empty(resourceGroup().tags.wlsKeyVault)), or(and(parameters('enableCustomSSL'), not(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')))), and(parameters('enableAppGWIngress'), not(equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))))))]",
    "const_createNewAcr": "[and(parameters('useOracleImage'), parameters('createACR'))]",
    "const_defaultKeystoreType": "PKCS12",
    "const_enableNetworking": "[or(greater(length(parameters('lbSvcValues')), 0), parameters('enableAppGWIngress'))]",
    "const_enablePV": "[or(parameters('enableCustomSSL'), parameters('enableAzureFileShare'))]",
    "const_identityKeyStoreType": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomIdentityKeyStoreType'), parameters('sslUploadedCustomIdentityKeyStoreType'))]",
    "const_keyvaultNameFromTag": "[if(and(variables('const_hasTags'), contains(resourceGroup().tags, variables('name_tagNameForKeyVault'))), resourceGroup().tags.wlsKeyVault, '')]",
    "const_showAdminConsoleExUrl": "[or(greater(length(parameters('lbSvcValues')), 0), and(parameters('enableAppGWIngress'), parameters('appgwForAdminServer')))]",
    "const_showRemoteAdminConsoleExUrl": "[and(or(greater(length(parameters('lbSvcValues')), 0), and(parameters('enableAppGWIngress'), parameters('appgwForRemoteConsole'))), not(parameters('enableCustomSSL')))]",
    "const_showRemoteAdminConsoleSecuredExUrl": "[and(or(greater(length(parameters('lbSvcValues')), 0), and(parameters('enableAppGWIngress'), parameters('appgwForRemoteConsole'))), parameters('enableCustomSSL'))]",
    "const_trustKeyStoreType": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomTrustKeyStoreType'), parameters('sslUploadedCustomTrustKeyStoreType'))]",
    "const_wlsClusterName": "cluster-1",
    "const_wlsJavaOptions": "[if(equals(parameters('wlsJavaOption'), ''), 'null', parameters('wlsJavaOption'))]",
    "const_wlsSSLCertOptionKeyVault": "keyVaultStoredConfig",
    "name_appgwFrontendSSLCertName": "appGatewaySslCert",
    "name_appgwBackendRootCertName": "appGatewayTrustedRootCert",
    "name_defaultPidDeployment": "pid",
    "name_dnsNameforApplicationGateway": "[format('{0}{1}', parameters('dnsNameforApplicationGateway'), take(parameters('utcValue'), 6))]",
    "name_domainLabelforApplicationGateway": "[take(format('{0}-{1}-{2}', variables('name_dnsNameforApplicationGateway'), toLower(variables('name_rgNameWithoutSpecialCharacter')), toLower(parameters('wlsDomainName'))), 63)]",
    "name_identityKeyStoreDataSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomIdentityKeyStoreDataSecretName'), 'myIdentityKeyStoreData')]",
    "name_identityKeyStorePswSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName'), 'myIdentityKeyStorePsw')]",
    "name_keyVaultName": "[if(empty(variables('const_keyvaultNameFromTag')), format('{0}', take(format('wls-kv{0}', uniqueString(parameters('utcValue'))), 24)), resourceGroup().tags.wlsKeyVault)]",
    "name_privateKeyAliasSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultPrivateKeyAliasSecretName'), 'privateKeyAlias')]",
    "name_privateKeyPswSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultPrivateKeyPassPhraseSecretName'), 'privateKeyPsw')]",
    "name_rgNameWithoutSpecialCharacter": "[replace(replace(replace(replace(resourceGroup().name, '.', ''), '(', ''), ')', ''), '_', '')]",
    "name_rgKeyvaultForWLSSSL": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultResourceGroup'), resourceGroup().name)]",
    "name_tagNameForKeyVault": "wlsKeyVault",
    "name_tagNameForStorageAccount": "wlsStorageAccount",
    "name_trustKeyStoreDataSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomTrustKeyStoreDataSecretName'), 'myTrustKeyStoreData')]",
    "name_trustKeyStorePswSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomTrustKeyStorePassPhraseSecretName'), 'myTrustKeyStorePsw')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/tags",
      "apiVersion": "2023-07-01",
      "name": "default",
      "properties": {
        "tags": {
          "[format('{0}', variables('name_tagNameForKeyVault'))]": "[if(variables('const_bCreateNewKeyVault'), variables('name_keyVaultName'), variables('const_keyvaultNameFromTag'))]",
          "[format('{0}', variables('name_tagNameForStorageAccount'))]": "[if(or(and(or(parameters('createAKSCluster'), not(and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null'))))), variables('const_enablePV')), and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null')))), if(and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null'))), reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, format('wls{0}', uniqueString(parameters('utcValue')))), '')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "initialization",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "2583726336413374107"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": "pid"
            }
          },
          "resources": [
            {
              "condition": "[not(equals(parameters('name'), 'pid'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('name')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1770112025391142865"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "This is an empty deployment"
                    }
                  },
                  "resources": [],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "appgwEnd": {
              "type": "string",
              "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
            },
            "appgwStart": {
              "type": "string",
              "value": "01288010-2672-5831-a66b-7b8b45cace1b"
            },
            "customCertForAppgw": {
              "type": "string",
              "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
            },
            "dbEnd": {
              "type": "string",
              "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
            },
            "dbStart": {
              "type": "string",
              "value": "0cc86800-37f4-5191-9368-2953394309ec"
            },
            "dnsEnd": {
              "type": "string",
              "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
            },
            "dnsStart": {
              "type": "string",
              "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
            },
            "lbEnd": {
              "type": "string",
              "value": "ce664543-77bd-515a-832e-107e32f99da9"
            },
            "lbStart": {
              "type": "string",
              "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
            },
            "networkingEnd": {
              "type": "string",
              "value": "2798165c-49fa-5701-b608-b80ed3986176"
            },
            "networkingStart": {
              "type": "string",
              "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
            },
            "otherDb": {
              "type": "string",
              "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
            },
            "pswlessDbEnd": {
              "type": "string",
              "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
            },
            "pswlessDbStart": {
              "type": "string",
              "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
            },
            "sslEnd": {
              "type": "string",
              "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
            },
            "sslStart": {
              "type": "string",
              "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
            },
            "wlsAKSEnd": {
              "type": "string",
              "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
            },
            "wlsAKSStart": {
              "type": "string",
              "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
            },
            "wlsClusterAppEnd": {
              "type": "string",
              "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
            },
            "wlsClusterAppStart": {
              "type": "string",
              "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "pid-a1775ed4-512c-4cfa-9e68-f0b09b36de90-partnercenter",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "1770112025391142865"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": "This is an empty deployment"
            }
          },
          "resources": [],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "uami-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "17736942642391688894"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            }
          },
          "variables": {
            "const_roleDefinitionIdOfContributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
            "name_deploymentScriptUserDefinedManagedIdentity": "wls-aks-deployment-script-user-defined-managed-itentity",
            "name_deploymentScriptContributorRoleAssignmentName": "[guid(format('{0}{1}Deployment Script', resourceGroup().id, variables('name_deploymentScriptUserDefinedManagedIdentity')))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('name_deploymentScriptUserDefinedManagedIdentity')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('name_deploymentScriptContributorRoleAssignmentName')]",
              "subscriptionId": "[subscription().subscriptionId]",
              "location": "[resourceGroup().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "roleDefinitionId": {
                    "value": "[variables('const_roleDefinitionIdOfContributor')]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('name_deploymentScriptUserDefinedManagedIdentity'))).principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2590683520063015238"
                    }
                  },
                  "parameters": {
                    "roleDefinitionId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "principalId": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "name_roleAssignmentName": "[guid(format('{0}{1}Role assignment in subscription scope', subscription().id, parameters('principalId')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[variables('name_roleAssignmentName')]",
                      "properties": {
                        "description": "Assign subscription scope role to User Assigned Managed Identity ",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleId": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "uamiIdForDeploymentScript": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('name_deploymentScriptUserDefinedManagedIdentity'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "pre-azure-resources-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrName": {
            "value": "[parameters('acrName')]"
          },
          "acrResourceGroupName": {
            "value": "[parameters('acrResourceGroupName')]"
          },
          "createNewAcr": {
            "value": "[variables('const_createNewAcr')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "9258656948185899952"
            }
          },
          "parameters": {
            "acrName": {
              "type": "string",
              "defaultValue": "acr-contoso"
            },
            "acrResourceGroupName": {
              "type": "string",
              "defaultValue": "acr-contoso-rg"
            },
            "createNewAcr": {
              "type": "bool",
              "defaultValue": false
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "condition": "[parameters('createNewAcr')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "acr-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "15039249450763850014"
                    }
                  },
                  "parameters": {
                    "acrNamePrefix": {
                      "type": "string",
                      "defaultValue": "wlsaksacr"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "name_acr": "[format('{0}{1}', parameters('acrNamePrefix'), uniqueString(parameters('utcValue')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ContainerRegistry/registries",
                      "apiVersion": "2023-07-01",
                      "name": "[variables('name_acr')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard",
                        "tier": "Standard"
                      },
                      "properties": {
                        "adminUserEnabled": true,
                        "policies": {
                          "quarantinePolicy": {
                            "status": "disabled"
                          },
                          "trustPolicy": {
                            "type": "Notary",
                            "status": "disabled"
                          },
                          "retentionPolicy": {
                            "days": 7,
                            "status": "disabled"
                          }
                        },
                        "encryption": {
                          "status": "disabled"
                        },
                        "dataEndpointEnabled": false,
                        "publicNetworkAccess": "Enabled",
                        "networkRuleBypassOptions": "AzureServices",
                        "zoneRedundancy": "Disabled",
                        "anonymousPullEnabled": false
                      }
                    }
                  ],
                  "outputs": {
                    "acrName": {
                      "type": "string",
                      "value": "[variables('name_acr')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "acrName": {
              "type": "string",
              "value": "[if(parameters('createNewAcr'), reference(resourceId('Microsoft.Resources/deployments', 'acr-deployment'), '2020-10-01').outputs.acrName.value, parameters('acrName'))]"
            },
            "acrResourceGroupName": {
              "type": "string",
              "value": "[if(parameters('createNewAcr'), resourceGroup().name, parameters('acrResourceGroupName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "validate-parameters-and-fail-fast",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')).outputs.acrName.value]"
          },
          "acrResourceGroupName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')).outputs.acrResourceGroupName.value]"
          },
          "aksAgentPoolNodeCount": {
            "value": "[parameters('aksAgentPoolNodeCount')]"
          },
          "aksAgentPoolVMSize": {
            "value": "[parameters('vmSize')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksVersion": {
            "value": "[parameters('aksVersion')]"
          },
          "appGatewayCertificateOption": {
            "value": "[parameters('appGatewayCertificateOption')]"
          },
          "appGatewaySSLCertData": {
            "value": "[parameters('appGatewaySSLCertData')]"
          },
          "appGatewaySSLCertPassword": {
            "value": "[parameters('appGatewaySSLCertPassword')]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createDNSZone": {
            "value": "[parameters('createDNSZone')]"
          },
          "dnszoneName": {
            "value": "[parameters('dnszoneName')]"
          },
          "dnszoneRGName": {
            "value": "[parameters('dnszoneRGName')]"
          },
          "enableAppGWIngress": {
            "value": "[parameters('enableAppGWIngress')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableDNSConfiguration": {
            "value": "[parameters('enableDNSConfiguration')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "keyVaultResourceGroup": {
            "value": "[parameters('keyVaultResourceGroup')]"
          },
          "keyVaultSSLCertDataSecretName": {
            "value": "[parameters('keyVaultSSLCertDataSecretName')]"
          },
          "keyVaultSSLCertPasswordSecretName": {
            "value": "[parameters('keyVaultSSLCertPasswordSecretName')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "isSSOSupportEntitled": {
            "value": "[parameters('isSSOSupportEntitled')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "ocrSSOPSW": {
            "value": "[parameters('ocrSSOPSW')]"
          },
          "ocrSSOUser": {
            "value": "[parameters('ocrSSOUser')]"
          },
          "sslConfigurationAccessOption": {
            "value": "[parameters('sslConfigurationAccessOption')]"
          },
          "sslKeyVaultCustomIdentityKeyStoreDataSecretName": {
            "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreDataSecretName')]"
          },
          "sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName": {
            "value": "[parameters('sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName')]"
          },
          "sslKeyVaultCustomIdentityKeyStoreType": {
            "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreType')]"
          },
          "sslKeyVaultCustomTrustKeyStoreDataSecretName": {
            "value": "[parameters('sslKeyVaultCustomTrustKeyStoreDataSecretName')]"
          },
          "sslKeyVaultCustomTrustKeyStorePassPhraseSecretName": {
            "value": "[parameters('sslKeyVaultCustomTrustKeyStorePassPhraseSecretName')]"
          },
          "sslKeyVaultCustomTrustKeyStoreType": {
            "value": "[parameters('sslKeyVaultCustomTrustKeyStoreType')]"
          },
          "sslKeyVaultName": {
            "value": "[parameters('sslKeyVaultName')]"
          },
          "sslKeyVaultPrivateKeyAliasSecretName": {
            "value": "[parameters('sslKeyVaultPrivateKeyAliasSecretName')]"
          },
          "sslKeyVaultPrivateKeyPassPhraseSecretName": {
            "value": "[parameters('sslKeyVaultPrivateKeyPassPhraseSecretName')]"
          },
          "sslKeyVaultResourceGroup": {
            "value": "[parameters('sslKeyVaultResourceGroup')]"
          },
          "sslUploadedCustomIdentityKeyStoreData": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
          },
          "sslUploadedCustomIdentityKeyStorePassphrase": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
          },
          "sslUploadedCustomIdentityKeyStoreType": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreType')]"
          },
          "sslUploadedCustomTrustKeyStoreData": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
          },
          "sslUploadedCustomTrustKeyStorePassPhrase": {
            "value": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
          },
          "sslUploadedCustomTrustKeyStoreType": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreType')]"
          },
          "sslUploadedPrivateKeyAlias": {
            "value": "[parameters('sslUploadedPrivateKeyAlias')]"
          },
          "sslUploadedPrivateKeyPassPhrase": {
            "value": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
          },
          "useAksWellTestedVersion": {
            "value": "[parameters('useLatestSupportedAksVersion')]"
          },
          "userProvidedAcr": {
            "value": "[parameters('userProvidedAcr')]"
          },
          "userProvidedAcrRgName": {
            "value": "[parameters('userProvidedAcrRgName')]"
          },
          "userProvidedImagePath": {
            "value": "[parameters('userProvidedImagePath')]"
          },
          "useOracleImage": {
            "value": "[parameters('useOracleImage')]"
          },
          "vnetForApplicationGateway": {
            "value": "[parameters('vnetForApplicationGateway')]"
          },
          "wlsImageTag": {
            "value": "[parameters('wlsImageTag')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "8453654891461021634"
            }
          },
          "parameters": {
            "acrName": {
              "type": "string"
            },
            "acrResourceGroupName": {
              "type": "string"
            },
            "aksAgentPoolNodeCount": {
              "type": "int"
            },
            "aksAgentPoolVMSize": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterRGName": {
              "type": "string"
            },
            "aksClusterName": {
              "type": "string"
            },
            "aksVersion": {
              "type": "string",
              "defaultValue": "default"
            },
            "appGatewayCertificateOption": {
              "type": "string"
            },
            "appGatewaySSLCertData": {
              "type": "string"
            },
            "appGatewaySSLCertPassword": {
              "type": "secureString"
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "createAKSCluster": {
              "type": "bool"
            },
            "createDNSZone": {
              "type": "bool"
            },
            "dnszoneName": {
              "type": "string"
            },
            "dnszoneRGName": {
              "type": "string"
            },
            "enableAppGWIngress": {
              "type": "bool"
            },
            "enableCustomSSL": {
              "type": "bool"
            },
            "enableDNSConfiguration": {
              "type": "bool"
            },
            "keyVaultName": {
              "type": "string"
            },
            "keyVaultResourceGroup": {
              "type": "string"
            },
            "keyVaultSSLCertDataSecretName": {
              "type": "string"
            },
            "keyVaultSSLCertPasswordSecretName": {
              "type": "string"
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "isSSOSupportEntitled": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "ocrSSOPSW": {
              "type": "secureString"
            },
            "ocrSSOUser": {
              "type": "string"
            },
            "sslConfigurationAccessOption": {
              "type": "string"
            },
            "sslKeyVaultCustomIdentityKeyStoreDataSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomIdentityKeyStoreType": {
              "type": "string"
            },
            "sslKeyVaultCustomTrustKeyStoreDataSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomTrustKeyStorePassPhraseSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomTrustKeyStoreType": {
              "type": "string"
            },
            "sslKeyVaultName": {
              "type": "string"
            },
            "sslKeyVaultPrivateKeyAliasSecretName": {
              "type": "string"
            },
            "sslKeyVaultPrivateKeyPassPhraseSecretName": {
              "type": "string"
            },
            "sslKeyVaultResourceGroup": {
              "type": "string"
            },
            "sslUploadedCustomIdentityKeyStoreData": {
              "type": "secureString"
            },
            "sslUploadedCustomIdentityKeyStorePassphrase": {
              "type": "secureString"
            },
            "sslUploadedCustomIdentityKeyStoreType": {
              "type": "string"
            },
            "sslUploadedCustomTrustKeyStoreData": {
              "type": "secureString"
            },
            "sslUploadedCustomTrustKeyStorePassPhrase": {
              "type": "secureString"
            },
            "sslUploadedCustomTrustKeyStoreType": {
              "type": "string"
            },
            "sslUploadedPrivateKeyAlias": {
              "type": "secureString"
            },
            "sslUploadedPrivateKeyPassPhrase": {
              "type": "secureString"
            },
            "useAksWellTestedVersion": {
              "type": "bool",
              "defaultValue": true
            },
            "userProvidedAcr": {
              "type": "string"
            },
            "userProvidedAcrRgName": {
              "type": "string"
            },
            "userProvidedImagePath": {
              "type": "string"
            },
            "useOracleImage": {
              "type": "bool"
            },
            "vnetForApplicationGateway": {
              "type": "object"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsImageTag": {
              "type": "string"
            }
          },
          "variables": {
            "base64_common": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZXhwb3J0IGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9MjAgIyBpbnRlcnZhbCBvZiBjaGVja2luZyBwb2Qgc3RhdHVzLgpleHBvcnQgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPTEwMCAjIG1heCBhdHRlbXB0IHRvIGNoZWNrIHBvZCBzdGF0dXMuCmV4cG9ydCBjaGVja1BWU3RhdGVJbnRlcnZhbD01ICMgaW50ZXJ2YWwgb2YgY2hlY2tpbmcgcHZjIHN0YXR1cy4KZXhwb3J0IGNoZWNrUFZTdGF0ZU1heEF0dGVtcHQ9MTAgIyBtYXggYXR0ZW1wdCB0byBjaGVjayBwdmMgc3RhdHVzLgpleHBvcnQgY2hlY2tTVkNTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrU1ZDSW50ZXJ2YWw9MzAgI3NlY29uZHMKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c01heEF0dGVtcHQ9MTAKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c0ludGVydmFsPTMwCmV4cG9ydCBjaGVja0luZ3Jlc3NTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrQWNySW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWNyTWF4QXR0ZW1wdD0xMApleHBvcnQgY2hlY2tBZ2ljSW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWdpY01heEF0dGVtcHQ9NTAKCmV4cG9ydCBjb25zdEFkbWluVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0FETUlOX0FERFJFU1MiCmV4cG9ydCBjb25zdEFkbWluU2VydmVyTmFtZT0nYWRtaW4tc2VydmVyJwpleHBvcnQgY29uc3RDbHVzdGVyTmFtZT0nY2x1c3Rlci0xJwpleHBvcnQgY29uc3RDbHVzdGVyVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0NMVVNURVJfQUREUkVTUyIKZXhwb3J0IGNvbnN0REJUeXBlTXlTUUw9Im15c3FsIgpleHBvcnQgY29uc3REQlR5cGVTcWxTZXJ2ZXI9InNxbHNlcnZlciIKZXhwb3J0IGNvbnN0RGVmYXVsdEphdmFPcHRpb25zPSItRGxvZzRqMi5mb3JtYXRNc2dOb0xvb2t1cHM9dHJ1ZSAtRHdlYmxvZ2ljLlN0ZG91dERlYnVnRW5hYmxlZD1mYWxzZSIgIyB0aGUgamF2YSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0SlZNQXJncz0iLURqYXZhLnNlY3VyaXR5LmVnZD1maWxlOi9kZXYvLi91cmFuZG9tIC1YbXMyNTZtIC1YbXg1MTJtIC1YWDpNaW5SQU1QZXJjZW50YWdlPTI1LjAgLVhYOk1heFJBTVBlcmNlbnRhZ2U9NTAuMCAiICMgdGhlIEpWTSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0QUtTVmVyc2lvbj0iZGVmYXVsdCIKZXhwb3J0IGV4dGVybmFsSkRCQ0xpYnJhcmllc0RpcmVjdG9yeU5hbWU9ImV4dGVybmFsSkRCQ0xpYnJhcmllcyIKZXhwb3J0IGNvbnN0RmFsc2U9ImZhbHNlIgpleHBvcnQgY29uc3RUcnVlPSJ0cnVlIgpleHBvcnQgY29uc3RJbnRyb3NwZWN0b3JKb2JBY3RpdmVEZWFkbGluZVNlY29uZHM9MzAwICAjIGZvciBHdWFyYW50ZWVkIFFvcwpleHBvcnQgY29uc3RQb3N0Z3JlRHJpdmVyTmFtZT0icG9zdGdyZXNxbC00Mi41LjEuamFyIgpleHBvcnQgY29uc3RNU1NRTERyaXZlck5hbWU9Im1zc3FsLWpkYmMtMTAuMi4xLmpyZTguamFyIgpleHBvcnQgY29uc3RBenVyZUNvcmVWZXJzaW9uPSIxLjM0LjAiCmV4cG9ydCBjb25zdERiUG9kSWRlbnRpdHlTZWxlY3Rvcj0iZGItcG9kLWlkZW50aXR5IiAjIGRvIG5vdCBjaGFuZ2UgdGhlIHZhbHVlCmV4cG9ydCBjb25zdFByZWNsYXNzRGlyZWN0b3J5TmFtZT0icHJlY2xhc3NMaWJyYXJpZXMiCgpleHBvcnQgY3VybE1heFRpbWU9MTIwICMgc2Vjb25kcwpleHBvcnQgb2NyTG9naW5TZXJ2ZXI9ImNvbnRhaW5lci1yZWdpc3RyeS5vcmFjbGUuY29tIgpleHBvcnQgb2NyR2FJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWMiCmV4cG9ydCBvY3JDcHVJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWNfY3B1IgpleHBvcnQgZ2l0VXJsNENwdUltYWdlcz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvd2VibG9naWNfY3B1X2ltYWdlcy5qc29uIgpleHBvcnQgZ2l0VXJsNEFrc1dlbGxUZXN0ZWRWZXJzaW9uSnNvbkZpbGU9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9vcmFjbGUvd2VibG9naWMtYXp1cmUvbWFpbi93ZWJsb2dpYy1henVyZS1ha3Mvc3JjL21haW4vcmVzb3VyY2VzL2Frc193ZWxsX3Rlc3RlZF92ZXJzaW9uLmpzb24iCmV4cG9ydCBnaXRVcmw0V0xTVG9vbGluZ0ZhbWlseUpzb25GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy93ZWJsb2dpY190b29saW5nX2ZhbWlseS5qc29uIgpleHBvcnQgZ2l0VXJsNEF6dXJlSWRlbnRpdHlFeHRlbnNpb25zUG9tRmlsZT0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvYXp1cmUtaWRlbnRpdHktZXh0ZW5zaW9ucy54bWwiCmV4cG9ydCBnaXRVcmw0TXlTUUxEcml2ZXJQb21GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy9teXNxbC1jb25uZWN0b3ItamF2YS54bWwiCgpleHBvcnQgb3B0VW5pbnN0YWxsTWF4VHJ5PTUgIyBNYXggYXR0ZW1wdHMgdG8gd2FpdCBmb3IgdGhlIG9wZXJhdG9yIHVuaW5zdGFsbGVkCmV4cG9ydCBvcHRVbmluc3RhbGxJbnRlcnZhbD0xMAoKZXhwb3J0IHJldHJ5TWF4QXR0ZW1wdD01ICMgcmV0cnkgYXR0ZW1wdCBmb3IgY3VybCBjb21tYW5kCmV4cG9ydCByZXRyeUludGVydmFsPTEwCgpleHBvcnQgd2xzQ29udGFpbmVyTmFtZT0id2VibG9naWMtc2VydmVyIgpleHBvcnQgd2xzUG9zdGdyZXNxbERyaXZlclVybD0iaHR0cHM6Ly9qZGJjLnBvc3RncmVzcWwub3JnL2Rvd25sb2FkL3Bvc3RncmVzcWwtNDIuNS4xLmphciIKZXhwb3J0IHdsc01TU1FMRHJpdmVyVXJsPSJodHRwczovL3JlcG8ubWF2ZW4uYXBhY2hlLm9yZy9tYXZlbjIvY29tL21pY3Jvc29mdC9zcWxzZXJ2ZXIvbXNzcWwtamRiYy8xMC4yLjEuanJlOC9tc3NxbC1qZGJjLTEwLjIuMS5qcmU4LmphciIK",
            "base64_utility": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZnVuY3Rpb24gZWNob19zdGRlcnIoKSB7CiAgICBlY2hvID4mMiAiJEAiCiAgICAjIFRoZSBmdW5jdGlvbiBpcyB1c2VkIGZvciBzY3JpcHRzIHJ1bm5pbmcgd2l0aGluIEF6dXJlIERlcGxveW1lbnQgU2NyaXB0CiAgICAjIFRoZSB2YWx1ZSBvZiBBWl9TQ1JJUFRTX09VVFBVVF9QQVRIIGlzIC9tbnQvYXpzY3JpcHRzL2F6c2NyaXB0b3V0cHV0CiAgICBlY2hvIC1lICIkQCIgPj4ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9lcnJvcnMubG9nCn0KCmZ1bmN0aW9uIGVjaG9fc3Rkb3V0KCkgewogICAgZWNobyAiJEAiCiAgICAjIFRoZSBmdW5jdGlvbiBpcyB1c2VkIGZvciBzY3JpcHRzIHJ1bm5pbmcgd2l0aGluIEF6dXJlIERlcGxveW1lbnQgU2NyaXB0CiAgICAjIFRoZSB2YWx1ZSBvZiBBWl9TQ1JJUFRTX09VVFBVVF9QQVRIIGlzIC9tbnQvYXpzY3JpcHRzL2F6c2NyaXB0b3V0cHV0CiAgICBlY2hvIC1lICIkQCIgPj4ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9kZWJ1Zy5sb2cKfQoKI1ZhbGlkYXRlIHRlbWluYWwgc3RhdHVzIHdpdGggJD8sIGV4aXQgd2l0aCBleGNlcHRpb24gaWYgZXJyb3JzIGhhcHBlbi4KZnVuY3Rpb24gdXRpbGl0eV92YWxpZGF0ZV9zdGF0dXMoKSB7CiAgICBpZiBbICQ/ID09IDEgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICIkQCIKICAgICAgICBlY2hvX3N0ZGVyciAiRXJyb3JzIGhhcHBlbiwgZXhpdCAxLiIKICAgICAgICBleGl0IDEKICAgIGVsc2UKICAgICAgICBlY2hvX3N0ZG91dCAiJEAiCiAgICBmaQp9CgojIEpBVkFfSE9NRT0vdXNyL2xpYi9qdm0vamF2YS0xMS1vcGVuamRrCmZ1bmN0aW9uIGluc3RhbGxfamRrKCkgewogICAgbG9jYWwgcmVhZHk9ZmFsc2UKICAgIGxvY2FsIGF0dGVtcHQ9MAogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke3JldHJ5TWF4QXR0ZW1wdH0gXV07IGRvCiAgICAgICAgZWNobyAiSW5zdGFsbGluZyBvcGVuamRrMTEgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgIyBJbnN0YWxsIE1pY3Jvc29mdCBPcGVuSkRLCiAgICAgICAgYXBrIHVwZ3JhZGUKICAgICAgICBhcGsgYWRkIG9wZW5qZGsxMSBcCiAgICAgICAgICAgIC0tbm8tY2FjaGUgXAogICAgICAgICAgICAtcSAtLXJlcG9zaXRvcnk9aHR0cDovL2RsLWNkbi5hbHBpbmVsaW51eC5vcmcvYWxwaW5lL2VkZ2UvY29tbXVuaXR5CgogICAgICAgIGVjaG8gImphdmEgdmVyc2lvbiIKICAgICAgICBqYXZhIC12ZXJzaW9uCiAgICAgICAgaWYgWyAkPyAtZXEgMSBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5PWZhbHNlCiAgICAgICAgZmkKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtyZXRyeUludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtyZXRyeU1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGluc3RhbGwgb3BlbmpkazExLiIKICAgICAgICBleGl0IDEKICAgIGZpCn0KCmZ1bmN0aW9uIGluc3RhbGxfZG9ja2VyKCkgewogICAgbG9jYWwgcmVhZHk9ZmFsc2UKICAgIGxvY2FsIGF0dGVtcHQ9MAogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke3JldHJ5TWF4QXR0ZW1wdH0gXV07IGRvCiAgICAgICAgZWNobyAiSW5zdGFsbGluZyBkb2NrZXIgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgYXBrIGFkZCBkb2NrZXIgLS1uby1jYWNoZSAtLXF1aWV0CiAgICAgICAgZG9ja2VyIC0taGVscAogICAgICAgIGlmIFsgJD8gLWVxIDEgXTsgdGhlbgogICAgICAgICAgICByZWFkeT1mYWxzZQogICAgICAgIGZpCgogICAgICAgIGF0dGVtcHQ9JCgoYXR0ZW1wdCArIDEpKQogICAgICAgIHNsZWVwICR7cmV0cnlJbnRlcnZhbH0KICAgIGRvbmUKCiAgICBpZiBbICR7YXR0ZW1wdH0gLWd0ICR7cmV0cnlNYXhBdHRlbXB0fSBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBpbnN0YWxsIGRvY2tlci4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgpmdW5jdGlvbiBpbnN0YWxsX2t1YmVjdGwoKSB7CiAgICBsb2NhbCByZWFkeT1mYWxzZQogICAgbG9jYWwgYXR0ZW1wdD0wCiAgICB3aGlsZSBbWyAiJHtyZWFkeX0iID09ICJmYWxzZSIgJiYgJGF0dGVtcHQgLWxlICR7cmV0cnlNYXhBdHRlbXB0fSBdXTsgZG8KICAgICAgICBlY2hvICJJbnN0YWxsaW5nIGt1YmVjdGwgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgIyBJbnN0YWxsIGt1YmVjdGwKICAgICAgICBheiBha3MgaW5zdGFsbC1jbGkKICAgICAgICBlY2hvICJ2YWxpZGF0ZSBrdWJlY3RsIgogICAgICAgIGt1YmVjdGwgLS1oZWxwCiAgICAgICAgaWYgWyAkPyAtZXEgMSBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5PWZhbHNlCiAgICAgICAgZmkKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtyZXRyeUludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtyZXRyeU1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGluc3RhbGwga3ViZWN0bC4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgpmdW5jdGlvbiBpbnN0YWxsX2hlbG0oKSB7CiAgICAjIEluc3RhbGwgSGVsbQogICAgYnJvd3NlclVSTD0kKGN1cmwgLW0gJHtjdXJsTWF4VGltZX0gLS1yZXRyeSAke3JldHJ5TWF4QXR0ZW1wdH0gLXMgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9oZWxtL2hlbG0vcmVsZWFzZXMvbGF0ZXN0IHwKICAgICAgICBncmVwICJicm93c2VyX2Rvd25sb2FkX3VybC4qbGludXgtYW1kNjQudGFyLmd6LmFzYyIgfAogICAgICAgIGN1dCAtZCA6IC1mIDIsMyB8CiAgICAgICAgdHIgLWQgXCIpCiAgICBoZWxtTGF0ZXN0VmVyc2lvbj0ke2Jyb3dzZXJVUkwjKmRvd25sb2FkXC99CiAgICBoZWxtTGF0ZXN0VmVyc2lvbj0ke2hlbG1MYXRlc3RWZXJzaW9uJSVcL2hlbG0qfQogICAgaGVsbVBhY2thZ2VOYW1lPWhlbG0tJHtoZWxtTGF0ZXN0VmVyc2lvbn0tbGludXgtYW1kNjQudGFyLmd6CiAgICBjdXJsIC1tICR7Y3VybE1heFRpbWV9IC0tcmV0cnkgJHtyZXRyeU1heEF0dGVtcHR9IC1mTCBodHRwczovL2dldC5oZWxtLnNoLyR7aGVsbVBhY2thZ2VOYW1lfSAtbyAvdG1wLyR7aGVsbVBhY2thZ2VOYW1lfQogICAgdGFyIC16eHZmIC90bXAvJHtoZWxtUGFja2FnZU5hbWV9IC1DIC90bXAKICAgIG12IC90bXAvbGludXgtYW1kNjQvaGVsbSAvdXNyL2xvY2FsL2Jpbi9oZWxtCiAgICBlY2hvICJIZWxtIHZlcnNpb24iCiAgICBoZWxtIHZlcnNpb24KICAgIHV0aWxpdHlfdmFsaWRhdGVfc3RhdHVzICJGaW5pc2hlZCBpbnN0YWxsaW5nIEhlbG0uIgp9CgojIFF1ZXJ5IHNlcnZpY2UgcG9ydAojICQxOiBzZXJ2aWNlIG5hbWUKIyAkMjogbmFtZXNwYWNlCiMgJDM6IGNoYW5uZWwgbmFtZQojIHJldHVybjogcG9ydAojIE5vdGVzOiBjaGFubmVsIG5hbWUgd2lsbCBiZSBkaWZmZXJlbnQgaWYgaXN0aW8gaXMgZW5hYmxlZC4KZnVuY3Rpb24gdXRpbGl0eV9xdWVyeV9zZXJ2aWNlX3BvcnQoKSB7CiAgICBsb2NhbCBwb3J0PSQoa3ViZWN0bCBnZXQgc2VydmljZSAkezF9IC1uICR7Mn0gLW8ganNvbiB8CiAgICAgICAganEgIi5zcGVjLnBvcnRzW10gfCBzZWxlY3QoLm5hbWU9PVwiJHszfVwiKSB8IC5wb3J0IikKICAgIGlmIFsgJD8gIT0gMCBdIHx8IFtbICIkcG9ydCIgPT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBxdWVyeSBwb3J0IG9mICR7MX0vJHszfSBpbiBuYW1lc3BhY2UgJHsyfSIKICAgICAgICBleGl0IDEKICAgIGZpCgogICAgZWNobyAkcG9ydAp9CgojCiMgQ2hlY2sgdGhlIHN0YXRlIG9mIGEgcGVyc2lzdGVudCB2b2x1bWUuCiMgTGV2ZXJhZ2Ugc291cmNlIGNvZGUgZnJvbSBmdW5jdGlvbiAiY2hlY2tQdlN0YXRlIiBpbiB3ZWJsb2dpYy1vcGVyYXRvciwga3ViZXJuZXRlc1xzYW1wbGVzXHNjcmlwdHNcY29tbW9uXHV0aWxpdHkuc2gKIyAkMSAtIG5hbWUgb2Ygdm9sdW1lCiMgJDIgLSBleHBlY3RlZCBzdGF0ZSBvZiB2b2x1bWUKIyAkMyAtIG1heCBhdHRlbXB0CiMgJDQgLSBpbnRlcnZhbApmdW5jdGlvbiB1dGlsaXR5X2NoZWNrX3B2X3N0YXRlIHsKCiAgICBlY2hvX3N0ZG91dCAiQ2hlY2tpbmcgaWYgdGhlIHBlcnNpc3RlbnQgdm9sdW1lICR7MTo/fSBpcyAkezI6P30iCiAgICBsb2NhbCBwdl9zdGF0ZT0kKGt1YmVjdGwgZ2V0IHB2ICQxIC1vIGpzb25wYXRoPSd7LnN0YXR1cy5waGFzZX0nKQogICAgYXR0ZW1wdHM9MAogICAgd2hpbGUgWyAhICIkcHZfc3RhdGUiID0gIiQyIiBdICYmIFsgISAkYXR0ZW1wdHMgLWVxICQzIF07IGRvCiAgICAgICAgYXR0ZW1wdHM9JCgoYXR0ZW1wdHMgKyAxKSkKICAgICAgICBzbGVlcCAkNAogICAgICAgIHB2X3N0YXRlPSQoa3ViZWN0bCBnZXQgcHYgJDEgLW8ganNvbnBhdGg9J3suc3RhdHVzLnBoYXNlfScpCiAgICBkb25lCiAgICBpZiBbICIkcHZfc3RhdGUiICE9ICIkMiIgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICJUaGUgcGVyc2lzdGVudCB2b2x1bWUgc3RhdGUgc2hvdWxkIGJlICQyIGJ1dCBpcyAkcHZfc3RhdGUiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojCiMgQ3JlYXRlIGRpcmVjdG9yeSBpbiBzcGVjaWZpZWQgZmlsZSBzaGFyZQojICQxIC0gbmFtZSBvZiBkaXJlY3RvcnkKIyAkMiAtIG5hbWUgb2YgZmlsZSBzaGFyZQojICQzIC0gbmFtZSBvZiBzdG9yYWdlIGFjY291bnQKIyAkNCAtIHNhcyB0b2tlbgpmdW5jdGlvbiB1dGlsaXR5X2NyZWF0ZV9kaXJlY3RvcnlfdG9fZmlsZXNoYXJlKCkgewogICAgcmV0PSQoYXogc3RvcmFnZSBkaXJlY3RvcnkgZXhpc3RzIC0tbmFtZSAkMSAtLXNoYXJlLW5hbWUgJDIgLS1hY2NvdW50LW5hbWUgJDMgLS1zYXMtdG9rZW4gJHs0fSB8IGpxICcuZXhpc3RzJykKICAgIGlmIFtbICIke3JldCwsfSIgPT0gImZhbHNlIiBdXTsgdGhlbgogICAgICAgIGF6IHN0b3JhZ2UgZGlyZWN0b3J5IGNyZWF0ZSAtLW5hbWUgJDEgLS1zaGFyZS1uYW1lICQyIC0tYWNjb3VudC1uYW1lICQzIC0tc2FzLXRva2VuICR7NH0gLS10aW1lb3V0IDMwCiAgICBmaQoKICAgIGlmIFsgJD8gIT0gMCBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBjcmVhdGUgZGlyZWN0b3J5ICR7MX0gaW4gZmlsZSBzaGFyZSAkezN9LyR7Mn0iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojCiMgVXBsb2FkIGZpbGUgdG8gZmlsZSBzaGFyZQojICQxIC0gbmFtZSBvZiBmaWxlIHNoYXJlCiMgJDIgLSBuYW1lIG9mIHN0b3JhZ2UgYWNjb3VudAojICQzIC0gcGF0aCBvZiBmaWxlCiMgJDQgLSBzb3VyY2UgcGF0aCBvZiBmaWxlCiMgJDUgLSBzYXMgdG9rZW4KZnVuY3Rpb24gdXRpbGl0eV91cGxvYWRfZmlsZV90b19maWxlc2hhcmUoKSB7CiAgICBheiBzdG9yYWdlIGZpbGUgdXBsb2FkIC0tc2hhcmUtbmFtZSAkezF9IC0tYWNjb3VudC1uYW1lICR7Mn0gLS1wYXRoICR7M30gLS1zb3VyY2UgJHs0fSAtLXNhcy10b2tlbiAkezV9IC0tdGltZW91dCA2MAogICAgaWYgWyAkPyAhPSAwIF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHVwbG9hZCAkezN9IHRvIGZpbGUgc2hhcmUgJHsyfS8kezF9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQoKIwojIE1ha2Ugc3VyZSBhbGwgdGhlIGFwcGxpY2F0aW9ucyBhcmUgcnVubmluZwojIEV4aXQgd2l0aCBlcnJvciBpZiB0aGVyZSBpcyBpbmFjdGl2ZSBhcHBsaWNhdGlvbi4KIyAkMSAtIG5hbWVzcGFjZSBvZiB0aGUgZG9tYWluCiMgJDIgLSBDbHVzdGVySVAgc2VydmljZSBuYW1lIG9mIGFkbWluIHNlcnZlcgojICQzIC0gZG9tYWluIHVzZXIKIyAkNCAtIGRvbWFpbiBwYXNzd29yZAojICQ1IC0gcGF0aCBvZiBweXRob24gc2NyaXB0IHdoaWNoIGNoZWNrcyBhcHBsaWNhdGlvbiBzdGF0dXMsIHRoZSBzY3JpcHQgd2lsbCBydW4gb24gYWRtaW4gc2VydmVyIHBvZC4KZnVuY3Rpb24gdXRpbGl0eV92YWxpZGF0ZV9hcHBsaWNhdGlvbl9zdGF0dXMoKSB7CiAgICBsb2NhbCB3bHNEb21haW5OUz0kMQogICAgbG9jYWwgd2xzQWRtaW5TdmNOYW1lPSQyCiAgICBsb2NhbCB3bHNVc2VyPSQzCiAgICBsb2NhbCB3bHNQYXNzd29yZD0kNAogICAgbG9jYWwgcHlTY3JpcHRQYXRoPSQ1CgogICAgbG9jYWwgcG9kTmFtZT0kKGt1YmVjdGwgLW4gJHt3bHNEb21haW5OU30gZ2V0IHBvZCAtbCB3ZWJsb2dpYy5zZXJ2ZXJOYW1lPWFkbWluLXNlcnZlciAtbyBqc29uIHwKICAgICAgICBqcSAnLml0ZW1zWzBdIHwgLm1ldGFkYXRhLm5hbWUnIHwKICAgICAgICB0ciAtZCAiXCIiKQoKICAgICMgZ2V0IG5vbi1zc2wgcG9ydAogICAgbG9jYWwgYWRtaW5UYXJnZXRQb3J0PSQoa3ViZWN0bCBnZXQgc3ZjICR7d2xzQWRtaW5TdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwganEgJy5zcGVjLnBvcnRzW10gfCBzZWxlY3QoLm5hbWU9PSJpbnRlcm5hbC10MyIpIHwgLnBvcnQnKQogICAgbG9jYWwgdDNDaGFubmVsQWRkcmVzcz0iJHtwb2ROYW1lfS4ke3dsc0RvbWFpbk5TfSIKCiAgICBsb2NhbCB0YXJnZXRGaWxlUGF0aD0vdG1wL2NoZWNrQXBwbGljYXRpb25TdGF0dXMucHkKICAgIGVjaG8gImNvcHkgJHtweVNjcmlwdFBhdGh9IHRvICR7dGFyZ2V0RmlsZVBhdGh9IgogICAga3ViZWN0bCBjcCAke3B5U2NyaXB0UGF0aH0gLW4gJHt3bHNEb21haW5OU30gJHtwb2ROYW1lfToke3RhcmdldEZpbGVQYXRofQogICAga3ViZWN0bCBleGVjIC1pdCAke3BvZE5hbWV9IC1uICR7d2xzRG9tYWluTlN9IC1jICJ3ZWJsb2dpYy1zZXJ2ZXIiIFwKICAgICAgICAtLSBiYXNoIC1jICJ3bHN0LnNoICR7dGFyZ2V0RmlsZVBhdGh9IC11c2VyICR7d2xzVXNlcn0gLXBhc3N3b3JkICR7d2xzUGFzc3dvcmR9IC10M0NoYW5uZWxBZGRyZXNzICR7dDNDaGFubmVsQWRkcmVzc30gLXQzQ2hhbm5lbFBvcnQgJHthZG1pblRhcmdldFBvcnR9IiB8CiAgICAgICAgZ3JlcCAiU3VtbWFyeTogYWxsIGFwcGxpY2F0aW9ucyBhcmUgYWN0aXZlIgoKICAgIGlmIFsgJD8gPT0gMSBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBkZXBsb3kgYXBwbGljYXRpb24gdG8gV0xTIGNsdXN0ZXIuIFBsZWFzZSBtYWtlIHN1cmUgdGhlIGNvbmZpZ3VyYXRpb25zIGFyZSBjb3JyZWN0LiIKICAgICAgICBleGl0IDEKICAgIGZpCn0KCiMgQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIG1ha2Ugc3VyZSBwb2RzIG9mIGEgZG9tYWluIGFyZSBydW5uaW5nLgojICAgKiBNYWtlIHN1cmUgdGhlIGFkbWluIHNlcnZlciBwb2QgaXMgcnVubmluZwojICAgKiBNYWtlIHN1cmUgYWxsIHRoZSBtYW5hZ2VkIHNlcnZlciBwb2RzIGFyZSBydW5uaW5nCiMgQXNzdW1pbmcgdGhlcmUgaXMgb25seSBvbmUgY2x1c3RlciBpbiB0aGUgZG9tYWluCiMgUGFyYW1ldGVyczoKIyAgICogYXBwUmVwbGljYXM6IHJlcGxpY2FzIG9mIHRoZSBtYW5hZ2VkIHNlcnZlcgojICAgKiB3bHNEb21haW5OUzogbmFtZSBzcGFjZQojICAgKiBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM6IG1heCBhdHRlbXB0cyB0byBxdWVyeSB0aGUgcG9kcyBzdGF0dXMgaWYgdGhleSBhcmUgbm90IGFsbCBydW5uaW5nLgojICAgKiBjaGVja1BvZFN0YXR1c0ludGVydmFsOiBpbnRlcnZhbCBvZiBxdWVyeSB0aGUgcG9kcyBzdGF0dXMKZnVuY3Rpb24gdXRpbGl0eV93YWl0X2Zvcl9wb2RfY29tcGxldGVkKCkgewogICAgYXBwUmVwbGljYXM9JDEKICAgIHdsc0RvbWFpbk5TPSQyCiAgICBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM9JDMKICAgIGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9JDQKCiAgICBlY2hvICJXYWl0aW5nIGZvciAkKChhcHBSZXBsaWNhcyArIDEpKSBwb2RzIGFyZSBydW5uaW5nLiIKCiAgICByZWFkeVBvZE51bT0wCiAgICBhdHRlbXB0PTAKICAgIHdoaWxlIFtbICR7cmVhZHlQb2ROdW19IC1sZSAke2FwcFJlcGxpY2FzfSAmJiAkYXR0ZW1wdCAtbGUgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF1dOyBkbwogICAgICAgIHJldD0kKGt1YmVjdGwgZ2V0IHBvZHMgLW4gJHt3bHNEb21haW5OU30gLW8ganNvbiB8CiAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zdGF0dXMucGhhc2UnIHwKICAgICAgICAgICAgZ3JlcCAiUnVubmluZyIpCiAgICAgICAgaWYgWyAteiAiJHtyZXR9IiBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5UG9kTnVtPTAKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlYWR5UG9kTnVtPSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zdGF0dXMucGhhc2UnIHwKICAgICAgICAgICAgICAgIGdyZXAgLWMgIlJ1bm5pbmciKQogICAgICAgIGZpCiAgICAgICAgZWNobyAiTnVtYmVyIG9mIG5ldyBydW5uaW5nIHBvZDogJHtyZWFkeVBvZE51bX0iCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiSXQgdGFrZXMgdG9vIGxvbmcgdG8gd2FpdCBmb3IgYWxsIHRoZSBwb2RzIHRvIHJlYWNoIHJ1bm5pbmcgc3RhdGUsIHBsZWFzZSByZWZlciB0byBodHRwczovL2FrYS5tcy93bHMtYWtzLXRyb3VibGVzaG9vdGluZy4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgcG9kcyBvZiBhIGRvbWFpbiBhcmUgdXBkYXRlZCB3aXRoIGV4cGVjdGVkIGltYWdlLgojICAgKiBNYWtlIHN1cmUgdGhlIGFkbWluIHNlcnZlciBwb2QgaXMgdXBkYXRlZCB3aXRoIGV4cGVjdGVkIGltYWdlCiMgICAqIE1ha2Ugc3VyZSBhbGwgdGhlIG1hbmFnZWQgc2VydmVyIHBvZHMgYXJlIHVwZGF0ZWQgd2l0aCBleHBlY3RlZCBpbWFnZQojIEFzc3VtaW5nIHRoZXJlIGlzIG9ubHkgb25lIGNsdXN0ZXIgaW4gdGhlIGRvbWFpbgojIFBhcmFtZXRlcnM6CiMgICAqIGFjckltYWdlUGF0aDogaW1hZ2UgcGF0aAojICAgKiBhcHBSZXBsaWNhczogcmVwbGljYXMgb2YgdGhlIG1hbmFnZWQgc2VydmVyCiMgICAqIHdsc0RvbWFpbk5TOiBuYW1lIHNwYWNlCiMgICAqIGNoZWNrUG9kU3RhdHVzTWF4QXR0ZW1wczogbWF4IGF0dGVtcHRzIHRvIHF1ZXJ5IHRoZSBwb2RzIHN0YXR1cyBpZiB0aGV5IGFyZSBub3QgYWxsIHJ1bm5pbmcuCiMgICAqIGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw6IGludGVydmFsIG9mIHF1ZXJ5IHRoZSBwb2RzIHN0YXR1cwpmdW5jdGlvbiB1dGlsaXR5X3dhaXRfZm9yX2ltYWdlX3VwZGF0ZV9jb21wbGV0ZWQoKSB7CiAgICAjIE1ha2Ugc3VyZSBhbGwgb2YgdGhlIHBvZHMgYXJlIHVwZGF0ZWQgd2l0aCBuZXcgaW1hZ2UuCiAgICAjIEFzc3VtcHRpb246IHdlIGhhdmUgb25seSBvbmUgY2x1c3RlciBjdXJyZW50bHkuCiAgICBhY3JJbWFnZVBhdGg9JDEKICAgIGFwcFJlcGxpY2FzPSQyCiAgICB3bHNEb21haW5OUz0kMwogICAgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPSQ0CiAgICBjaGVja1BvZFN0YXR1c0ludGVydmFsPSQ1CgogICAgZWNobyAiV2FpdGluZyBmb3IgJCgoYXBwUmVwbGljYXMgKyAxKSkgbmV3IHBvZHMgY3JlYXRlZCB3aXRoIGltYWdlICR7YWNySW1hZ2VQYXRofSIKCiAgICB1cGRhdGVkUG9kTnVtPTAKICAgIGF0dGVtcHQ9MAogICAgd2hpbGUgWyAke3VwZGF0ZWRQb2ROdW19IC1sZSAke2FwcFJlcGxpY2FzfSBdICYmIFsgJGF0dGVtcHQgLWxlICR7Y2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzfSBdOyBkbwogICAgICAgIGVjaG8gImF0dGVtcHRzICR7YXR0ZW1wdH0iCiAgICAgICAgcmV0PSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5pdGVtc1tdIHwgLnNwZWMgfCAuY29udGFpbmVyc1tdIHwgc2VsZWN0KC5uYW1lID09ICJ3ZWJsb2dpYy1zZXJ2ZXIiKSB8IC5pbWFnZScgfAogICAgICAgICAgICBncmVwICIke2FjckltYWdlUGF0aH0iKQoKICAgICAgICBpZiBbIC16ICIke3JldH0iIF07IHRoZW4KICAgICAgICAgICAgdXBkYXRlZFBvZE51bT0wCiAgICAgICAgZWxzZQogICAgICAgICAgICB1cGRhdGVkUG9kTnVtPSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zcGVjIHwgLmNvbnRhaW5lcnNbXSB8IHNlbGVjdCgubmFtZSA9PSAid2VibG9naWMtc2VydmVyIikgfCAuaW1hZ2UnIHwKICAgICAgICAgICAgICAgIGdyZXAgLWMgIiR7YWNySW1hZ2VQYXRofSIpCiAgICAgICAgZmkKICAgICAgICBlY2hvICJOdW1iZXIgb2YgbmV3IHBvZDogJHt1cGRhdGVkUG9kTnVtfSIKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHVwZGF0ZSBpbWFnZSAke2FjckltYWdlUGF0aH0gdG8gYWxsIHdlYmxvZ2ljIHNlcnZlciBwb2RzLiAiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgcG9kcyBvZiBhIGRvbWFpbiBhcmUgcmVzdGFydGVkLgojIEFzc3VtaW5nIHRoZXJlIGlzIG9ubHkgb25lIGNsdXN0ZXIgaW4gdGhlIGRvbWFpbgojIFBhcmFtZXRlcnM6CiMgICAqIGJhc2VUaW1lOiB0aW1lIHN0YW1wIHRoYXQgc2hvdWxkIGJlIGVhcmxpZXIgdGhlbiBwb2QgcmVzdGFydHMKIyAgICogYXBwUmVwbGljYXM6IHJlcGxpY2FzIG9mIHRoZSBtYW5hZ2VkIHNlcnZlcgojICAgKiB3bHNEb21haW5OUzogbmFtZSBzcGFjZQojICAgKiBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM6IG1heCBhdHRlbXB0cyB0byBxdWVyeSB0aGUgcG9kcyBzdGF0dXMgaWYgdGhleSBhcmUgbm90IGFsbCBydW5uaW5nLgojICAgKiBjaGVja1BvZFN0YXR1c0ludGVydmFsOiBpbnRlcnZhbCBvZiBxdWVyeSB0aGUgcG9kcyBzdGF0dXMKZnVuY3Rpb24gdXRpbGl0eV93YWl0X2Zvcl9wb2RfcmVzdGFydGVkKCkgewogICAgYmFzZVRpbWU9JDEKICAgIGFwcFJlcGxpY2FzPSQyCiAgICB3bHNEb21haW5VSUQ9JDMKICAgIGNoZWNrUG9kU3RhdHVzTWF4QXR0ZW1wcz0kNAogICAgY2hlY2tQb2RTdGF0dXNJbnRlcnZhbD0kNQoKICAgIHdsc0RvbWFpbk5TPSR7d2xzRG9tYWluVUlEfS1ucwoKICAgIHVwZGF0ZWRQb2ROdW09MAogICAgYXR0ZW1wdD0wCiAgICB3aGlsZSBbICR7dXBkYXRlZFBvZE51bX0gLWxlICR7YXBwUmVwbGljYXN9IF0gJiYgWyAkYXR0ZW1wdCAtbGUgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IGRvCiAgICAgICAgZWNobyAiYXR0ZW1wdHMgJHthdHRlbXB0fSIKICAgICAgICByZXQ9JChrdWJlY3RsIGdldCBwb2RzIC1uICR7d2xzRG9tYWluTlN9IC1sIHdlYmxvZ2ljLmRvbWFpblVJRD0ke3dsc0RvbWFpblVJRH0gLW8ganNvbiB8CiAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5tZXRhZGF0YS5jcmVhdGlvblRpbWVzdGFtcCcgfCB0ciAtZCAiXCIiKQoKICAgICAgICBjb3VudGVyPTAKICAgICAgICBmb3IgaXRlbSBpbiAkcmV0OyBkbwogICAgICAgICAgICAjIGNvbnZlciB0aGUgdGltZSBmb3JtYXQgZnJvbSBZWVlZLU1NLUREVGhoOm1tOnNzWiB0byBZWVlZLk1NLkRELWhoOm1tOnNzCiAgICAgICAgICAgIGFscGluZUl0ZW09JChlY2hvICIke2l0ZW19IiB8IHNlZCAtZSAicy8tLy4vZztzL1QvLS9nO3MvWi8vZyIpCiAgICAgICAgICAgIHBvZENyZWF0ZVRpbWVTdGFtcD0kKGRhdGUgLXUgLWQgIiR7YWxwaW5lSXRlbX0iICsiJXMiKQogICAgICAgICAgICBlY2hvICJwb2QgY3JlYXRlIHRpbWU6ICRwb2RDcmVhdGVUaW1lU3RhbXAsIGJhc2UgdGltZTogJHtiYXNlVGltZX0iCiAgICAgICAgICAgIGlmIFsgJHtwb2RDcmVhdGVUaW1lU3RhbXB9IC1ndCAke2Jhc2VUaW1lfSBdOyB0aGVuCiAgICAgICAgICAgICAgICBjb3VudGVyPSQoKGNvdW50ZXIgKyAxKSkKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCgogICAgICAgIHVwZGF0ZWRQb2ROdW09JGNvdW50ZXIKICAgICAgICBlY2hvICJOdW1iZXIgb2YgbmV3IHBvZDogJHt1cGRhdGVkUG9kTnVtfSIKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHJlc3RhcnQgYWxsIHdlYmxvZ2ljIHNlcnZlciBwb2RzLiAiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgdGhlIGxiIHNlcnZpY2UgaXMgYXZhbGlhYmxlLgpmdW5jdGlvbiB1dGlsaXR5X3dhaXRmb3JfbGJfc3ZjX2NvbXBsZXRlZCgpIHsKICAgIHN2Y05hbWU9JDEKICAgIHdsc0RvbWFpbk5TPSQyCiAgICBwZXJmU1ZDQXR0ZW1wcz0kMwogICAgcGVyZlJldHJ5SW50ZXJ2YWw9JDQKCiAgICBhdHRlbXB0cz0wCiAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgIHdoaWxlIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWx0ICR7cGVyZlNWQ0F0dGVtcHN9IF07IGRvCiAgICAgICAgc3ZjU3RhdGU9ImNvbXBsZXRlZCIKICAgICAgICBhdHRlbXB0cz0kKChhdHRlbXB0cyArIDEpKQogICAgICAgIGVjaG8gV2FpdGluZyBmb3Igam9iIGNvbXBsZXRlZC4uLiR7YXR0ZW1wdHN9CiAgICAgICAgc2xlZXAgJHtwZXJmUmV0cnlJbnRlcnZhbH0KCiAgICAgICAgaXA9JChrdWJlY3RsIGdldCBzdmMgJHtzdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5zdGF0dXMubG9hZEJhbGFuY2VyLmluZ3Jlc3NbMF0uaXAnKQogICAgICAgIGVjaG8gImlwOiAke2lwfSIKICAgICAgICBpZiBbWyAiJHtpcH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgICAgICBmaQogICAgZG9uZQoKICAgIGlmIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWdlICR7cGVyZlNWQ0F0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGNyZWF0ZSBzZXJ2aWNlOiAke3N2Y05hbWV9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQoKIyBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gbWFrZSBzdXJlIHRoZSBpbmdyZXNzIGlzIGF2YWxpYWJsZS4KZnVuY3Rpb24gdXRpbGl0eV93YWl0Zm9yX2luZ3Jlc3NfY29tcGxldGVkKCkgewogICAgc3ZjTmFtZT0kMQogICAgd2xzRG9tYWluTlM9JDIKICAgIHBlcmZTVkNBdHRlbXBzPSQzCiAgICBwZXJmUmV0cnlJbnRlcnZhbD0kNAoKICAgIGF0dGVtcHRzPTAKICAgIHN2Y1N0YXRlPSJydW5uaW5nIgogICAgd2hpbGUgWyAiJHN2Y1N0YXRlIiA9PSAicnVubmluZyIgXSAmJiBbICRhdHRlbXB0cyAtbHQgJHtwZXJmU1ZDQXR0ZW1wc30gXTsgZG8KICAgICAgICBzdmNTdGF0ZT0iY29tcGxldGVkIgogICAgICAgIGF0dGVtcHRzPSQoKGF0dGVtcHRzICsgMSkpCiAgICAgICAgZWNobyBXYWl0aW5nIGZvciBqb2IgY29tcGxldGVkLi4uJHthdHRlbXB0c30KICAgICAgICBzbGVlcCAke3BlcmZSZXRyeUludGVydmFsfQoKICAgICAgICBpcD0kKGt1YmVjdGwgZ2V0IGluZ3Jlc3MgJHtzdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5zdGF0dXMubG9hZEJhbGFuY2VyLmluZ3Jlc3NbMF0uaXAnKQogICAgICAgIGVjaG8gImlwOiAke2lwfSIKICAgICAgICBpZiBbWyAiJHtpcH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgICAgICBmaQogICAgZG9uZQoKICAgIGlmIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWdlICR7cGVyZlNWQ0F0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGNyZWF0ZSBzZXJ2aWNlOiAke3N2Y05hbWV9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQo=",
            "base64_validateParameters": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgojCiMgZW52IGlucHV0czoKIyBPUkFDTEVfQUNDT1VOVF9OQU1FCiMgT1JBQ0xFX0FDQ09VTlRfUEFTU1dPUkQKIyBBQ1JfTkFNRQojIEFLU19DTFVTVEVSX05BTUUKIyBBS1NfQ0xVU1RFUl9SRVNPVVJDRUdST1VQX05BTUUKIyBCQVNFNjRfRk9SX1NFUlZJQ0VfUFJJTkNJUEFMCiMgV0xTX1NTTF9LRVlWQVVMVF9OQU1FCiMgV0xTX1NTTF9LRVlWQVVMVF9SRVNPVVJDRUdST1VQX05BTUUKIyBXTFNfU1NMX0tFWVZBVUxUX0lERU5USVRZX0RBVEFfU0VDUkVUX05BTUUKIyBXTFNfU1NMX0tFWVZBVUxUX0lERU5USVRZX1BBU1NXT1JEX1NFQ1JFVF9OQU1FCiMgV0xTX1NTTF9LRVlWQVVMVF9JREVOVElUWV9UWVBFCiMgV0xTX1NTTF9LRVlWQVVMVF9UUlVTVF9EQVRBX1NFQ1JFVF9OQU1FCiMgV0xTX1NTTF9LRVlWQVVMVF9UUlVTVF9QQVNTV09SRF9TRUNSRVRfTkFNRQojIFdMU19TU0xfS0VZVkFVTFRfVFJVU1RfVFlQRQojIFdMU19TU0xfS0VZVkFVTFRfUFJJVkFURV9LRVlfQUxJQVMKIyBXTFNfU1NMX0tFWVZBVUxUX1BSSVZBVEVfS0VZX1BBU1NXT1JECiMgV0xTX1NTTF9JREVOVElUWV9EQVRBCiMgV0xTX1NTTF9JREVOVElUWV9QQVNTV09SRAojIFdMU19TU0xfSURFTlRJVFlfVFlQRQojIFdMU19TU0xfVFJVU1RfREFUQQojIFdMU19TU0xfVFJVU1RfUEFTU1dPUkQKIyBXTFNfU1NMX1RSVVNUX1RZUEUKIyBXTFNfU1NMX1BSSVZBVEVfS0VZX0FMSUFTCiMgV0xTX1NTTF9QUklWQVRFX0tFWV9QQVNTV09SRAojIEFQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0tFWVZBVUxUX05BTUUKIyBBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9SRVNPVVJDRUdST1VQCiMgQVBQTElDQVRJT05fR0FURVdBWV9TU0xfS0VZVkFVTFRfRlJPTlRFTkRfQ0VSVF9EQVRBX1NFQ1JFVF9OQU1FCiMgQVBQTElDQVRJT05fR0FURVdBWV9TU0xfS0VZVkFVTFRfRlJPTlRFTkRfQ0VSVF9QQVNTV09SRF9TRUNSRVRfTkFNRQojIEFQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0ZST05URU5EX0NFUlRfREFUQQojIEFQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0ZST05URU5EX0NFUlRfUEFTU1dPUkQKIyBETlNfWk9ORV9OQU1FCiMgRE5TX1pPTkVfUkVTT1VSQ0VHUk9VUF9OQU1FCiMgQUtTX1ZFUlNJT04KIyBVU0VfQUtTX1dFTExfVEVTVEVEX1ZFUlNJT04KIyBWTkVUX0ZPUl9BUFBMSUNBVElPTkdBVEVXQVkKCiNWYWxpZGF0ZSB0ZW1pbmFsIHN0YXR1cyB3aXRoICQ/LCBleGl0IHdpdGggZXhjZXB0aW9uIGlmIGVycm9ycyBoYXBwZW4uCiMgJDEgLSBlcnJvciBtZXNzYWdlCiMgJDIgLSAgcm9vdCBjYXVzZSBtZXNzYWdlCmZ1bmN0aW9uIHZhbGlkYXRlX3N0YXR1cygpIHsKICBpZiBbICQ/ICE9IDAgXTsgdGhlbgogICAgZWNob19zdGRlcnIgIkVycm9ycyBoYXBwZW4gZHVyaW5nOiAkMS4iICQyCiAgICBleGl0IDEKICBlbHNlCiAgICBlY2hvX3N0ZG91dCAiJDEiCiAgZmkKfQoKIyBWYWxpZGF0ZSBjb21wdXRlIHJlc291cmNlcwojIENoZWNrIHBvaW50czoKIyAgIC0gdGhlcmUgaXMgZW5vdWdoIHJlc291cmNlIGZvciBBS1MgY2x1c3RlcgojICAgLSB0aGVyZSBpcyBlbm91Z2ggcmVzb3VyY2UgZm9yIFZNIHRvIGJ1aWxkIHRoZSBpbWFnZQojIEV4YW1wbGUgdG8gbGlzdCB0aGUgdm0gdXNhZ2U6CiMgYXogdm0gbGlzdC11c2FnZSAtLWxvY2F0aW9uICJFYXN0IFVTIiAtbyB0YWJsZQojIE5hbWUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEN1cnJlbnRWYWx1ZSAgICBMaW1pdAojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gIC0tLS0tLS0tLS0tLS0tICAtLS0tLS0tCiMgQXZhaWxhYmlsaXR5IFNldHMgICAgICAgICAgICAgICAgICAgICAgICAgMCAgICAgICAgICAgICAgIDI1MDAKIyBUb3RhbCBSZWdpb25hbCB2Q1BVcyAgICAgICAgICAgICAgICAgICAgICAyICAgICAgICAgICAgICAgMjAwCiMgVmlydHVhbCBNYWNoaW5lcyAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICAgICAgICAgICAgIDI1MDAwCiMgVmlydHVhbCBNYWNoaW5lIFNjYWxlIFNldHMgICAgICAgICAgICAgICAgMCAgICAgICAgICAgICAgIDI1MDAKIyBEZWRpY2F0ZWQgdkNQVXMgICAgICAgICAgICAgICAgICAgICAgICAgICAwICAgICAgICAgICAgICAgMzAwMAojIENsb3VkIFNlcnZpY2VzICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgICAgICAgICAgICAgICAyNTAwCiMgVG90YWwgUmVnaW9uYWwgTG93LXByaW9yaXR5IHZDUFVzICAgICAgICAgMCAgICAgICAgICAgICAgIDEwMAojIFN0YW5kYXJkIERTdjIgRmFtaWx5IHZDUFVzICAgICAgICAgICAgICAgIDAgICAgICAgICAgICAgICAxMDAKIyBTdGFuZGFyZCBBdjIgRmFtaWx5IHZDUFVzICAgICAgICAgICAgICAgICAyICAgICAgICAgICAgICAgMTAwCiMgQmFzaWMgQSBGYW1pbHkgdkNQVXMgICAgICAgICAgICAgICAgICAgICAgMCAgICAgICAgICAgICAgIDEwMAojIFN0YW5kYXJkIEEwLUE3IEZhbWlseSB2Q1BVcyAgICAgICAgICAgICAgIDAgICAgICAgICAgICAgICAyMDAKIyBTdGFuZGFyZCBBOC1BMTEgRmFtaWx5IHZDUFVzICAgICAgICAgICAgICAwICAgICAgICAgICAgICAgMTAwCiMgU3RhbmRhcmQgRCBGYW1pbHkgdkNQVXMgICAgICAgICAgICAgICAgICAgMCAgICAgICAgICAgICAgIDEwMAojIFN0YW5kYXJkIER2MiBGYW1pbHkgdkNQVXMgICAgICAgICAgICAgICAgIDAgICAgICAgICAgICAgICAxMDAKIyBTdGFuZGFyZCBEUyBGYW1pbHkgdkNQVXMgICAgICAgICAgICAgICAgICAwICAgICAgICAgICAgICAgMTAwCiMgU3RhbmRhcmQgRyBGYW1pbHkgdkNQVXMgICAgICAgICAgICAgICAgICAgMCAgICAgICAgICAgICAgIDEwMAojIFN0YW5kYXJkIEdTIEZhbWlseSB2Q1BVcyAgICAgICAgICAgICAgICAgIDAgICAgICAgICAgICAgICAxMDAKIyBTdGFuZGFyZCBGIEZhbWlseSB2Q1BVcyAgICAgICAgICAgICAgICAgICAwICAgICAgICAgICAgICAgMTAwCiMgU3RhbmRhcmQgRlMgRmFtaWx5IHZDUFVzICAgICAgICAgICAgICAgICAgMCAgICAgICAgICAgICAgIDEwMAojIC4uLiAuLi4KZnVuY3Rpb24gdmFsaWRhdGVfY29tcHV0ZV9yZXNvdXJjZXMoKSB7CiAgIyBSZXNvdXJjZSBmb3IgdWJ1bnR1IG1hY2hpbmUKICAjIDIgU3RhbmRhcmQgQXYyIEZhbWlseSB2Q1BVcwoKICAjIHF1ZXJ5IHRvdGFsIGNvcmVzCiAgbG9jYWwgdm1Vc2FnZT0kKGF6IHZtIGxpc3QtdXNhZ2UgLWwgJHtsb2NhdGlvbn0gLW8ganNvbikKICBsb2NhbCB0b3RhbENQVXM9JChlY2hvICR7dm1Vc2FnZX0gfCBqcSAnLltdIHwgc2VsZWN0KC5uYW1lLnZhbHVlPT0iY29yZXMiKSB8IC5saW1pdCcgfCB0ciAtZCAiXCIiKQogIGxvY2FsIGN1cnJlbnRDUFVzPSQoZWNobyAke3ZtVXNhZ2V9IHwganEgJy5bXSB8IHNlbGVjdCgubmFtZS52YWx1ZT09ImNvcmVzIikgfCAuY3VycmVudFZhbHVlJyB8IHRyIC1kICJcIiIpCiAgbG9jYWwgYWtzQ1BVcz0wCgogICMgaWYgY3JlYXRpbmcgbmV3IEFLUyBjbHVzdGVyCiAgaWYgW1sgIiR7Y3JlYXRlQUtTQ2x1c3RlciwsfSIgPT0gInRydWUiIF1dOyB0aGVuCiAgICBsb2NhbCBha3NWTURldGFpbHM9JChheiB2bSBsaXN0LXNrdXMgLS1zaXplICR7YWtzQWdlbnRQb29sVk1TaXplfSAtbCAke2xvY2F0aW9ufSAtLXF1ZXJ5IFswXSkKICAgIGxvY2FsIHZtRmFtaWx5PSQoZWNobyAke2Frc1ZNRGV0YWlsc30gfCBqcSAnLmZhbWlseScgfCB0ciAtZCAiXCIiKQogICAgbG9jYWwgdm1DUFVzPSQoZWNobyAke2Frc1ZNRGV0YWlsc30gfCBqcSAnLmNhcGFiaWxpdGllc1tdIHwgc2VsZWN0KC5uYW1lPT0idkNQVXMiKSB8IC52YWx1ZScgfCB0ciAtZCAiXCIiKQogICAgYWtzQ1BVcz0kKCh2bUNQVXMgKiBha3NBZ2VudFBvb2xOb2RlQ291bnQpKQoKICAgICMgcXVlcnkgQ1BVIHVzYWdlIG9mIHRoZSB2bSBmYW1pbHkKICAgIGxvY2FsIGZhbWlseUxpbWl0PSQoZWNobyAke3ZtVXNhZ2V9IHwganEgJy5bXSB8IHNlbGVjdCgubmFtZS52YWx1ZT09Iicke3ZtRmFtaWx5fSciKSB8IC5saW1pdCcgfCB0ciAtZCAiXCIiKQogICAgbG9jYWwgZmFtaWx5VXNhZ2U9JChlY2hvICR7dm1Vc2FnZX0gfCBqcSAnLltdIHwgc2VsZWN0KC5uYW1lLnZhbHVlPT0iJyR7dm1GYW1pbHl9JyIpIHwgLmN1cnJlbnRWYWx1ZScgfCB0ciAtZCAiXCIiKQogICAgbG9jYWwgcmVxdWlyZWRGYW1pbHlDUFVzPSQoKGFrc0NQVXMgKyBmYW1pbHlVc2FnZSkpCiAgICAjIG1ha2Ugc3VyZSB0aGVycyBpcyBlbm91Z2ggdkNQVXMgb2YgdGhlIGZhbWlseSBmb3IgQUtTCiAgICBpZiBbICR7cmVxdWlyZWRGYW1pbHlDUFVzfSAtZ3QgJHtmYW1pbHlMaW1pdH0gXTsgdGhlbgogICAgICBlY2hvX3N0ZGVyciAiSXQgcmVxdWlyZXMgJHtha3NDUFVzfSAke3ZtRmFtaWx5fSB2Q1BVcyB0byBjcmVhdGUgdGhlIEFLUyBjbHVzdGVyLCAke3ZtRmFtaWx5fSB2Q1BVcyBxdW90YSBpcyBsaW1pdGVkIHRvICR7ZmFtaWx5TGltaXR9LCBjdXJyZW50IHVzYWdlIGlzICR7ZmFtaWx5VXNhZ2V9LiIKICAgICAgZXhpdCAxCiAgICBmaQogIGZpCgogIGxvY2FsIHZtRmFtaWx5T2ZVYnVudHU9InN0YW5kYXJkQXYyRmFtaWx5IgogIGxvY2FsIGZhbWlseUxpbWl0PSQoZWNobyAke3ZtVXNhZ2V9IHwganEgJy5bXSB8IHNlbGVjdCgubmFtZS52YWx1ZT09Iicke3ZtRmFtaWx5T2ZVYnVudHV9JyIpIHwgLmxpbWl0JyB8IHRyIC1kICJcIiIpCiAgbG9jYWwgZmFtaWx5VXNhZ2U9JChlY2hvICR7dm1Vc2FnZX0gfCBqcSAnLltdIHwgc2VsZWN0KC5uYW1lLnZhbHVlPT0iJyR7dm1GYW1pbHlPZlVidW50dX0nIikgfCAuY3VycmVudFZhbHVlJyB8IHRyIC1kICJcIiIpCiAgbG9jYWwgcmVxdWlyZWRGYW1pbHlDUFVzPSQoKDIgKyBmYW1pbHlVc2FnZSkpCiAgIyBtYWtlIHN1cmUgdGhlcnMgaXMgZW5vdWdoIHZDUFVzIG9mIHRoZSBmYW1pbHkgZm9yIHVidW50dSBtYWNoaW5lCiAgaWYgWyAke3JlcXVpcmVkRmFtaWx5Q1BVc30gLWd0ICR7ZmFtaWx5TGltaXR9IF07IHRoZW4KICAgICAgZWNob19zdGRlcnIgIkl0IHJlcXVpcmVzIDIgJHt2bUZhbWlseU9mVWJ1bnR1fSB2Q1BVcyB0byBjcmVhdGUgYW4gdWJ1bnR1IG1hY2hpbmUgZm9yIGRvY2tlciBpbWFnZSwgJHt2bUZhbWlseU9mVWJ1bnR1fSB2Q1BVcyBxdW90YSBpcyBsaW1pdGVkIHRvICR7ZmFtaWx5TGltaXR9LCBjdXJyZW50IHVzYWdlIGlzICR7ZmFtaWx5VXNhZ2V9LiIKICAgICAgZXhpdCAxCiAgZmkKCiAgbG9jYWwgcmVxdWlyZWRDUFU9JCgoYWtzQ1BVcyArIDIgKyBjdXJyZW50Q1BVcykpCiAgaWYgWyAke3JlcXVpcmVkQ1BVfSAtZ3QgJHt0b3RhbENQVXN9IF07IHRoZW4KICAgICAgZWNob19zdGRlcnIgIkl0IHJlcXVpcmVzICR7cmVxdWlyZWRDUFV9IHZDUFVzIHRvIHJ1biBXTFMgb24gQUtTLCB2Q1BVcyBxdW90YSBpcyBsaW1pdGVkIHRvICR7dG90YWxDUFVzfSwgY3VycmVudCB1c2FnZSBpcyAke2N1cnJlbnRDUFVzfS4iCiAgICAgIGV4aXQgMQogIGZpCgogIGVjaG9fc3Rkb3V0ICJDaGVjayBjb21wdXRlIHJlc291cmNlczogcGFzc2VkISIKfQoKZnVuY3Rpb24gdmFsaWRhdGVfb2NyX2FjY291bnQoKSB7CiAgIyBpbnN0YWxsIGRvY2tlciBjbGkKICBpbnN0YWxsX2RvY2tlcgoKICAjIE9SQUNMRV9BQ0NPVU5UX05BTUUKICAjIE9SQUNMRV9BQ0NPVU5UX1BBU1NXT1JECiAgZG9ja2VyIGxvZ291dAogIGVjaG8gIiR7T1JBQ0xFX0FDQ09VTlRfUEFTU1dPUkR9IiB8IGRvY2tlciBsb2dpbiAke29jckxvZ2luU2VydmVyfSAtdSAke09SQUNMRV9BQ0NPVU5UX05BTUV9IC0tcGFzc3dvcmQtc3RkaW4KICB2YWxpZGF0ZV9zdGF0dXMgImxvZ2luIE9DUiB3aXRoIHVzZXIgJHtPUkFDTEVfQUNDT1VOVF9OQU1FfSIKCiAgZWNob19zdGRvdXQgIkNoZWNrIE9DUiBhY2NvdW50OiBwYXNzZWQhIgp9CgpmdW5jdGlvbiBjaGVja19hY3IoKSB7CiAgbG9jYWwgcmVhZHk9ZmFsc2UKICBsb2NhbCBhdHRlbXB0PTAKICB3aGlsZSBbWyAiJHtyZWFkeX0iID09ICJmYWxzZSIgJiYgJGF0dGVtcHQgLWxlICR7Y2hlY2tBY3JNYXhBdHRlbXB0fSBdXTsgZG8KICAgICAgZWNob19zdGRvdXQgIkNoZWNrIGlmIEFDUiAke0FDUl9OQU1FfSBpcyByZWFkeSwgYXR0ZW1wdDogJHthdHRlbXB0fS4iCiAgICAgIHJlYWR5PXRydWUKCiAgICAgIGxvY2FsIHJldD0kKGF6IGFjciBzaG93IC0tbmFtZSAke0FDUl9OQU1FfSAtLXJlc291cmNlLWdyb3VwICR7QUNSX1JFU09VUkNFX0dST1VQfSkKICAgICAgaWYgWyAteiAiJHtyZXR9IiBdOyB0aGVuCiAgICAgICAgICByZWFkeT1mYWxzZQogICAgICBmaQoKICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgIHNsZWVwICR7Y2hlY2tBY3JJbnRlcnZhbH0KICBkb25lCgogIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja0Fjck1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgZWNob19zdGRlcnIgIkFDUiAke0FDUl9OQU1FfSBpcyBub3QgcmVhZHkuIgogICAgICBleGl0IDEKICBmaQoKICBlY2hvX3N0ZG91dCAiQ2hlY2sgaWYgQUNSICR7QUNSX05BTUV9IGlzIHJlYWR5IHRvIGltcG9ydCBpbWFnZS4iCn0KCmZ1bmN0aW9uIHZhbGlkYXRlX29jcl9pbWFnZSgpIHsKICBsb2NhbCBvY3JJbWFnZUZ1bGxQYXRoPSIke29jckxvZ2luU2VydmVyfS8ke29jckdhSW1hZ2VQYXRofToke3dsc0ltYWdlVGFnfSIKCiAgaWYgW1sgIiR7T1JBQ0xFX0FDQ09VTlRfRU5USVRMRUQsLH0iID09ICJ0cnVlIiBdXTsgdGhlbgoKICAgICMgZG93bmxvYWQgdGhlIGdhIGNwdSBpbWFnZSBtYXBwaW5nIGZpbGUuCiAgICBsb2NhbCBjcHVJbWFnZXNMaXN0RmlsZT13ZWJsb2dpY19jcHVfaW1hZ2VzLmpzb24KICAgIGN1cmwgLUwgIiR7Z2l0VXJsNENwdUltYWdlc30iIC0tcmV0cnkgJHtyZXRyeU1heEF0dGVtcHR9IC1vICR7Y3B1SW1hZ2VzTGlzdEZpbGV9CiAgICBsb2NhbCBjcHVUYWc9JChjYXQgJHtjcHVJbWFnZXNMaXN0RmlsZX0gfCBqcSAiLml0ZW1zW10gfCBzZWxlY3QoLmdhVGFnID09IFwiJHt3bHNJbWFnZVRhZ31cIikgfCAuY3B1VGFnIiB8IHRyIC1kICJcIiIpCiAgICBlY2hvX3N0ZG91dCAiY3B1IHRhZzogJHtjcHVUYWd9IgogICAgIyBpZiB3ZSBjYW4gbm90IGZpbmQgYSBtYXRjaGVkIGltYWdlLCBrZWVwIHRoZSBpbnB1dCB0YWcuCiAgICBpZiBbWyAiJHtjcHVUYWd9IiA9PSAiIiB8fCAgIiR7Y3B1VGFnLCx9IiA9PSAibnVsbCIgXV07IHRoZW4KICAgICAgY3B1VGFnPSR7d2xzSW1hZ2VUYWd9CiAgICBmaQoKICAgIG9jckltYWdlRnVsbFBhdGg9IiR7b2NyTG9naW5TZXJ2ZXJ9LyR7b2NyQ3B1SW1hZ2VQYXRofToke2NwdVRhZ30iCiAgZmkKCiAgZWNob19zdGRvdXQgImltYWdlIHBhdGg6ICR7b2NySW1hZ2VGdWxsUGF0aH0iICAKCiAgIyB0byBtaXRpZ2F0ZSBlcnJvciBpbiBodHRwczovL2xlYXJuLm1pY3Jvc29mdC5jb20vZW4tdXMvYW5zd2Vycy9xdWVzdGlvbnMvMTE4ODQxMy90aGUtcmVzb3VyY2Utd2l0aC1uYW1lLW5hbWUtYW5kLXR5cGUtbWljcm9zb2Z0LWNvbgogIGF6IHByb3ZpZGVyIHJlZ2lzdGVyIC1uIE1pY3Jvc29mdC5Db250YWluZXJSZWdpc3RyeQoKICBjaGVja19hY3IKCiAgIyB2YWxpZGF0ZSB0aGUgaW1hZ2UgYnkgaW1wb3J0aW5nIGl0IHRvIEFDUi4KICAjIGlmIGZhaWx1cmUgaGFwcGVucywgdGhlIGltYWdlIHNob3VsZCBiZSB1bmF2YWlsYWJsZQogIGxvY2FsIHRtcEltYWdlUGF0aD0idG1wJChkYXRlICslcyk6JHt3bHNJbWFnZVRhZ30iCiAgYXogYWNyIGltcG9ydCAtLW5hbWUgJHtBQ1JfTkFNRX0gXAogICAgLS1yZXNvdXJjZS1ncm91cCAke0FDUl9SRVNPVVJDRV9HUk9VUH0gXAogICAgLS1zb3VyY2UgJHtvY3JJbWFnZUZ1bGxQYXRofSBcCiAgICAtdSAke09SQUNMRV9BQ0NPVU5UX05BTUV9IFwKICAgIC1wICR7T1JBQ0xFX0FDQ09VTlRfUEFTU1dPUkR9IFwKICAgIC0taW1hZ2UgJHt0bXBJbWFnZVBhdGh9IFwKICAgIC0tb25seS1zaG93LWVycm9ycwoKICAjICQ/IGVxdWFscyAwIGV2ZW4gdGhvdWdoIGZhaWx1cmUgaGFwcGVucy4KICAjIGNoZWNrIGlmIHRoZSBpbWFnZSBpcyBpbXBvcnRlZCBzdWNjZXNzZnVsbHkuCiAgbG9jYWwgcmV0PSQoYXogYWNyIHJlcG9zaXRvcnkgc2hvdyAtLW5hbWUgJEFDUl9OQU1FIC0taW1hZ2UgJHt0bXBJbWFnZVBhdGh9KQogIGlmIFsgLW4gIiR7cmV0fSIgXTsgdGhlbgogICAgIyBkZWxldGUgdGhlIGltYWdlIGZyb20gQUNSLgogICAgYXogYWNyIHJlcG9zaXRvcnkgZGVsZXRlIC0tbmFtZSAke0FDUl9OQU1FfSAtLWltYWdlICR7dG1wSW1hZ2VQYXRofSAtLXllcwogIGVsc2UKICAgIGVjaG9fc3RkZXJyICRyZXQKICAgIGVjaG9fc3RkZXJyICIiCiAgICBlY2hvX3N0ZGVyciAiSW1hZ2UgJHtvY3JJbWFnZUZ1bGxQYXRofSBpcyBub3QgYXZhaWxhYmxlISBQbGVhc2UgbWFrZSBzdXJlIHlvdSBoYXZlIGFjY2VwdGVkIHRoZSBPcmFjbGUgU3RhbmRhcmQgVGVybXMgYW5kIFJlc3RyaWN0aW9ucyBhbmQgdGhlIGltYWdlIGV4aXN0cyBpbiBodHRwczovL2NvbnRhaW5lci1yZWdpc3RyeS5vcmFjbGUuY29tLyAiCiAgICBpZiBbWyAiJHtPUkFDTEVfQUNDT1VOVF9FTlRJVExFRCwsfSIgPT0gInRydWUiIF1dOyB0aGVuCiAgICAgIGVjaG9fc3RkZXJyICJNYWtlIHN1cmUgeW91IGFyZSBlbnRpdGxlZCB0byBhY2Nlc3MgbWlkZGxld2FyZS93ZWJsb2dpY19jcHUgcmVwb3NpdG9yeS4iCiAgICBmaQoKICAgIGV4aXQgMQogIGZpCgogIGVjaG9fc3Rkb3V0ICJDaGVjayBPQ1IgaW1hZ2UgJHtvY3JJbWFnZUZ1bGxQYXRofTogcGFzc2VkISIKfQoKZnVuY3Rpb24gY2hlY2tfYWNyX2FkbWluX2VuYWJsZWQoKSB7CiAgbG9jYWwgYWNyTmFtZT0kMQogIGxvY2FsIGFjclJnTmFtZT0kMgogIGVjaG9fc3Rkb3V0ICJjaGVjayBpZiBhZG1pbiB1c2VyIGVuYWJsZWQgaW4gQUNSICRhY3JOYW1lICIKICBsb2NhbCBhZG1pblVzZXJFbmFibGVkPSQoYXogYWNyIHNob3cgLS1uYW1lICRhY3JOYW1lIC0tcmVzb3VyY2UtZ3JvdXAgJHthY3JSZ05hbWV9IC0tcXVlcnkgImFkbWluVXNlckVuYWJsZWQiKQogIHZhbGlkYXRlX3N0YXR1cyAicXVlcnkgJ2FkbWluVXNlckVuYWJsZWQnIHByb3BlcnR5IG9mIEFDUiAke2Fjck5hbWV9IiAiSW52YWxpZCBBQ1I6ICR7YWNyTmFtZX0iCgogIGlmIFtbICIke2FkbWluVXNlckVuYWJsZWR9IiA9PSAiZmFsc2UiIF1dOyB0aGVuCiAgICBlY2hvX3N0ZGVyciAiTWFrZSBzdXJlIGFkbWluIHVzZXIgaXMgZW5hYmxlZCBpbiBBQ1IgJGFjck5hbWUuIFBsZWFzZSBmaW5kIHN0ZXBzIGluIGh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL2F6dXJlL2NvbnRhaW5lci1yZWdpc3RyeS9jb250YWluZXItcmVnaXN0cnktYXV0aGVudGljYXRpb24/V1QubWNfaWQ9UG9ydGFsLU1pY3Jvc29mdF9BenVyZV9DcmVhdGVVSURlZiZ0YWJzPWF6dXJlLWNsaSNhZG1pbi1hY2NvdW50IgogICAgZXhpdCAxCiAgZmkKfQoKZnVuY3Rpb24gdmFsaWRhdGVfYWNyX2ltYWdlKCkgewogIGVjaG9fc3Rkb3V0ICJ1c2VyIHByb3ZpZGVkIEFDUjogJEFDUl9OQU1FX0ZPUl9VU0VSX1BST1ZJREVEX0lNQUdFIgoKICBsb2NhbCBwYXRoV2l0aG91dFRhZz0ke3VzZXJQcm92aWRlZEltYWdlUGF0aCVcOip9CiAgbG9jYWwgcmVwb3NpdG9yeT0ke3BhdGhXaXRob3V0VGFnIypcL30KICBsb2NhbCB0YWc9IiR7dXNlclByb3ZpZGVkSW1hZ2VQYXRoIyMqOn0iCgogIGxvY2FsIHRhZ0luZGV4PSQoYXogYWNyIHJlcG9zaXRvcnkgc2hvdy10YWdzIC0tbmFtZSAkQUNSX05BTUVfRk9SX1VTRVJfUFJPVklERURfSU1BR0UgLS1yZXBvc2l0b3J5ICR7cmVwb3NpdG9yeX0gfCBqcSAnaW5kZXgoIicke3RhZ30nIiknKQogIHZhbGlkYXRlX3N0YXR1cyAiY2hlY2sgaWYgdGFnICR7dGFnfSBleGlzdHMuIiAiSW52YWxpZCBpbWFnZSBwYXRoICR7dXNlclByb3ZpZGVkSW1hZ2VQYXRofSIKICBpZiBbWyAiJHt0YWdJbmRleH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgZWNob19zdGRlcnIgIkltYWdlICR7dGFnfSBkb2VzIG5vdCBleGlzdCBpbiAke3JlcG9zaXRvcnl9LiIKICAgIGV4aXQgMQogIGZpCgogIGVjaG9fc3Rkb3V0ICJDaGVjayBBQ1IgaW1hZ2U6IHBhc3NlZCEiCn0KCmZ1bmN0aW9uIHZhbGlkYXRlX2Jhc2VfaW1hZ2VfcGF0aCgpIHsKICBpZiBbWyAiJHt1c2VPcmFjbGVJbWFnZSwsfSIgPT0gInRydWUiIF1dOyB0aGVuCiAgICB2YWxpZGF0ZV9vY3JfYWNjb3VudAogICAgdmFsaWRhdGVfb2NyX2ltYWdlCiAgZWxzZQogICAgdmFsaWRhdGVfYWNyX2ltYWdlCiAgZmkKfQoKZnVuY3Rpb24gdmFsaWRhdGVfYWNyX2FkbWluX2VuYWJsZWQoKQp7CiAgaWYgW1sgIiR7dXNlT3JhY2xlSW1hZ2UsLH0iID09ICJ0cnVlIiBdXTsgdGhlbgogICAgY2hlY2tfYWNyX2FkbWluX2VuYWJsZWQgIiR7QUNSX05BTUV9IiAiJHtBQ1JfUkVTT1VSQ0VfR1JPVVB9IgogIGVsc2UKICAgIGNoZWNrX2Fjcl9hZG1pbl9lbmFibGVkICIke0FDUl9OQU1FX0ZPUl9VU0VSX1BST1ZJREVEX0lNQUdFfSIgIiR7QUNSX1JHX05BTUVfRk9SX1VTRVJfUFJPVklERURfSU1BR0V9IgogIGZpCn0KCmZ1bmN0aW9uIGRvd25sb2FkX3dsc19zc2xfY2VydGlmaWNhdGVzX2Zyb21fa2V5dmF1bHQoKSB7CiAgIyBjaGVjayBrZXkgdmF1bHQgYWNjZXNzaWJpbGl0eSBmb3IgdGVtcGxhdGUgZGVwbG95bWVudAogIGxvY2FsIGVuYWJsZWRGb3JUZW1wbGF0ZURlcGxveW1lbnQ9JChheiBrZXl2YXVsdCBzaG93IC0tbmFtZSAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0gLS1xdWVyeSAicHJvcGVydGllcy5lbmFibGVkRm9yVGVtcGxhdGVEZXBsb3ltZW50IikKICBpZiBbWyAiJHtlbmFibGVkRm9yVGVtcGxhdGVEZXBsb3ltZW50LCx9IiAhPSAidHJ1ZSIgXV07IHRoZW4KICAgIGVjaG9fc3RkZXJyICJNYWtlIHN1cmUgS2V5IFZhdWx0ICR7V0xTX1NTTF9LRVlWQVVMVF9OQU1FfSBpcyBlbmFibGVkIGZvciB0ZW1wbGF0ZSBkZXBsb3ltZW50LiAiCiAgICBleGl0IDEKICBmaQoKICAjIGFsbG93IHRoZSBpZGVudGl0eSB0byBhY2Nlc3MgdGhlIGtleXZhdWx0CiAgbG9jYWwgcHJpbmNpcGFsSWQ9JChheiBpZGVudGl0eSBzaG93IC0taWRzICR7QVpfU0NSSVBUU19VU0VSX0FTU0lHTkVEX0lERU5USVRZfSAtLXF1ZXJ5ICJwcmluY2lwYWxJZCIgLW8gdHN2KQogIGF6IGtleXZhdWx0IHNldC1wb2xpY3kgLS1uYW1lICR7V0xTX1NTTF9LRVlWQVVMVF9OQU1FfSAgLS1vYmplY3QtaWQgJHtwcmluY2lwYWxJZH0gLS1zZWNyZXQtcGVybWlzc2lvbnMgZ2V0IGxpc3QKICB2YWxpZGF0ZV9zdGF0dXMgImdyYW50IGlkZW50aXR5IHBlcm1pc3Npb24gdG8gZ2V0L2xpc3Qgc2VjcmV0cyBpbiBrZXkgdmF1bHQgJHtXTFNfU1NMX0tFWVZBVUxUX05BTUV9IgoKICBsb2NhbCBpZGVudGl0eURhdGFGaWxlTmFtZT0ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9pZGVudGl0eURhdGEudHh0CiAgbG9jYWwgaWRlbnRpdHlQc3dGaWxlTmFtZT0ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9pZGVudGl0eVBzdy50eHQKICBsb2NhbCB0cnVzdERhdGFGaWxlTmFtZT0ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS90cnVzdERhdGEudHh0CiAgbG9jYWwgdHJ1c3RQc3dGaWxlTmFtZT0ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS90cnVzdFBzdy50eHQKICBsb2NhbCBwcml2YXRlS2V5QWxpYXNGaWxlTmFtZT0ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9wcml2YXRlS2V5RGF0YS50eHQKICBsb2NhbCBwcml2YXRlS2V5UHN3RmlsZU5hbWU9JHtBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWX0vcHJpdmF0ZUtleVBzdy50eHQKCiAgcm0gLWYgJHtpZGVudGl0eURhdGFGaWxlTmFtZX0KICBybSAtZiAke2lkZW50aXR5UHN3RmlsZU5hbWV9CiAgcm0gLWYgJHt0cnVzdERhdGFGaWxlTmFtZX0KICBybSAtZiAke3RydXN0UHN3RmlsZU5hbWV9CiAgcm0gLWYgJHtwcml2YXRlS2V5QWxpYXNGaWxlTmFtZX0KICBybSAtZiAke3ByaXZhdGVLZXlQc3dGaWxlTmFtZX0KCiAgIyBkb3dubG9hZCBpZGVudGl0eSBkYXRhCiAgYXoga2V5dmF1bHQgc2VjcmV0IGRvd25sb2FkIC0tZmlsZSAke2lkZW50aXR5RGF0YUZpbGVOYW1lfSBcCiAgICAtLW5hbWUgJHtXTFNfU1NMX0tFWVZBVUxUX0lERU5USVRZX0RBVEFfU0VDUkVUX05BTUV9IFwKICAgIC0tdmF1bHQtbmFtZSAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0gCiAgdmFsaWRhdGVfc3RhdHVzICJkb3dubG9hZCBzZWNyZXQgJHtXTFNfU1NMX0tFWVZBVUxUX0lERU5USVRZX0RBVEFfU0VDUkVUX05BTUV9IGZyb20ga2V5IHZhdWx0ICR7V0xTX1NTTF9LRVlWQVVMVF9OQU1FfSIKICAjIHNldCBpZGVudGl0eSBkYXRhIHdpdGggdmFsdWVzIGluIGRvd25sb2FkIGZpbGUKICBXTFNfU1NMX0lERU5USVRZX0RBVEE9IiQoY2F0ICR7aWRlbnRpdHlEYXRhRmlsZU5hbWV9IHwgYmFzZTY0KSIKICAjIHJlbW92ZSB0aGUgZGF0YSBmaWxlCiAgcm0gLWYgJHtpZGVudGl0eURhdGFGaWxlTmFtZX0KCiAgIyBkb3dubG9hZCBpZGVudGl0eSBwYXNzd29yZAogIGF6IGtleXZhdWx0IHNlY3JldCBkb3dubG9hZCAtLWZpbGUgJHtpZGVudGl0eVBzd0ZpbGVOYW1lfSBcCiAgICAtLW5hbWUgJHtXTFNfU1NMX0tFWVZBVUxUX0lERU5USVRZX1BBU1NXT1JEX1NFQ1JFVF9OQU1FfSBcCiAgICAtLXZhdWx0LW5hbWUgJHtXTFNfU1NMX0tFWVZBVUxUX05BTUV9IAogIHZhbGlkYXRlX3N0YXR1cyAiZG93bmxvYWQgc2VjcmV0ICR7V0xTX1NTTF9LRVlWQVVMVF9JREVOVElUWV9QQVNTV09SRF9TRUNSRVRfTkFNRX0gZnJvbSBrZXkgdmF1bHQgJHtXTFNfU1NMX0tFWVZBVUxUX05BTUV9IgogICMgc2V0IGlkZW50aXR5IHBzdyB3aXRoIHZhbHVlcyBpbiBkb3dubG9hZCBmaWxlCiAgV0xTX1NTTF9JREVOVElUWV9QQVNTV09SRD0iJChjYXQgJHtpZGVudGl0eVBzd0ZpbGVOYW1lfSkiCiAgIyByZW1vdmUgdGhlIGRhdGEgZmlsZQogIHJtIC1mICR7aWRlbnRpdHlQc3dGaWxlTmFtZX0KCiAgIyBkb3dubG9hZCB0cnVzdCBkYXRhCiAgYXoga2V5dmF1bHQgc2VjcmV0IGRvd25sb2FkIC0tZmlsZSAke3RydXN0RGF0YUZpbGVOYW1lfSBcCiAgICAtLW5hbWUgJHtXTFNfU1NMX0tFWVZBVUxUX1RSVVNUX0RBVEFfU0VDUkVUX05BTUV9IFwKICAgIC0tdmF1bHQtbmFtZSAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0gCiAgdmFsaWRhdGVfc3RhdHVzICJkb3dubG9hZCBzZWNyZXQgJHtXTFNfU1NMX0tFWVZBVUxUX1RSVVNUX0RBVEFfU0VDUkVUX05BTUV9IGZyb20ga2V5IHZhdWx0ICR7V0xTX1NTTF9LRVlWQVVMVF9OQU1FfSIKICAjIHNldCB0cnVzdCBkYXRhIHdpdGggdmFsdWVzIGluIGRvd25sb2FkIGZpbGUKICBXTFNfU1NMX1RSVVNUX0RBVEE9IiQoY2F0ICR7dHJ1c3REYXRhRmlsZU5hbWV9IHwgYmFzZTY0KSIKICAjIHJlbW92ZSB0aGUgZGF0YSBmaWxlCiAgcm0gLWYgJHt0cnVzdERhdGFGaWxlTmFtZX0KCiAgIyBkb3dubG9hZCB0cnVzdCBwc3cKICBheiBrZXl2YXVsdCBzZWNyZXQgZG93bmxvYWQgLS1maWxlICR7dHJ1c3RQc3dGaWxlTmFtZX0gXAogICAgLS1uYW1lICR7V0xTX1NTTF9LRVlWQVVMVF9UUlVTVF9QQVNTV09SRF9TRUNSRVRfTkFNRX0gXAogICAgLS12YXVsdC1uYW1lICR7V0xTX1NTTF9LRVlWQVVMVF9OQU1FfSAKICB2YWxpZGF0ZV9zdGF0dXMgImRvd25sb2FkIHNlY3JldCAke1dMU19TU0xfS0VZVkFVTFRfVFJVU1RfUEFTU1dPUkRfU0VDUkVUX05BTUV9IGZyb20ga2V5IHZhdWx0ICR7V0xTX1NTTF9LRVlWQVVMVF9OQU1FfSIKICAjIHNldCB0cnVzdCBwc3cgd2l0aCB2YWx1ZXMgaW4gZG93bmxvYWQgZmlsZQogIFdMU19TU0xfVFJVU1RfUEFTU1dPUkQ9IiQoY2F0ICR7dHJ1c3RQc3dGaWxlTmFtZX0pIgogICMgcmVtb3ZlIHRoZSBkYXRhIGZpbGUKICBybSAtZiAke3RydXN0UHN3RmlsZU5hbWV9CgogICMgZG93bmxvYWQgYWxpYXMKICBheiBrZXl2YXVsdCBzZWNyZXQgZG93bmxvYWQgLS1maWxlICR7cHJpdmF0ZUtleUFsaWFzRmlsZU5hbWV9IFwKICAgIC0tbmFtZSAke1dMU19TU0xfS0VZVkFVTFRfUFJJVkFURV9LRVlfQUxJQVN9IFwKICAgIC0tdmF1bHQtbmFtZSAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0gCiAgdmFsaWRhdGVfc3RhdHVzICJkb3dubG9hZCBzZWNyZXQgJHtXTFNfU1NMX0tFWVZBVUxUX1BSSVZBVEVfS0VZX0FMSUFTfSBmcm9tIGtleSB2YXVsdCAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0iCiAgIyBzZXQgYWxpYXMgd2l0aCB2YWx1ZXMgaW4gZG93bmxvYWQgZmlsZQogIFdMU19TU0xfUFJJVkFURV9LRVlfQUxJQVM9IiQoY2F0ICR7cHJpdmF0ZUtleUFsaWFzRmlsZU5hbWV9KSIKICAjIHJlbW92ZSB0aGUgZGF0YSBmaWxlCiAgcm0gLWYgJHtwcml2YXRlS2V5QWxpYXNGaWxlTmFtZX0KCiAgIyBkb3dubG9hZCBwcml2YXRlIGtleSBwc3cKICBheiBrZXl2YXVsdCBzZWNyZXQgZG93bmxvYWQgLS1maWxlICR7cHJpdmF0ZUtleVBzd0ZpbGVOYW1lfSBcCiAgICAtLW5hbWUgJHtXTFNfU1NMX0tFWVZBVUxUX1BSSVZBVEVfS0VZX1BBU1NXT1JEfSBcCiAgICAtLXZhdWx0LW5hbWUgJHtXTFNfU1NMX0tFWVZBVUxUX05BTUV9IAogIHZhbGlkYXRlX3N0YXR1cyAiZG93bmxvYWQgc2VjcmV0ICR7V0xTX1NTTF9LRVlWQVVMVF9QUklWQVRFX0tFWV9QQVNTV09SRH0gZnJvbSBrZXkgdmF1bHQgJHtXTFNfU1NMX0tFWVZBVUxUX05BTUV9IgogICMgc2V0IHByaXZhdGUga2V5IHBzdyB3aXRoIHZhbHVlcyBpbiBkb3dubG9hZCBmaWxlCiAgV0xTX1NTTF9QUklWQVRFX0tFWV9QQVNTV09SRD0iJChjYXQgJHtwcml2YXRlS2V5UHN3RmlsZU5hbWV9KSIKICAjIHJlbW92ZSB0aGUgZGF0YSBmaWxlCiAgcm0gLWYgJHtwcml2YXRlS2V5UHN3RmlsZU5hbWV9CgogIFdMU19TU0xfSURFTlRJVFlfVFlQRT0iJHtXTFNfU1NMX0tFWVZBVUxUX0lERU5USVRZX1RZUEV9IgogIFdMU19TU0xfVFJVU1RfVFlQRT0iJHtXTFNfU1NMX0tFWVZBVUxUX1RSVVNUX1RZUEV9IgoKICAjIHJlc2V0IGtleSB2YXVsdCBwb2xpY3kKICBheiBrZXl2YXVsdCBkZWxldGUtcG9saWN5IC0tbmFtZSAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0gIC0tb2JqZWN0LWlkICR7cHJpbmNpcGFsSWR9CiAgdmFsaWRhdGVfc3RhdHVzICJkZWxldGUgaWRlbnRpdHkgcGVybWlzc2lvbiB0byBnZXQvbGlzdCBzZWNyZXRzIGluIGtleSB2YXVsdCAke1dMU19TU0xfS0VZVkFVTFRfTkFNRX0iCn0KCmZ1bmN0aW9uIHZhbGlkYXRlX3dsc19zc2xfY2VydGlmaWNhdGVzKCkgewogIGlmIFtbICIke3NzbENvbmZpZ3VyYXRpb25BY2Nlc3NPcHRpb259IiA9PSAiJHtzc2xDZXJ0aWZpY2F0ZUtleVZhdWx0T3B0aW9ufSIgXV07IHRoZW4KICAgIGRvd25sb2FkX3dsc19zc2xfY2VydGlmaWNhdGVzX2Zyb21fa2V5dmF1bHQKICBmaQoKICBsb2NhbCB3bHNJZGVudGl0eUtleVN0b3JlRmlsZU5hbWU9JHtBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWX0vaWRlbnRpdHkua2V5c3RvcmUKICBsb2NhbCB3bHNUcnVzdEtleVN0b3JlRmlsZU5hbWU9JHtBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWX0vdHJ1c3Qua2V5c3RvcmUKICBlY2hvICIkV0xTX1NTTF9JREVOVElUWV9EQVRBIiB8IGJhc2U2NCAtZCA+JHdsc0lkZW50aXR5S2V5U3RvcmVGaWxlTmFtZQogIGVjaG8gIiRXTFNfU1NMX1RSVVNUX0RBVEEiIHwgYmFzZTY0IC1kID4kd2xzVHJ1c3RLZXlTdG9yZUZpbGVOYW1lCgogICMgdXNlIGRlZmF1bHQgSmF2YSwgaWYgbm8sIGluc3RhbGwgb3BlbiBqZGsgMTEuCiAgIyB3aHkgbm90IHVzaW5nIE1pY3Jvc29mdCBvcGVuIGpkaz8gCiAgIyBObyBhcGsgaW5zdGFsbGF0aW9uIHBhY2thZ2UhCiAgZXhwb3J0IEpBVkFfSE9NRT0vdXNyL2xpYi9qdm0vZGVmYXVsdC1qdm0vCiAgaWYgWyAhIC1kICIke0pBVkFfSE9NRX0iIF07IHRoZW4KICAgICAgaW5zdGFsbF9qZGsKICAgICAgSkFWQV9IT01FPS91c3IvbGliL2p2bS9qYXZhLTExLW9wZW5qZGsKICBmaQogICN2YWxpZGF0ZSBpZiBpZGVudGl0eSBrZXlzdG9yZSBoYXMgZW50cnkKICAke0pBVkFfSE9NRX0vYmluL2tleXRvb2wgLWxpc3QgLXYgXAogICAgICAta2V5c3RvcmUgJHdsc0lkZW50aXR5S2V5U3RvcmVGaWxlTmFtZSBcCiAgICAgIC1zdG9yZXBhc3MgJFdMU19TU0xfSURFTlRJVFlfUEFTU1dPUkQgXAogICAgICAtc3RvcmV0eXBlICRXTFNfU1NMX0lERU5USVRZX1RZUEUgfAogICAgICBncmVwICdFbnRyeSB0eXBlOicgfAogICAgICBncmVwICdQcml2YXRlS2V5RW50cnknCgogIHZhbGlkYXRlX3N0YXR1cyAidmFsaWRhdGUgSWRlbnRpdHkgS2V5c3RvcmUuIgoKICAjdmFsaWRhdGUgaWYgdHJ1c3Qga2V5c3RvcmUgaGFzIGVudHJ5CiAgJHtKQVZBX0hPTUV9L2Jpbi9rZXl0b29sIC1saXN0IC12IFwKICAgICAgLWtleXN0b3JlICR7d2xzVHJ1c3RLZXlTdG9yZUZpbGVOYW1lfSBcCiAgICAgIC1zdG9yZXBhc3MgJFdMU19TU0xfVFJVU1RfUEFTU1dPUkQgXAogICAgICAtc3RvcmV0eXBlICRXTFNfU1NMX1RSVVNUX1RZUEUgfAogICAgICBncmVwICdFbnRyeSB0eXBlOicgfAogICAgICBncmVwICd0cnVzdGVkQ2VydEVudHJ5JwoKICB2YWxpZGF0ZV9zdGF0dXMgInZhbGlkYXRlIFRydXN0IEtleXN0b3JlLiIKCiAgZWNob19zdGRvdXQgInZhbGlkYXRlIFNTTCBrZXkgc3RvcmVzOiBwYXNzZWQhIgp9CgpmdW5jdGlvbiBkb3dubG9hZF9hcHBsaWNhdGlvbl9nYXRld2F5X2NlcnRpZmljYXRlX2Zyb21fa2V5dmF1bHQoKSB7CiAgIyBjaGVjayBrZXkgdmF1bHQgYWNjZXNzaWJpbGl0eSBmb3IgdGVtcGxhdGUgZGVwbG95bWVudAogIGxvY2FsIGVuYWJsZWRGb3JUZW1wbGF0ZURlcGxveW1lbnQ9JChheiBrZXl2YXVsdCBzaG93IC0tbmFtZSAke0FQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0tFWVZBVUxUX05BTUV9IC0tcXVlcnkgInByb3BlcnRpZXMuZW5hYmxlZEZvclRlbXBsYXRlRGVwbG95bWVudCIpCiAgaWYgW1sgIiR7ZW5hYmxlZEZvclRlbXBsYXRlRGVwbG95bWVudCwsfSIgIT0gInRydWUiIF1dOyB0aGVuCiAgICBlY2hvX3N0ZGVyciAiTWFrZSBzdXJlIEtleSBWYXVsdCAke0FQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0tFWVZBVUxUX05BTUV9IGlzIGVuYWJsZWQgZm9yIHRlbXBsYXRlIGRlcGxveW1lbnQuICIKICAgIGV4aXQgMQogIGZpCgogICMgYWxsb3cgdGhlIGlkZW50aXR5IHRvIGFjY2VzcyB0aGUga2V5dmF1bHQKICBsb2NhbCBwcmluY2lwYWxJZD0kKGF6IGlkZW50aXR5IHNob3cgLS1pZHMgJHtBWl9TQ1JJUFRTX1VTRVJfQVNTSUdORURfSURFTlRJVFl9IC0tcXVlcnkgInByaW5jaXBhbElkIiAtbyB0c3YpCiAgYXoga2V5dmF1bHQgc2V0LXBvbGljeSAtLW5hbWUgJHtBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9OQU1FfSAgLS1vYmplY3QtaWQgJHtwcmluY2lwYWxJZH0gLS1zZWNyZXQtcGVybWlzc2lvbnMgZ2V0IGxpc3QKICB2YWxpZGF0ZV9zdGF0dXMgImdyYW50IGlkZW50aXR5IHBlcm1pc3Npb24gdG8gZ2V0L2xpc3Qgc2VjcmV0cyBpbiBrZXkgdmF1bHQgJHtBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9OQU1FfSIKCiAgbG9jYWwgZ2F0ZXdheUNlcnREYXRhRmlsZU5hbWU9JHtBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWX0vZ2F0ZXdheUNlcnREYXRhLnR4dAogIGxvY2FsIGdhdGV3YXlDZXJ0UHN3RmlsZU5hbWU9JHtBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWX0vZ2F0ZXdheUNlcnRQc3cudHh0CgogIHJtIC1mICR7Z2F0ZXdheUNlcnREYXRhRmlsZU5hbWV9CiAgcm0gLWYgJHtnYXRld2F5Q2VydFBzd0ZpbGVOYW1lfQoKICAjIGRvd25sb2FkIGNlcnQgZGF0YQogIGF6IGtleXZhdWx0IHNlY3JldCBkb3dubG9hZCAtLWZpbGUgJHtnYXRld2F5Q2VydERhdGFGaWxlTmFtZX0gXAogICAgLS1uYW1lICR7QVBQTElDQVRJT05fR0FURVdBWV9TU0xfS0VZVkFVTFRfRlJPTlRFTkRfQ0VSVF9EQVRBX1NFQ1JFVF9OQU1FfSBcCiAgICAtLXZhdWx0LW5hbWUgJHtBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9OQU1FfQogIHZhbGlkYXRlX3N0YXR1cyAiZG93bmxvYWQgc2VjcmV0ICR7QVBQTElDQVRJT05fR0FURVdBWV9TU0xfS0VZVkFVTFRfRlJPTlRFTkRfQ0VSVF9EQVRBX1NFQ1JFVF9OQU1FfSBmcm9tIGtleSB2YXVsdCAke0FQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0tFWVZBVUxUX05BTUV9IgogICMgc2V0IGNlcnQgZGF0YSB3aXRoIHZhbHVlcyBpbiBkb3dubG9hZCBmaWxlCiAgQVBQTElDQVRJT05fR0FURVdBWV9TU0xfRlJPTlRFTkRfQ0VSVF9EQVRBPSQoY2F0ICR7Z2F0ZXdheUNlcnREYXRhRmlsZU5hbWV9KQogICMgcmVtb3ZlIHRoZSBkYXRhIGZpbGUKICBybSAtZiAke2dhdGV3YXlDZXJ0RGF0YUZpbGVOYW1lfQoKICAjIGRvd25sb2FkIGNlcnQgZGF0YQogIGF6IGtleXZhdWx0IHNlY3JldCBkb3dubG9hZCAtLWZpbGUgJHtnYXRld2F5Q2VydFBzd0ZpbGVOYW1lfSBcCiAgICAtLW5hbWUgJHtBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9GUk9OVEVORF9DRVJUX1BBU1NXT1JEX1NFQ1JFVF9OQU1FfSBcCiAgICAtLXZhdWx0LW5hbWUgJHtBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9OQU1FfSAKICB2YWxpZGF0ZV9zdGF0dXMgImRvd25sb2FkIHNlY3JldCAke0FQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0tFWVZBVUxUX0ZST05URU5EX0NFUlRfUEFTU1dPUkRfU0VDUkVUX05BTUV9IGZyb20ga2V5IHZhdWx0ICR7QVBQTElDQVRJT05fR0FURVdBWV9TU0xfS0VZVkFVTFRfTkFNRX0iCiAgIyBzZXQgY2VydCBkYXRhIHdpdGggdmFsdWVzIGluIGRvd25sb2FkIGZpbGUKICBBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9GUk9OVEVORF9DRVJUX1BBU1NXT1JEPSQoY2F0ICR7Z2F0ZXdheUNlcnRQc3dGaWxlTmFtZX0pCiAgIyByZW1vdmUgdGhlIGRhdGEgZmlsZQogIHJtIC1mICR7Z2F0ZXdheUNlcnRQc3dGaWxlTmFtZX0KCiAgIyByZXNldCBrZXkgdmF1bHQgcG9saWN5CiAgYXoga2V5dmF1bHQgZGVsZXRlLXBvbGljeSAtLW5hbWUgJHtBUFBMSUNBVElPTl9HQVRFV0FZX1NTTF9LRVlWQVVMVF9OQU1FfSAgLS1vYmplY3QtaWQgJHtwcmluY2lwYWxJZH0KICB2YWxpZGF0ZV9zdGF0dXMgImRlbGV0ZSBpZGVudGl0eSBwZXJtaXNzaW9uIHRvIGdldC9saXN0IHNlY3JldHMgaW4ga2V5IHZhdWx0ICR7QVBQTElDQVRJT05fR0FURVdBWV9TU0xfS0VZVkFVTFRfTkFNRX0iCn0KCmZ1bmN0aW9uIHZhbGlkYXRlX2dhdGV3YXlfZnJvbnRlbmRfY2VydGlmaWNhdGVzKCkgewogIGlmIFtbICIke2FwcEdhdGV3YXlDZXJ0aWZpY2F0ZU9wdGlvbn0iID09ICJnZW5lcmF0ZUNlcnQiIF1dOyB0aGVuCiAgICByZXR1cm4KICBmaQoKICBpZiBbWyAiJHthcHBHYXRld2F5Q2VydGlmaWNhdGVPcHRpb259IiA9PSAiaGF2ZUtleVZhdWx0IiBdXTsgdGhlbgogICAgZG93bmxvYWRfYXBwbGljYXRpb25fZ2F0ZXdheV9jZXJ0aWZpY2F0ZV9mcm9tX2tleXZhdWx0CiAgZmkKCiAgbG9jYWwgYXBwZ3dGcm9udENlcnRGaWxlTmFtZT0ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9nYXRld2F5Y2VydC5wZngKICBlY2hvICIkQVBQTElDQVRJT05fR0FURVdBWV9TU0xfRlJPTlRFTkRfQ0VSVF9EQVRBIiB8IGJhc2U2NCAtZCA+JGFwcGd3RnJvbnRDZXJ0RmlsZU5hbWUKCiAgb3BlbnNzbCBwa2NzMTIgXAogICAgLWluICRhcHBnd0Zyb250Q2VydEZpbGVOYW1lIFwKICAgIC1ub2NlcnRzIFwKICAgIC1vdXQgJHtBWl9TQ1JJUFRTX1BBVEhfT1VUUFVUX0RJUkVDVE9SWX0vY2VydC5rZXkgXAogICAgLXBhc3NpbiBwYXNzOiR7QVBQTElDQVRJT05fR0FURVdBWV9TU0xfRlJPTlRFTkRfQ0VSVF9QQVNTV09SRH0gXAogICAgLXBhc3NvdXQgcGFzczoke0FQUExJQ0FUSU9OX0dBVEVXQVlfU1NMX0ZST05URU5EX0NFUlRfUEFTU1dPUkR9CiAgCiAgdmFsaWRhdGVfc3RhdHVzICJhY2Nlc3MgYXBwbGljYXRpb24gZ2F0ZXdheSBmcm9udGVuZCBrZXkuIiAiTWFrZSBzdXJlIHRoZSBBcHBsaWNhdGlvbiBHYXRld2F5IGZyb250ZW5kIGNlcnRpZmljYXRlIGlzIGNvcnJlY3QuIgp9CgpmdW5jdGlvbiB2YWxpZGF0ZV9kbnNfem9uZSgpIHsKICBpZiBbWyAiJHtjaGVja0ROU1pvbmUsLH0iID09ICJ0cnVlIiBdXTsgdGhlbgogICAgYXogbmV0d29yayBkbnMgem9uZSBzaG93IC1uICR7RE5TX1pPTkVfTkFNRX0gLWcgJHtETlNfWk9ORV9SRVNPVVJDRUdST1VQX05BTUV9CiAgICB2YWxpZGF0ZV9zdGF0dXMgImNoZWNrIEROUyBab25lICR7RE5TX1pPTkVfTkFNRX0iICJNYWtlIHN1cmUgdGhlIEROUyBab25lIGV4aXN0cy4iCgogICAgZWNob19zdGRvdXQgIkNoZWNrIEROUyBab25lOiBwYXNzZWQhIgogIGZpCn0KCmZ1bmN0aW9uIGdldF9ha3NfZGVmYXVsdF92ZXJzaW9uKCkgewogIGNvbnN0RGVmYXVsdEFLU1ZlcnNpb249JChheiBha3MgZ2V0LXZlcnNpb25zIC0tbG9jYXRpb24gJHtsb2NhdGlvbn0gXAogICAgfCBqcSAnLm9yY2hlc3RyYXRvcnNbXSB8IHNlbGVjdCguZGVmYXVsdD09dHJ1ZSkgfCAub3JjaGVzdHJhdG9yVmVyc2lvbicgXAogICAgfCB0ciAtZCAiXCIiKQoKICB2YWxpZGF0ZV9zdGF0dXMgImdldCBBS1MgZGVmYXVsdCB2ZXJzaW9uICR7Y29uc3REZWZhdWx0QUtTVmVyc2lvbn0iCn0KCmZ1bmN0aW9uIHZhbGlkYXRlX2Frc192ZXJzaW9uKCkgewogIGlmIFtbICIke1VTRV9BS1NfV0VMTF9URVNURURfVkVSU0lPTiwsfSIgPT0gInRydWUiIF1dOyB0aGVuCiAgICBsb2NhbCBha3NXZWxsVGVzdGVkVmVyc2lvbkZpbGU9YWtzX3dlbGxfdGVzdGVkX3ZlcnNpb24uanNvbgogICAgIyBkb3dubG9hZCB0aGUganNvbiBmaWxlIHRoYXQgaGFzIHdlbGwtdGVzdGVkIHZlcnNpb24gZnJvbSB3ZWJsb2dpYy1henVyZSByZXBvLgogICAgY3VybCAtTCAiJHtnaXRVcmw0QWtzV2VsbFRlc3RlZFZlcnNpb25Kc29uRmlsZX0iIC0tcmV0cnkgJHtyZXRyeU1heEF0dGVtcHR9IC1vICR7YWtzV2VsbFRlc3RlZFZlcnNpb25GaWxlfQogICAgbG9jYWwgYWtzV2VsbFRlc3RlZFZlcnNpb249JChjYXQgJHtha3NXZWxsVGVzdGVkVmVyc2lvbkZpbGV9IHwganEgICIudmFsdWUiIHwgdHIgLWQgIlwiIikKICAgIGVjaG8gIkFLUyB3ZWxsLXRlc3RlZCB2ZXJzaW9uOiAke2Frc1dlbGxUZXN0ZWRWZXJzaW9ufSIKICAgICMgY2hlY2sgaWYgdGhlIHdlbGwtdGVzdGVkIHZlcnNpb24gaXMgc3VwcG9ydGVkIGluIHRoZSBsb2NhdGlvbgogICAgbG9jYWwgcmV0PSQoYXogYWtzIGdldC12ZXJzaW9ucyAtLWxvY2F0aW9uICR7bG9jYXRpb259IFwKICAgICAgfCBqcSAiLm9yY2hlc3RyYXRvcnNbXSB8IHNlbGVjdCgub3JjaGVzdHJhdG9yVmVyc2lvbiA9PSBcIiR7YWtzV2VsbFRlc3RlZFZlcnNpb259XCIpIHwgLm9yY2hlc3RyYXRvclZlcnNpb24iIFwKICAgICAgfCB0ciAtZCAiXCIiKQogICAgaWYgW1sgIiR7YWtzV2VsbFRlc3RlZFZlcnNpb259IiAhPSAgIiIgXV0gJiYgW1sgIiR7cmV0fSIgPT0gICIke2Frc1dlbGxUZXN0ZWRWZXJzaW9ufSIgXV07IHRoZW4KICAgICAgb3V0cHV0QWtzVmVyc2lvbj0ke2Frc1dlbGxUZXN0ZWRWZXJzaW9ufQogICAgZWxzZQogICAgICAjIGlmIHRoZSB3ZWxsLXRlc3RlZCB2ZXJzaW9uIGlzIGludmFsaWQsIHVzZSBkZWZhdWx0IHZlcnNpb24uCiAgICAgIGdldF9ha3NfZGVmYXVsdF92ZXJzaW9uCiAgICAgIG91dHB1dEFrc1ZlcnNpb249JHtjb25zdERlZmF1bHRBS1NWZXJzaW9ufQogICAgZmkKICBlbHNlCiAgICAjIGNoZWNrIGlmIHRoZSBpbnB1dCB2ZXJzaW9uIGlzIHN1cHBvcnRlZCBpbiB0aGUgbG9jYXRpb24KICAgIGxvY2FsIHJldD0kKGF6IGFrcyBnZXQtdmVyc2lvbnMgLS1sb2NhdGlvbiAke2xvY2F0aW9ufSBcCiAgICAgIHwganEgIi5vcmNoZXN0cmF0b3JzW10gfCBzZWxlY3QoLm9yY2hlc3RyYXRvclZlcnNpb24gPT0gXCIke0FLU19WRVJTSU9OfVwiKSB8IC5vcmNoZXN0cmF0b3JWZXJzaW9uIiBcCiAgICAgIHwgdHIgLWQgIlwiIikKICAgIGlmIFtbICIke3JldH0iID09ICAiJHtBS1NfVkVSU0lPTn0iIF1dOyB0aGVuCiAgICAgIG91dHB1dEFrc1ZlcnNpb249JHtBS1NfVkVSU0lPTn0KICAgIGVsc2UKICAgICAgZWNob19zdGRlcnIgIkVSUk9SOiBpbnZhbGlkIGFrcyB2ZXJzaW9uICR7QUtTX1ZFUlNJT059IGluICR7bG9jYXRpb259LiIKICAgICAgZXhpdCAxCiAgICBmaQogIGZpCn0KCmZ1bmN0aW9uIGVuYWJsZV9ha3NfbWFuYWdlZF9pZGVudGl0eSgpIHsKICBsb2NhbCBpZGVudGl0eUxlbmd0aD0kKGF6IGFrcyBzaG93IC1nICR7QUtTX0NMVVNURVJfUkVTT1VSQ0VHUk9VUF9OQU1FfSAtbiAke0FLU19DTFVTVEVSX05BTUV9IHwganEgJy5pZGVudGl0eSB8IGxlbmd0aCcpCiAgZWNobyAiaWRlbnRpdHlMZW5ndGggJHtpZGVudGl0eUxlbmd0aH0iCgogIGlmIFsgJGlkZW50aXR5TGVuZ3RoIC1sdCAxIF07IHRoZW4KICAgICAgZWNobyAiZW5hYmxlIG1hbmFnZWQgaWRlbnRpdHkuLi4iCiAgICAgICMgWW91ciBjbHVzdGVyIGlzIHVzaW5nIHNlcnZpY2UgcHJpbmNpcGFsLCBhbmQgeW91IGFyZSBnb2luZyB0byB1cGRhdGUgdGhlIGNsdXN0ZXIgdG8gdXNlIHN5c3RlbWFzc2lnbmVkIG1hbmFnZWQgaWRlbnRpdHkuCiAgICAgICMgQWZ0ZXIgdXBkYXRpbmcsIHlvdXIgY2x1c3RlcidzIGNvbnRyb2wgcGxhbmUgYW5kIGFkZG9uIHBvZHMgd2lsbCBzd2l0Y2ggdG8gdXNlIG1hbmFnZWQgaWRlbnRpdHksIGJ1dCBrdWJlbGV0IHdpbGwgS0VFUCBVU0lORyBTRVJWSUNFIFBSSU5DSVBBTCB1bnRpbCB5b3UgdXBncmFkZSB5b3VyIGFnZW50cG9vbC4KICAgICAgYXogYWtzIHVwZGF0ZSAteSAtZyAke0FLU19DTFVTVEVSX1JFU09VUkNFR1JPVVBfTkFNRX0gLW4gJHtBS1NfQ0xVU1RFUl9OQU1FfSAtLWVuYWJsZS1tYW5hZ2VkLWlkZW50aXR5CgogICAgICB2YWxpZGF0ZV9zdGF0dXMgIkVuYWJsZSBBcHBsY2lhdGlvbiBHYXRld2F5IEluZ3Jlc3MgQ29udHJvbGxlciBmb3IgJHtBS1NfQ0xVU1RFUl9OQU1FfS4iCiAgZmkKfQoKIyBWTkVUIGlucHV0IHNhbXBsZToKIyB7CiMgICAgICJuYW1lIjogIndsc2Frcy12bmV0IiwKIyAgICAgInJlc291cmNlR3JvdXAiOiAiaGFpY2hlLXRlc3QiLAojICAgICAiYWRkcmVzc1ByZWZpeGVzIjogWwojICAgICAgICAgIjEwLjMuMC4wLzI4IgojICAgICBdLAojICAgICAiYWRkcmVzc1ByZWZpeCI6ICIxMC4zLjAuMC8yOCIsCiMgICAgICJuZXdPckV4aXN0aW5nIjogIm5ldyIsCiMgICAgICJzdWJuZXRzIjogewojICAgICAgICAgImdhdGV3YXlTdWJuZXQiOiB7CiMgICAgICAgICAgICAgIm5hbWUiOiAid2xzLWFrcy1nYXRld2F5LXN1Ym5ldCIsCiMgICAgICAgICAgICAgImFkZHJlc3NQcmVmaXgiOiAiMTAuMy4wLjAvMjkiLAojICAgICAgICAgICAgICJzdGFydEFkZHJlc3MiOiAiMTAuMy4wLjQiCiMgICAgICAgICB9CiMgICAgIH0KIyB9CiMgVG8gbWFrZSBzdXJlIHRoZSBzdWJuZXQgb25seSBoYXZlIGFwcGxpY2F0aW9uIGdhdGV3YXkKZnVuY3Rpb24gdmFsaWRhdGVfYXBwZ2F0ZXdheV92bmV0KCkgewogIGVjaG9fc3Rkb3V0ICJWTkVUIGZvciBhcHBsaWNhdGlvbiBnYXRld2F5OiAke1ZORVRfRk9SX0FQUExJQ0FUSU9OR0FURVdBWX0iCiAgbG9jYWwgdm5ldE5hbWU9JChlY2hvICR7Vk5FVF9GT1JfQVBQTElDQVRJT05HQVRFV0FZfSB8IGpxICcubmFtZScgfCB0ciAtZCAiXCIiKQogIGxvY2FsIHZuZXRSZXNvdXJjZUdyb3VwPSQoZWNobyAke1ZORVRfRk9SX0FQUExJQ0FUSU9OR0FURVdBWX0gfCBqcSAnLnJlc291cmNlR3JvdXAnIHwgdHIgLWQgIlwiIikKICBsb2NhbCBuZXdPckV4aXN0aW5nPSQoZWNobyAke1ZORVRfRk9SX0FQUExJQ0FUSU9OR0FURVdBWX0gfCBqcSAnLm5ld09yRXhpc3RpbmcnIHwgdHIgLWQgIlwiIikKICBsb2NhbCBzdWJuZXROYW1lPSQoZWNobyAke1ZORVRfRk9SX0FQUExJQ0FUSU9OR0FURVdBWX0gfCBqcSAnLnN1Ym5ldHMuZ2F0ZXdheVN1Ym5ldC5uYW1lJyB8IHRyIC1kICJcIiIpCgogIGlmIFtbICIke25ld09yRXhpc3RpbmcsLH0iICE9ICJuZXciIF1dOyB0aGVuCiAgICAjIHRoZSBzdWJuZXQgY2FuIG9ubHkgaGF2ZSBBcHBsaWNhdGlvbiBHYXRld2F5LgogICAgIyBxdWVyeSBpcENvbmZpZ3VyYXRpb25zOgogICAgIyBpZiBsZW5naHQgb2YgaXBDb25maWd1cmF0aW9ucyBpcyBncmVhdGVyIHRoYW4gMCwgdGhlIHN1Ym5ldCBmYWlscyB0byBtZWV0IHJlcXVpcmVtZW50IG9mIEFwcGxpY2F0aW9uIEdhdGV3YXkuCiAgICBsb2NhbCByZXQ9JChheiBuZXR3b3JrIHZuZXQgc2hvdyBcCiAgICAgIC1nICR7dm5ldFJlc291cmNlR3JvdXB9IFwKICAgICAgLS1uYW1lICR7dm5ldE5hbWV9IFwKICAgICAgfCBqcSAiLnN1Ym5ldHNbXSB8IHNlbGVjdCgubmFtZT09XCIke3N1Ym5ldE5hbWV9XCIpIHwgLmlwQ29uZmlndXJhdGlvbnMgfCBsZW5ndGgiKQogICAgCiAgICBpZiBbICRyZXQgLWd0IDAgXTsgdGhlbgogICAgICBlY2hvX3N0ZGVyciAiRVJST1I6IGludmFsaWQgc3VibmV0IGZvciBBcHBsaWNhdGlvbiBHYXRld2F5LCB0aGUgc3VibmV0IGhhcyAke3JldH0gY29ubmVjdGVkIGRldmljZShzKS4gTWFrZSBzdXJlIHRoZSBzdWJuZXQgaXMgb25seSBmb3IgQXBwbGljYXRpb24gR2F0ZXdheS4iCiAgICAgIGV4aXQgMQogICAgZmkKICBmaQp9CgpmdW5jdGlvbiBvdXRwdXRfcmVzdWx0KCkgewogIGVjaG8gIkFLUyB2ZXJzaW9uOiAke291dHB1dEFrc1ZlcnNpb259IgogIHJlc3VsdD0kKGpxIC1uIC1jIFwKICAgIC0tYXJnIGFrc1ZlcnNpb24gIiRvdXRwdXRBa3NWZXJzaW9uIiBcCiAgICAne2Frc1ZlcnNpb246ICRha3NWZXJzaW9ufScpCiAgZWNobyAicmVzdWx0IGlzOiAkcmVzdWx0IgogIGVjaG8gJHJlc3VsdCA+JEFaX1NDUklQVFNfT1VUUFVUX1BBVEgKfQoKIyBtYWluCmxvY2F0aW9uPSQxCmNyZWF0ZUFLU0NsdXN0ZXI9JDIKYWtzQWdlbnRQb29sVk1TaXplPSQzCmFrc0FnZW50UG9vbE5vZGVDb3VudD0kNAp1c2VPcmFjbGVJbWFnZT0kNQp3bHNJbWFnZVRhZz0kNgp1c2VyUHJvdmlkZWRJbWFnZVBhdGg9JDcKZW5hYmxlQ3VzdG9tU1NMPSQ4CnNzbENvbmZpZ3VyYXRpb25BY2Nlc3NPcHRpb249JDkKYXBwR2F0ZXdheUNlcnRpZmljYXRlT3B0aW9uPSR7MTB9CmVuYWJsZUFwcEdXSW5ncmVzcz0kezExfQpjaGVja0ROU1pvbmU9JHsxMn0KCm91dHB1dEFrc1ZlcnNpb249JHtjb25zdERlZmF1bHRBS1NWZXJzaW9ufQpzc2xDZXJ0aWZpY2F0ZUtleVZhdWx0T3B0aW9uPSJrZXlWYXVsdFN0b3JlZENvbmZpZyIKCnZhbGlkYXRlX2NvbXB1dGVfcmVzb3VyY2VzCgp2YWxpZGF0ZV9iYXNlX2ltYWdlX3BhdGgKCnZhbGlkYXRlX2Fjcl9hZG1pbl9lbmFibGVkCgppZiBbWyAiJHtlbmFibGVDdXN0b21TU0wsLH0iID09ICJ0cnVlIiBdXTsgdGhlbgogIHZhbGlkYXRlX3dsc19zc2xfY2VydGlmaWNhdGVzCmZpCgppZiBbWyAiJHtlbmFibGVBcHBHV0luZ3Jlc3MsLH0iID09ICJ0cnVlIiBdXTsgdGhlbgogIHZhbGlkYXRlX2dhdGV3YXlfZnJvbnRlbmRfY2VydGlmaWNhdGVzCmZpCgp2YWxpZGF0ZV9kbnNfem9uZQoKaWYgW1sgIiR7Y3JlYXRlQUtTQ2x1c3RlciwsfSIgPT0gInRydWUiIF1dOyB0aGVuCiAgdmFsaWRhdGVfYWtzX3ZlcnNpb24KZmkKCmlmIFtbICIke2NyZWF0ZUFLU0NsdXN0ZXIsLH0iICE9ICJ0cnVlIiBdXTsgdGhlbgogIGVuYWJsZV9ha3NfbWFuYWdlZF9pZGVudGl0eQpmaQoKdmFsaWRhdGVfYXBwZ2F0ZXdheV92bmV0CgpvdXRwdXRfcmVzdWx0Cgo=",
            "const_arguments": "[format('{0} {1} {2} {3} {4} {5} {6} {7} {8} {9} {10} {11}', parameters('location'), parameters('createAKSCluster'), parameters('aksAgentPoolVMSize'), parameters('aksAgentPoolNodeCount'), parameters('useOracleImage'), parameters('wlsImageTag'), parameters('userProvidedImagePath'), parameters('enableCustomSSL'), parameters('sslConfigurationAccessOption'), parameters('appGatewayCertificateOption'), parameters('enableAppGWIngress'), variables('const_checkDNSZone'))]",
            "const_checkDNSZone": "[and(parameters('enableDNSConfiguration'), not(parameters('createDNSZone')))]",
            "const_deploymentName": "ds-validate-parameters-and-fail-fast"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[variables('const_deploymentName')]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[parameters('azCliVersion')]",
                "arguments": "[variables('const_arguments')]",
                "environmentVariables": [
                  {
                    "name": "ORACLE_ACCOUNT_NAME",
                    "value": "[parameters('ocrSSOUser')]"
                  },
                  {
                    "name": "ORACLE_ACCOUNT_PASSWORD",
                    "secureValue": "[parameters('ocrSSOPSW')]"
                  },
                  {
                    "name": "ORACLE_ACCOUNT_ENTITLED",
                    "value": "[string(parameters('isSSOSupportEntitled'))]"
                  },
                  {
                    "name": "ACR_NAME",
                    "value": "[parameters('acrName')]"
                  },
                  {
                    "name": "ACR_RESOURCE_GROUP",
                    "value": "[parameters('acrResourceGroupName')]"
                  },
                  {
                    "name": "ACR_NAME_FOR_USER_PROVIDED_IMAGE",
                    "value": "[parameters('userProvidedAcr')]"
                  },
                  {
                    "name": "ACR_RG_NAME_FOR_USER_PROVIDED_IMAGE",
                    "value": "[parameters('userProvidedAcrRgName')]"
                  },
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  {
                    "name": "AKS_VERSION",
                    "value": "[parameters('aksVersion')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_NAME",
                    "value": "[parameters('sslKeyVaultName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_RESOURCEGROUP_NAME",
                    "value": "[parameters('sslKeyVaultResourceGroup')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_IDENTITY_DATA_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreDataSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_IDENTITY_PASSWORD_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_IDENTITY_TYPE",
                    "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_TRUST_DATA_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomTrustKeyStoreDataSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_TRUST_PASSWORD_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomTrustKeyStorePassPhraseSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_TRUST_TYPE",
                    "value": "[parameters('sslKeyVaultCustomTrustKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_PRIVATE_KEY_ALIAS",
                    "value": "[parameters('sslKeyVaultPrivateKeyAliasSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_PRIVATE_KEY_PASSWORD",
                    "value": "[parameters('sslKeyVaultPrivateKeyPassPhraseSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_IDENTITY_DATA",
                    "secureValue": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
                  },
                  {
                    "name": "WLS_SSL_IDENTITY_PASSWORD",
                    "secureValue": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
                  },
                  {
                    "name": "WLS_SSL_IDENTITY_TYPE",
                    "value": "[parameters('sslUploadedCustomIdentityKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_TRUST_DATA",
                    "secureValue": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
                  },
                  {
                    "name": "WLS_SSL_TRUST_PASSWORD",
                    "secureValue": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
                  },
                  {
                    "name": "WLS_SSL_TRUST_TYPE",
                    "value": "[parameters('sslUploadedCustomTrustKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_PRIVATE_KEY_ALIAS",
                    "secureValue": "[parameters('sslUploadedPrivateKeyAlias')]"
                  },
                  {
                    "name": "WLS_SSL_PRIVATE_KEY_PASSWORD",
                    "secureValue": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_NAME",
                    "value": "[parameters('keyVaultName')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_RESOURCEGROUP",
                    "value": "[parameters('keyVaultResourceGroup')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_DATA_SECRET_NAME",
                    "value": "[parameters('keyVaultSSLCertDataSecretName')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_PASSWORD_SECRET_NAME",
                    "value": "[parameters('keyVaultSSLCertPasswordSecretName')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_FRONTEND_CERT_DATA",
                    "value": "[parameters('appGatewaySSLCertData')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_FRONTEND_CERT_PASSWORD",
                    "value": "[parameters('appGatewaySSLCertPassword')]"
                  },
                  {
                    "name": "DNS_ZONE_NAME",
                    "value": "[parameters('dnszoneName')]"
                  },
                  {
                    "name": "DNS_ZONE_RESOURCEGROUP_NAME",
                    "value": "[parameters('dnszoneRGName')]"
                  },
                  {
                    "name": "USE_AKS_WELL_TESTED_VERSION",
                    "value": "[string(parameters('useAksWellTestedVersion'))]"
                  },
                  {
                    "name": "VNET_FOR_APPLICATIONGATEWAY",
                    "value": "[string(parameters('vnetForApplicationGateway'))]"
                  }
                ],
                "scriptContent": "[format('{0}\r\n\r\n{1}\r\n\r\n{2}', base64ToString(variables('base64_common')), base64ToString(variables('base64_utility')), base64ToString(variables('base64_validateParameters')))]",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ],
          "outputs": {
            "aksVersion": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', variables('const_deploymentName'))).outputs.aksVersion]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]"
      ]
    },
    {
      "condition": "[and(parameters('enableCustomSSL'), not(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "upload-wls-ssl-cert-to-keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('name_keyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('keyVaultSku')]"
          },
          "wlsIdentityKeyStoreData": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
          },
          "wlsIdentityKeyStoreDataSecretName": {
            "value": "[variables('name_identityKeyStoreDataSecret')]"
          },
          "wlsIdentityKeyStorePassphrase": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
          },
          "wlsIdentityKeyStorePassphraseSecretName": {
            "value": "[variables('name_identityKeyStorePswSecret')]"
          },
          "wlsPrivateKeyAlias": {
            "value": "[parameters('sslUploadedPrivateKeyAlias')]"
          },
          "wlsPrivateKeyAliasSecretName": {
            "value": "[variables('name_privateKeyAliasSecret')]"
          },
          "wlsPrivateKeyPassPhrase": {
            "value": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
          },
          "wlsPrivateKeyPassPhraseSecretName": {
            "value": "[variables('name_privateKeyPswSecret')]"
          },
          "wlsTrustKeyStoreData": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
          },
          "wlsTrustKeyStoreDataSecretName": {
            "value": "[variables('name_trustKeyStoreDataSecret')]"
          },
          "wlsTrustKeyStorePassPhrase": {
            "value": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
          },
          "wlsTrustKeyStorePassPhraseSecretName": {
            "value": "[variables('name_trustKeyStorePswSecret')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "1041456355823874620"
            }
          },
          "parameters": {
            "enabledForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the vault"
              }
            },
            "location": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "Price tier for Key Vault."
              }
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsIdentityKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStoreDataSecretName": {
              "type": "string",
              "defaultValue": "myIdentityKeyStoreData"
            },
            "wlsIdentityKeyStorePassphrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStorePassphraseSecretName": {
              "type": "string",
              "defaultValue": "myIdentityKeyStorePsw"
            },
            "wlsPrivateKeyAlias": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyAliasSecretName": {
              "type": "string",
              "defaultValue": "privateKeyAlias"
            },
            "wlsPrivateKeyPassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyPassPhraseSecretName": {
              "type": "string",
              "defaultValue": "privateKeyPsw"
            },
            "wlsTrustKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreDataSecretName": {
              "type": "string",
              "defaultValue": "myTrustKeyStoreData"
            },
            "wlsTrustKeyStorePassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStorePassPhraseSecretName": {
              "type": "string",
              "defaultValue": "myTrustKeyStorePsw"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-02-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "accessPolicies": [],
                "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                "sku": {
                  "name": "[parameters('sku')]",
                  "family": "A"
                },
                "tenantId": "[subscription().tenantId]"
              },
              "tags": {
                "managed-by-azure-weblogic": "[parameters('utcValue')]"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsIdentityKeyStoreDataSecretName'))]",
              "properties": {
                "value": "[parameters('wlsIdentityKeyStoreData')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsIdentityKeyStorePassphraseSecretName'))]",
              "properties": {
                "value": "[parameters('wlsIdentityKeyStorePassphrase')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsPrivateKeyAliasSecretName'))]",
              "properties": {
                "value": "[parameters('wlsPrivateKeyAlias')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsPrivateKeyPassPhraseSecretName'))]",
              "properties": {
                "value": "[parameters('wlsPrivateKeyPassPhrase')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsTrustKeyStoreDataSecretName'))]",
              "properties": {
                "value": "[parameters('wlsTrustKeyStoreData')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsTrustKeyStorePassPhraseSecretName'))]",
              "properties": {
                "value": "[parameters('wlsTrustKeyStorePassPhrase')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]"
      ]
    },
    {
      "condition": "[not(parameters('createAKSCluster'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "query-existing-storage-account",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "16833738421283356134"
            }
          },
          "parameters": {
            "aksClusterName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "variables": {
            "base64_queryStorageAccount": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgSW5wdXRzOgojIEFLU19DTFVTVEVSX1JFU09VUkNFR1JPVVBfTkFNRQojIEFLU19DTFVTVEVSX05BTUUKCmVjaG8gIlNjcmlwdCAkezB9IHN0YXJ0cyIKCmV4cG9ydCBjdXJyZW50U3RvcmFnZUFjY291bnQ9Im51bGwiCgojIENvbm5lY3QgdG8gQUtTIGNsdXN0ZXIKZnVuY3Rpb24gY29ubmVjdF9ha3NfY2x1c3RlcigpIHsKICBheiBha3MgZ2V0LWNyZWRlbnRpYWxzIFwKICAgIC0tcmVzb3VyY2UtZ3JvdXAgJHtBS1NfQ0xVU1RFUl9SRVNPVVJDRUdST1VQX05BTUV9IFwKICAgIC0tbmFtZSAke0FLU19DTFVTVEVSX05BTUV9IFwKICAgIC0tb3ZlcndyaXRlLWV4aXN0aW5nCn0KCmZ1bmN0aW9uIHF1ZXJ5X3N0b3JhZ2VfYWNjb3VudCgpIHsKICBlY2hvICJpbnN0YWxsIGt1YmVjdGwiCiAgYXogYWtzIGluc3RhbGwtY2xpCgogIGVjaG8gImdldCBwdiBuYW1lIgogIHB2TmFtZT0kKGt1YmVjdGwgZ2V0IHB2IC1vIGpzb24gfAogICAganEgJy5pdGVtc1tdIHwgc2VsZWN0KC5zdGF0dXMucGhhc2U9PSJCb3VuZCIpIHwgWy5tZXRhZGF0YS5uYW1lXSB8IC5bMF0nIHwKICAgIHRyIC1kICJcIiIpCgogIGlmIFtbICIke3B2TmFtZX0iICE9ICJudWxsIiBdXSAmJiBbWyAiJHtwdk5hbWV9IiAhPSAiIiBdXTsgdGhlbgogICAgIyB0aGlzIGlzIGEgd29ya2Fyb3VuZCBmb3IgdXBkYXRlIGRvbWFpbiB1c2luZyBtYXJrZXRwbGFjZSBvZmZlci4KICAgICMgdGhlIG9mZmVyIHdpbGwgY3JlYXRlIGEgbmV3IHN0b3JhZ2UgYWNjb3VudCBpbiBhIG5ldyByZXNvdXJjZSBncm91cCBpZiB0aGVyZSBpcyBubyBzdG9yYWdlIGF0dGFjaGVkLgogICAgY3VycmVudFN0b3JhZ2VBY2NvdW50PSQoa3ViZWN0bCBnZXQgcHYgJHtwdk5hbWV9IC1vIGpzb24gfCBqcSAnLiB8IC5tZXRhZGF0YS5sYWJlbHMuc3RvcmFnZUFjY291bnQnIHwgdHIgLWQgIlwiIikKICBmaQp9CgpmdW5jdGlvbiBvdXRwdXRfcmVzdWx0KCkgewogIGVjaG8gJHtjdXJyZW50U3RvcmFnZUFjY291bnR9CgogIHJlc3VsdD0kKGpxIC1uIC1jIFwKICAgIC0tYXJnIHN0b3JhZ2VBY2NvdW50ICRjdXJyZW50U3RvcmFnZUFjY291bnQgXAogICAgJ3tzdG9yYWdlQWNjb3VudDogJHN0b3JhZ2VBY2NvdW50fScpCiAgZWNobyAicmVzdWx0IGlzOiAkcmVzdWx0IgogIGVjaG8gJHJlc3VsdCA+JEFaX1NDUklQVFNfT1VUUFVUX1BBVEgKfQoKY29ubmVjdF9ha3NfY2x1c3RlcgoKcXVlcnlfc3RvcmFnZV9hY2NvdW50CgpvdXRwdXRfcmVzdWx0Cg==",
            "const_deploymentName": "ds-query-storage-account"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[variables('const_deploymentName')]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[parameters('azCliVersion')]",
                "environmentVariables": [
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  }
                ],
                "scriptContent": "[base64ToString(variables('base64_queryStorageAccount'))]",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ],
          "outputs": {
            "storageAccount": {
              "type": "string",
              "value": "[string(reference(resourceId('Microsoft.Resources/deploymentScripts', variables('const_deploymentName'))).outputs.storageAccount)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]"
      ]
    },
    {
      "condition": "[and(parameters('enableAppGWIngress'), not(equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "appgateway-certificates-secrets-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "backendCertificateDataValue": {
            "value": "[parameters('appGatewaySSLBackendRootCertData')]"
          },
          "certificateDataValue": {
            "value": "[parameters('appGatewaySSLCertData')]"
          },
          "certificatePasswordValue": {
            "value": "[parameters('appGatewaySSLCertPassword')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('keyVaultSku')]"
          },
          "subjectName": {
            "value": "[format('CN={0}', if(parameters('enableDNSConfiguration'), format('{0}.{1}', parameters('dnsNameforApplicationGateway'), parameters('dnszoneName')), variables('const_azureSubjectName')))]"
          },
          "useExistingAppGatewaySSLCertificate": {
            "value": "[variables('_useExistingAppGatewaySSLCertificate')]"
          },
          "keyVaultName": {
            "value": "[variables('name_keyVaultName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "13425276493083368586"
            }
          },
          "parameters": {
            "backendCertificateDataValue": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Backend certificate data to store in the secret"
              }
            },
            "certificateDataValue": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Certificate data to store in the secret"
              }
            },
            "certificatePasswordValue": {
              "type": "secureString",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Certificate password to store in the secret"
              }
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to upload trusted root certificate"
              }
            },
            "enabledForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
              }
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "location": {
              "type": "string"
            },
            "permission": {
              "type": "object",
              "defaultValue": {
                "certificates": [
                  "get",
                  "list",
                  "update",
                  "create"
                ]
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "Price tier for Key Vault."
              }
            },
            "subjectName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Subject name to create a certificate."
              }
            },
            "useExistingAppGatewaySSLCertificate": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "If false, will create a certificate."
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "GEN_UNIQUE",
              "metadata": {
                "description": "Current deployment time. Used as a tag in deployment script."
              }
            }
          },
          "variables": {
            "name_sslBackendCertSercretName": "myAppGatewaySSLBackendRootCert",
            "name_sslCertSecretName": "myAppGatewaySSLCert",
            "name_sslCertPasswordSecretName": "myAppGatewaySSLCertPassword"
          },
          "resources": [
            {
              "condition": "[not(parameters('useExistingAppGatewaySSLCertificate'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "kv-appgw-selfsigned-certificate-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "permission": {
                    "value": "[parameters('permission')]"
                  },
                  "subjectName": {
                    "value": "[parameters('subjectName')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "9714798136298434026"
                    }
                  },
                  "parameters": {
                    "identity": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Managed identity to be used for the deployment script. Currently, only user-assigned MSI is supported."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "defaultValue": "[format('wls-kv-{0}', uniqueString(parameters('utcValue')))]",
                      "metadata": {
                        "description": "Used to name the new Azure Key Vault resoure."
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "permission": {
                      "type": "object",
                      "defaultValue": {
                        "certificates": [
                          "get",
                          "list",
                          "update",
                          "create"
                        ]
                      },
                      "metadata": {
                        "description": "Access permission of the key vault, will applied to all access policies."
                      }
                    },
                    "secretName": {
                      "type": "string",
                      "defaultValue": "mySelfSignedCertificate",
                      "metadata": {
                        "description": "Used to name the new certificate resource."
                      }
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "metadata": {
                        "description": "Price tier for Key Vault."
                      }
                    },
                    "subjectName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz",
                      "metadata": {
                        "description": "Subject name to create a new certificate, example: 'CN=contoso.com'."
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_identityId": "[format('{0}', substring(string(parameters('identity').userAssignedIdentities), add(indexOf(string(parameters('identity').userAssignedIdentities), '\"'), 1), sub(lastIndexOf(string(parameters('identity').userAssignedIdentities), '\"'), add(indexOf(string(parameters('identity').userAssignedIdentities), '\"'), 1))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2023-02-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "family": "A",
                          "name": "[parameters('sku')]"
                        },
                        "tenantId": "[subscription().tenantId]",
                        "accessPolicies": [
                          {
                            "objectId": "[reference(variables('const_identityId'), '2018-11-30').principalId]",
                            "tenantId": "[subscription().tenantId]",
                            "permissions": "[parameters('permission')]"
                          }
                        ],
                        "enabledForDeployment": false,
                        "enabledForDiskEncryption": false,
                        "enabledForTemplateDeployment": true,
                        "enableSoftDelete": true
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-create-add-appgw-certificate",
                      "location": "[parameters('location')]",
                      "identity": "[parameters('identity')]",
                      "kind": "AzurePowerShell",
                      "properties": {
                        "forceUpdateTag": "[parameters('utcValue')]",
                        "azPowerShellVersion": "8.3",
                        "timeout": "PT30M",
                        "arguments": "[format(' -vaultName {0} -certificateName {1} -subjectName {2}', parameters('keyVaultName'), parameters('secretName'), parameters('subjectName'))]",
                        "scriptContent": "\n                    param(\n                        [string] [Parameter(Mandatory=$true)] $vaultName,\n                        [string] [Parameter(Mandatory=$true)] $certificateName,\n                        [string] [Parameter(Mandatory=$true)] $subjectName\n                    )\n\n                    $ErrorActionPreference = 'Stop'\n                    $DeploymentScriptOutputs = @{}\n\n                    $existingCert = Get-AzKeyVaultCertificate -VaultName $vaultName -Name $certificateName\n\n                    if ($existingCert -and $existingCert.Certificate.Subject -eq $subjectName) {\n\n                        Write-Host 'Certificate $certificateName in vault $vaultName is already present.'\n\n                        $DeploymentScriptOutputs['certThumbprint'] = $existingCert.Thumbprint\n                        $existingCert | Out-String\n                    }\n                    else {\n                        $policy = New-AzKeyVaultCertificatePolicy -SubjectName $subjectName -IssuerName Self -ValidityInMonths 12 -Verbose\n\n                        # private key is added as a secret that can be retrieved in the ARM template\n                        Add-AzKeyVaultCertificate -VaultName $vaultName -Name $certificateName -CertificatePolicy $policy -Verbose\n\n                        $newCert = Get-AzKeyVaultCertificate -VaultName $vaultName -Name $certificateName\n\n                        # it takes a few seconds for KeyVault to finish\n                        $tries = 0\n                        do {\n                        Write-Host 'Waiting for certificate creation completion...'\n                        Start-Sleep -Seconds 10\n                        $operation = Get-AzKeyVaultCertificateOperation -VaultName $vaultName -Name $certificateName\n                        $tries++\n\n                        if ($operation.Status -eq 'failed')\n                        {\n                            throw 'Creating certificate $certificateName in vault $vaultName failed with error $($operation.ErrorMessage)'\n                        }\n\n                        if ($tries -gt 120)\n                        {\n                            throw 'Timed out waiting for creation of certificate $certificateName in vault $vaultName'\n                        }\n                        } while ($operation.Status -ne 'completed')\n\n                        $DeploymentScriptOutputs['certThumbprint'] = $newCert.Thumbprint\n                        $newCert | Out-String\n                    }\n                ",
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultName": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "secretName": {
                      "type": "string",
                      "value": "[parameters('secretName')]"
                    },
                    "identityId": {
                      "type": "string",
                      "value": "[variables('const_identityId')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('useExistingAppGatewaySSLCertificate')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "kv-appgw-existing-certificate-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "certificateDataName": {
                    "value": "[variables('name_sslCertSecretName')]"
                  },
                  "certificateDataValue": {
                    "value": "[parameters('certificateDataValue')]"
                  },
                  "certificatePswSecretName": {
                    "value": "[variables('name_sslCertPasswordSecretName')]"
                  },
                  "certificatePasswordValue": {
                    "value": "[parameters('certificatePasswordValue')]"
                  },
                  "enabledForTemplateDeployment": {
                    "value": "[parameters('enabledForTemplateDeployment')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1318772876909575764"
                    }
                  },
                  "parameters": {
                    "certificateDataName": {
                      "type": "string",
                      "defaultValue": "myIdentityKeyStoreData",
                      "metadata": {
                        "description": "Secret name of certificate data."
                      }
                    },
                    "certificateDataValue": {
                      "type": "string",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Certificate data to store in the secret"
                      }
                    },
                    "certificatePswSecretName": {
                      "type": "string",
                      "defaultValue": "myIdentityKeyStorePsw",
                      "metadata": {
                        "description": "Secret name of certificate password."
                      }
                    },
                    "certificatePasswordValue": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Certificate password to store in the secret"
                      }
                    },
                    "enabledForTemplateDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "defaultValue": "kv-contoso",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "metadata": {
                        "description": "Price tier for Key Vault."
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2023-02-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "accessPolicies": [],
                        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                        "sku": {
                          "name": "[parameters('sku')]",
                          "family": "A"
                        },
                        "tenantId": "[subscription().tenantId]"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-02-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('certificateDataName'))]",
                      "properties": {
                        "value": "[parameters('certificateDataValue')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-02-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('certificatePswSecretName'))]",
                      "properties": {
                        "value": "[parameters('certificatePasswordValue')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultName": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "sslCertDataSecretName": {
                      "type": "string",
                      "value": "[parameters('certificateDataName')]"
                    },
                    "sslCertPwdSecretName": {
                      "type": "string",
                      "value": "[parameters('certificatePswSecretName')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableCustomSSL')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "kv-appgw-e2e-ssl-backend-certificate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "certificateDataName": {
                    "value": "[variables('name_sslBackendCertSercretName')]"
                  },
                  "certificateDataValue": {
                    "value": "[parameters('backendCertificateDataValue')]"
                  },
                  "enabledForTemplateDeployment": {
                    "value": "[parameters('enabledForTemplateDeployment')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "11669550598791452942"
                    }
                  },
                  "parameters": {
                    "certificateDataName": {
                      "type": "string",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Secret name of certificate data."
                      }
                    },
                    "certificateDataValue": {
                      "type": "string",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Certificate data to store in the secret"
                      }
                    },
                    "enabledForTemplateDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "metadata": {
                        "description": "Price tier for Key Vault."
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2023-02-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "accessPolicies": [],
                        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                        "sku": {
                          "name": "[parameters('sku')]",
                          "family": "A"
                        },
                        "tenantId": "[subscription().tenantId]"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-02-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('certificateDataName'))]",
                      "properties": {
                        "value": "[parameters('certificateDataValue')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultName": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "sslBackendCertDataSecretName": {
                      "type": "string",
                      "value": "[parameters('certificateDataName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'kv-appgw-selfsigned-certificate-deployment')]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[if(parameters('useExistingAppGatewaySSLCertificate'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment'), '2020-10-01').outputs.keyVaultName.value, reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-selfsigned-certificate-deployment'), '2020-10-01').outputs.keyVaultName.value)]"
            },
            "sslCertDataSecretName": {
              "type": "string",
              "value": "[if(parameters('useExistingAppGatewaySSLCertificate'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment'), '2020-10-01').outputs.sslCertDataSecretName.value, reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-selfsigned-certificate-deployment'), '2020-10-01').outputs.secretName.value)]"
            },
            "sslCertPwdSecretName": {
              "type": "string",
              "value": "[if(parameters('useExistingAppGatewaySSLCertificate'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment'), '2020-10-01').outputs.sslCertPwdSecretName.value, '')]"
            },
            "sslBackendCertDataSecretName": {
              "type": "string",
              "value": "[if(parameters('enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-e2e-ssl-backend-certificate'), '2020-10-01').outputs.sslBackendCertDataSecretName.value, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'upload-wls-ssl-cert-to-keyvault')]"
      ]
    },
    {
      "condition": "[parameters('enableAppGWIngress')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "application-gateway-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_pidAppgwEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.appgwEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.appgwEnd.value)]"
          },
          "_pidAppgwStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.appgwStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.appgwStart.value)]"
          },
          "_pidAppgwWithCustomCert": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.customCertForAppgw.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.customCertForAppgw.value)]"
          },
          "appgwPublicIPAddressName": {
            "value": "[parameters('appGatewayPublicIPAddressName')]"
          },
          "appgwUsePrivateIP": {
            "value": "[parameters('appgwUsePrivateIP')]"
          },
          "appgwSslCertName": {
            "value": "[variables('name_appgwFrontendSSLCertName')]"
          },
          "appgwTrustedRootCertName": {
            "value": "[variables('name_appgwBackendRootCertName')]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "dnsNameforApplicationGateway": {
            "value": "[variables('name_domainLabelforApplicationGateway')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "keyVaultName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2020-10-01').outputs.keyVaultName.value)]"
          },
          "keyVaultResourceGroup": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultResourceGroup'), resourceGroup().name)]"
          },
          "keyvaultBackendCertDataSecretName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultSSLBackendRootCertDataSecretName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2020-10-01').outputs.sslBackendCertDataSecretName.value)]"
          },
          "keyvaultFrontendCertDataSecretName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultSSLCertDataSecretName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2020-10-01').outputs.sslCertDataSecretName.value)]"
          },
          "keyvaultFrontendCertPswSecretName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultSSLCertPasswordSecretName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2020-10-01').outputs.sslCertPwdSecretName.value)]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "newOrExistingVnetForApplicationGateway": {
            "value": "[parameters('newOrExistingVnetForApplicationGateway')]"
          },
          "vnetForApplicationGateway": {
            "value": "[parameters('vnetForApplicationGateway')]"
          },
          "vnetRGNameForApplicationGateway": {
            "value": "[parameters('vnetRGNameForApplicationGateway')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "7682368214978470300"
            }
          },
          "parameters": {
            "_pidAppgwEnd": {
              "type": "string",
              "defaultValue": "pid-networking-appgateway-end"
            },
            "_pidAppgwStart": {
              "type": "string",
              "defaultValue": "pid-networking-appgateway-start"
            },
            "_pidAppgwWithCustomCert": {
              "type": "string",
              "defaultValue": "pid-networking-appgateway-with-custom-certificate"
            },
            "appgwPublicIPAddressName": {
              "type": "string",
              "defaultValue": "gwip"
            },
            "appgwUsePrivateIP": {
              "type": "bool"
            },
            "appgwSslCertName": {
              "type": "string",
              "defaultValue": "appGatewaySslCert"
            },
            "appgwTrustedRootCertName": {
              "type": "string",
              "defaultValue": "appGatewayTrustedRootCert"
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "dnsNameforApplicationGateway": {
              "type": "string",
              "defaultValue": "wlsgw"
            },
            "enableCustomSSL": {
              "type": "bool"
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "kv-contoso"
            },
            "keyVaultResourceGroup": {
              "type": "string",
              "defaultValue": "kv-contoso-rg"
            },
            "keyvaultBackendCertDataSecretName": {
              "type": "string",
              "defaultValue": "kv-ssl-backend-data"
            },
            "keyvaultFrontendCertDataSecretName": {
              "type": "string",
              "defaultValue": "kv-ssl-frontend-data"
            },
            "keyvaultFrontendCertPswSecretName": {
              "type": "string",
              "defaultValue": "kv-ssl-frontend-psw"
            },
            "location": {
              "type": "string"
            },
            "newOrExistingVnetForApplicationGateway": {
              "type": "string"
            },
            "vnetForApplicationGateway": {
              "type": "object"
            },
            "vnetRGNameForApplicationGateway": {
              "type": "string"
            }
          },
          "variables": {
            "_appgwUsePrivateIP": "[parameters('appgwUsePrivateIP')]",
            "_selfSignedFrontendCertAndNoBackendCert": "[and(empty(parameters('keyvaultFrontendCertPswSecretName')), not(parameters('enableCustomSSL')))]",
            "_selfSignedFrontendCertAndBackendCert": "[and(empty(parameters('keyvaultFrontendCertPswSecretName')), parameters('enableCustomSSL'))]",
            "_signedFrontendCertAndNoBackendCert": "[and(not(empty(parameters('keyvaultFrontendCertPswSecretName'))), not(parameters('enableCustomSSL')))]",
            "_signedFrontendCertAndBackendCert": "[and(not(empty(parameters('keyvaultFrontendCertPswSecretName'))), parameters('enableCustomSSL'))]",
            "const_null": "null",
            "name_gatewayDeploymentPrefix": "app-gateway-deployment-"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-app-gateway-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidAppgwStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[or(variables('_signedFrontendCertAndNoBackendCert'), variables('_signedFrontendCertAndBackendCert'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-app-gateway-with-custom-certificate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidAppgwWithCustomCert')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "vnet-application-gateway",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetForApplicationGateway": {
                    "value": "[parameters('vnetForApplicationGateway')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "10635494851103494132"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vnetForApplicationGateway": {
                      "type": "object",
                      "defaultValue": {
                        "name": "wlsaks-app-gateway-vnet",
                        "resourceGroup": "[resourceGroup().name]",
                        "addressPrefixes": [
                          "172.16.0.0/24"
                        ],
                        "addressPrefix": "172.16.0.0/24",
                        "newOrExisting": "new",
                        "subnets": {
                          "gatewaySubnet": {
                            "name": "wlsaks-gateway-subnet",
                            "addressPrefix": "172.16.0.0/24",
                            "startAddress": "172.16.0.4"
                          }
                        }
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_subnetAddressPrefixes": "[parameters('vnetForApplicationGateway').subnets.gatewaySubnet.addressPrefix]",
                    "const_vnetAddressPrefixes": "[parameters('vnetForApplicationGateway').addressPrefixes]",
                    "const_newVnet": "[if(equals(parameters('vnetForApplicationGateway').newOrExisting, 'new'), true(), false())]",
                    "name_nsg": "[format('wlsaks-nsg-{0}', uniqueString(parameters('utcValue')))]",
                    "name_subnet": "[parameters('vnetForApplicationGateway').subnets.gatewaySubnet.name]",
                    "name_vnet": "[parameters('vnetForApplicationGateway').name]"
                  },
                  "resources": [
                    {
                      "condition": "[variables('const_newVnet')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('name_nsg')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "securityRules": [
                          {
                            "properties": {
                              "protocol": "Tcp",
                              "sourcePortRange": "*",
                              "destinationPortRange": "65200-65535",
                              "sourceAddressPrefix": "GatewayManager",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 500,
                              "direction": "Inbound"
                            },
                            "name": "ALLOW_APPGW"
                          },
                          {
                            "properties": {
                              "protocol": "Tcp",
                              "sourcePortRange": "*",
                              "sourceAddressPrefix": "Internet",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 510,
                              "direction": "Inbound",
                              "destinationPortRanges": [
                                "80",
                                "443"
                              ]
                            },
                            "name": "ALLOW_HTTP_ACCESS"
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[variables('const_newVnet')]",
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('name_vnet')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": "[variables('const_vnetAddressPrefixes')]"
                        },
                        "subnets": [
                          {
                            "name": "[variables('name_subnet')]",
                            "properties": {
                              "addressPrefix": "[variables('const_subnetAddressPrefixes')]",
                              "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('name_nsg'))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('name_nsg'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "subIdForApplicationGateway": {
                      "type": "string",
                      "value": "[if(variables('const_newVnet'), resourceId('Microsoft.Network/virtualNetworks/subnets', variables('name_vnet'), variables('name_subnet')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetForApplicationGateway').resourceGroup), 'Microsoft.Network/virtualNetworks/subnets', variables('name_vnet'), variables('name_subnet')))]"
                    },
                    "knownIPAddress": {
                      "type": "string",
                      "value": "[parameters('vnetForApplicationGateway').subnets.gatewaySubnet.startAddress]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-app-gateway-start-deployment')]"
              ]
            },
            {
              "condition": "[parameters('appgwUsePrivateIP')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "query-available-private-ip-for-app-gateway",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')).outputs.subIdForApplicationGateway.value]"
                  },
                  "knownIP": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')).outputs.knownIPAddress.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "5370485166608561520"
                    }
                  },
                  "parameters": {
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "subnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "knownIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "base64_common": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZXhwb3J0IGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9MjAgIyBpbnRlcnZhbCBvZiBjaGVja2luZyBwb2Qgc3RhdHVzLgpleHBvcnQgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPTEwMCAjIG1heCBhdHRlbXB0IHRvIGNoZWNrIHBvZCBzdGF0dXMuCmV4cG9ydCBjaGVja1BWU3RhdGVJbnRlcnZhbD01ICMgaW50ZXJ2YWwgb2YgY2hlY2tpbmcgcHZjIHN0YXR1cy4KZXhwb3J0IGNoZWNrUFZTdGF0ZU1heEF0dGVtcHQ9MTAgIyBtYXggYXR0ZW1wdCB0byBjaGVjayBwdmMgc3RhdHVzLgpleHBvcnQgY2hlY2tTVkNTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrU1ZDSW50ZXJ2YWw9MzAgI3NlY29uZHMKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c01heEF0dGVtcHQ9MTAKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c0ludGVydmFsPTMwCmV4cG9ydCBjaGVja0luZ3Jlc3NTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrQWNySW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWNyTWF4QXR0ZW1wdD0xMApleHBvcnQgY2hlY2tBZ2ljSW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWdpY01heEF0dGVtcHQ9NTAKCmV4cG9ydCBjb25zdEFkbWluVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0FETUlOX0FERFJFU1MiCmV4cG9ydCBjb25zdEFkbWluU2VydmVyTmFtZT0nYWRtaW4tc2VydmVyJwpleHBvcnQgY29uc3RDbHVzdGVyTmFtZT0nY2x1c3Rlci0xJwpleHBvcnQgY29uc3RDbHVzdGVyVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0NMVVNURVJfQUREUkVTUyIKZXhwb3J0IGNvbnN0REJUeXBlTXlTUUw9Im15c3FsIgpleHBvcnQgY29uc3REQlR5cGVTcWxTZXJ2ZXI9InNxbHNlcnZlciIKZXhwb3J0IGNvbnN0RGVmYXVsdEphdmFPcHRpb25zPSItRGxvZzRqMi5mb3JtYXRNc2dOb0xvb2t1cHM9dHJ1ZSAtRHdlYmxvZ2ljLlN0ZG91dERlYnVnRW5hYmxlZD1mYWxzZSIgIyB0aGUgamF2YSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0SlZNQXJncz0iLURqYXZhLnNlY3VyaXR5LmVnZD1maWxlOi9kZXYvLi91cmFuZG9tIC1YbXMyNTZtIC1YbXg1MTJtIC1YWDpNaW5SQU1QZXJjZW50YWdlPTI1LjAgLVhYOk1heFJBTVBlcmNlbnRhZ2U9NTAuMCAiICMgdGhlIEpWTSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0QUtTVmVyc2lvbj0iZGVmYXVsdCIKZXhwb3J0IGV4dGVybmFsSkRCQ0xpYnJhcmllc0RpcmVjdG9yeU5hbWU9ImV4dGVybmFsSkRCQ0xpYnJhcmllcyIKZXhwb3J0IGNvbnN0RmFsc2U9ImZhbHNlIgpleHBvcnQgY29uc3RUcnVlPSJ0cnVlIgpleHBvcnQgY29uc3RJbnRyb3NwZWN0b3JKb2JBY3RpdmVEZWFkbGluZVNlY29uZHM9MzAwICAjIGZvciBHdWFyYW50ZWVkIFFvcwpleHBvcnQgY29uc3RQb3N0Z3JlRHJpdmVyTmFtZT0icG9zdGdyZXNxbC00Mi41LjEuamFyIgpleHBvcnQgY29uc3RNU1NRTERyaXZlck5hbWU9Im1zc3FsLWpkYmMtMTAuMi4xLmpyZTguamFyIgpleHBvcnQgY29uc3RBenVyZUNvcmVWZXJzaW9uPSIxLjM0LjAiCmV4cG9ydCBjb25zdERiUG9kSWRlbnRpdHlTZWxlY3Rvcj0iZGItcG9kLWlkZW50aXR5IiAjIGRvIG5vdCBjaGFuZ2UgdGhlIHZhbHVlCmV4cG9ydCBjb25zdFByZWNsYXNzRGlyZWN0b3J5TmFtZT0icHJlY2xhc3NMaWJyYXJpZXMiCgpleHBvcnQgY3VybE1heFRpbWU9MTIwICMgc2Vjb25kcwpleHBvcnQgb2NyTG9naW5TZXJ2ZXI9ImNvbnRhaW5lci1yZWdpc3RyeS5vcmFjbGUuY29tIgpleHBvcnQgb2NyR2FJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWMiCmV4cG9ydCBvY3JDcHVJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWNfY3B1IgpleHBvcnQgZ2l0VXJsNENwdUltYWdlcz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvd2VibG9naWNfY3B1X2ltYWdlcy5qc29uIgpleHBvcnQgZ2l0VXJsNEFrc1dlbGxUZXN0ZWRWZXJzaW9uSnNvbkZpbGU9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9vcmFjbGUvd2VibG9naWMtYXp1cmUvbWFpbi93ZWJsb2dpYy1henVyZS1ha3Mvc3JjL21haW4vcmVzb3VyY2VzL2Frc193ZWxsX3Rlc3RlZF92ZXJzaW9uLmpzb24iCmV4cG9ydCBnaXRVcmw0V0xTVG9vbGluZ0ZhbWlseUpzb25GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy93ZWJsb2dpY190b29saW5nX2ZhbWlseS5qc29uIgpleHBvcnQgZ2l0VXJsNEF6dXJlSWRlbnRpdHlFeHRlbnNpb25zUG9tRmlsZT0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvYXp1cmUtaWRlbnRpdHktZXh0ZW5zaW9ucy54bWwiCmV4cG9ydCBnaXRVcmw0TXlTUUxEcml2ZXJQb21GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy9teXNxbC1jb25uZWN0b3ItamF2YS54bWwiCgpleHBvcnQgb3B0VW5pbnN0YWxsTWF4VHJ5PTUgIyBNYXggYXR0ZW1wdHMgdG8gd2FpdCBmb3IgdGhlIG9wZXJhdG9yIHVuaW5zdGFsbGVkCmV4cG9ydCBvcHRVbmluc3RhbGxJbnRlcnZhbD0xMAoKZXhwb3J0IHJldHJ5TWF4QXR0ZW1wdD01ICMgcmV0cnkgYXR0ZW1wdCBmb3IgY3VybCBjb21tYW5kCmV4cG9ydCByZXRyeUludGVydmFsPTEwCgpleHBvcnQgd2xzQ29udGFpbmVyTmFtZT0id2VibG9naWMtc2VydmVyIgpleHBvcnQgd2xzUG9zdGdyZXNxbERyaXZlclVybD0iaHR0cHM6Ly9qZGJjLnBvc3RncmVzcWwub3JnL2Rvd25sb2FkL3Bvc3RncmVzcWwtNDIuNS4xLmphciIKZXhwb3J0IHdsc01TU1FMRHJpdmVyVXJsPSJodHRwczovL3JlcG8ubWF2ZW4uYXBhY2hlLm9yZy9tYXZlbjIvY29tL21pY3Jvc29mdC9zcWxzZXJ2ZXIvbXNzcWwtamRiYy8xMC4yLjEuanJlOC9tc3NxbC1qZGJjLTEwLjIuMS5qcmU4LmphciIK",
                    "base64_queryPrivateIPForAppGateway": "IyBDb3B5cmlnaHQgKGMpIDIwMjIsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgojCiMgZW52IGlucHV0czoKIyBTVUJORVRfSUQKIyBLTk9XTl9JUAoKZnVuY3Rpb24gcXVlcnlfaXAoKSB7CiAgICBlY2hvX3N0ZG91dCAiU3VibmV0IElkOiAke1NVQk5FVF9JRH0iCgogICAgIyBzZWxlY3QgYSBhdmFpbGFibGUgcHJpdmF0ZSBJUAogICAgIyBhenVyZSByZXNlcnZlcyB0aGUgZmlyc3QgMyBwcml2YXRlIElQcy4KICAgIGxvY2FsIHJldD0kKGF6IG5ldHdvcmsgdm5ldCBjaGVjay1pcC1hZGRyZXNzIFwKICAgICAgICAtLWlkcyAke1NVQk5FVF9JRH0gXAogICAgICAgIC0taXAtYWRkcmVzcyAke0tOT1dOX0lQfSkKICAgIGxvY2FsIGF2YWlsYWJsZT0kKGVjaG8gJHtyZXR9IHwganEgLXIgLmF2YWlsYWJsZSkKICAgIGlmIFtbICIke2F2YWlsYWJsZSwsfSIgPT0gInRydWUiIF1dOyB0aGVuCiAgICAgIG91dHB1dFByaXZhdGVJUD0ke0tOT1dOX0lQfQogICAgZWxzZQogICAgICBsb2NhbCBwcml2YXRlSVBBZGRyZXNzPSQoZWNobyAke3JldH0gfCBqcSAtciAuYXZhaWxhYmxlSXBBZGRyZXNzZXNbMF0pCiAgICAgIGlmIFtbIC16ICIke3ByaXZhdGVJUEFkZHJlc3N9IiBdXSB8fCBbWyAiJHtwcml2YXRlSVBBZGRyZXNzfSI9PSJudWxsIiBdXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICJFUlJPUjogbWFrZSBzdXJlIHRoZXJlIGlzIGF2YWlsYWJsZSBJUCBmb3IgYXBwbGljYXRpb24gZ2F0ZXdheSBpbiB5b3VyIHN1Ym5ldC4iCiAgICAgIGZpCgogICAgICBvdXRwdXRQcml2YXRlSVA9JHtwcml2YXRlSVBBZGRyZXNzfQogICAgZmkKfQoKZnVuY3Rpb24gb3V0cHV0X3Jlc3VsdCgpIHsKICBlY2hvICJBdmFpbGFibGUgUHJpdmF0ZSBJUDogJHtvdXRwdXRQcml2YXRlSVB9IgogIHJlc3VsdD0kKGpxIC1uIC1jIFwKICAgIC0tYXJnIHByaXZhdGVJUCAiJG91dHB1dFByaXZhdGVJUCIgXAogICAgJ3twcml2YXRlSVA6ICRwcml2YXRlSVB9JykKICBlY2hvICJyZXN1bHQgaXM6ICRyZXN1bHQiCiAgZWNobyAkcmVzdWx0ID4kQVpfU0NSSVBUU19PVVRQVVRfUEFUSAp9CgojIG1haW4gc2NyaXB0Cm91dHB1dFByaXZhdGVJUD0iMTAuMC4wLjEiCgpxdWVyeV9pcAoKb3V0cHV0X3Jlc3VsdA==",
                    "const_deploymentName": "ds-query-private-ip"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[variables('const_deploymentName')]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "scriptContent": "[format('{0}\r\n\r\n{1}', base64ToString(variables('base64_common')), base64ToString(variables('base64_queryPrivateIPForAppGateway')))]",
                        "environmentVariables": [
                          {
                            "name": "SUBNET_ID",
                            "value": "[parameters('subnetId')]"
                          },
                          {
                            "name": "KNOWN_IP",
                            "value": "[parameters('knownIP')]"
                          }
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "privateIP": {
                      "type": "string",
                      "value": "[string(reference(resourceId('Microsoft.Resources/deploymentScripts', variables('const_deploymentName'))).outputs.privateIP)]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]"
              ]
            },
            {
              "condition": "[variables('_selfSignedFrontendCertAndNoBackendCert')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}1', variables('name_gatewayDeploymentPrefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnsNameforApplicationGateway": {
                    "value": "[parameters('dnsNameforApplicationGateway')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "gatewayPublicIPAddressName": {
                    "value": "[parameters('appgwPublicIPAddressName')]"
                  },
                  "gatewaySubnetId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')).outputs.subIdForApplicationGateway.value]"
                  },
                  "gatewaySslCertName": {
                    "value": "[parameters('appgwSslCertName')]"
                  },
                  "gatewayTrustedRootCertName": {
                    "value": "[parameters('appgwTrustedRootCertName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "noSslCertPsw": {
                    "value": true
                  },
                  "sslCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultFrontendCertDataSecretName')]"
                    }
                  },
                  "sslCertPswData": {
                    "value": "[variables('const_null')]"
                  },
                  "staticPrivateFrontentIP": {
                    "value": "[if(variables('_appgwUsePrivateIP'), reference(resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway'), '2020-10-01').outputs.privateIP.value, '')]"
                  },
                  "trustedRootCertData": {
                    "value": "[variables('const_null')]"
                  },
                  "usePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "4076459226453898855"
                    }
                  },
                  "parameters": {
                    "dnsNameforApplicationGateway": {
                      "type": "string",
                      "defaultValue": "[take(format('wlsgw{0}', uniqueString(parameters('utcValue'))), 63)]",
                      "metadata": {
                        "description": "DNS for ApplicationGateway"
                      }
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "gatewayPublicIPAddressName": {
                      "type": "string",
                      "defaultValue": "gwip",
                      "metadata": {
                        "description": "Public IP Name for the Application Gateway"
                      }
                    },
                    "gatewaySubnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "gatewaySslCertName": {
                      "type": "string",
                      "defaultValue": "appGatewaySslCert"
                    },
                    "gatewayTrustedRootCertName": {
                      "type": "string",
                      "defaultValue": "appGatewayTrustedRootCert"
                    },
                    "location": {
                      "type": "string"
                    },
                    "noSslCertPsw": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "sslCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "sslCertPswData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "staticPrivateFrontentIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "trustedRootCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "usePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_sslCertPsw": "[if(parameters('noSslCertPsw'), '', parameters('sslCertPswData'))]",
                    "name_appGateway": "[format('appgw{0}', uniqueString(parameters('utcValue')))]",
                    "name_backendAddressPool": "myGatewayBackendPool",
                    "name_frontEndIPConfig": "appGwPublicFrontendIp",
                    "name_frontEndPrivateIPConfig": "appGwPrivateFrontendIp",
                    "name_httpListener": "HTTPListener",
                    "name_httpPort": "httpport",
                    "name_httpSetting": "myHTTPSetting",
                    "ref_backendAddressPool": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('name_appGateway'), variables('name_backendAddressPool'))]",
                    "ref_backendHttpSettings": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('name_appGateway'), variables('name_httpSetting'))]",
                    "ref_frontendHTTPPort": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('name_appGateway'), variables('name_httpPort'))]",
                    "ref_frontendIPConfiguration": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('name_appGateway'), variables('name_frontEndIPConfig'))]",
                    "ref_httpListener": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('name_appGateway'), variables('name_httpListener'))]",
                    "ref_publicIPAddress": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]",
                    "obj_backendTrustedRootCerts": [
                      {
                        "name": "[parameters('gatewayTrustedRootCertName')]",
                        "properties": {
                          "data": "[parameters('trustedRootCertData')]"
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations1": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations2": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      },
                      {
                        "name": "[variables('name_frontEndPrivateIPConfig')]",
                        "properties": {
                          "privateIPAllocationMethod": "Static",
                          "privateIPAddress": "[parameters('staticPrivateFrontentIP')]",
                          "subnet": {
                            "id": "[parameters('gatewaySubnetId')]"
                          }
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('gatewayPublicIPAddressName')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsNameforApplicationGateway')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/applicationGateways",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('name_appGateway')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "managed-by-k8s-ingress": "true"
                      },
                      "properties": {
                        "sku": {
                          "name": "WAF_v2",
                          "tier": "WAF_v2"
                        },
                        "sslCertificates": [
                          {
                            "name": "[parameters('gatewaySslCertName')]",
                            "properties": {
                              "data": "[parameters('sslCertData')]",
                              "password": "[variables('const_sslCertPsw')]"
                            }
                          }
                        ],
                        "trustedRootCertificates": "[if(parameters('enableCustomSSL'), variables('obj_backendTrustedRootCerts'), createArray())]",
                        "gatewayIPConfigurations": [
                          {
                            "name": "appGatewayIpConfig",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('gatewaySubnetId')]"
                              }
                            }
                          }
                        ],
                        "frontendIPConfigurations": "[if(parameters('usePrivateIP'), variables('obj_frontendIPConfigurations2'), variables('obj_frontendIPConfigurations1'))]",
                        "frontendPorts": [
                          {
                            "name": "[variables('name_httpPort')]",
                            "properties": {
                              "port": 80
                            }
                          }
                        ],
                        "backendAddressPools": [
                          {
                            "name": "myGatewayBackendPool"
                          }
                        ],
                        "httpListeners": [
                          {
                            "name": "[variables('name_httpListener')]",
                            "properties": {
                              "protocol": "Http",
                              "frontendIPConfiguration": {
                                "id": "[variables('ref_frontendIPConfiguration')]"
                              },
                              "frontendPort": {
                                "id": "[variables('ref_frontendHTTPPort')]"
                              }
                            }
                          }
                        ],
                        "backendHttpSettingsCollection": [
                          {
                            "name": "[variables('name_httpSetting')]",
                            "properties": {
                              "port": 80,
                              "protocol": "Http"
                            }
                          }
                        ],
                        "requestRoutingRules": [
                          {
                            "name": "HTTPRoutingRule",
                            "properties": {
                              "priority": 3,
                              "httpListener": {
                                "id": "[variables('ref_httpListener')]"
                              },
                              "backendAddressPool": {
                                "id": "[variables('ref_backendAddressPool')]"
                              },
                              "backendHttpSettings": {
                                "id": "[variables('ref_backendHttpSettings')]"
                              }
                            }
                          }
                        ],
                        "webApplicationFirewallConfiguration": {
                          "enabled": true,
                          "firewallMode": "Prevention",
                          "ruleSetType": "OWASP",
                          "ruleSetVersion": "3.0"
                        },
                        "enableHttp2": false,
                        "autoscaleConfiguration": {
                          "minCapacity": 2,
                          "maxCapacity": 3
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "appGatewayAlias": {
                      "type": "string",
                      "value": "[if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)]"
                    },
                    "appGatewayId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/applicationGateways', variables('name_appGateway'))]"
                    },
                    "appGatewayName": {
                      "type": "string",
                      "value": "[variables('name_appGateway')]"
                    },
                    "appGatewayURL": {
                      "type": "string",
                      "value": "[uri(format('http://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    },
                    "appGatewaySecuredURL": {
                      "type": "string",
                      "value": "[uri(format('https://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]",
                "[resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway')]"
              ]
            },
            {
              "condition": "[variables('_selfSignedFrontendCertAndBackendCert')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}2', variables('name_gatewayDeploymentPrefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnsNameforApplicationGateway": {
                    "value": "[parameters('dnsNameforApplicationGateway')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "gatewayPublicIPAddressName": {
                    "value": "[parameters('appgwPublicIPAddressName')]"
                  },
                  "gatewaySubnetId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')).outputs.subIdForApplicationGateway.value]"
                  },
                  "gatewaySslCertName": {
                    "value": "[parameters('appgwSslCertName')]"
                  },
                  "gatewayTrustedRootCertName": {
                    "value": "[parameters('appgwTrustedRootCertName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "noSslCertPsw": {
                    "value": true
                  },
                  "sslCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultFrontendCertDataSecretName')]"
                    }
                  },
                  "sslCertPswData": {
                    "value": "[variables('const_null')]"
                  },
                  "staticPrivateFrontentIP": {
                    "value": "[if(variables('_appgwUsePrivateIP'), reference(resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway'), '2020-10-01').outputs.privateIP.value, '')]"
                  },
                  "trustedRootCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultBackendCertDataSecretName')]"
                    }
                  },
                  "usePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "4076459226453898855"
                    }
                  },
                  "parameters": {
                    "dnsNameforApplicationGateway": {
                      "type": "string",
                      "defaultValue": "[take(format('wlsgw{0}', uniqueString(parameters('utcValue'))), 63)]",
                      "metadata": {
                        "description": "DNS for ApplicationGateway"
                      }
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "gatewayPublicIPAddressName": {
                      "type": "string",
                      "defaultValue": "gwip",
                      "metadata": {
                        "description": "Public IP Name for the Application Gateway"
                      }
                    },
                    "gatewaySubnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "gatewaySslCertName": {
                      "type": "string",
                      "defaultValue": "appGatewaySslCert"
                    },
                    "gatewayTrustedRootCertName": {
                      "type": "string",
                      "defaultValue": "appGatewayTrustedRootCert"
                    },
                    "location": {
                      "type": "string"
                    },
                    "noSslCertPsw": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "sslCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "sslCertPswData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "staticPrivateFrontentIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "trustedRootCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "usePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_sslCertPsw": "[if(parameters('noSslCertPsw'), '', parameters('sslCertPswData'))]",
                    "name_appGateway": "[format('appgw{0}', uniqueString(parameters('utcValue')))]",
                    "name_backendAddressPool": "myGatewayBackendPool",
                    "name_frontEndIPConfig": "appGwPublicFrontendIp",
                    "name_frontEndPrivateIPConfig": "appGwPrivateFrontendIp",
                    "name_httpListener": "HTTPListener",
                    "name_httpPort": "httpport",
                    "name_httpSetting": "myHTTPSetting",
                    "ref_backendAddressPool": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('name_appGateway'), variables('name_backendAddressPool'))]",
                    "ref_backendHttpSettings": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('name_appGateway'), variables('name_httpSetting'))]",
                    "ref_frontendHTTPPort": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('name_appGateway'), variables('name_httpPort'))]",
                    "ref_frontendIPConfiguration": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('name_appGateway'), variables('name_frontEndIPConfig'))]",
                    "ref_httpListener": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('name_appGateway'), variables('name_httpListener'))]",
                    "ref_publicIPAddress": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]",
                    "obj_backendTrustedRootCerts": [
                      {
                        "name": "[parameters('gatewayTrustedRootCertName')]",
                        "properties": {
                          "data": "[parameters('trustedRootCertData')]"
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations1": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations2": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      },
                      {
                        "name": "[variables('name_frontEndPrivateIPConfig')]",
                        "properties": {
                          "privateIPAllocationMethod": "Static",
                          "privateIPAddress": "[parameters('staticPrivateFrontentIP')]",
                          "subnet": {
                            "id": "[parameters('gatewaySubnetId')]"
                          }
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('gatewayPublicIPAddressName')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsNameforApplicationGateway')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/applicationGateways",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('name_appGateway')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "managed-by-k8s-ingress": "true"
                      },
                      "properties": {
                        "sku": {
                          "name": "WAF_v2",
                          "tier": "WAF_v2"
                        },
                        "sslCertificates": [
                          {
                            "name": "[parameters('gatewaySslCertName')]",
                            "properties": {
                              "data": "[parameters('sslCertData')]",
                              "password": "[variables('const_sslCertPsw')]"
                            }
                          }
                        ],
                        "trustedRootCertificates": "[if(parameters('enableCustomSSL'), variables('obj_backendTrustedRootCerts'), createArray())]",
                        "gatewayIPConfigurations": [
                          {
                            "name": "appGatewayIpConfig",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('gatewaySubnetId')]"
                              }
                            }
                          }
                        ],
                        "frontendIPConfigurations": "[if(parameters('usePrivateIP'), variables('obj_frontendIPConfigurations2'), variables('obj_frontendIPConfigurations1'))]",
                        "frontendPorts": [
                          {
                            "name": "[variables('name_httpPort')]",
                            "properties": {
                              "port": 80
                            }
                          }
                        ],
                        "backendAddressPools": [
                          {
                            "name": "myGatewayBackendPool"
                          }
                        ],
                        "httpListeners": [
                          {
                            "name": "[variables('name_httpListener')]",
                            "properties": {
                              "protocol": "Http",
                              "frontendIPConfiguration": {
                                "id": "[variables('ref_frontendIPConfiguration')]"
                              },
                              "frontendPort": {
                                "id": "[variables('ref_frontendHTTPPort')]"
                              }
                            }
                          }
                        ],
                        "backendHttpSettingsCollection": [
                          {
                            "name": "[variables('name_httpSetting')]",
                            "properties": {
                              "port": 80,
                              "protocol": "Http"
                            }
                          }
                        ],
                        "requestRoutingRules": [
                          {
                            "name": "HTTPRoutingRule",
                            "properties": {
                              "priority": 3,
                              "httpListener": {
                                "id": "[variables('ref_httpListener')]"
                              },
                              "backendAddressPool": {
                                "id": "[variables('ref_backendAddressPool')]"
                              },
                              "backendHttpSettings": {
                                "id": "[variables('ref_backendHttpSettings')]"
                              }
                            }
                          }
                        ],
                        "webApplicationFirewallConfiguration": {
                          "enabled": true,
                          "firewallMode": "Prevention",
                          "ruleSetType": "OWASP",
                          "ruleSetVersion": "3.0"
                        },
                        "enableHttp2": false,
                        "autoscaleConfiguration": {
                          "minCapacity": 2,
                          "maxCapacity": 3
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "appGatewayAlias": {
                      "type": "string",
                      "value": "[if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)]"
                    },
                    "appGatewayId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/applicationGateways', variables('name_appGateway'))]"
                    },
                    "appGatewayName": {
                      "type": "string",
                      "value": "[variables('name_appGateway')]"
                    },
                    "appGatewayURL": {
                      "type": "string",
                      "value": "[uri(format('http://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    },
                    "appGatewaySecuredURL": {
                      "type": "string",
                      "value": "[uri(format('https://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]",
                "[resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway')]"
              ]
            },
            {
              "condition": "[variables('_signedFrontendCertAndNoBackendCert')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}3', variables('name_gatewayDeploymentPrefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnsNameforApplicationGateway": {
                    "value": "[parameters('dnsNameforApplicationGateway')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "gatewayPublicIPAddressName": {
                    "value": "[parameters('appgwPublicIPAddressName')]"
                  },
                  "gatewaySubnetId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')).outputs.subIdForApplicationGateway.value]"
                  },
                  "gatewaySslCertName": {
                    "value": "[parameters('appgwSslCertName')]"
                  },
                  "gatewayTrustedRootCertName": {
                    "value": "[parameters('appgwTrustedRootCertName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sslCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultFrontendCertDataSecretName')]"
                    }
                  },
                  "sslCertPswData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultFrontendCertPswSecretName')]"
                    }
                  },
                  "staticPrivateFrontentIP": {
                    "value": "[if(variables('_appgwUsePrivateIP'), reference(resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway'), '2020-10-01').outputs.privateIP.value, '')]"
                  },
                  "trustedRootCertData": {
                    "value": "[variables('const_null')]"
                  },
                  "usePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "4076459226453898855"
                    }
                  },
                  "parameters": {
                    "dnsNameforApplicationGateway": {
                      "type": "string",
                      "defaultValue": "[take(format('wlsgw{0}', uniqueString(parameters('utcValue'))), 63)]",
                      "metadata": {
                        "description": "DNS for ApplicationGateway"
                      }
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "gatewayPublicIPAddressName": {
                      "type": "string",
                      "defaultValue": "gwip",
                      "metadata": {
                        "description": "Public IP Name for the Application Gateway"
                      }
                    },
                    "gatewaySubnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "gatewaySslCertName": {
                      "type": "string",
                      "defaultValue": "appGatewaySslCert"
                    },
                    "gatewayTrustedRootCertName": {
                      "type": "string",
                      "defaultValue": "appGatewayTrustedRootCert"
                    },
                    "location": {
                      "type": "string"
                    },
                    "noSslCertPsw": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "sslCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "sslCertPswData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "staticPrivateFrontentIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "trustedRootCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "usePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_sslCertPsw": "[if(parameters('noSslCertPsw'), '', parameters('sslCertPswData'))]",
                    "name_appGateway": "[format('appgw{0}', uniqueString(parameters('utcValue')))]",
                    "name_backendAddressPool": "myGatewayBackendPool",
                    "name_frontEndIPConfig": "appGwPublicFrontendIp",
                    "name_frontEndPrivateIPConfig": "appGwPrivateFrontendIp",
                    "name_httpListener": "HTTPListener",
                    "name_httpPort": "httpport",
                    "name_httpSetting": "myHTTPSetting",
                    "ref_backendAddressPool": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('name_appGateway'), variables('name_backendAddressPool'))]",
                    "ref_backendHttpSettings": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('name_appGateway'), variables('name_httpSetting'))]",
                    "ref_frontendHTTPPort": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('name_appGateway'), variables('name_httpPort'))]",
                    "ref_frontendIPConfiguration": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('name_appGateway'), variables('name_frontEndIPConfig'))]",
                    "ref_httpListener": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('name_appGateway'), variables('name_httpListener'))]",
                    "ref_publicIPAddress": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]",
                    "obj_backendTrustedRootCerts": [
                      {
                        "name": "[parameters('gatewayTrustedRootCertName')]",
                        "properties": {
                          "data": "[parameters('trustedRootCertData')]"
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations1": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations2": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      },
                      {
                        "name": "[variables('name_frontEndPrivateIPConfig')]",
                        "properties": {
                          "privateIPAllocationMethod": "Static",
                          "privateIPAddress": "[parameters('staticPrivateFrontentIP')]",
                          "subnet": {
                            "id": "[parameters('gatewaySubnetId')]"
                          }
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('gatewayPublicIPAddressName')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsNameforApplicationGateway')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/applicationGateways",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('name_appGateway')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "managed-by-k8s-ingress": "true"
                      },
                      "properties": {
                        "sku": {
                          "name": "WAF_v2",
                          "tier": "WAF_v2"
                        },
                        "sslCertificates": [
                          {
                            "name": "[parameters('gatewaySslCertName')]",
                            "properties": {
                              "data": "[parameters('sslCertData')]",
                              "password": "[variables('const_sslCertPsw')]"
                            }
                          }
                        ],
                        "trustedRootCertificates": "[if(parameters('enableCustomSSL'), variables('obj_backendTrustedRootCerts'), createArray())]",
                        "gatewayIPConfigurations": [
                          {
                            "name": "appGatewayIpConfig",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('gatewaySubnetId')]"
                              }
                            }
                          }
                        ],
                        "frontendIPConfigurations": "[if(parameters('usePrivateIP'), variables('obj_frontendIPConfigurations2'), variables('obj_frontendIPConfigurations1'))]",
                        "frontendPorts": [
                          {
                            "name": "[variables('name_httpPort')]",
                            "properties": {
                              "port": 80
                            }
                          }
                        ],
                        "backendAddressPools": [
                          {
                            "name": "myGatewayBackendPool"
                          }
                        ],
                        "httpListeners": [
                          {
                            "name": "[variables('name_httpListener')]",
                            "properties": {
                              "protocol": "Http",
                              "frontendIPConfiguration": {
                                "id": "[variables('ref_frontendIPConfiguration')]"
                              },
                              "frontendPort": {
                                "id": "[variables('ref_frontendHTTPPort')]"
                              }
                            }
                          }
                        ],
                        "backendHttpSettingsCollection": [
                          {
                            "name": "[variables('name_httpSetting')]",
                            "properties": {
                              "port": 80,
                              "protocol": "Http"
                            }
                          }
                        ],
                        "requestRoutingRules": [
                          {
                            "name": "HTTPRoutingRule",
                            "properties": {
                              "priority": 3,
                              "httpListener": {
                                "id": "[variables('ref_httpListener')]"
                              },
                              "backendAddressPool": {
                                "id": "[variables('ref_backendAddressPool')]"
                              },
                              "backendHttpSettings": {
                                "id": "[variables('ref_backendHttpSettings')]"
                              }
                            }
                          }
                        ],
                        "webApplicationFirewallConfiguration": {
                          "enabled": true,
                          "firewallMode": "Prevention",
                          "ruleSetType": "OWASP",
                          "ruleSetVersion": "3.0"
                        },
                        "enableHttp2": false,
                        "autoscaleConfiguration": {
                          "minCapacity": 2,
                          "maxCapacity": 3
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "appGatewayAlias": {
                      "type": "string",
                      "value": "[if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)]"
                    },
                    "appGatewayId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/applicationGateways', variables('name_appGateway'))]"
                    },
                    "appGatewayName": {
                      "type": "string",
                      "value": "[variables('name_appGateway')]"
                    },
                    "appGatewayURL": {
                      "type": "string",
                      "value": "[uri(format('http://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    },
                    "appGatewaySecuredURL": {
                      "type": "string",
                      "value": "[uri(format('https://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]",
                "[resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway')]"
              ]
            },
            {
              "condition": "[variables('_signedFrontendCertAndBackendCert')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}4', variables('name_gatewayDeploymentPrefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnsNameforApplicationGateway": {
                    "value": "[parameters('dnsNameforApplicationGateway')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "gatewayPublicIPAddressName": {
                    "value": "[parameters('appgwPublicIPAddressName')]"
                  },
                  "gatewaySubnetId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')).outputs.subIdForApplicationGateway.value]"
                  },
                  "gatewaySslCertName": {
                    "value": "[parameters('appgwSslCertName')]"
                  },
                  "gatewayTrustedRootCertName": {
                    "value": "[parameters('appgwTrustedRootCertName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sslCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultFrontendCertDataSecretName')]"
                    }
                  },
                  "sslCertPswData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultFrontendCertPswSecretName')]"
                    }
                  },
                  "staticPrivateFrontentIP": {
                    "value": "[if(variables('_appgwUsePrivateIP'), reference(resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway'), '2020-10-01').outputs.privateIP.value, '')]"
                  },
                  "trustedRootCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultBackendCertDataSecretName')]"
                    }
                  },
                  "usePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "4076459226453898855"
                    }
                  },
                  "parameters": {
                    "dnsNameforApplicationGateway": {
                      "type": "string",
                      "defaultValue": "[take(format('wlsgw{0}', uniqueString(parameters('utcValue'))), 63)]",
                      "metadata": {
                        "description": "DNS for ApplicationGateway"
                      }
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "gatewayPublicIPAddressName": {
                      "type": "string",
                      "defaultValue": "gwip",
                      "metadata": {
                        "description": "Public IP Name for the Application Gateway"
                      }
                    },
                    "gatewaySubnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "gatewaySslCertName": {
                      "type": "string",
                      "defaultValue": "appGatewaySslCert"
                    },
                    "gatewayTrustedRootCertName": {
                      "type": "string",
                      "defaultValue": "appGatewayTrustedRootCert"
                    },
                    "location": {
                      "type": "string"
                    },
                    "noSslCertPsw": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "sslCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "sslCertPswData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "staticPrivateFrontentIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "trustedRootCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "usePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_sslCertPsw": "[if(parameters('noSslCertPsw'), '', parameters('sslCertPswData'))]",
                    "name_appGateway": "[format('appgw{0}', uniqueString(parameters('utcValue')))]",
                    "name_backendAddressPool": "myGatewayBackendPool",
                    "name_frontEndIPConfig": "appGwPublicFrontendIp",
                    "name_frontEndPrivateIPConfig": "appGwPrivateFrontendIp",
                    "name_httpListener": "HTTPListener",
                    "name_httpPort": "httpport",
                    "name_httpSetting": "myHTTPSetting",
                    "ref_backendAddressPool": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('name_appGateway'), variables('name_backendAddressPool'))]",
                    "ref_backendHttpSettings": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('name_appGateway'), variables('name_httpSetting'))]",
                    "ref_frontendHTTPPort": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('name_appGateway'), variables('name_httpPort'))]",
                    "ref_frontendIPConfiguration": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('name_appGateway'), variables('name_frontEndIPConfig'))]",
                    "ref_httpListener": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('name_appGateway'), variables('name_httpListener'))]",
                    "ref_publicIPAddress": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]",
                    "obj_backendTrustedRootCerts": [
                      {
                        "name": "[parameters('gatewayTrustedRootCertName')]",
                        "properties": {
                          "data": "[parameters('trustedRootCertData')]"
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations1": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations2": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      },
                      {
                        "name": "[variables('name_frontEndPrivateIPConfig')]",
                        "properties": {
                          "privateIPAllocationMethod": "Static",
                          "privateIPAddress": "[parameters('staticPrivateFrontentIP')]",
                          "subnet": {
                            "id": "[parameters('gatewaySubnetId')]"
                          }
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('gatewayPublicIPAddressName')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsNameforApplicationGateway')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/applicationGateways",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('name_appGateway')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "managed-by-k8s-ingress": "true"
                      },
                      "properties": {
                        "sku": {
                          "name": "WAF_v2",
                          "tier": "WAF_v2"
                        },
                        "sslCertificates": [
                          {
                            "name": "[parameters('gatewaySslCertName')]",
                            "properties": {
                              "data": "[parameters('sslCertData')]",
                              "password": "[variables('const_sslCertPsw')]"
                            }
                          }
                        ],
                        "trustedRootCertificates": "[if(parameters('enableCustomSSL'), variables('obj_backendTrustedRootCerts'), createArray())]",
                        "gatewayIPConfigurations": [
                          {
                            "name": "appGatewayIpConfig",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('gatewaySubnetId')]"
                              }
                            }
                          }
                        ],
                        "frontendIPConfigurations": "[if(parameters('usePrivateIP'), variables('obj_frontendIPConfigurations2'), variables('obj_frontendIPConfigurations1'))]",
                        "frontendPorts": [
                          {
                            "name": "[variables('name_httpPort')]",
                            "properties": {
                              "port": 80
                            }
                          }
                        ],
                        "backendAddressPools": [
                          {
                            "name": "myGatewayBackendPool"
                          }
                        ],
                        "httpListeners": [
                          {
                            "name": "[variables('name_httpListener')]",
                            "properties": {
                              "protocol": "Http",
                              "frontendIPConfiguration": {
                                "id": "[variables('ref_frontendIPConfiguration')]"
                              },
                              "frontendPort": {
                                "id": "[variables('ref_frontendHTTPPort')]"
                              }
                            }
                          }
                        ],
                        "backendHttpSettingsCollection": [
                          {
                            "name": "[variables('name_httpSetting')]",
                            "properties": {
                              "port": 80,
                              "protocol": "Http"
                            }
                          }
                        ],
                        "requestRoutingRules": [
                          {
                            "name": "HTTPRoutingRule",
                            "properties": {
                              "priority": 3,
                              "httpListener": {
                                "id": "[variables('ref_httpListener')]"
                              },
                              "backendAddressPool": {
                                "id": "[variables('ref_backendAddressPool')]"
                              },
                              "backendHttpSettings": {
                                "id": "[variables('ref_backendHttpSettings')]"
                              }
                            }
                          }
                        ],
                        "webApplicationFirewallConfiguration": {
                          "enabled": true,
                          "firewallMode": "Prevention",
                          "ruleSetType": "OWASP",
                          "ruleSetVersion": "3.0"
                        },
                        "enableHttp2": false,
                        "autoscaleConfiguration": {
                          "minCapacity": 2,
                          "maxCapacity": 3
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "appGatewayAlias": {
                      "type": "string",
                      "value": "[if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)]"
                    },
                    "appGatewayId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/applicationGateways', variables('name_appGateway'))]"
                    },
                    "appGatewayName": {
                      "type": "string",
                      "value": "[variables('name_appGateway')]"
                    },
                    "appGatewayURL": {
                      "type": "string",
                      "value": "[uri(format('http://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    },
                    "appGatewaySecuredURL": {
                      "type": "string",
                      "value": "[uri(format('https://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]",
                "[resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-app-gateway-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidAppgwEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('{0}1', variables('name_gatewayDeploymentPrefix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}2', variables('name_gatewayDeploymentPrefix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}3', variables('name_gatewayDeploymentPrefix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}4', variables('name_gatewayDeploymentPrefix')))]"
              ]
            }
          ],
          "outputs": {
            "appGatewayAlias": {
              "type": "string",
              "value": "[if(variables('_selfSignedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}1', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_selfSignedFrontendCertAndBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}2', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_signedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}3', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', format('{0}4', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs))).appGatewayAlias.value]"
            },
            "appGatewayId": {
              "type": "string",
              "value": "[if(variables('_selfSignedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}1', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_selfSignedFrontendCertAndBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}2', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_signedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}3', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', format('{0}4', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs))).appGatewayId.value]"
            },
            "appGatewayName": {
              "type": "string",
              "value": "[if(variables('_selfSignedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}1', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_selfSignedFrontendCertAndBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}2', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_signedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}3', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', format('{0}4', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs))).appGatewayName.value]"
            },
            "appGatewayURL": {
              "type": "string",
              "value": "[uri(if(variables('_selfSignedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}1', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_selfSignedFrontendCertAndBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}2', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_signedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}3', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', format('{0}4', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs))).appGatewayURL.value, '')]"
            },
            "appGatewaySecuredURL": {
              "type": "string",
              "value": "[uri(if(variables('_selfSignedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}1', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_selfSignedFrontendCertAndBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}2', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, if(variables('_signedFrontendCertAndNoBackendCert'), reference(resourceId('Microsoft.Resources/deployments', format('{0}3', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', format('{0}4', variables('name_gatewayDeploymentPrefix'))), '2020-10-01').outputs))).appGatewaySecuredURL.value, '')]"
            },
            "vnetResourceGroupName": {
              "type": "string",
              "value": "[parameters('vnetRGNameForApplicationGateway')]"
            },
            "newOrExisting": {
              "type": "string",
              "value": "[parameters('newOrExistingVnetForApplicationGateway')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]"
      ]
    },
    {
      "condition": "[not(parameters('enableCustomSSL'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "setup-wls-cluster",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSEnd.value)]"
          },
          "_pidSSLEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.sslEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.sslEnd.value)]"
          },
          "_pidSSLStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.sslStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.sslStart.value)]"
          },
          "_pidStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSStart.value)]"
          },
          "aciResourcePermissions": {
            "value": "[parameters('aciResourcePermissions')]"
          },
          "aciRetentionInDays": {
            "value": "[parameters('aciRetentionInDays')]"
          },
          "aciWorkspaceSku": {
            "value": "[parameters('aciWorkspaceSku')]"
          },
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')).outputs.acrName.value]"
          },
          "acrResourceGroupName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')).outputs.acrResourceGroupName.value]"
          },
          "aksAgentPoolName": {
            "value": "[parameters('aksAgentPoolName')]"
          },
          "aksAgentPoolNodeCount": {
            "value": "[parameters('aksAgentPoolNodeCount')]"
          },
          "vmSize": {
            "value": "[parameters('vmSize')]"
          },
          "aksClusterNamePrefix": {
            "value": "[parameters('aksClusterNamePrefix')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')).outputs.aksVersion.value]"
          },
          "appPackageUrls": {
            "value": "[parameters('appPackageUrls')]"
          },
          "appReplicas": {
            "value": "[parameters('appReplicas')]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createStorageAccount": {
            "value": "[and(or(parameters('createAKSCluster'), not(and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null'))))), variables('const_enablePV'))]"
          },
          "databaseType": {
            "value": "[parameters('databaseType')]"
          },
          "dbDriverLibrariesUrls": {
            "value": "[parameters('dbDriverLibrariesUrls')]"
          },
          "enableAzureMonitoring": {
            "value": "[parameters('enableAzureMonitoring')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableAdminT3Tunneling": {
            "value": "[parameters('enableAdminT3Tunneling')]"
          },
          "enableClusterT3Tunneling": {
            "value": "[parameters('enableClusterT3Tunneling')]"
          },
          "enablePswlessConnection": {
            "value": "[parameters('enablePswlessConnection')]"
          },
          "enablePV": {
            "value": "[variables('const_enablePV')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "isSSOSupportEntitled": {
            "value": "[parameters('isSSOSupportEntitled')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "managedServerPrefix": {
            "value": "[parameters('managedServerPrefix')]"
          },
          "ocrSSOPSW": {
            "value": "[parameters('ocrSSOPSW')]"
          },
          "ocrSSOUser": {
            "value": "[parameters('ocrSSOUser')]"
          },
          "storageAccountName": {
            "value": "[if(and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null'))), reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, format('wls{0}', uniqueString(parameters('utcValue'))))]"
          },
          "t3ChannelAdminPort": {
            "value": "[parameters('t3ChannelAdminPort')]"
          },
          "t3ChannelClusterPort": {
            "value": "[parameters('t3ChannelClusterPort')]"
          },
          "wdtRuntimePassword": {
            "value": "[parameters('wdtRuntimePassword')]"
          },
          "userProvidedAcr": {
            "value": "[parameters('userProvidedAcr')]"
          },
          "userProvidedAcrRgName": {
            "value": "[parameters('userProvidedAcrRgName')]"
          },
          "userProvidedImagePath": {
            "value": "[parameters('userProvidedImagePath')]"
          },
          "useOracleImage": {
            "value": "[parameters('useOracleImage')]"
          },
          "wlsClusterSize": {
            "value": "[parameters('wlsClusterSize')]"
          },
          "wlsCPU": {
            "value": "[parameters('wlsCPU')]"
          },
          "wlsDomainName": {
            "value": "[parameters('wlsDomainName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsIdentityKeyStoreData": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
          },
          "wlsIdentityKeyStorePassphrase": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
          },
          "wlsIdentityKeyStoreType": {
            "value": "[variables('const_defaultKeystoreType')]"
          },
          "wlsImageTag": {
            "value": "[parameters('wlsImageTag')]"
          },
          "wlsJavaOption": {
            "value": "[variables('const_wlsJavaOptions')]"
          },
          "wlsMemory": {
            "value": "[parameters('wlsMemory')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsPrivateKeyAlias": {
            "value": "[parameters('sslUploadedPrivateKeyAlias')]"
          },
          "wlsPrivateKeyPassPhrase": {
            "value": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
          },
          "wlsTrustKeyStoreData": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
          },
          "wlsTrustKeyStorePassPhrase": {
            "value": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
          },
          "wlsTrustKeyStoreType": {
            "value": "[variables('const_defaultKeystoreType')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "15395910228669165274"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": "pid-wls-end"
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": "pid-wls-start"
            },
            "_pidSSLEnd": {
              "type": "string",
              "defaultValue": "pid-ssl-end"
            },
            "_pidSSLStart": {
              "type": "string",
              "defaultValue": "pid-ssl-start"
            },
            "aciResourcePermissions": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to use resource or workspace permissions. false to require workspace permissions."
              }
            },
            "aciRetentionInDays": {
              "type": "int",
              "defaultValue": 120,
              "metadata": {
                "description": "Number of days to retain data in Azure Monitor workspace."
              }
            },
            "aciWorkspaceSku": {
              "type": "string",
              "defaultValue": "pergb2018",
              "metadata": {
                "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
              }
            },
            "acrName": {
              "type": "string",
              "defaultValue": ""
            },
            "acrResourceGroupName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksAgentPoolName": {
              "type": "string",
              "defaultValue": "agentpool",
              "metadata": {
                "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
              },
              "minLength": 1,
              "maxLength": 12
            },
            "aksAgentPoolNodeCount": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
              },
              "minValue": 1,
              "maxValue": 10000
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_DS2_v2",
              "metadata": {
                "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
              }
            },
            "aksClusterNamePrefix": {
              "type": "string",
              "defaultValue": "wlsonaks",
              "metadata": {
                "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource group name of an existing AKS cluster."
              }
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksVersion": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "The AKS version."
              }
            },
            "appPackageUrls": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Urls of Java EE application packages."
              }
            },
            "appReplicas": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "The number of managed server to start."
              }
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "createAKSCluster": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to create a new AKS cluster."
              }
            },
            "createStorageAccount": {
              "type": "bool",
              "defaultValue": false
            },
            "databaseType": {
              "type": "string",
              "defaultValue": "oracle"
            },
            "dbDriverLibrariesUrls": {
              "type": "array",
              "defaultValue": []
            },
            "enableAzureMonitoring": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
              }
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to create persistent volume using file share."
              }
            },
            "enableAdminT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enableClusterT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enablePswlessConnection": {
              "type": "bool",
              "defaultValue": false
            },
            "enablePV": {
              "type": "bool",
              "defaultValue": false
            },
            "identity": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "An user assigned managed identity. Make sure the identity has permission to create/update/delete/list Azure resources."
              }
            },
            "isSSOSupportEntitled": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "managedServerPrefix": {
              "type": "string",
              "defaultValue": "managed-server",
              "metadata": {
                "description": "Name prefix of managed server."
              }
            },
            "ocrSSOPSW": {
              "type": "secureString",
              "metadata": {
                "description": "Password of Oracle SSO account."
              }
            },
            "ocrSSOUser": {
              "type": "string",
              "metadata": {
                "description": "User name of Oracle SSO account."
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "stg-contoso"
            },
            "t3ChannelAdminPort": {
              "type": "int",
              "defaultValue": 7005
            },
            "t3ChannelClusterPort": {
              "type": "int",
              "defaultValue": 8011
            },
            "userProvidedAcr": {
              "type": "string",
              "defaultValue": "null"
            },
            "userProvidedAcrRgName": {
              "type": "string",
              "defaultValue": "null"
            },
            "userProvidedImagePath": {
              "type": "string",
              "defaultValue": "null"
            },
            "useOracleImage": {
              "type": "bool",
              "defaultValue": true
            },
            "wdtRuntimePassword": {
              "type": "secureString",
              "metadata": {
                "description": "Password for model WebLogic Deploy Tooling runtime encrytion."
              }
            },
            "wlsClusterSize": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Maximum cluster size."
              }
            },
            "wlsCPU": {
              "type": "string",
              "defaultValue": "200m",
              "metadata": {
                "description": "Requests for CPU resources for admin server and managed server."
              }
            },
            "wlsDomainName": {
              "type": "string",
              "defaultValue": "domain1",
              "metadata": {
                "description": "Name of WebLogic domain to create."
              }
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsIdentityKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStorePassphrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsImageTag": {
              "type": "string",
              "defaultValue": "12.2.1.4",
              "metadata": {
                "description": "Docker tag that comes after \"container-registry.oracle.com/middleware/weblogic:\""
              }
            },
            "wlsJavaOption": {
              "type": "string",
              "defaultValue": "null"
            },
            "wlsMemory": {
              "type": "string",
              "defaultValue": "1.5Gi",
              "metadata": {
                "description": "Memory requests for admin server and managed server."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsPrivateKeyAlias": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyPassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStorePassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableCustomSSL')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-ssl-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidSSLStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('createAKSCluster')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "aks-cluster-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aciResourcePermissions": {
                    "value": "[parameters('aciResourcePermissions')]"
                  },
                  "aciRetentionInDays": {
                    "value": "[parameters('aciRetentionInDays')]"
                  },
                  "aciWorkspaceSku": {
                    "value": "[parameters('aciWorkspaceSku')]"
                  },
                  "aksAgentPoolName": {
                    "value": "[parameters('aksAgentPoolName')]"
                  },
                  "aksAgentPoolNodeCount": {
                    "value": "[parameters('aksAgentPoolNodeCount')]"
                  },
                  "aksAgentPoolVMSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "aksClusterNamePrefix": {
                    "value": "[parameters('aksClusterNamePrefix')]"
                  },
                  "aksVersion": {
                    "value": "[parameters('aksVersion')]"
                  },
                  "enableAzureMonitoring": {
                    "value": "[parameters('enableAzureMonitoring')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "11591397974282754947"
                    }
                  },
                  "parameters": {
                    "aciResourcePermissions": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "true to use resource or workspace permissions. false to require workspace permissions."
                      }
                    },
                    "aciRetentionInDays": {
                      "type": "int",
                      "defaultValue": 120,
                      "metadata": {
                        "description": "Number of days to retain data in Azure Monitor workspace."
                      }
                    },
                    "aciWorkspaceSku": {
                      "type": "string",
                      "defaultValue": "pergb2018",
                      "metadata": {
                        "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
                      }
                    },
                    "aksAgentPoolName": {
                      "type": "string",
                      "defaultValue": "agentpool",
                      "metadata": {
                        "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
                      },
                      "minLength": 1,
                      "maxLength": 12
                    },
                    "aksAgentPoolNodeCount": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
                      },
                      "minValue": 1,
                      "maxValue": 10000
                    },
                    "aksAgentPoolVMSize": {
                      "type": "string",
                      "defaultValue": "Standard_DS2_v2",
                      "metadata": {
                        "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
                      }
                    },
                    "aksClusterNamePrefix": {
                      "type": "string",
                      "defaultValue": "wlsonaks",
                      "metadata": {
                        "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
                      }
                    },
                    "aksVersion": {
                      "type": "string",
                      "defaultValue": "default"
                    },
                    "enableAzureMonitoring": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_aksAgentPoolOSDiskSizeGB": 128,
                    "const_aksAgentPoolMaxPods": 110,
                    "const_aksAvailabilityZones": [
                      "1",
                      "2",
                      "3"
                    ],
                    "name_aciWorkspace": "[format('Workspace-{0}-{1}', guid(parameters('utcValue')), parameters('location'))]",
                    "name_aksClusterNameForSV": "[format('{0}{1}', parameters('aksClusterNamePrefix'), uniqueString(parameters('utcValue')))]",
                    "obj_aciDisableOmsAgent": {
                      "enabled": false
                    },
                    "obj_aciEnableOmsAgent": {
                      "enabled": true,
                      "config": {
                        "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[parameters('enableAzureMonitoring')]",
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2022-10-01",
                      "name": "[variables('name_aciWorkspace')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "name": "[parameters('aciWorkspaceSku')]"
                        },
                        "retentionInDays": "[parameters('aciRetentionInDays')]",
                        "features": {
                          "searchVersion": 1,
                          "legacy": 0,
                          "enableLogAccessUsingOnlyResourcePermissions": "[parameters('aciResourcePermissions')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2023-08-01",
                      "name": "[variables('name_aksClusterNameForSV')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "kubernetesVersion": "[parameters('aksVersion')]",
                        "dnsPrefix": "[format('{0}-dns', variables('name_aksClusterNameForSV'))]",
                        "agentPoolProfiles": [
                          {
                            "name": "[parameters('aksAgentPoolName')]",
                            "count": "[parameters('aksAgentPoolNodeCount')]",
                            "vmSize": "[parameters('aksAgentPoolVMSize')]",
                            "osDiskSizeGB": "[variables('const_aksAgentPoolOSDiskSizeGB')]",
                            "osDiskType": "Managed",
                            "kubeletDiskType": "OS",
                            "maxPods": "[variables('const_aksAgentPoolMaxPods')]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": "[variables('const_aksAvailabilityZones')]",
                            "mode": "System",
                            "osType": "Linux"
                          }
                        ],
                        "addonProfiles": {
                          "KubeDashboard": {
                            "enabled": false
                          },
                          "azurepolicy": {
                            "enabled": false
                          },
                          "httpApplicationRouting": {
                            "enabled": false
                          },
                          "omsAgent": "[if(parameters('enableAzureMonitoring'), variables('obj_aciEnableOmsAgent'), variables('obj_aciDisableOmsAgent'))]"
                        },
                        "enableRBAC": true,
                        "networkProfile": {
                          "networkPlugin": "azure",
                          "loadBalancerSku": "standard"
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "aksClusterName": {
                      "type": "string",
                      "value": "[variables('name_aksClusterNameForSV')]"
                    },
                    "aksNodeRgName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('name_aksClusterNameForSV'))).nodeResourceGroup]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "condition": "[parameters('createStorageAccount')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "storage-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "10484945738947836392"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "stg-contoso"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_shareQuota": 5120,
                    "const_sku": "Standard_LRS",
                    "name_fileShare": "weblogic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "StorageV2",
                      "sku": {
                        "name": "[variables('const_sku')]",
                        "tier": "Standard"
                      },
                      "properties": {
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "Allow"
                        },
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        },
                        "accessTier": "Hot"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/default/{1}', parameters('storageAccountName'), variables('name_fileShare'))]",
                      "properties": {
                        "accessTier": "TransactionOptimized",
                        "shareQuota": "[variables('const_shareQuota')]",
                        "enabledProtocols": "SMB"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-domain-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterRGName": {
                    "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
                  },
                  "aksClusterName": {
                    "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2020-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
                  },
                  "acrName": {
                    "value": "[if(parameters('useOracleImage'), parameters('acrName'), parameters('userProvidedAcr'))]"
                  },
                  "acrResourceGroupName": {
                    "value": "[if(parameters('useOracleImage'), parameters('acrResourceGroupName'), parameters('userProvidedAcrRgName'))]"
                  },
                  "appPackageUrls": {
                    "value": "[parameters('appPackageUrls')]"
                  },
                  "appReplicas": {
                    "value": "[parameters('appReplicas')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "databaseType": {
                    "value": "[parameters('databaseType')]"
                  },
                  "dbDriverLibrariesUrls": {
                    "value": "[parameters('dbDriverLibrariesUrls')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableAdminT3Tunneling": {
                    "value": "[parameters('enableAdminT3Tunneling')]"
                  },
                  "enableClusterT3Tunneling": {
                    "value": "[parameters('enableClusterT3Tunneling')]"
                  },
                  "enablePswlessConnection": {
                    "value": "[parameters('enablePswlessConnection')]"
                  },
                  "enablePV": {
                    "value": "[parameters('enablePV')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "isSSOSupportEntitled": {
                    "value": "[parameters('isSSOSupportEntitled')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "managedServerPrefix": {
                    "value": "[parameters('managedServerPrefix')]"
                  },
                  "ocrSSOUser": {
                    "value": "[parameters('ocrSSOUser')]"
                  },
                  "ocrSSOPSW": {
                    "value": "[parameters('ocrSSOPSW')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "t3ChannelAdminPort": {
                    "value": "[parameters('t3ChannelAdminPort')]"
                  },
                  "t3ChannelClusterPort": {
                    "value": "[parameters('t3ChannelClusterPort')]"
                  },
                  "userProvidedImagePath": {
                    "value": "[parameters('userProvidedImagePath')]"
                  },
                  "useOracleImage": {
                    "value": "[parameters('useOracleImage')]"
                  },
                  "wdtRuntimePassword": {
                    "value": "[parameters('wdtRuntimePassword')]"
                  },
                  "wlsClusterSize": {
                    "value": "[parameters('wlsClusterSize')]"
                  },
                  "wlsCPU": {
                    "value": "[parameters('wlsCPU')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsIdentityKeyStoreData": {
                    "value": "[parameters('wlsIdentityKeyStoreData')]"
                  },
                  "wlsIdentityKeyStorePassphrase": {
                    "value": "[parameters('wlsIdentityKeyStorePassphrase')]"
                  },
                  "wlsIdentityKeyStoreType": {
                    "value": "[parameters('wlsIdentityKeyStoreType')]"
                  },
                  "wlsImageTag": {
                    "value": "[parameters('wlsImageTag')]"
                  },
                  "wlsJavaOption": {
                    "value": "[parameters('wlsJavaOption')]"
                  },
                  "wlsMemory": {
                    "value": "[parameters('wlsMemory')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsPrivateKeyAlias": {
                    "value": "[parameters('wlsPrivateKeyAlias')]"
                  },
                  "wlsPrivateKeyPassPhrase": {
                    "value": "[parameters('wlsPrivateKeyPassPhrase')]"
                  },
                  "wlsTrustKeyStoreData": {
                    "value": "[parameters('wlsTrustKeyStoreData')]"
                  },
                  "wlsTrustKeyStorePassPhrase": {
                    "value": "[parameters('wlsTrustKeyStorePassPhrase')]"
                  },
                  "wlsTrustKeyStoreType": {
                    "value": "[parameters('wlsTrustKeyStoreType')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "14692618040337665210"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "acrName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "acrResourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appPackageUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "appReplicas": {
                      "type": "int",
                      "defaultValue": 2
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "databaseType": {
                      "type": "string",
                      "defaultValue": "oracle"
                    },
                    "dbDriverLibrariesUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableAdminT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableClusterT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enablePswlessConnection": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enablePV": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "isSSOSupportEntitled": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string"
                    },
                    "managedServerPrefix": {
                      "type": "string",
                      "defaultValue": "managed-server"
                    },
                    "ocrSSOPSW": {
                      "type": "secureString"
                    },
                    "ocrSSOUser": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "t3ChannelAdminPort": {
                      "type": "int",
                      "defaultValue": 7005
                    },
                    "t3ChannelClusterPort": {
                      "type": "int",
                      "defaultValue": 8011
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "userProvidedImagePath": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "useOracleImage": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "wdtRuntimePassword": {
                      "type": "secureString"
                    },
                    "wlsClusterSize": {
                      "type": "int",
                      "defaultValue": 5
                    },
                    "wlsCPU": {
                      "type": "string",
                      "defaultValue": "200m"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsIdentityKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStorePassphrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsImageTag": {
                      "type": "string",
                      "defaultValue": "12.2.1.4"
                    },
                    "wlsJavaOption": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "wlsMemory": {
                      "type": "string",
                      "defaultValue": "1.5Gi"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsPrivateKeyAlias": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsPrivateKeyPassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStorePassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic"
                    }
                  },
                  "variables": {
                    "const_buildDockerImageScript": "createVMAndBuildImage.sh",
                    "const_commonScript": "common.sh",
                    "const_pvTempalte": "pv.yaml.template",
                    "const_pvcTempalte": "pvc.yaml.template",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_genDomainConfigScript": "genDomainConfig.sh",
                    "const_setUpDomainScript": "setupWLSDomain.sh",
                    "const_updateDomainConfigScript": "updateDomainConfig.sh",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-wls-cluster-creation",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "environmentVariables": [
                          {
                            "name": "ACR_NAME",
                            "value": "[parameters('acrName')]"
                          },
                          {
                            "name": "ACR_RESOURCEGROUP_NAME",
                            "value": "[parameters('acrResourceGroupName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "CURRENT_RESOURCEGROUP_NAME",
                            "value": "[resourceGroup().name]"
                          },
                          {
                            "name": "DB_TYPE",
                            "value": "[parameters('databaseType')]"
                          },
                          {
                            "name": "ENABLE_ADMIN_CUSTOM_T3",
                            "value": "[string(parameters('enableAdminT3Tunneling'))]"
                          },
                          {
                            "name": "ENABLE_CLUSTER_CUSTOM_T3",
                            "value": "[string(parameters('enableClusterT3Tunneling'))]"
                          },
                          {
                            "name": "ENABLE_CUSTOM_SSL",
                            "value": "[string(parameters('enableCustomSSL'))]"
                          },
                          {
                            "name": "ENABLE_PASSWORDLESS_DB_CONNECTION",
                            "value": "[string(parameters('enablePswlessConnection'))]"
                          },
                          {
                            "name": "ENABLE_PV",
                            "value": "[string(parameters('enablePV'))]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_NAME",
                            "value": "[parameters('ocrSSOUser')]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_PASSWORD",
                            "secureValue": "[parameters('ocrSSOPSW')]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_ENTITLED",
                            "value": "[string(parameters('isSSOSupportEntitled'))]"
                          },
                          {
                            "name": "SCRIPT_LOCATION",
                            "value": "[variables('const_scriptLocation')]"
                          },
                          {
                            "name": "STORAGE_ACCOUNT_NAME",
                            "value": "[parameters('storageAccountName')]"
                          },
                          {
                            "name": "URL_3RD_DATASOURCE",
                            "value": "[string(parameters('dbDriverLibrariesUrls'))]"
                          },
                          {
                            "name": "USE_ORACLE_IMAGE",
                            "value": "[string(parameters('useOracleImage'))]"
                          },
                          {
                            "name": "USER_PROVIDED_IMAGE_PATH",
                            "value": "[parameters('userProvidedImagePath')]"
                          },
                          {
                            "name": "WLS_ADMIN_PASSWORD",
                            "secureValue": "[parameters('wlsPassword')]"
                          },
                          {
                            "name": "WLS_ADMIN_USER_NAME",
                            "secureValue": "[parameters('wlsUserName')]"
                          },
                          {
                            "name": "WLS_APP_PACKAGE_URLS",
                            "value": "[base64(string(parameters('appPackageUrls')))]"
                          },
                          {
                            "name": "WLS_APP_REPLICAS",
                            "value": "[string(parameters('appReplicas'))]"
                          },
                          {
                            "name": "WLS_CLUSTER_SIZE",
                            "value": "[string(parameters('wlsClusterSize'))]"
                          },
                          {
                            "name": "WLS_DOMAIN_NAME",
                            "value": "[parameters('wlsDomainName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_UID",
                            "value": "[parameters('wlsDomainUID')]"
                          },
                          {
                            "name": "WLS_IMAGE_TAG",
                            "value": "[parameters('wlsImageTag')]"
                          },
                          {
                            "name": "WLS_JAVA_OPTIONS",
                            "value": "[parameters('wlsJavaOption')]"
                          },
                          {
                            "name": "WLS_MANAGED_SERVER_PREFIX",
                            "value": "[parameters('managedServerPrefix')]"
                          },
                          {
                            "name": "WLS_RESOURCE_REQUEST_CPU",
                            "value": "[parameters('wlsCPU')]"
                          },
                          {
                            "name": "WLS_RESOURCE_REQUEST_MEMORY",
                            "value": "[parameters('wlsMemory')]"
                          },
                          {
                            "name": "WLS_SSL_IDENTITY_DATA",
                            "secureValue": "[parameters('wlsIdentityKeyStoreData')]"
                          },
                          {
                            "name": "WLS_SSL_IDENTITY_PASSWORD",
                            "secureValue": "[parameters('wlsIdentityKeyStorePassphrase')]"
                          },
                          {
                            "name": "WLS_SSL_IDENTITY_TYPE",
                            "value": "[parameters('wlsIdentityKeyStoreType')]"
                          },
                          {
                            "name": "WLS_SSL_TRUST_DATA",
                            "secureValue": "[parameters('wlsTrustKeyStoreData')]"
                          },
                          {
                            "name": "WLS_SSL_TRUST_PASSWORD",
                            "secureValue": "[parameters('wlsTrustKeyStorePassPhrase')]"
                          },
                          {
                            "name": "WLS_SSL_TRUST_TYPE",
                            "value": "[parameters('wlsTrustKeyStoreType')]"
                          },
                          {
                            "name": "WLS_SSL_PRIVATE_KEY_ALIAS",
                            "secureValue": "[parameters('wlsPrivateKeyAlias')]"
                          },
                          {
                            "name": "WLS_SSL_PRIVATE_KEY_PASSWORD",
                            "secureValue": "[parameters('wlsPrivateKeyPassPhrase')]"
                          },
                          {
                            "name": "WLS_T3_ADMIN_PORT",
                            "value": "[string(parameters('t3ChannelAdminPort'))]"
                          },
                          {
                            "name": "WLS_T3_CLUSTER_PORT",
                            "value": "[string(parameters('t3ChannelClusterPort'))]"
                          },
                          {
                            "name": "WLS_WDT_RUNTIME_PSW",
                            "secureValue": "[parameters('wdtRuntimePassword')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setUpDomainScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_genDomainConfigScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvcTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_buildDockerImageScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_updateDomainConfigScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
              ]
            },
            {
              "condition": "[parameters('enableCustomSSL')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-ssl-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidSSLEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-domain-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-domain-deployment')]"
              ]
            }
          ],
          "outputs": {
            "aksClusterName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2020-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
            },
            "aksClusterRGName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
            },
            "aksNodeRgName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2020-10-01').outputs.aksNodeRgName.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aksClusterRGName')), 'Microsoft.ContainerService/managedClusters', parameters('aksClusterName')), '2023-08-01').nodeResourceGroup)]"
            },
            "adminServerEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-admin-server.{0}-ns.svc.cluster.local:7001/console', parameters('wlsDomainUID'))]"
            },
            "adminServerT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableAdminT3Tunneling'), format('{0}://{1}-admin-server.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelAdminPort')), '')]"
            },
            "clusterEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-cluster-cluster-1.{0}-ns.svc.cluster.local:8001/', parameters('wlsDomainUID'))]"
            },
            "clusterT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableClusterT3Tunneling'), format('{0}://{1}-cluster-cluster-1.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelClusterPort')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]"
      ]
    },
    {
      "condition": "[parameters('enableCustomSSL')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "setup-wls-cluster-with-custom-ssl-enabled",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSEnd.value)]"
          },
          "_pidStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.wlsAKSStart.value)]"
          },
          "aciResourcePermissions": {
            "value": "[parameters('aciResourcePermissions')]"
          },
          "aciRetentionInDays": {
            "value": "[parameters('aciRetentionInDays')]"
          },
          "aciWorkspaceSku": {
            "value": "[parameters('aciWorkspaceSku')]"
          },
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')).outputs.acrName.value]"
          },
          "acrResourceGroupName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')).outputs.acrResourceGroupName.value]"
          },
          "aksAgentPoolName": {
            "value": "[parameters('aksAgentPoolName')]"
          },
          "aksAgentPoolNodeCount": {
            "value": "[parameters('aksAgentPoolNodeCount')]"
          },
          "vmSize": {
            "value": "[parameters('vmSize')]"
          },
          "aksClusterNamePrefix": {
            "value": "[parameters('aksClusterNamePrefix')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')).outputs.aksVersion.value]"
          },
          "appPackageUrls": {
            "value": "[parameters('appPackageUrls')]"
          },
          "appReplicas": {
            "value": "[parameters('appReplicas')]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createStorageAccount": {
            "value": "[and(or(parameters('createAKSCluster'), not(and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null'))))), variables('const_enablePV'))]"
          },
          "databaseType": {
            "value": "[parameters('databaseType')]"
          },
          "dbDriverLibrariesUrls": {
            "value": "[parameters('dbDriverLibrariesUrls')]"
          },
          "enableAzureMonitoring": {
            "value": "[parameters('enableAzureMonitoring')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableAdminT3Tunneling": {
            "value": "[parameters('enableAdminT3Tunneling')]"
          },
          "enableClusterT3Tunneling": {
            "value": "[parameters('enableClusterT3Tunneling')]"
          },
          "enablePswlessConnection": {
            "value": "[parameters('enablePswlessConnection')]"
          },
          "enablePV": {
            "value": "[variables('const_enablePV')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "isSSOSupportEntitled": {
            "value": "[parameters('isSSOSupportEntitled')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "managedServerPrefix": {
            "value": "[parameters('managedServerPrefix')]"
          },
          "ocrSSOPSW": {
            "value": "[parameters('ocrSSOPSW')]"
          },
          "ocrSSOUser": {
            "value": "[parameters('ocrSSOUser')]"
          },
          "storageAccountName": {
            "value": "[if(and(not(parameters('createAKSCluster')), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, 'null'))), reference(resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account'), '2020-10-01').outputs.storageAccount.value, format('wls{0}', uniqueString(parameters('utcValue'))))]"
          },
          "t3ChannelAdminPort": {
            "value": "[parameters('t3ChannelAdminPort')]"
          },
          "t3ChannelClusterPort": {
            "value": "[parameters('t3ChannelClusterPort')]"
          },
          "userProvidedAcr": {
            "value": "[parameters('userProvidedAcr')]"
          },
          "userProvidedAcrRgName": {
            "value": "[parameters('userProvidedAcrRgName')]"
          },
          "userProvidedImagePath": {
            "value": "[parameters('userProvidedImagePath')]"
          },
          "useOracleImage": {
            "value": "[parameters('useOracleImage')]"
          },
          "wdtRuntimePassword": {
            "value": "[parameters('wdtRuntimePassword')]"
          },
          "wlsClusterSize": {
            "value": "[parameters('wlsClusterSize')]"
          },
          "wlsCPU": {
            "value": "[parameters('wlsCPU')]"
          },
          "wlsDomainName": {
            "value": "[parameters('wlsDomainName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsIdentityKeyStoreData": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_identityKeyStoreDataSecret')]"
            }
          },
          "wlsIdentityKeyStorePassphrase": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_identityKeyStorePswSecret')]"
            }
          },
          "wlsIdentityKeyStoreType": {
            "value": "[variables('const_identityKeyStoreType')]"
          },
          "wlsImageTag": {
            "value": "[parameters('wlsImageTag')]"
          },
          "wlsJavaOption": {
            "value": "[variables('const_wlsJavaOptions')]"
          },
          "wlsMemory": {
            "value": "[parameters('wlsMemory')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsPrivateKeyAlias": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_privateKeyAliasSecret')]"
            }
          },
          "wlsPrivateKeyPassPhrase": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_privateKeyPswSecret')]"
            }
          },
          "wlsTrustKeyStoreData": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_trustKeyStoreDataSecret')]"
            }
          },
          "wlsTrustKeyStorePassPhrase": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_trustKeyStorePswSecret')]"
            }
          },
          "wlsTrustKeyStoreType": {
            "value": "[variables('const_trustKeyStoreType')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "15395910228669165274"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": "pid-wls-end"
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": "pid-wls-start"
            },
            "_pidSSLEnd": {
              "type": "string",
              "defaultValue": "pid-ssl-end"
            },
            "_pidSSLStart": {
              "type": "string",
              "defaultValue": "pid-ssl-start"
            },
            "aciResourcePermissions": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to use resource or workspace permissions. false to require workspace permissions."
              }
            },
            "aciRetentionInDays": {
              "type": "int",
              "defaultValue": 120,
              "metadata": {
                "description": "Number of days to retain data in Azure Monitor workspace."
              }
            },
            "aciWorkspaceSku": {
              "type": "string",
              "defaultValue": "pergb2018",
              "metadata": {
                "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
              }
            },
            "acrName": {
              "type": "string",
              "defaultValue": ""
            },
            "acrResourceGroupName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksAgentPoolName": {
              "type": "string",
              "defaultValue": "agentpool",
              "metadata": {
                "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
              },
              "minLength": 1,
              "maxLength": 12
            },
            "aksAgentPoolNodeCount": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
              },
              "minValue": 1,
              "maxValue": 10000
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_DS2_v2",
              "metadata": {
                "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
              }
            },
            "aksClusterNamePrefix": {
              "type": "string",
              "defaultValue": "wlsonaks",
              "metadata": {
                "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource group name of an existing AKS cluster."
              }
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksVersion": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "The AKS version."
              }
            },
            "appPackageUrls": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Urls of Java EE application packages."
              }
            },
            "appReplicas": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "The number of managed server to start."
              }
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "createAKSCluster": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to create a new AKS cluster."
              }
            },
            "createStorageAccount": {
              "type": "bool",
              "defaultValue": false
            },
            "databaseType": {
              "type": "string",
              "defaultValue": "oracle"
            },
            "dbDriverLibrariesUrls": {
              "type": "array",
              "defaultValue": []
            },
            "enableAzureMonitoring": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
              }
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to create persistent volume using file share."
              }
            },
            "enableAdminT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enableClusterT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enablePswlessConnection": {
              "type": "bool",
              "defaultValue": false
            },
            "enablePV": {
              "type": "bool",
              "defaultValue": false
            },
            "identity": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "An user assigned managed identity. Make sure the identity has permission to create/update/delete/list Azure resources."
              }
            },
            "isSSOSupportEntitled": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "managedServerPrefix": {
              "type": "string",
              "defaultValue": "managed-server",
              "metadata": {
                "description": "Name prefix of managed server."
              }
            },
            "ocrSSOPSW": {
              "type": "secureString",
              "metadata": {
                "description": "Password of Oracle SSO account."
              }
            },
            "ocrSSOUser": {
              "type": "string",
              "metadata": {
                "description": "User name of Oracle SSO account."
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "stg-contoso"
            },
            "t3ChannelAdminPort": {
              "type": "int",
              "defaultValue": 7005
            },
            "t3ChannelClusterPort": {
              "type": "int",
              "defaultValue": 8011
            },
            "userProvidedAcr": {
              "type": "string",
              "defaultValue": "null"
            },
            "userProvidedAcrRgName": {
              "type": "string",
              "defaultValue": "null"
            },
            "userProvidedImagePath": {
              "type": "string",
              "defaultValue": "null"
            },
            "useOracleImage": {
              "type": "bool",
              "defaultValue": true
            },
            "wdtRuntimePassword": {
              "type": "secureString",
              "metadata": {
                "description": "Password for model WebLogic Deploy Tooling runtime encrytion."
              }
            },
            "wlsClusterSize": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Maximum cluster size."
              }
            },
            "wlsCPU": {
              "type": "string",
              "defaultValue": "200m",
              "metadata": {
                "description": "Requests for CPU resources for admin server and managed server."
              }
            },
            "wlsDomainName": {
              "type": "string",
              "defaultValue": "domain1",
              "metadata": {
                "description": "Name of WebLogic domain to create."
              }
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsIdentityKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStorePassphrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsImageTag": {
              "type": "string",
              "defaultValue": "12.2.1.4",
              "metadata": {
                "description": "Docker tag that comes after \"container-registry.oracle.com/middleware/weblogic:\""
              }
            },
            "wlsJavaOption": {
              "type": "string",
              "defaultValue": "null"
            },
            "wlsMemory": {
              "type": "string",
              "defaultValue": "1.5Gi",
              "metadata": {
                "description": "Memory requests for admin server and managed server."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsPrivateKeyAlias": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyPassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStorePassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableCustomSSL')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-ssl-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidSSLStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('createAKSCluster')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "aks-cluster-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aciResourcePermissions": {
                    "value": "[parameters('aciResourcePermissions')]"
                  },
                  "aciRetentionInDays": {
                    "value": "[parameters('aciRetentionInDays')]"
                  },
                  "aciWorkspaceSku": {
                    "value": "[parameters('aciWorkspaceSku')]"
                  },
                  "aksAgentPoolName": {
                    "value": "[parameters('aksAgentPoolName')]"
                  },
                  "aksAgentPoolNodeCount": {
                    "value": "[parameters('aksAgentPoolNodeCount')]"
                  },
                  "aksAgentPoolVMSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "aksClusterNamePrefix": {
                    "value": "[parameters('aksClusterNamePrefix')]"
                  },
                  "aksVersion": {
                    "value": "[parameters('aksVersion')]"
                  },
                  "enableAzureMonitoring": {
                    "value": "[parameters('enableAzureMonitoring')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "11591397974282754947"
                    }
                  },
                  "parameters": {
                    "aciResourcePermissions": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "true to use resource or workspace permissions. false to require workspace permissions."
                      }
                    },
                    "aciRetentionInDays": {
                      "type": "int",
                      "defaultValue": 120,
                      "metadata": {
                        "description": "Number of days to retain data in Azure Monitor workspace."
                      }
                    },
                    "aciWorkspaceSku": {
                      "type": "string",
                      "defaultValue": "pergb2018",
                      "metadata": {
                        "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
                      }
                    },
                    "aksAgentPoolName": {
                      "type": "string",
                      "defaultValue": "agentpool",
                      "metadata": {
                        "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
                      },
                      "minLength": 1,
                      "maxLength": 12
                    },
                    "aksAgentPoolNodeCount": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
                      },
                      "minValue": 1,
                      "maxValue": 10000
                    },
                    "aksAgentPoolVMSize": {
                      "type": "string",
                      "defaultValue": "Standard_DS2_v2",
                      "metadata": {
                        "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
                      }
                    },
                    "aksClusterNamePrefix": {
                      "type": "string",
                      "defaultValue": "wlsonaks",
                      "metadata": {
                        "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
                      }
                    },
                    "aksVersion": {
                      "type": "string",
                      "defaultValue": "default"
                    },
                    "enableAzureMonitoring": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_aksAgentPoolOSDiskSizeGB": 128,
                    "const_aksAgentPoolMaxPods": 110,
                    "const_aksAvailabilityZones": [
                      "1",
                      "2",
                      "3"
                    ],
                    "name_aciWorkspace": "[format('Workspace-{0}-{1}', guid(parameters('utcValue')), parameters('location'))]",
                    "name_aksClusterNameForSV": "[format('{0}{1}', parameters('aksClusterNamePrefix'), uniqueString(parameters('utcValue')))]",
                    "obj_aciDisableOmsAgent": {
                      "enabled": false
                    },
                    "obj_aciEnableOmsAgent": {
                      "enabled": true,
                      "config": {
                        "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[parameters('enableAzureMonitoring')]",
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2022-10-01",
                      "name": "[variables('name_aciWorkspace')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "name": "[parameters('aciWorkspaceSku')]"
                        },
                        "retentionInDays": "[parameters('aciRetentionInDays')]",
                        "features": {
                          "searchVersion": 1,
                          "legacy": 0,
                          "enableLogAccessUsingOnlyResourcePermissions": "[parameters('aciResourcePermissions')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2023-08-01",
                      "name": "[variables('name_aksClusterNameForSV')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "kubernetesVersion": "[parameters('aksVersion')]",
                        "dnsPrefix": "[format('{0}-dns', variables('name_aksClusterNameForSV'))]",
                        "agentPoolProfiles": [
                          {
                            "name": "[parameters('aksAgentPoolName')]",
                            "count": "[parameters('aksAgentPoolNodeCount')]",
                            "vmSize": "[parameters('aksAgentPoolVMSize')]",
                            "osDiskSizeGB": "[variables('const_aksAgentPoolOSDiskSizeGB')]",
                            "osDiskType": "Managed",
                            "kubeletDiskType": "OS",
                            "maxPods": "[variables('const_aksAgentPoolMaxPods')]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": "[variables('const_aksAvailabilityZones')]",
                            "mode": "System",
                            "osType": "Linux"
                          }
                        ],
                        "addonProfiles": {
                          "KubeDashboard": {
                            "enabled": false
                          },
                          "azurepolicy": {
                            "enabled": false
                          },
                          "httpApplicationRouting": {
                            "enabled": false
                          },
                          "omsAgent": "[if(parameters('enableAzureMonitoring'), variables('obj_aciEnableOmsAgent'), variables('obj_aciDisableOmsAgent'))]"
                        },
                        "enableRBAC": true,
                        "networkProfile": {
                          "networkPlugin": "azure",
                          "loadBalancerSku": "standard"
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "aksClusterName": {
                      "type": "string",
                      "value": "[variables('name_aksClusterNameForSV')]"
                    },
                    "aksNodeRgName": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('name_aksClusterNameForSV'))).nodeResourceGroup]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "condition": "[parameters('createStorageAccount')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "storage-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "10484945738947836392"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "stg-contoso"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_shareQuota": 5120,
                    "const_sku": "Standard_LRS",
                    "name_fileShare": "weblogic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "StorageV2",
                      "sku": {
                        "name": "[variables('const_sku')]",
                        "tier": "Standard"
                      },
                      "properties": {
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "Allow"
                        },
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        },
                        "accessTier": "Hot"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/default/{1}', parameters('storageAccountName'), variables('name_fileShare'))]",
                      "properties": {
                        "accessTier": "TransactionOptimized",
                        "shareQuota": "[variables('const_shareQuota')]",
                        "enabledProtocols": "SMB"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-domain-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterRGName": {
                    "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
                  },
                  "aksClusterName": {
                    "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2020-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
                  },
                  "acrName": {
                    "value": "[if(parameters('useOracleImage'), parameters('acrName'), parameters('userProvidedAcr'))]"
                  },
                  "acrResourceGroupName": {
                    "value": "[if(parameters('useOracleImage'), parameters('acrResourceGroupName'), parameters('userProvidedAcrRgName'))]"
                  },
                  "appPackageUrls": {
                    "value": "[parameters('appPackageUrls')]"
                  },
                  "appReplicas": {
                    "value": "[parameters('appReplicas')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "databaseType": {
                    "value": "[parameters('databaseType')]"
                  },
                  "dbDriverLibrariesUrls": {
                    "value": "[parameters('dbDriverLibrariesUrls')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableAdminT3Tunneling": {
                    "value": "[parameters('enableAdminT3Tunneling')]"
                  },
                  "enableClusterT3Tunneling": {
                    "value": "[parameters('enableClusterT3Tunneling')]"
                  },
                  "enablePswlessConnection": {
                    "value": "[parameters('enablePswlessConnection')]"
                  },
                  "enablePV": {
                    "value": "[parameters('enablePV')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "isSSOSupportEntitled": {
                    "value": "[parameters('isSSOSupportEntitled')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "managedServerPrefix": {
                    "value": "[parameters('managedServerPrefix')]"
                  },
                  "ocrSSOUser": {
                    "value": "[parameters('ocrSSOUser')]"
                  },
                  "ocrSSOPSW": {
                    "value": "[parameters('ocrSSOPSW')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "t3ChannelAdminPort": {
                    "value": "[parameters('t3ChannelAdminPort')]"
                  },
                  "t3ChannelClusterPort": {
                    "value": "[parameters('t3ChannelClusterPort')]"
                  },
                  "userProvidedImagePath": {
                    "value": "[parameters('userProvidedImagePath')]"
                  },
                  "useOracleImage": {
                    "value": "[parameters('useOracleImage')]"
                  },
                  "wdtRuntimePassword": {
                    "value": "[parameters('wdtRuntimePassword')]"
                  },
                  "wlsClusterSize": {
                    "value": "[parameters('wlsClusterSize')]"
                  },
                  "wlsCPU": {
                    "value": "[parameters('wlsCPU')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsIdentityKeyStoreData": {
                    "value": "[parameters('wlsIdentityKeyStoreData')]"
                  },
                  "wlsIdentityKeyStorePassphrase": {
                    "value": "[parameters('wlsIdentityKeyStorePassphrase')]"
                  },
                  "wlsIdentityKeyStoreType": {
                    "value": "[parameters('wlsIdentityKeyStoreType')]"
                  },
                  "wlsImageTag": {
                    "value": "[parameters('wlsImageTag')]"
                  },
                  "wlsJavaOption": {
                    "value": "[parameters('wlsJavaOption')]"
                  },
                  "wlsMemory": {
                    "value": "[parameters('wlsMemory')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsPrivateKeyAlias": {
                    "value": "[parameters('wlsPrivateKeyAlias')]"
                  },
                  "wlsPrivateKeyPassPhrase": {
                    "value": "[parameters('wlsPrivateKeyPassPhrase')]"
                  },
                  "wlsTrustKeyStoreData": {
                    "value": "[parameters('wlsTrustKeyStoreData')]"
                  },
                  "wlsTrustKeyStorePassPhrase": {
                    "value": "[parameters('wlsTrustKeyStorePassPhrase')]"
                  },
                  "wlsTrustKeyStoreType": {
                    "value": "[parameters('wlsTrustKeyStoreType')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "14692618040337665210"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "acrName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "acrResourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appPackageUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "appReplicas": {
                      "type": "int",
                      "defaultValue": 2
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "databaseType": {
                      "type": "string",
                      "defaultValue": "oracle"
                    },
                    "dbDriverLibrariesUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableAdminT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableClusterT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enablePswlessConnection": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enablePV": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "isSSOSupportEntitled": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string"
                    },
                    "managedServerPrefix": {
                      "type": "string",
                      "defaultValue": "managed-server"
                    },
                    "ocrSSOPSW": {
                      "type": "secureString"
                    },
                    "ocrSSOUser": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "t3ChannelAdminPort": {
                      "type": "int",
                      "defaultValue": 7005
                    },
                    "t3ChannelClusterPort": {
                      "type": "int",
                      "defaultValue": 8011
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "userProvidedImagePath": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "useOracleImage": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "wdtRuntimePassword": {
                      "type": "secureString"
                    },
                    "wlsClusterSize": {
                      "type": "int",
                      "defaultValue": 5
                    },
                    "wlsCPU": {
                      "type": "string",
                      "defaultValue": "200m"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsIdentityKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStorePassphrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsImageTag": {
                      "type": "string",
                      "defaultValue": "12.2.1.4"
                    },
                    "wlsJavaOption": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "wlsMemory": {
                      "type": "string",
                      "defaultValue": "1.5Gi"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsPrivateKeyAlias": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsPrivateKeyPassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStorePassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic"
                    }
                  },
                  "variables": {
                    "const_buildDockerImageScript": "createVMAndBuildImage.sh",
                    "const_commonScript": "common.sh",
                    "const_pvTempalte": "pv.yaml.template",
                    "const_pvcTempalte": "pvc.yaml.template",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_genDomainConfigScript": "genDomainConfig.sh",
                    "const_setUpDomainScript": "setupWLSDomain.sh",
                    "const_updateDomainConfigScript": "updateDomainConfig.sh",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-wls-cluster-creation",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "environmentVariables": [
                          {
                            "name": "ACR_NAME",
                            "value": "[parameters('acrName')]"
                          },
                          {
                            "name": "ACR_RESOURCEGROUP_NAME",
                            "value": "[parameters('acrResourceGroupName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "CURRENT_RESOURCEGROUP_NAME",
                            "value": "[resourceGroup().name]"
                          },
                          {
                            "name": "DB_TYPE",
                            "value": "[parameters('databaseType')]"
                          },
                          {
                            "name": "ENABLE_ADMIN_CUSTOM_T3",
                            "value": "[string(parameters('enableAdminT3Tunneling'))]"
                          },
                          {
                            "name": "ENABLE_CLUSTER_CUSTOM_T3",
                            "value": "[string(parameters('enableClusterT3Tunneling'))]"
                          },
                          {
                            "name": "ENABLE_CUSTOM_SSL",
                            "value": "[string(parameters('enableCustomSSL'))]"
                          },
                          {
                            "name": "ENABLE_PASSWORDLESS_DB_CONNECTION",
                            "value": "[string(parameters('enablePswlessConnection'))]"
                          },
                          {
                            "name": "ENABLE_PV",
                            "value": "[string(parameters('enablePV'))]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_NAME",
                            "value": "[parameters('ocrSSOUser')]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_PASSWORD",
                            "secureValue": "[parameters('ocrSSOPSW')]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_ENTITLED",
                            "value": "[string(parameters('isSSOSupportEntitled'))]"
                          },
                          {
                            "name": "SCRIPT_LOCATION",
                            "value": "[variables('const_scriptLocation')]"
                          },
                          {
                            "name": "STORAGE_ACCOUNT_NAME",
                            "value": "[parameters('storageAccountName')]"
                          },
                          {
                            "name": "URL_3RD_DATASOURCE",
                            "value": "[string(parameters('dbDriverLibrariesUrls'))]"
                          },
                          {
                            "name": "USE_ORACLE_IMAGE",
                            "value": "[string(parameters('useOracleImage'))]"
                          },
                          {
                            "name": "USER_PROVIDED_IMAGE_PATH",
                            "value": "[parameters('userProvidedImagePath')]"
                          },
                          {
                            "name": "WLS_ADMIN_PASSWORD",
                            "secureValue": "[parameters('wlsPassword')]"
                          },
                          {
                            "name": "WLS_ADMIN_USER_NAME",
                            "secureValue": "[parameters('wlsUserName')]"
                          },
                          {
                            "name": "WLS_APP_PACKAGE_URLS",
                            "value": "[base64(string(parameters('appPackageUrls')))]"
                          },
                          {
                            "name": "WLS_APP_REPLICAS",
                            "value": "[string(parameters('appReplicas'))]"
                          },
                          {
                            "name": "WLS_CLUSTER_SIZE",
                            "value": "[string(parameters('wlsClusterSize'))]"
                          },
                          {
                            "name": "WLS_DOMAIN_NAME",
                            "value": "[parameters('wlsDomainName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_UID",
                            "value": "[parameters('wlsDomainUID')]"
                          },
                          {
                            "name": "WLS_IMAGE_TAG",
                            "value": "[parameters('wlsImageTag')]"
                          },
                          {
                            "name": "WLS_JAVA_OPTIONS",
                            "value": "[parameters('wlsJavaOption')]"
                          },
                          {
                            "name": "WLS_MANAGED_SERVER_PREFIX",
                            "value": "[parameters('managedServerPrefix')]"
                          },
                          {
                            "name": "WLS_RESOURCE_REQUEST_CPU",
                            "value": "[parameters('wlsCPU')]"
                          },
                          {
                            "name": "WLS_RESOURCE_REQUEST_MEMORY",
                            "value": "[parameters('wlsMemory')]"
                          },
                          {
                            "name": "WLS_SSL_IDENTITY_DATA",
                            "secureValue": "[parameters('wlsIdentityKeyStoreData')]"
                          },
                          {
                            "name": "WLS_SSL_IDENTITY_PASSWORD",
                            "secureValue": "[parameters('wlsIdentityKeyStorePassphrase')]"
                          },
                          {
                            "name": "WLS_SSL_IDENTITY_TYPE",
                            "value": "[parameters('wlsIdentityKeyStoreType')]"
                          },
                          {
                            "name": "WLS_SSL_TRUST_DATA",
                            "secureValue": "[parameters('wlsTrustKeyStoreData')]"
                          },
                          {
                            "name": "WLS_SSL_TRUST_PASSWORD",
                            "secureValue": "[parameters('wlsTrustKeyStorePassPhrase')]"
                          },
                          {
                            "name": "WLS_SSL_TRUST_TYPE",
                            "value": "[parameters('wlsTrustKeyStoreType')]"
                          },
                          {
                            "name": "WLS_SSL_PRIVATE_KEY_ALIAS",
                            "secureValue": "[parameters('wlsPrivateKeyAlias')]"
                          },
                          {
                            "name": "WLS_SSL_PRIVATE_KEY_PASSWORD",
                            "secureValue": "[parameters('wlsPrivateKeyPassPhrase')]"
                          },
                          {
                            "name": "WLS_T3_ADMIN_PORT",
                            "value": "[string(parameters('t3ChannelAdminPort'))]"
                          },
                          {
                            "name": "WLS_T3_CLUSTER_PORT",
                            "value": "[string(parameters('t3ChannelClusterPort'))]"
                          },
                          {
                            "name": "WLS_WDT_RUNTIME_PSW",
                            "secureValue": "[parameters('wdtRuntimePassword')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setUpDomainScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_genDomainConfigScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvcTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_buildDockerImageScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_updateDomainConfigScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
              ]
            },
            {
              "condition": "[parameters('enableCustomSSL')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-ssl-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidSSLEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-domain-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-domain-deployment')]"
              ]
            }
          ],
          "outputs": {
            "aksClusterName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2020-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
            },
            "aksClusterRGName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
            },
            "aksNodeRgName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2020-10-01').outputs.aksNodeRgName.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aksClusterRGName')), 'Microsoft.ContainerService/managedClusters', parameters('aksClusterName')), '2023-08-01').nodeResourceGroup)]"
            },
            "adminServerEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-admin-server.{0}-ns.svc.cluster.local:7001/console', parameters('wlsDomainUID'))]"
            },
            "adminServerT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableAdminT3Tunneling'), format('{0}://{1}-admin-server.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelAdminPort')), '')]"
            },
            "clusterEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-cluster-cluster-1.{0}-ns.svc.cluster.local:8001/', parameters('wlsDomainUID'))]"
            },
            "clusterT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableClusterT3Tunneling'), format('{0}://{1}-cluster-cluster-1.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelClusterPort')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]",
        "[resourceId('Microsoft.Resources/deployments', 'upload-wls-ssl-cert-to-keyvault')]"
      ]
    },
    {
      "condition": "[variables('const_enableNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "networking-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidNetworkingEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.networkingEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.networkingEnd.value)]"
          },
          "_pidNetworkingStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.networkingStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.networkingStart.value)]"
          },
          "aksClusterRGName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value]"
          },
          "appGatewayName": {
            "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'application-gateway-deployment'), '2020-10-01').outputs.appGatewayName.value, '')]"
          },
          "appGatewayAlias": {
            "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'application-gateway-deployment'), '2020-10-01').outputs.appGatewayAlias.value, '')]"
          },
          "appGatewaySecuredURL": {
            "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'application-gateway-deployment'), '2020-10-01').outputs.appGatewaySecuredURL.value, '')]"
          },
          "appGatewayURL": {
            "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'application-gateway-deployment'), '2020-10-01').outputs.appGatewayURL.value, '')]"
          },
          "appGatewaySslCert": {
            "value": "[variables('name_appgwFrontendSSLCertName')]"
          },
          "appGatewayTrustedRootCert": {
            "value": "[variables('name_appgwBackendRootCertName')]"
          },
          "appgwUsePrivateIP": {
            "value": "[parameters('appgwUsePrivateIP')]"
          },
          "appgwForAdminServer": {
            "value": "[parameters('appgwForAdminServer')]"
          },
          "appgwForRemoteConsole": {
            "value": "[parameters('appgwForRemoteConsole')]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createDNSZone": {
            "value": "[parameters('createDNSZone')]"
          },
          "dnszoneAdminConsoleLabel": {
            "value": "[parameters('dnszoneAdminConsoleLabel')]"
          },
          "dnszoneAdminT3ChannelLabel": {
            "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
          },
          "dnszoneClusterLabel": {
            "value": "[parameters('dnszoneClusterLabel')]"
          },
          "dnszoneClusterT3ChannelLabel": {
            "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
          },
          "dnszoneName": {
            "value": "[parameters('dnszoneName')]"
          },
          "dnszoneRGName": {
            "value": "[parameters('dnszoneRGName')]"
          },
          "enableAppGWIngress": {
            "value": "[parameters('enableAppGWIngress')]"
          },
          "enableCookieBasedAffinity": {
            "value": "[parameters('enableCookieBasedAffinity')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableDNSConfiguration": {
            "value": "[parameters('enableDNSConfiguration')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "lbSvcValues": {
            "value": "[parameters('lbSvcValues')]"
          },
          "useInternalLB": {
            "value": "[parameters('useInternalLB')]"
          },
          "wlsDomainName": {
            "value": "[parameters('wlsDomainName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "16625188559085171092"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidDnsEnd": {
              "type": "string",
              "defaultValue": "pid-networking-dns-end"
            },
            "_pidDnsStart": {
              "type": "string",
              "defaultValue": "pid-networking-dns-start"
            },
            "_pidLbEnd": {
              "type": "string",
              "defaultValue": "pid-networking-lb-end"
            },
            "_pidLbStart": {
              "type": "string",
              "defaultValue": "pid-networking-lb-start"
            },
            "_pidNetworkingEnd": {
              "type": "string",
              "defaultValue": "pid-networking-end"
            },
            "_pidNetworkingStart": {
              "type": "string",
              "defaultValue": "pid-networking-start"
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": "aks-contoso-rg",
              "metadata": {
                "description": "Resource group name of an existing AKS cluster."
              }
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "aks-contoso",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "appGatewayName": {
              "type": "string",
              "defaultValue": ""
            },
            "appGatewayAlias": {
              "type": "string",
              "defaultValue": ""
            },
            "appGatewaySecuredURL": {
              "type": "string",
              "defaultValue": ""
            },
            "appGatewaySslCert": {
              "type": "string",
              "defaultValue": ""
            },
            "appGatewayTrustedRootCert": {
              "type": "string",
              "defaultValue": ""
            },
            "appGatewayURL": {
              "type": "string",
              "defaultValue": ""
            },
            "appgwForAdminServer": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Create Application Gateway ingress for admin console."
              }
            },
            "appgwForRemoteConsole": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Create Application Gateway ingress for remote console."
              }
            },
            "appgwUsePrivateIP": {
              "type": "bool",
              "defaultValue": false
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "createAKSCluster": {
              "type": "bool",
              "defaultValue": true
            },
            "createDNSZone": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "If true, the template will update records to the existing DNS Zone. If false, the template will create a new DNS Zone."
              }
            },
            "dnszoneName": {
              "type": "string",
              "defaultValue": "contoso.xyz",
              "metadata": {
                "description": "Azure DNS Zone name."
              }
            },
            "dnszoneAdminConsoleLabel": {
              "type": "string",
              "defaultValue": "admin"
            },
            "dnszoneAdminT3ChannelLabel": {
              "type": "string",
              "defaultValue": "admin-t3"
            },
            "dnszoneClusterLabel": {
              "type": "string",
              "defaultValue": "www",
              "metadata": {
                "description": "Specify a label used to generate subdomain of WebLogic cluster. The final subdomain name will be label.dnszoneName, e.g. applications.contoso.xyz"
              }
            },
            "dnszoneClusterT3ChannelLabel": {
              "type": "string",
              "defaultValue": "cluster-t3"
            },
            "dnszoneRGName": {
              "type": "string",
              "defaultValue": "dns-contoso-rg"
            },
            "enableAppGWIngress": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to set up Application Gateway ingress."
              }
            },
            "enableCookieBasedAffinity": {
              "type": "bool",
              "defaultValue": false
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false
            },
            "enableDNSConfiguration": {
              "type": "bool",
              "defaultValue": false
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "location": {
              "type": "string"
            },
            "lbSvcValues": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Object array to define Load Balancer service, each object must include service name, service target[admin-server or cluster-1], port."
              }
            },
            "useInternalLB": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "True to set up internal load balancer service."
              }
            },
            "wlsDomainName": {
              "type": "string",
              "defaultValue": "domain1",
              "metadata": {
                "description": "Name of WebLogic domain to create."
              }
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            }
          },
          "variables": {
            "_enableAppGWIngress": "[parameters('enableAppGWIngress')]",
            "const_appgwCustomDNSAlias": "[format('{0}.{1}/', parameters('dnszoneClusterLabel'), parameters('dnszoneName'))]",
            "const_appgwAdminCustomDNSAlias": "[format('{0}.{1}/', parameters('dnszoneAdminConsoleLabel'), parameters('dnszoneName'))]",
            "const_enableLbService": "[greater(length(parameters('lbSvcValues')), 0)]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-networking-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidNetworkingStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[variables('const_enableLbService')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-loadbalancer-service-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidLbStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableDNSConfiguration')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-dns-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidDnsStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[and(parameters('enableDNSConfiguration'), parameters('createDNSZone'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "dnszone-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "14887684426611215996"
                    }
                  },
                  "parameters": {
                    "dnszoneName": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure DNS Zone name."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/dnszones",
                      "apiVersion": "2023-07-01-preview",
                      "name": "[parameters('dnszoneName')]",
                      "location": "global",
                      "properties": {
                        "zoneType": "Public"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-dns-start-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'pid-networking-start-deployment')]"
              ]
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "install-agic",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "appgwName": {
                    "value": "[parameters('appGatewayName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "12582797575356286149"
                    }
                  },
                  "parameters": {
                    "aksClusterName": {
                      "type": "string"
                    },
                    "aksClusterRGName": {
                      "type": "string"
                    },
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "base64_common": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZXhwb3J0IGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9MjAgIyBpbnRlcnZhbCBvZiBjaGVja2luZyBwb2Qgc3RhdHVzLgpleHBvcnQgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPTEwMCAjIG1heCBhdHRlbXB0IHRvIGNoZWNrIHBvZCBzdGF0dXMuCmV4cG9ydCBjaGVja1BWU3RhdGVJbnRlcnZhbD01ICMgaW50ZXJ2YWwgb2YgY2hlY2tpbmcgcHZjIHN0YXR1cy4KZXhwb3J0IGNoZWNrUFZTdGF0ZU1heEF0dGVtcHQ9MTAgIyBtYXggYXR0ZW1wdCB0byBjaGVjayBwdmMgc3RhdHVzLgpleHBvcnQgY2hlY2tTVkNTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrU1ZDSW50ZXJ2YWw9MzAgI3NlY29uZHMKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c01heEF0dGVtcHQ9MTAKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c0ludGVydmFsPTMwCmV4cG9ydCBjaGVja0luZ3Jlc3NTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrQWNySW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWNyTWF4QXR0ZW1wdD0xMApleHBvcnQgY2hlY2tBZ2ljSW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWdpY01heEF0dGVtcHQ9NTAKCmV4cG9ydCBjb25zdEFkbWluVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0FETUlOX0FERFJFU1MiCmV4cG9ydCBjb25zdEFkbWluU2VydmVyTmFtZT0nYWRtaW4tc2VydmVyJwpleHBvcnQgY29uc3RDbHVzdGVyTmFtZT0nY2x1c3Rlci0xJwpleHBvcnQgY29uc3RDbHVzdGVyVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0NMVVNURVJfQUREUkVTUyIKZXhwb3J0IGNvbnN0REJUeXBlTXlTUUw9Im15c3FsIgpleHBvcnQgY29uc3REQlR5cGVTcWxTZXJ2ZXI9InNxbHNlcnZlciIKZXhwb3J0IGNvbnN0RGVmYXVsdEphdmFPcHRpb25zPSItRGxvZzRqMi5mb3JtYXRNc2dOb0xvb2t1cHM9dHJ1ZSAtRHdlYmxvZ2ljLlN0ZG91dERlYnVnRW5hYmxlZD1mYWxzZSIgIyB0aGUgamF2YSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0SlZNQXJncz0iLURqYXZhLnNlY3VyaXR5LmVnZD1maWxlOi9kZXYvLi91cmFuZG9tIC1YbXMyNTZtIC1YbXg1MTJtIC1YWDpNaW5SQU1QZXJjZW50YWdlPTI1LjAgLVhYOk1heFJBTVBlcmNlbnRhZ2U9NTAuMCAiICMgdGhlIEpWTSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0QUtTVmVyc2lvbj0iZGVmYXVsdCIKZXhwb3J0IGV4dGVybmFsSkRCQ0xpYnJhcmllc0RpcmVjdG9yeU5hbWU9ImV4dGVybmFsSkRCQ0xpYnJhcmllcyIKZXhwb3J0IGNvbnN0RmFsc2U9ImZhbHNlIgpleHBvcnQgY29uc3RUcnVlPSJ0cnVlIgpleHBvcnQgY29uc3RJbnRyb3NwZWN0b3JKb2JBY3RpdmVEZWFkbGluZVNlY29uZHM9MzAwICAjIGZvciBHdWFyYW50ZWVkIFFvcwpleHBvcnQgY29uc3RQb3N0Z3JlRHJpdmVyTmFtZT0icG9zdGdyZXNxbC00Mi41LjEuamFyIgpleHBvcnQgY29uc3RNU1NRTERyaXZlck5hbWU9Im1zc3FsLWpkYmMtMTAuMi4xLmpyZTguamFyIgpleHBvcnQgY29uc3RBenVyZUNvcmVWZXJzaW9uPSIxLjM0LjAiCmV4cG9ydCBjb25zdERiUG9kSWRlbnRpdHlTZWxlY3Rvcj0iZGItcG9kLWlkZW50aXR5IiAjIGRvIG5vdCBjaGFuZ2UgdGhlIHZhbHVlCmV4cG9ydCBjb25zdFByZWNsYXNzRGlyZWN0b3J5TmFtZT0icHJlY2xhc3NMaWJyYXJpZXMiCgpleHBvcnQgY3VybE1heFRpbWU9MTIwICMgc2Vjb25kcwpleHBvcnQgb2NyTG9naW5TZXJ2ZXI9ImNvbnRhaW5lci1yZWdpc3RyeS5vcmFjbGUuY29tIgpleHBvcnQgb2NyR2FJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWMiCmV4cG9ydCBvY3JDcHVJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWNfY3B1IgpleHBvcnQgZ2l0VXJsNENwdUltYWdlcz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvd2VibG9naWNfY3B1X2ltYWdlcy5qc29uIgpleHBvcnQgZ2l0VXJsNEFrc1dlbGxUZXN0ZWRWZXJzaW9uSnNvbkZpbGU9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9vcmFjbGUvd2VibG9naWMtYXp1cmUvbWFpbi93ZWJsb2dpYy1henVyZS1ha3Mvc3JjL21haW4vcmVzb3VyY2VzL2Frc193ZWxsX3Rlc3RlZF92ZXJzaW9uLmpzb24iCmV4cG9ydCBnaXRVcmw0V0xTVG9vbGluZ0ZhbWlseUpzb25GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy93ZWJsb2dpY190b29saW5nX2ZhbWlseS5qc29uIgpleHBvcnQgZ2l0VXJsNEF6dXJlSWRlbnRpdHlFeHRlbnNpb25zUG9tRmlsZT0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvYXp1cmUtaWRlbnRpdHktZXh0ZW5zaW9ucy54bWwiCmV4cG9ydCBnaXRVcmw0TXlTUUxEcml2ZXJQb21GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy9teXNxbC1jb25uZWN0b3ItamF2YS54bWwiCgpleHBvcnQgb3B0VW5pbnN0YWxsTWF4VHJ5PTUgIyBNYXggYXR0ZW1wdHMgdG8gd2FpdCBmb3IgdGhlIG9wZXJhdG9yIHVuaW5zdGFsbGVkCmV4cG9ydCBvcHRVbmluc3RhbGxJbnRlcnZhbD0xMAoKZXhwb3J0IHJldHJ5TWF4QXR0ZW1wdD01ICMgcmV0cnkgYXR0ZW1wdCBmb3IgY3VybCBjb21tYW5kCmV4cG9ydCByZXRyeUludGVydmFsPTEwCgpleHBvcnQgd2xzQ29udGFpbmVyTmFtZT0id2VibG9naWMtc2VydmVyIgpleHBvcnQgd2xzUG9zdGdyZXNxbERyaXZlclVybD0iaHR0cHM6Ly9qZGJjLnBvc3RncmVzcWwub3JnL2Rvd25sb2FkL3Bvc3RncmVzcWwtNDIuNS4xLmphciIKZXhwb3J0IHdsc01TU1FMRHJpdmVyVXJsPSJodHRwczovL3JlcG8ubWF2ZW4uYXBhY2hlLm9yZy9tYXZlbjIvY29tL21pY3Jvc29mdC9zcWxzZXJ2ZXIvbXNzcWwtamRiYy8xMC4yLjEuanJlOC9tc3NxbC1qZGJjLTEwLjIuMS5qcmU4LmphciIK",
                    "base64_enableAgic": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCgpmdW5jdGlvbiBlbmFibGVfYWtzX21zaSgpIHsKICAgIGxvY2FsIGlkZW50aXR5TGVuZ3RoPSQoYXogYWtzIHNob3cgLWcgJHtBS1NfQ0xVU1RFUl9SR19OQU1FfSAtbiAke0FLU19DTFVTVEVSX05BTUV9IHwganEgJy5pZGVudGl0eSB8IGxlbmd0aCcpCiAgICBlY2hvICJpZGVudGl0eUxlbmd0aCAke2lkZW50aXR5TGVuZ3RofSIKCiAgICBpZiBbICRpZGVudGl0eUxlbmd0aCAtbHQgMSBdOyB0aGVuCiAgICAgICAgZWNobyAiZW5hYmxlIG1hbmFnZWQgaWRlbnRpdHkuLi4iCiAgICAgICAgIyBZb3VyIGNsdXN0ZXIgaXMgdXNpbmcgc2VydmljZSBwcmluY2lwYWwsIGFuZCB5b3UgYXJlIGdvaW5nIHRvIHVwZGF0ZSB0aGUgY2x1c3RlciB0byB1c2Ugc3lzdGVtYXNzaWduZWQgbWFuYWdlZCBpZGVudGl0eS4KICAgICAgICAjIEFmdGVyIHVwZGF0aW5nLCB5b3VyIGNsdXN0ZXIncyBjb250cm9sIHBsYW5lIGFuZCBhZGRvbiBwb2RzIHdpbGwgc3dpdGNoIHRvIHVzZSBtYW5hZ2VkIGlkZW50aXR5LCBidXQga3ViZWxldCB3aWxsIEtFRVAgVVNJTkcgU0VSVklDRSBQUklOQ0lQQUwgdW50aWwgeW91IHVwZ3JhZGUgeW91ciBhZ2VudHBvb2wuCiAgICAgICAgYXogYWtzIHVwZGF0ZSAteSAtZyAke0FLU19DTFVTVEVSX1JHX05BTUV9IC1uICR7QUtTX0NMVVNURVJfTkFNRX0gLS1lbmFibGUtbWFuYWdlZC1pZGVudGl0eQoKICAgICAgICB1dGlsaXR5X3ZhbGlkYXRlX3N0YXR1cyAiRW5hYmxlIG1hbmFnZWQgaWRlbnRpdHkgZm9yICR7QUtTX0NMVVNURVJfTkFNRX0uIgogICAgZmkKfQoKZnVuY3Rpb24gaW5zdGFsbF9henVyZV9pbmdyZXNzKCkgewogICAgbG9jYWwgYWdpY0VuYWJsZWQ9JChheiBha3Mgc2hvdyAtbiAke0FLU19DTFVTVEVSX05BTUV9IC1nICR7QUtTX0NMVVNURVJfUkdfTkFNRX0gfCAKICAgICAgICBqcSAnLmFkZG9uUHJvZmlsZXMuaW5ncmVzc0FwcGxpY2F0aW9uR2F0ZXdheS5lbmFibGVkJykKICAgIGxvY2FsIGFnaWNHYXRld2F5SWQ9IiIKICAgIAogICAgaWYgW1sgIiR7YWdpY0VuYWJsZWQsLH0iID09ICJ0cnVlIiBdXTsgdGhlbgogICAgICAgIGFnaWNHYXRld2F5SWQ9JChheiBha3Mgc2hvdyAtbiAke0FLU19DTFVTVEVSX05BTUV9IC1nICR7QUtTX0NMVVNURVJfUkdfTkFNRX0gfAogICAgICAgICAgICBqcSAnLmFkZG9uUHJvZmlsZXMuaW5ncmVzc0FwcGxpY2F0aW9uR2F0ZXdheS5jb25maWcuYXBwbGljYXRpb25HYXRld2F5SWQnIHwKICAgICAgICAgICAgdHIgLWQgIlwiIikKICAgIGZpCgogICAgbG9jYWwgYXBwZ3dJZD0kKGF6IG5ldHdvcmsgYXBwbGljYXRpb24tZ2F0ZXdheSBzaG93IFwKICAgICAgICAtbiAke0FQUEdXX05BTUV9IFwKICAgICAgICAtZyAke0NVUlJFTlRfUkdfTkFNRX0gLW8gdHN2IC0tcXVlcnkgImlkIikKCiAgICBpZiBbWyAiJHthZ2ljR2F0ZXdheUlkfSIgIT0gIiR7YXBwZ3dJZH0iIF1dOyB0aGVuCiAgICAgICAgYXogYWtzIGVuYWJsZS1hZGRvbnMgLW4gJHtBS1NfQ0xVU1RFUl9OQU1FfSAtZyAke0FLU19DTFVTVEVSX1JHX05BTUV9IC0tYWRkb25zIGluZ3Jlc3MtYXBwZ3cgLS1hcHBndy1pZCAkYXBwZ3dJZAogICAgICAgIHV0aWxpdHlfdmFsaWRhdGVfc3RhdHVzICJJbnN0YWxsIGFwcCBnYXRld2F5IGluZ3Jlc3MgY29udHJvbGxlci4iCiAgICBmaQp9CgojIE1haW4gc2NyaXB0CnNldCAtRW8gcGlwZWZhaWwKCmVuYWJsZV9ha3NfbXNpCgppbnN0YWxsX2F6dXJlX2luZ3Jlc3MK",
                    "base64_utility": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZnVuY3Rpb24gZWNob19zdGRlcnIoKSB7CiAgICBlY2hvID4mMiAiJEAiCiAgICAjIFRoZSBmdW5jdGlvbiBpcyB1c2VkIGZvciBzY3JpcHRzIHJ1bm5pbmcgd2l0aGluIEF6dXJlIERlcGxveW1lbnQgU2NyaXB0CiAgICAjIFRoZSB2YWx1ZSBvZiBBWl9TQ1JJUFRTX09VVFBVVF9QQVRIIGlzIC9tbnQvYXpzY3JpcHRzL2F6c2NyaXB0b3V0cHV0CiAgICBlY2hvIC1lICIkQCIgPj4ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9lcnJvcnMubG9nCn0KCmZ1bmN0aW9uIGVjaG9fc3Rkb3V0KCkgewogICAgZWNobyAiJEAiCiAgICAjIFRoZSBmdW5jdGlvbiBpcyB1c2VkIGZvciBzY3JpcHRzIHJ1bm5pbmcgd2l0aGluIEF6dXJlIERlcGxveW1lbnQgU2NyaXB0CiAgICAjIFRoZSB2YWx1ZSBvZiBBWl9TQ1JJUFRTX09VVFBVVF9QQVRIIGlzIC9tbnQvYXpzY3JpcHRzL2F6c2NyaXB0b3V0cHV0CiAgICBlY2hvIC1lICIkQCIgPj4ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9kZWJ1Zy5sb2cKfQoKI1ZhbGlkYXRlIHRlbWluYWwgc3RhdHVzIHdpdGggJD8sIGV4aXQgd2l0aCBleGNlcHRpb24gaWYgZXJyb3JzIGhhcHBlbi4KZnVuY3Rpb24gdXRpbGl0eV92YWxpZGF0ZV9zdGF0dXMoKSB7CiAgICBpZiBbICQ/ID09IDEgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICIkQCIKICAgICAgICBlY2hvX3N0ZGVyciAiRXJyb3JzIGhhcHBlbiwgZXhpdCAxLiIKICAgICAgICBleGl0IDEKICAgIGVsc2UKICAgICAgICBlY2hvX3N0ZG91dCAiJEAiCiAgICBmaQp9CgojIEpBVkFfSE9NRT0vdXNyL2xpYi9qdm0vamF2YS0xMS1vcGVuamRrCmZ1bmN0aW9uIGluc3RhbGxfamRrKCkgewogICAgbG9jYWwgcmVhZHk9ZmFsc2UKICAgIGxvY2FsIGF0dGVtcHQ9MAogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke3JldHJ5TWF4QXR0ZW1wdH0gXV07IGRvCiAgICAgICAgZWNobyAiSW5zdGFsbGluZyBvcGVuamRrMTEgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgIyBJbnN0YWxsIE1pY3Jvc29mdCBPcGVuSkRLCiAgICAgICAgYXBrIHVwZ3JhZGUKICAgICAgICBhcGsgYWRkIG9wZW5qZGsxMSBcCiAgICAgICAgICAgIC0tbm8tY2FjaGUgXAogICAgICAgICAgICAtcSAtLXJlcG9zaXRvcnk9aHR0cDovL2RsLWNkbi5hbHBpbmVsaW51eC5vcmcvYWxwaW5lL2VkZ2UvY29tbXVuaXR5CgogICAgICAgIGVjaG8gImphdmEgdmVyc2lvbiIKICAgICAgICBqYXZhIC12ZXJzaW9uCiAgICAgICAgaWYgWyAkPyAtZXEgMSBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5PWZhbHNlCiAgICAgICAgZmkKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtyZXRyeUludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtyZXRyeU1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGluc3RhbGwgb3BlbmpkazExLiIKICAgICAgICBleGl0IDEKICAgIGZpCn0KCmZ1bmN0aW9uIGluc3RhbGxfZG9ja2VyKCkgewogICAgbG9jYWwgcmVhZHk9ZmFsc2UKICAgIGxvY2FsIGF0dGVtcHQ9MAogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke3JldHJ5TWF4QXR0ZW1wdH0gXV07IGRvCiAgICAgICAgZWNobyAiSW5zdGFsbGluZyBkb2NrZXIgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgYXBrIGFkZCBkb2NrZXIgLS1uby1jYWNoZSAtLXF1aWV0CiAgICAgICAgZG9ja2VyIC0taGVscAogICAgICAgIGlmIFsgJD8gLWVxIDEgXTsgdGhlbgogICAgICAgICAgICByZWFkeT1mYWxzZQogICAgICAgIGZpCgogICAgICAgIGF0dGVtcHQ9JCgoYXR0ZW1wdCArIDEpKQogICAgICAgIHNsZWVwICR7cmV0cnlJbnRlcnZhbH0KICAgIGRvbmUKCiAgICBpZiBbICR7YXR0ZW1wdH0gLWd0ICR7cmV0cnlNYXhBdHRlbXB0fSBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBpbnN0YWxsIGRvY2tlci4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgpmdW5jdGlvbiBpbnN0YWxsX2t1YmVjdGwoKSB7CiAgICBsb2NhbCByZWFkeT1mYWxzZQogICAgbG9jYWwgYXR0ZW1wdD0wCiAgICB3aGlsZSBbWyAiJHtyZWFkeX0iID09ICJmYWxzZSIgJiYgJGF0dGVtcHQgLWxlICR7cmV0cnlNYXhBdHRlbXB0fSBdXTsgZG8KICAgICAgICBlY2hvICJJbnN0YWxsaW5nIGt1YmVjdGwgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgIyBJbnN0YWxsIGt1YmVjdGwKICAgICAgICBheiBha3MgaW5zdGFsbC1jbGkKICAgICAgICBlY2hvICJ2YWxpZGF0ZSBrdWJlY3RsIgogICAgICAgIGt1YmVjdGwgLS1oZWxwCiAgICAgICAgaWYgWyAkPyAtZXEgMSBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5PWZhbHNlCiAgICAgICAgZmkKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtyZXRyeUludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtyZXRyeU1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGluc3RhbGwga3ViZWN0bC4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgpmdW5jdGlvbiBpbnN0YWxsX2hlbG0oKSB7CiAgICAjIEluc3RhbGwgSGVsbQogICAgYnJvd3NlclVSTD0kKGN1cmwgLW0gJHtjdXJsTWF4VGltZX0gLS1yZXRyeSAke3JldHJ5TWF4QXR0ZW1wdH0gLXMgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9oZWxtL2hlbG0vcmVsZWFzZXMvbGF0ZXN0IHwKICAgICAgICBncmVwICJicm93c2VyX2Rvd25sb2FkX3VybC4qbGludXgtYW1kNjQudGFyLmd6LmFzYyIgfAogICAgICAgIGN1dCAtZCA6IC1mIDIsMyB8CiAgICAgICAgdHIgLWQgXCIpCiAgICBoZWxtTGF0ZXN0VmVyc2lvbj0ke2Jyb3dzZXJVUkwjKmRvd25sb2FkXC99CiAgICBoZWxtTGF0ZXN0VmVyc2lvbj0ke2hlbG1MYXRlc3RWZXJzaW9uJSVcL2hlbG0qfQogICAgaGVsbVBhY2thZ2VOYW1lPWhlbG0tJHtoZWxtTGF0ZXN0VmVyc2lvbn0tbGludXgtYW1kNjQudGFyLmd6CiAgICBjdXJsIC1tICR7Y3VybE1heFRpbWV9IC0tcmV0cnkgJHtyZXRyeU1heEF0dGVtcHR9IC1mTCBodHRwczovL2dldC5oZWxtLnNoLyR7aGVsbVBhY2thZ2VOYW1lfSAtbyAvdG1wLyR7aGVsbVBhY2thZ2VOYW1lfQogICAgdGFyIC16eHZmIC90bXAvJHtoZWxtUGFja2FnZU5hbWV9IC1DIC90bXAKICAgIG12IC90bXAvbGludXgtYW1kNjQvaGVsbSAvdXNyL2xvY2FsL2Jpbi9oZWxtCiAgICBlY2hvICJIZWxtIHZlcnNpb24iCiAgICBoZWxtIHZlcnNpb24KICAgIHV0aWxpdHlfdmFsaWRhdGVfc3RhdHVzICJGaW5pc2hlZCBpbnN0YWxsaW5nIEhlbG0uIgp9CgojIFF1ZXJ5IHNlcnZpY2UgcG9ydAojICQxOiBzZXJ2aWNlIG5hbWUKIyAkMjogbmFtZXNwYWNlCiMgJDM6IGNoYW5uZWwgbmFtZQojIHJldHVybjogcG9ydAojIE5vdGVzOiBjaGFubmVsIG5hbWUgd2lsbCBiZSBkaWZmZXJlbnQgaWYgaXN0aW8gaXMgZW5hYmxlZC4KZnVuY3Rpb24gdXRpbGl0eV9xdWVyeV9zZXJ2aWNlX3BvcnQoKSB7CiAgICBsb2NhbCBwb3J0PSQoa3ViZWN0bCBnZXQgc2VydmljZSAkezF9IC1uICR7Mn0gLW8ganNvbiB8CiAgICAgICAganEgIi5zcGVjLnBvcnRzW10gfCBzZWxlY3QoLm5hbWU9PVwiJHszfVwiKSB8IC5wb3J0IikKICAgIGlmIFsgJD8gIT0gMCBdIHx8IFtbICIkcG9ydCIgPT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBxdWVyeSBwb3J0IG9mICR7MX0vJHszfSBpbiBuYW1lc3BhY2UgJHsyfSIKICAgICAgICBleGl0IDEKICAgIGZpCgogICAgZWNobyAkcG9ydAp9CgojCiMgQ2hlY2sgdGhlIHN0YXRlIG9mIGEgcGVyc2lzdGVudCB2b2x1bWUuCiMgTGV2ZXJhZ2Ugc291cmNlIGNvZGUgZnJvbSBmdW5jdGlvbiAiY2hlY2tQdlN0YXRlIiBpbiB3ZWJsb2dpYy1vcGVyYXRvciwga3ViZXJuZXRlc1xzYW1wbGVzXHNjcmlwdHNcY29tbW9uXHV0aWxpdHkuc2gKIyAkMSAtIG5hbWUgb2Ygdm9sdW1lCiMgJDIgLSBleHBlY3RlZCBzdGF0ZSBvZiB2b2x1bWUKIyAkMyAtIG1heCBhdHRlbXB0CiMgJDQgLSBpbnRlcnZhbApmdW5jdGlvbiB1dGlsaXR5X2NoZWNrX3B2X3N0YXRlIHsKCiAgICBlY2hvX3N0ZG91dCAiQ2hlY2tpbmcgaWYgdGhlIHBlcnNpc3RlbnQgdm9sdW1lICR7MTo/fSBpcyAkezI6P30iCiAgICBsb2NhbCBwdl9zdGF0ZT0kKGt1YmVjdGwgZ2V0IHB2ICQxIC1vIGpzb25wYXRoPSd7LnN0YXR1cy5waGFzZX0nKQogICAgYXR0ZW1wdHM9MAogICAgd2hpbGUgWyAhICIkcHZfc3RhdGUiID0gIiQyIiBdICYmIFsgISAkYXR0ZW1wdHMgLWVxICQzIF07IGRvCiAgICAgICAgYXR0ZW1wdHM9JCgoYXR0ZW1wdHMgKyAxKSkKICAgICAgICBzbGVlcCAkNAogICAgICAgIHB2X3N0YXRlPSQoa3ViZWN0bCBnZXQgcHYgJDEgLW8ganNvbnBhdGg9J3suc3RhdHVzLnBoYXNlfScpCiAgICBkb25lCiAgICBpZiBbICIkcHZfc3RhdGUiICE9ICIkMiIgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICJUaGUgcGVyc2lzdGVudCB2b2x1bWUgc3RhdGUgc2hvdWxkIGJlICQyIGJ1dCBpcyAkcHZfc3RhdGUiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojCiMgQ3JlYXRlIGRpcmVjdG9yeSBpbiBzcGVjaWZpZWQgZmlsZSBzaGFyZQojICQxIC0gbmFtZSBvZiBkaXJlY3RvcnkKIyAkMiAtIG5hbWUgb2YgZmlsZSBzaGFyZQojICQzIC0gbmFtZSBvZiBzdG9yYWdlIGFjY291bnQKIyAkNCAtIHNhcyB0b2tlbgpmdW5jdGlvbiB1dGlsaXR5X2NyZWF0ZV9kaXJlY3RvcnlfdG9fZmlsZXNoYXJlKCkgewogICAgcmV0PSQoYXogc3RvcmFnZSBkaXJlY3RvcnkgZXhpc3RzIC0tbmFtZSAkMSAtLXNoYXJlLW5hbWUgJDIgLS1hY2NvdW50LW5hbWUgJDMgLS1zYXMtdG9rZW4gJHs0fSB8IGpxICcuZXhpc3RzJykKICAgIGlmIFtbICIke3JldCwsfSIgPT0gImZhbHNlIiBdXTsgdGhlbgogICAgICAgIGF6IHN0b3JhZ2UgZGlyZWN0b3J5IGNyZWF0ZSAtLW5hbWUgJDEgLS1zaGFyZS1uYW1lICQyIC0tYWNjb3VudC1uYW1lICQzIC0tc2FzLXRva2VuICR7NH0gLS10aW1lb3V0IDMwCiAgICBmaQoKICAgIGlmIFsgJD8gIT0gMCBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBjcmVhdGUgZGlyZWN0b3J5ICR7MX0gaW4gZmlsZSBzaGFyZSAkezN9LyR7Mn0iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojCiMgVXBsb2FkIGZpbGUgdG8gZmlsZSBzaGFyZQojICQxIC0gbmFtZSBvZiBmaWxlIHNoYXJlCiMgJDIgLSBuYW1lIG9mIHN0b3JhZ2UgYWNjb3VudAojICQzIC0gcGF0aCBvZiBmaWxlCiMgJDQgLSBzb3VyY2UgcGF0aCBvZiBmaWxlCiMgJDUgLSBzYXMgdG9rZW4KZnVuY3Rpb24gdXRpbGl0eV91cGxvYWRfZmlsZV90b19maWxlc2hhcmUoKSB7CiAgICBheiBzdG9yYWdlIGZpbGUgdXBsb2FkIC0tc2hhcmUtbmFtZSAkezF9IC0tYWNjb3VudC1uYW1lICR7Mn0gLS1wYXRoICR7M30gLS1zb3VyY2UgJHs0fSAtLXNhcy10b2tlbiAkezV9IC0tdGltZW91dCA2MAogICAgaWYgWyAkPyAhPSAwIF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHVwbG9hZCAkezN9IHRvIGZpbGUgc2hhcmUgJHsyfS8kezF9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQoKIwojIE1ha2Ugc3VyZSBhbGwgdGhlIGFwcGxpY2F0aW9ucyBhcmUgcnVubmluZwojIEV4aXQgd2l0aCBlcnJvciBpZiB0aGVyZSBpcyBpbmFjdGl2ZSBhcHBsaWNhdGlvbi4KIyAkMSAtIG5hbWVzcGFjZSBvZiB0aGUgZG9tYWluCiMgJDIgLSBDbHVzdGVySVAgc2VydmljZSBuYW1lIG9mIGFkbWluIHNlcnZlcgojICQzIC0gZG9tYWluIHVzZXIKIyAkNCAtIGRvbWFpbiBwYXNzd29yZAojICQ1IC0gcGF0aCBvZiBweXRob24gc2NyaXB0IHdoaWNoIGNoZWNrcyBhcHBsaWNhdGlvbiBzdGF0dXMsIHRoZSBzY3JpcHQgd2lsbCBydW4gb24gYWRtaW4gc2VydmVyIHBvZC4KZnVuY3Rpb24gdXRpbGl0eV92YWxpZGF0ZV9hcHBsaWNhdGlvbl9zdGF0dXMoKSB7CiAgICBsb2NhbCB3bHNEb21haW5OUz0kMQogICAgbG9jYWwgd2xzQWRtaW5TdmNOYW1lPSQyCiAgICBsb2NhbCB3bHNVc2VyPSQzCiAgICBsb2NhbCB3bHNQYXNzd29yZD0kNAogICAgbG9jYWwgcHlTY3JpcHRQYXRoPSQ1CgogICAgbG9jYWwgcG9kTmFtZT0kKGt1YmVjdGwgLW4gJHt3bHNEb21haW5OU30gZ2V0IHBvZCAtbCB3ZWJsb2dpYy5zZXJ2ZXJOYW1lPWFkbWluLXNlcnZlciAtbyBqc29uIHwKICAgICAgICBqcSAnLml0ZW1zWzBdIHwgLm1ldGFkYXRhLm5hbWUnIHwKICAgICAgICB0ciAtZCAiXCIiKQoKICAgICMgZ2V0IG5vbi1zc2wgcG9ydAogICAgbG9jYWwgYWRtaW5UYXJnZXRQb3J0PSQoa3ViZWN0bCBnZXQgc3ZjICR7d2xzQWRtaW5TdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwganEgJy5zcGVjLnBvcnRzW10gfCBzZWxlY3QoLm5hbWU9PSJpbnRlcm5hbC10MyIpIHwgLnBvcnQnKQogICAgbG9jYWwgdDNDaGFubmVsQWRkcmVzcz0iJHtwb2ROYW1lfS4ke3dsc0RvbWFpbk5TfSIKCiAgICBsb2NhbCB0YXJnZXRGaWxlUGF0aD0vdG1wL2NoZWNrQXBwbGljYXRpb25TdGF0dXMucHkKICAgIGVjaG8gImNvcHkgJHtweVNjcmlwdFBhdGh9IHRvICR7dGFyZ2V0RmlsZVBhdGh9IgogICAga3ViZWN0bCBjcCAke3B5U2NyaXB0UGF0aH0gLW4gJHt3bHNEb21haW5OU30gJHtwb2ROYW1lfToke3RhcmdldEZpbGVQYXRofQogICAga3ViZWN0bCBleGVjIC1pdCAke3BvZE5hbWV9IC1uICR7d2xzRG9tYWluTlN9IC1jICJ3ZWJsb2dpYy1zZXJ2ZXIiIFwKICAgICAgICAtLSBiYXNoIC1jICJ3bHN0LnNoICR7dGFyZ2V0RmlsZVBhdGh9IC11c2VyICR7d2xzVXNlcn0gLXBhc3N3b3JkICR7d2xzUGFzc3dvcmR9IC10M0NoYW5uZWxBZGRyZXNzICR7dDNDaGFubmVsQWRkcmVzc30gLXQzQ2hhbm5lbFBvcnQgJHthZG1pblRhcmdldFBvcnR9IiB8CiAgICAgICAgZ3JlcCAiU3VtbWFyeTogYWxsIGFwcGxpY2F0aW9ucyBhcmUgYWN0aXZlIgoKICAgIGlmIFsgJD8gPT0gMSBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBkZXBsb3kgYXBwbGljYXRpb24gdG8gV0xTIGNsdXN0ZXIuIFBsZWFzZSBtYWtlIHN1cmUgdGhlIGNvbmZpZ3VyYXRpb25zIGFyZSBjb3JyZWN0LiIKICAgICAgICBleGl0IDEKICAgIGZpCn0KCiMgQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIG1ha2Ugc3VyZSBwb2RzIG9mIGEgZG9tYWluIGFyZSBydW5uaW5nLgojICAgKiBNYWtlIHN1cmUgdGhlIGFkbWluIHNlcnZlciBwb2QgaXMgcnVubmluZwojICAgKiBNYWtlIHN1cmUgYWxsIHRoZSBtYW5hZ2VkIHNlcnZlciBwb2RzIGFyZSBydW5uaW5nCiMgQXNzdW1pbmcgdGhlcmUgaXMgb25seSBvbmUgY2x1c3RlciBpbiB0aGUgZG9tYWluCiMgUGFyYW1ldGVyczoKIyAgICogYXBwUmVwbGljYXM6IHJlcGxpY2FzIG9mIHRoZSBtYW5hZ2VkIHNlcnZlcgojICAgKiB3bHNEb21haW5OUzogbmFtZSBzcGFjZQojICAgKiBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM6IG1heCBhdHRlbXB0cyB0byBxdWVyeSB0aGUgcG9kcyBzdGF0dXMgaWYgdGhleSBhcmUgbm90IGFsbCBydW5uaW5nLgojICAgKiBjaGVja1BvZFN0YXR1c0ludGVydmFsOiBpbnRlcnZhbCBvZiBxdWVyeSB0aGUgcG9kcyBzdGF0dXMKZnVuY3Rpb24gdXRpbGl0eV93YWl0X2Zvcl9wb2RfY29tcGxldGVkKCkgewogICAgYXBwUmVwbGljYXM9JDEKICAgIHdsc0RvbWFpbk5TPSQyCiAgICBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM9JDMKICAgIGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9JDQKCiAgICBlY2hvICJXYWl0aW5nIGZvciAkKChhcHBSZXBsaWNhcyArIDEpKSBwb2RzIGFyZSBydW5uaW5nLiIKCiAgICByZWFkeVBvZE51bT0wCiAgICBhdHRlbXB0PTAKICAgIHdoaWxlIFtbICR7cmVhZHlQb2ROdW19IC1sZSAke2FwcFJlcGxpY2FzfSAmJiAkYXR0ZW1wdCAtbGUgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF1dOyBkbwogICAgICAgIHJldD0kKGt1YmVjdGwgZ2V0IHBvZHMgLW4gJHt3bHNEb21haW5OU30gLW8ganNvbiB8CiAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zdGF0dXMucGhhc2UnIHwKICAgICAgICAgICAgZ3JlcCAiUnVubmluZyIpCiAgICAgICAgaWYgWyAteiAiJHtyZXR9IiBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5UG9kTnVtPTAKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlYWR5UG9kTnVtPSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zdGF0dXMucGhhc2UnIHwKICAgICAgICAgICAgICAgIGdyZXAgLWMgIlJ1bm5pbmciKQogICAgICAgIGZpCiAgICAgICAgZWNobyAiTnVtYmVyIG9mIG5ldyBydW5uaW5nIHBvZDogJHtyZWFkeVBvZE51bX0iCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiSXQgdGFrZXMgdG9vIGxvbmcgdG8gd2FpdCBmb3IgYWxsIHRoZSBwb2RzIHRvIHJlYWNoIHJ1bm5pbmcgc3RhdGUsIHBsZWFzZSByZWZlciB0byBodHRwczovL2FrYS5tcy93bHMtYWtzLXRyb3VibGVzaG9vdGluZy4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgcG9kcyBvZiBhIGRvbWFpbiBhcmUgdXBkYXRlZCB3aXRoIGV4cGVjdGVkIGltYWdlLgojICAgKiBNYWtlIHN1cmUgdGhlIGFkbWluIHNlcnZlciBwb2QgaXMgdXBkYXRlZCB3aXRoIGV4cGVjdGVkIGltYWdlCiMgICAqIE1ha2Ugc3VyZSBhbGwgdGhlIG1hbmFnZWQgc2VydmVyIHBvZHMgYXJlIHVwZGF0ZWQgd2l0aCBleHBlY3RlZCBpbWFnZQojIEFzc3VtaW5nIHRoZXJlIGlzIG9ubHkgb25lIGNsdXN0ZXIgaW4gdGhlIGRvbWFpbgojIFBhcmFtZXRlcnM6CiMgICAqIGFjckltYWdlUGF0aDogaW1hZ2UgcGF0aAojICAgKiBhcHBSZXBsaWNhczogcmVwbGljYXMgb2YgdGhlIG1hbmFnZWQgc2VydmVyCiMgICAqIHdsc0RvbWFpbk5TOiBuYW1lIHNwYWNlCiMgICAqIGNoZWNrUG9kU3RhdHVzTWF4QXR0ZW1wczogbWF4IGF0dGVtcHRzIHRvIHF1ZXJ5IHRoZSBwb2RzIHN0YXR1cyBpZiB0aGV5IGFyZSBub3QgYWxsIHJ1bm5pbmcuCiMgICAqIGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw6IGludGVydmFsIG9mIHF1ZXJ5IHRoZSBwb2RzIHN0YXR1cwpmdW5jdGlvbiB1dGlsaXR5X3dhaXRfZm9yX2ltYWdlX3VwZGF0ZV9jb21wbGV0ZWQoKSB7CiAgICAjIE1ha2Ugc3VyZSBhbGwgb2YgdGhlIHBvZHMgYXJlIHVwZGF0ZWQgd2l0aCBuZXcgaW1hZ2UuCiAgICAjIEFzc3VtcHRpb246IHdlIGhhdmUgb25seSBvbmUgY2x1c3RlciBjdXJyZW50bHkuCiAgICBhY3JJbWFnZVBhdGg9JDEKICAgIGFwcFJlcGxpY2FzPSQyCiAgICB3bHNEb21haW5OUz0kMwogICAgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPSQ0CiAgICBjaGVja1BvZFN0YXR1c0ludGVydmFsPSQ1CgogICAgZWNobyAiV2FpdGluZyBmb3IgJCgoYXBwUmVwbGljYXMgKyAxKSkgbmV3IHBvZHMgY3JlYXRlZCB3aXRoIGltYWdlICR7YWNySW1hZ2VQYXRofSIKCiAgICB1cGRhdGVkUG9kTnVtPTAKICAgIGF0dGVtcHQ9MAogICAgd2hpbGUgWyAke3VwZGF0ZWRQb2ROdW19IC1sZSAke2FwcFJlcGxpY2FzfSBdICYmIFsgJGF0dGVtcHQgLWxlICR7Y2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzfSBdOyBkbwogICAgICAgIGVjaG8gImF0dGVtcHRzICR7YXR0ZW1wdH0iCiAgICAgICAgcmV0PSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5pdGVtc1tdIHwgLnNwZWMgfCAuY29udGFpbmVyc1tdIHwgc2VsZWN0KC5uYW1lID09ICJ3ZWJsb2dpYy1zZXJ2ZXIiKSB8IC5pbWFnZScgfAogICAgICAgICAgICBncmVwICIke2FjckltYWdlUGF0aH0iKQoKICAgICAgICBpZiBbIC16ICIke3JldH0iIF07IHRoZW4KICAgICAgICAgICAgdXBkYXRlZFBvZE51bT0wCiAgICAgICAgZWxzZQogICAgICAgICAgICB1cGRhdGVkUG9kTnVtPSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zcGVjIHwgLmNvbnRhaW5lcnNbXSB8IHNlbGVjdCgubmFtZSA9PSAid2VibG9naWMtc2VydmVyIikgfCAuaW1hZ2UnIHwKICAgICAgICAgICAgICAgIGdyZXAgLWMgIiR7YWNySW1hZ2VQYXRofSIpCiAgICAgICAgZmkKICAgICAgICBlY2hvICJOdW1iZXIgb2YgbmV3IHBvZDogJHt1cGRhdGVkUG9kTnVtfSIKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHVwZGF0ZSBpbWFnZSAke2FjckltYWdlUGF0aH0gdG8gYWxsIHdlYmxvZ2ljIHNlcnZlciBwb2RzLiAiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgcG9kcyBvZiBhIGRvbWFpbiBhcmUgcmVzdGFydGVkLgojIEFzc3VtaW5nIHRoZXJlIGlzIG9ubHkgb25lIGNsdXN0ZXIgaW4gdGhlIGRvbWFpbgojIFBhcmFtZXRlcnM6CiMgICAqIGJhc2VUaW1lOiB0aW1lIHN0YW1wIHRoYXQgc2hvdWxkIGJlIGVhcmxpZXIgdGhlbiBwb2QgcmVzdGFydHMKIyAgICogYXBwUmVwbGljYXM6IHJlcGxpY2FzIG9mIHRoZSBtYW5hZ2VkIHNlcnZlcgojICAgKiB3bHNEb21haW5OUzogbmFtZSBzcGFjZQojICAgKiBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM6IG1heCBhdHRlbXB0cyB0byBxdWVyeSB0aGUgcG9kcyBzdGF0dXMgaWYgdGhleSBhcmUgbm90IGFsbCBydW5uaW5nLgojICAgKiBjaGVja1BvZFN0YXR1c0ludGVydmFsOiBpbnRlcnZhbCBvZiBxdWVyeSB0aGUgcG9kcyBzdGF0dXMKZnVuY3Rpb24gdXRpbGl0eV93YWl0X2Zvcl9wb2RfcmVzdGFydGVkKCkgewogICAgYmFzZVRpbWU9JDEKICAgIGFwcFJlcGxpY2FzPSQyCiAgICB3bHNEb21haW5VSUQ9JDMKICAgIGNoZWNrUG9kU3RhdHVzTWF4QXR0ZW1wcz0kNAogICAgY2hlY2tQb2RTdGF0dXNJbnRlcnZhbD0kNQoKICAgIHdsc0RvbWFpbk5TPSR7d2xzRG9tYWluVUlEfS1ucwoKICAgIHVwZGF0ZWRQb2ROdW09MAogICAgYXR0ZW1wdD0wCiAgICB3aGlsZSBbICR7dXBkYXRlZFBvZE51bX0gLWxlICR7YXBwUmVwbGljYXN9IF0gJiYgWyAkYXR0ZW1wdCAtbGUgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IGRvCiAgICAgICAgZWNobyAiYXR0ZW1wdHMgJHthdHRlbXB0fSIKICAgICAgICByZXQ9JChrdWJlY3RsIGdldCBwb2RzIC1uICR7d2xzRG9tYWluTlN9IC1sIHdlYmxvZ2ljLmRvbWFpblVJRD0ke3dsc0RvbWFpblVJRH0gLW8ganNvbiB8CiAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5tZXRhZGF0YS5jcmVhdGlvblRpbWVzdGFtcCcgfCB0ciAtZCAiXCIiKQoKICAgICAgICBjb3VudGVyPTAKICAgICAgICBmb3IgaXRlbSBpbiAkcmV0OyBkbwogICAgICAgICAgICAjIGNvbnZlciB0aGUgdGltZSBmb3JtYXQgZnJvbSBZWVlZLU1NLUREVGhoOm1tOnNzWiB0byBZWVlZLk1NLkRELWhoOm1tOnNzCiAgICAgICAgICAgIGFscGluZUl0ZW09JChlY2hvICIke2l0ZW19IiB8IHNlZCAtZSAicy8tLy4vZztzL1QvLS9nO3MvWi8vZyIpCiAgICAgICAgICAgIHBvZENyZWF0ZVRpbWVTdGFtcD0kKGRhdGUgLXUgLWQgIiR7YWxwaW5lSXRlbX0iICsiJXMiKQogICAgICAgICAgICBlY2hvICJwb2QgY3JlYXRlIHRpbWU6ICRwb2RDcmVhdGVUaW1lU3RhbXAsIGJhc2UgdGltZTogJHtiYXNlVGltZX0iCiAgICAgICAgICAgIGlmIFsgJHtwb2RDcmVhdGVUaW1lU3RhbXB9IC1ndCAke2Jhc2VUaW1lfSBdOyB0aGVuCiAgICAgICAgICAgICAgICBjb3VudGVyPSQoKGNvdW50ZXIgKyAxKSkKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCgogICAgICAgIHVwZGF0ZWRQb2ROdW09JGNvdW50ZXIKICAgICAgICBlY2hvICJOdW1iZXIgb2YgbmV3IHBvZDogJHt1cGRhdGVkUG9kTnVtfSIKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHJlc3RhcnQgYWxsIHdlYmxvZ2ljIHNlcnZlciBwb2RzLiAiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgdGhlIGxiIHNlcnZpY2UgaXMgYXZhbGlhYmxlLgpmdW5jdGlvbiB1dGlsaXR5X3dhaXRmb3JfbGJfc3ZjX2NvbXBsZXRlZCgpIHsKICAgIHN2Y05hbWU9JDEKICAgIHdsc0RvbWFpbk5TPSQyCiAgICBwZXJmU1ZDQXR0ZW1wcz0kMwogICAgcGVyZlJldHJ5SW50ZXJ2YWw9JDQKCiAgICBhdHRlbXB0cz0wCiAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgIHdoaWxlIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWx0ICR7cGVyZlNWQ0F0dGVtcHN9IF07IGRvCiAgICAgICAgc3ZjU3RhdGU9ImNvbXBsZXRlZCIKICAgICAgICBhdHRlbXB0cz0kKChhdHRlbXB0cyArIDEpKQogICAgICAgIGVjaG8gV2FpdGluZyBmb3Igam9iIGNvbXBsZXRlZC4uLiR7YXR0ZW1wdHN9CiAgICAgICAgc2xlZXAgJHtwZXJmUmV0cnlJbnRlcnZhbH0KCiAgICAgICAgaXA9JChrdWJlY3RsIGdldCBzdmMgJHtzdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5zdGF0dXMubG9hZEJhbGFuY2VyLmluZ3Jlc3NbMF0uaXAnKQogICAgICAgIGVjaG8gImlwOiAke2lwfSIKICAgICAgICBpZiBbWyAiJHtpcH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgICAgICBmaQogICAgZG9uZQoKICAgIGlmIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWdlICR7cGVyZlNWQ0F0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGNyZWF0ZSBzZXJ2aWNlOiAke3N2Y05hbWV9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQoKIyBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gbWFrZSBzdXJlIHRoZSBpbmdyZXNzIGlzIGF2YWxpYWJsZS4KZnVuY3Rpb24gdXRpbGl0eV93YWl0Zm9yX2luZ3Jlc3NfY29tcGxldGVkKCkgewogICAgc3ZjTmFtZT0kMQogICAgd2xzRG9tYWluTlM9JDIKICAgIHBlcmZTVkNBdHRlbXBzPSQzCiAgICBwZXJmUmV0cnlJbnRlcnZhbD0kNAoKICAgIGF0dGVtcHRzPTAKICAgIHN2Y1N0YXRlPSJydW5uaW5nIgogICAgd2hpbGUgWyAiJHN2Y1N0YXRlIiA9PSAicnVubmluZyIgXSAmJiBbICRhdHRlbXB0cyAtbHQgJHtwZXJmU1ZDQXR0ZW1wc30gXTsgZG8KICAgICAgICBzdmNTdGF0ZT0iY29tcGxldGVkIgogICAgICAgIGF0dGVtcHRzPSQoKGF0dGVtcHRzICsgMSkpCiAgICAgICAgZWNobyBXYWl0aW5nIGZvciBqb2IgY29tcGxldGVkLi4uJHthdHRlbXB0c30KICAgICAgICBzbGVlcCAke3BlcmZSZXRyeUludGVydmFsfQoKICAgICAgICBpcD0kKGt1YmVjdGwgZ2V0IGluZ3Jlc3MgJHtzdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5zdGF0dXMubG9hZEJhbGFuY2VyLmluZ3Jlc3NbMF0uaXAnKQogICAgICAgIGVjaG8gImlwOiAke2lwfSIKICAgICAgICBpZiBbWyAiJHtpcH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgICAgICBmaQogICAgZG9uZQoKICAgIGlmIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWdlICR7cGVyZlNWQ0F0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGNyZWF0ZSBzZXJ2aWNlOiAke3N2Y05hbWV9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQo=",
                    "const_deploymentName": "ds-install-agic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[variables('const_deploymentName')]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "scriptContent": "[format('{0}\r\n\r\n{1}\r\n\r\n{2}', base64ToString(variables('base64_common')), base64ToString(variables('base64_utility')), base64ToString(variables('base64_enableAgic')))]",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_RG_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "APPGW_NAME",
                            "value": "[parameters('appgwName')]"
                          },
                          {
                            "name": "CURRENT_RG_NAME",
                            "value": "[resourceGroup().name]"
                          }
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-networking-start-deployment')]"
              ]
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "allow-agic-access-current-resource-group",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "8359539449010825441"
                    }
                  },
                  "parameters": {
                    "aksClusterName": {
                      "type": "string"
                    },
                    "aksClusterRGName": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_APIVersion": "2020-12-01",
                    "name_appGwContributorRoleAssignmentName": "[guid(format('{0}{1}ForApplicationGateway', resourceGroup().id, parameters('utcValue')))]",
                    "const_roleDefinitionIdOfContributor": "b24988ac-6180-42a0-ab88-20f7382dd24c"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[variables('name_appGwContributorRoleAssignmentName')]",
                      "properties": {
                        "description": "Assign Resource Group Contributor role to User Assigned Managed Identity ",
                        "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aksClusterRGName')), 'Microsoft.ContainerService/managedClusters', parameters('aksClusterName')), variables('const_APIVersion'), 'Full').properties.addonProfiles.ingressApplicationGateway.identity.objectId]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('const_roleDefinitionIdOfContributor'))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'install-agic')]"
              ]
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "validate-agic",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "10833340935559867707"
                    }
                  },
                  "parameters": {
                    "aksClusterName": {
                      "type": "string"
                    },
                    "aksClusterRGName": {
                      "type": "string"
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "base64_common": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZXhwb3J0IGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9MjAgIyBpbnRlcnZhbCBvZiBjaGVja2luZyBwb2Qgc3RhdHVzLgpleHBvcnQgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPTEwMCAjIG1heCBhdHRlbXB0IHRvIGNoZWNrIHBvZCBzdGF0dXMuCmV4cG9ydCBjaGVja1BWU3RhdGVJbnRlcnZhbD01ICMgaW50ZXJ2YWwgb2YgY2hlY2tpbmcgcHZjIHN0YXR1cy4KZXhwb3J0IGNoZWNrUFZTdGF0ZU1heEF0dGVtcHQ9MTAgIyBtYXggYXR0ZW1wdCB0byBjaGVjayBwdmMgc3RhdHVzLgpleHBvcnQgY2hlY2tTVkNTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrU1ZDSW50ZXJ2YWw9MzAgI3NlY29uZHMKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c01heEF0dGVtcHQ9MTAKZXhwb3J0IGNoZWNrQUdJQ1N0YXR1c0ludGVydmFsPTMwCmV4cG9ydCBjaGVja0luZ3Jlc3NTdGF0ZU1heEF0dGVtcHQ9NTAKZXhwb3J0IGNoZWNrQWNySW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWNyTWF4QXR0ZW1wdD0xMApleHBvcnQgY2hlY2tBZ2ljSW50ZXJ2YWw9MzAKZXhwb3J0IGNoZWNrQWdpY01heEF0dGVtcHQ9NTAKCmV4cG9ydCBjb25zdEFkbWluVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0FETUlOX0FERFJFU1MiCmV4cG9ydCBjb25zdEFkbWluU2VydmVyTmFtZT0nYWRtaW4tc2VydmVyJwpleHBvcnQgY29uc3RDbHVzdGVyTmFtZT0nY2x1c3Rlci0xJwpleHBvcnQgY29uc3RDbHVzdGVyVDNBZGRyZXNzRW52TmFtZT0iVDNfVFVOTkVMSU5HX0NMVVNURVJfQUREUkVTUyIKZXhwb3J0IGNvbnN0REJUeXBlTXlTUUw9Im15c3FsIgpleHBvcnQgY29uc3REQlR5cGVTcWxTZXJ2ZXI9InNxbHNlcnZlciIKZXhwb3J0IGNvbnN0RGVmYXVsdEphdmFPcHRpb25zPSItRGxvZzRqMi5mb3JtYXRNc2dOb0xvb2t1cHM9dHJ1ZSAtRHdlYmxvZ2ljLlN0ZG91dERlYnVnRW5hYmxlZD1mYWxzZSIgIyB0aGUgamF2YSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0SlZNQXJncz0iLURqYXZhLnNlY3VyaXR5LmVnZD1maWxlOi9kZXYvLi91cmFuZG9tIC1YbXMyNTZtIC1YbXg1MTJtIC1YWDpNaW5SQU1QZXJjZW50YWdlPTI1LjAgLVhYOk1heFJBTVBlcmNlbnRhZ2U9NTAuMCAiICMgdGhlIEpWTSBvcHRpb25zIHdpbGwgYmUgYXBwbGllZCB0byB0aGUgY2x1c3RlcgpleHBvcnQgY29uc3REZWZhdWx0QUtTVmVyc2lvbj0iZGVmYXVsdCIKZXhwb3J0IGV4dGVybmFsSkRCQ0xpYnJhcmllc0RpcmVjdG9yeU5hbWU9ImV4dGVybmFsSkRCQ0xpYnJhcmllcyIKZXhwb3J0IGNvbnN0RmFsc2U9ImZhbHNlIgpleHBvcnQgY29uc3RUcnVlPSJ0cnVlIgpleHBvcnQgY29uc3RJbnRyb3NwZWN0b3JKb2JBY3RpdmVEZWFkbGluZVNlY29uZHM9MzAwICAjIGZvciBHdWFyYW50ZWVkIFFvcwpleHBvcnQgY29uc3RQb3N0Z3JlRHJpdmVyTmFtZT0icG9zdGdyZXNxbC00Mi41LjEuamFyIgpleHBvcnQgY29uc3RNU1NRTERyaXZlck5hbWU9Im1zc3FsLWpkYmMtMTAuMi4xLmpyZTguamFyIgpleHBvcnQgY29uc3RBenVyZUNvcmVWZXJzaW9uPSIxLjM0LjAiCmV4cG9ydCBjb25zdERiUG9kSWRlbnRpdHlTZWxlY3Rvcj0iZGItcG9kLWlkZW50aXR5IiAjIGRvIG5vdCBjaGFuZ2UgdGhlIHZhbHVlCmV4cG9ydCBjb25zdFByZWNsYXNzRGlyZWN0b3J5TmFtZT0icHJlY2xhc3NMaWJyYXJpZXMiCgpleHBvcnQgY3VybE1heFRpbWU9MTIwICMgc2Vjb25kcwpleHBvcnQgb2NyTG9naW5TZXJ2ZXI9ImNvbnRhaW5lci1yZWdpc3RyeS5vcmFjbGUuY29tIgpleHBvcnQgb2NyR2FJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWMiCmV4cG9ydCBvY3JDcHVJbWFnZVBhdGg9Im1pZGRsZXdhcmUvd2VibG9naWNfY3B1IgpleHBvcnQgZ2l0VXJsNENwdUltYWdlcz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvd2VibG9naWNfY3B1X2ltYWdlcy5qc29uIgpleHBvcnQgZ2l0VXJsNEFrc1dlbGxUZXN0ZWRWZXJzaW9uSnNvbkZpbGU9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9vcmFjbGUvd2VibG9naWMtYXp1cmUvbWFpbi93ZWJsb2dpYy1henVyZS1ha3Mvc3JjL21haW4vcmVzb3VyY2VzL2Frc193ZWxsX3Rlc3RlZF92ZXJzaW9uLmpzb24iCmV4cG9ydCBnaXRVcmw0V0xTVG9vbGluZ0ZhbWlseUpzb25GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy93ZWJsb2dpY190b29saW5nX2ZhbWlseS5qc29uIgpleHBvcnQgZ2l0VXJsNEF6dXJlSWRlbnRpdHlFeHRlbnNpb25zUG9tRmlsZT0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL29yYWNsZS93ZWJsb2dpYy1henVyZS9tYWluL3dlYmxvZ2ljLWF6dXJlLWFrcy9zcmMvbWFpbi9yZXNvdXJjZXMvYXp1cmUtaWRlbnRpdHktZXh0ZW5zaW9ucy54bWwiCmV4cG9ydCBnaXRVcmw0TXlTUUxEcml2ZXJQb21GaWxlPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vb3JhY2xlL3dlYmxvZ2ljLWF6dXJlL21haW4vd2VibG9naWMtYXp1cmUtYWtzL3NyYy9tYWluL3Jlc291cmNlcy9teXNxbC1jb25uZWN0b3ItamF2YS54bWwiCgpleHBvcnQgb3B0VW5pbnN0YWxsTWF4VHJ5PTUgIyBNYXggYXR0ZW1wdHMgdG8gd2FpdCBmb3IgdGhlIG9wZXJhdG9yIHVuaW5zdGFsbGVkCmV4cG9ydCBvcHRVbmluc3RhbGxJbnRlcnZhbD0xMAoKZXhwb3J0IHJldHJ5TWF4QXR0ZW1wdD01ICMgcmV0cnkgYXR0ZW1wdCBmb3IgY3VybCBjb21tYW5kCmV4cG9ydCByZXRyeUludGVydmFsPTEwCgpleHBvcnQgd2xzQ29udGFpbmVyTmFtZT0id2VibG9naWMtc2VydmVyIgpleHBvcnQgd2xzUG9zdGdyZXNxbERyaXZlclVybD0iaHR0cHM6Ly9qZGJjLnBvc3RncmVzcWwub3JnL2Rvd25sb2FkL3Bvc3RncmVzcWwtNDIuNS4xLmphciIKZXhwb3J0IHdsc01TU1FMRHJpdmVyVXJsPSJodHRwczovL3JlcG8ubWF2ZW4uYXBhY2hlLm9yZy9tYXZlbjIvY29tL21pY3Jvc29mdC9zcWxzZXJ2ZXIvbXNzcWwtamRiYy8xMC4yLjEuanJlOC9tc3NxbC1qZGJjLTEwLjIuMS5qcmU4LmphciIK",
                    "base64_enableAgic": "IyBDb3B5cmlnaHQgKGMpIDIwMjQsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCgpmdW5jdGlvbiB3YWl0X2Zvcl9henVyZV9pbmdyZXNzX3JlYWR5KCkgewogICAgYXogYWtzIGdldC1jcmVkZW50aWFscyBcCiAgICAgICAgLS1yZXNvdXJjZS1ncm91cCAke0FLU19DTFVTVEVSX1JHX05BTUV9IFwKICAgICAgICAtLW5hbWUgJHtBS1NfQ0xVU1RFUl9OQU1FfSBcCiAgICAgICAgLS1vdmVyd3JpdGUtZXhpc3RpbmcKCiAgICBsb2NhbCByZWFkeT1mYWxzZQogICAgbG9jYWwgYXR0ZW1wdD0wCgogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke2NoZWNrQWdpY01heEF0dGVtcHR9IF1dOyBkbwogICAgICAgIGVjaG9fc3Rkb3V0ICJDaGVjayBpZiBBQ0lHIGlzIHJlYWR5LCBhdHRlbXB0OiAke2F0dGVtcHR9LiIKICAgICAgICByZWFkeT10cnVlCgogICAgICAgIGxvY2FsIHJldD0kKGt1YmVjdGwgZ2V0IHBvZCAtbiBrdWJlLXN5c3RlbSB8IGdyZXAgImluZ3Jlc3MtYXBwZ3ctZGVwbG95bWVudC0qIiB8IGdyZXAgIlJ1bm5pbmciKQogICAgICAgIGlmIFsgLXogIiR7cmV0fSIgXTsgdGhlbgogICAgICAgICAgICByZWFkeT1mYWxzZQogICAgICAgIGZpCgogICAgICAgIGF0dGVtcHQ9JCgoYXR0ZW1wdCArIDEpKQogICAgICAgIHNsZWVwICR7Y2hlY2tBZ2ljSW50ZXJ2YWx9CiAgICBkb25lCgogICAgaWYgWyAke2F0dGVtcHR9IC1ndCAke2NoZWNrQWdpY01heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGVuYWJsZSBBcHBsaWNhdGlvbiBHYXRld2F5IEluZ3Jlc3MgQ29udHJvbGVyLiIKICAgICAgICBleGl0IDEKICAgIGZpCgogICAgZWNobyAiQXBwbGljYXRpb24gR2F0ZXdheSBJbmdyZXNzIENvbnRyb2xlciBpcyBydW5uaW5nLiIKfQoKIyBNYWluIHNjcmlwdApzZXQgLUVvIHBpcGVmYWlsCgppbnN0YWxsX2t1YmVjdGwKCndhaXRfZm9yX2F6dXJlX2luZ3Jlc3NfcmVhZHkK",
                    "base64_utility": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgoKZnVuY3Rpb24gZWNob19zdGRlcnIoKSB7CiAgICBlY2hvID4mMiAiJEAiCiAgICAjIFRoZSBmdW5jdGlvbiBpcyB1c2VkIGZvciBzY3JpcHRzIHJ1bm5pbmcgd2l0aGluIEF6dXJlIERlcGxveW1lbnQgU2NyaXB0CiAgICAjIFRoZSB2YWx1ZSBvZiBBWl9TQ1JJUFRTX09VVFBVVF9QQVRIIGlzIC9tbnQvYXpzY3JpcHRzL2F6c2NyaXB0b3V0cHV0CiAgICBlY2hvIC1lICIkQCIgPj4ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9lcnJvcnMubG9nCn0KCmZ1bmN0aW9uIGVjaG9fc3Rkb3V0KCkgewogICAgZWNobyAiJEAiCiAgICAjIFRoZSBmdW5jdGlvbiBpcyB1c2VkIGZvciBzY3JpcHRzIHJ1bm5pbmcgd2l0aGluIEF6dXJlIERlcGxveW1lbnQgU2NyaXB0CiAgICAjIFRoZSB2YWx1ZSBvZiBBWl9TQ1JJUFRTX09VVFBVVF9QQVRIIGlzIC9tbnQvYXpzY3JpcHRzL2F6c2NyaXB0b3V0cHV0CiAgICBlY2hvIC1lICIkQCIgPj4ke0FaX1NDUklQVFNfUEFUSF9PVVRQVVRfRElSRUNUT1JZfS9kZWJ1Zy5sb2cKfQoKI1ZhbGlkYXRlIHRlbWluYWwgc3RhdHVzIHdpdGggJD8sIGV4aXQgd2l0aCBleGNlcHRpb24gaWYgZXJyb3JzIGhhcHBlbi4KZnVuY3Rpb24gdXRpbGl0eV92YWxpZGF0ZV9zdGF0dXMoKSB7CiAgICBpZiBbICQ/ID09IDEgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICIkQCIKICAgICAgICBlY2hvX3N0ZGVyciAiRXJyb3JzIGhhcHBlbiwgZXhpdCAxLiIKICAgICAgICBleGl0IDEKICAgIGVsc2UKICAgICAgICBlY2hvX3N0ZG91dCAiJEAiCiAgICBmaQp9CgojIEpBVkFfSE9NRT0vdXNyL2xpYi9qdm0vamF2YS0xMS1vcGVuamRrCmZ1bmN0aW9uIGluc3RhbGxfamRrKCkgewogICAgbG9jYWwgcmVhZHk9ZmFsc2UKICAgIGxvY2FsIGF0dGVtcHQ9MAogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke3JldHJ5TWF4QXR0ZW1wdH0gXV07IGRvCiAgICAgICAgZWNobyAiSW5zdGFsbGluZyBvcGVuamRrMTEgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgIyBJbnN0YWxsIE1pY3Jvc29mdCBPcGVuSkRLCiAgICAgICAgYXBrIHVwZ3JhZGUKICAgICAgICBhcGsgYWRkIG9wZW5qZGsxMSBcCiAgICAgICAgICAgIC0tbm8tY2FjaGUgXAogICAgICAgICAgICAtcSAtLXJlcG9zaXRvcnk9aHR0cDovL2RsLWNkbi5hbHBpbmVsaW51eC5vcmcvYWxwaW5lL2VkZ2UvY29tbXVuaXR5CgogICAgICAgIGVjaG8gImphdmEgdmVyc2lvbiIKICAgICAgICBqYXZhIC12ZXJzaW9uCiAgICAgICAgaWYgWyAkPyAtZXEgMSBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5PWZhbHNlCiAgICAgICAgZmkKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtyZXRyeUludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtyZXRyeU1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGluc3RhbGwgb3BlbmpkazExLiIKICAgICAgICBleGl0IDEKICAgIGZpCn0KCmZ1bmN0aW9uIGluc3RhbGxfZG9ja2VyKCkgewogICAgbG9jYWwgcmVhZHk9ZmFsc2UKICAgIGxvY2FsIGF0dGVtcHQ9MAogICAgd2hpbGUgW1sgIiR7cmVhZHl9IiA9PSAiZmFsc2UiICYmICRhdHRlbXB0IC1sZSAke3JldHJ5TWF4QXR0ZW1wdH0gXV07IGRvCiAgICAgICAgZWNobyAiSW5zdGFsbGluZyBkb2NrZXIgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgYXBrIGFkZCBkb2NrZXIgLS1uby1jYWNoZSAtLXF1aWV0CiAgICAgICAgZG9ja2VyIC0taGVscAogICAgICAgIGlmIFsgJD8gLWVxIDEgXTsgdGhlbgogICAgICAgICAgICByZWFkeT1mYWxzZQogICAgICAgIGZpCgogICAgICAgIGF0dGVtcHQ9JCgoYXR0ZW1wdCArIDEpKQogICAgICAgIHNsZWVwICR7cmV0cnlJbnRlcnZhbH0KICAgIGRvbmUKCiAgICBpZiBbICR7YXR0ZW1wdH0gLWd0ICR7cmV0cnlNYXhBdHRlbXB0fSBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBpbnN0YWxsIGRvY2tlci4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgpmdW5jdGlvbiBpbnN0YWxsX2t1YmVjdGwoKSB7CiAgICBsb2NhbCByZWFkeT1mYWxzZQogICAgbG9jYWwgYXR0ZW1wdD0wCiAgICB3aGlsZSBbWyAiJHtyZWFkeX0iID09ICJmYWxzZSIgJiYgJGF0dGVtcHQgLWxlICR7cmV0cnlNYXhBdHRlbXB0fSBdXTsgZG8KICAgICAgICBlY2hvICJJbnN0YWxsaW5nIGt1YmVjdGwgJHthdHRlbXB0fSIKICAgICAgICByZWFkeT10cnVlCiAgICAgICAgIyBJbnN0YWxsIGt1YmVjdGwKICAgICAgICBheiBha3MgaW5zdGFsbC1jbGkKICAgICAgICBlY2hvICJ2YWxpZGF0ZSBrdWJlY3RsIgogICAgICAgIGt1YmVjdGwgLS1oZWxwCiAgICAgICAgaWYgWyAkPyAtZXEgMSBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5PWZhbHNlCiAgICAgICAgZmkKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtyZXRyeUludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtyZXRyeU1heEF0dGVtcHR9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGluc3RhbGwga3ViZWN0bC4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgpmdW5jdGlvbiBpbnN0YWxsX2hlbG0oKSB7CiAgICAjIEluc3RhbGwgSGVsbQogICAgYnJvd3NlclVSTD0kKGN1cmwgLW0gJHtjdXJsTWF4VGltZX0gLS1yZXRyeSAke3JldHJ5TWF4QXR0ZW1wdH0gLXMgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9oZWxtL2hlbG0vcmVsZWFzZXMvbGF0ZXN0IHwKICAgICAgICBncmVwICJicm93c2VyX2Rvd25sb2FkX3VybC4qbGludXgtYW1kNjQudGFyLmd6LmFzYyIgfAogICAgICAgIGN1dCAtZCA6IC1mIDIsMyB8CiAgICAgICAgdHIgLWQgXCIpCiAgICBoZWxtTGF0ZXN0VmVyc2lvbj0ke2Jyb3dzZXJVUkwjKmRvd25sb2FkXC99CiAgICBoZWxtTGF0ZXN0VmVyc2lvbj0ke2hlbG1MYXRlc3RWZXJzaW9uJSVcL2hlbG0qfQogICAgaGVsbVBhY2thZ2VOYW1lPWhlbG0tJHtoZWxtTGF0ZXN0VmVyc2lvbn0tbGludXgtYW1kNjQudGFyLmd6CiAgICBjdXJsIC1tICR7Y3VybE1heFRpbWV9IC0tcmV0cnkgJHtyZXRyeU1heEF0dGVtcHR9IC1mTCBodHRwczovL2dldC5oZWxtLnNoLyR7aGVsbVBhY2thZ2VOYW1lfSAtbyAvdG1wLyR7aGVsbVBhY2thZ2VOYW1lfQogICAgdGFyIC16eHZmIC90bXAvJHtoZWxtUGFja2FnZU5hbWV9IC1DIC90bXAKICAgIG12IC90bXAvbGludXgtYW1kNjQvaGVsbSAvdXNyL2xvY2FsL2Jpbi9oZWxtCiAgICBlY2hvICJIZWxtIHZlcnNpb24iCiAgICBoZWxtIHZlcnNpb24KICAgIHV0aWxpdHlfdmFsaWRhdGVfc3RhdHVzICJGaW5pc2hlZCBpbnN0YWxsaW5nIEhlbG0uIgp9CgojIFF1ZXJ5IHNlcnZpY2UgcG9ydAojICQxOiBzZXJ2aWNlIG5hbWUKIyAkMjogbmFtZXNwYWNlCiMgJDM6IGNoYW5uZWwgbmFtZQojIHJldHVybjogcG9ydAojIE5vdGVzOiBjaGFubmVsIG5hbWUgd2lsbCBiZSBkaWZmZXJlbnQgaWYgaXN0aW8gaXMgZW5hYmxlZC4KZnVuY3Rpb24gdXRpbGl0eV9xdWVyeV9zZXJ2aWNlX3BvcnQoKSB7CiAgICBsb2NhbCBwb3J0PSQoa3ViZWN0bCBnZXQgc2VydmljZSAkezF9IC1uICR7Mn0gLW8ganNvbiB8CiAgICAgICAganEgIi5zcGVjLnBvcnRzW10gfCBzZWxlY3QoLm5hbWU9PVwiJHszfVwiKSB8IC5wb3J0IikKICAgIGlmIFsgJD8gIT0gMCBdIHx8IFtbICIkcG9ydCIgPT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBxdWVyeSBwb3J0IG9mICR7MX0vJHszfSBpbiBuYW1lc3BhY2UgJHsyfSIKICAgICAgICBleGl0IDEKICAgIGZpCgogICAgZWNobyAkcG9ydAp9CgojCiMgQ2hlY2sgdGhlIHN0YXRlIG9mIGEgcGVyc2lzdGVudCB2b2x1bWUuCiMgTGV2ZXJhZ2Ugc291cmNlIGNvZGUgZnJvbSBmdW5jdGlvbiAiY2hlY2tQdlN0YXRlIiBpbiB3ZWJsb2dpYy1vcGVyYXRvciwga3ViZXJuZXRlc1xzYW1wbGVzXHNjcmlwdHNcY29tbW9uXHV0aWxpdHkuc2gKIyAkMSAtIG5hbWUgb2Ygdm9sdW1lCiMgJDIgLSBleHBlY3RlZCBzdGF0ZSBvZiB2b2x1bWUKIyAkMyAtIG1heCBhdHRlbXB0CiMgJDQgLSBpbnRlcnZhbApmdW5jdGlvbiB1dGlsaXR5X2NoZWNrX3B2X3N0YXRlIHsKCiAgICBlY2hvX3N0ZG91dCAiQ2hlY2tpbmcgaWYgdGhlIHBlcnNpc3RlbnQgdm9sdW1lICR7MTo/fSBpcyAkezI6P30iCiAgICBsb2NhbCBwdl9zdGF0ZT0kKGt1YmVjdGwgZ2V0IHB2ICQxIC1vIGpzb25wYXRoPSd7LnN0YXR1cy5waGFzZX0nKQogICAgYXR0ZW1wdHM9MAogICAgd2hpbGUgWyAhICIkcHZfc3RhdGUiID0gIiQyIiBdICYmIFsgISAkYXR0ZW1wdHMgLWVxICQzIF07IGRvCiAgICAgICAgYXR0ZW1wdHM9JCgoYXR0ZW1wdHMgKyAxKSkKICAgICAgICBzbGVlcCAkNAogICAgICAgIHB2X3N0YXRlPSQoa3ViZWN0bCBnZXQgcHYgJDEgLW8ganNvbnBhdGg9J3suc3RhdHVzLnBoYXNlfScpCiAgICBkb25lCiAgICBpZiBbICIkcHZfc3RhdGUiICE9ICIkMiIgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICJUaGUgcGVyc2lzdGVudCB2b2x1bWUgc3RhdGUgc2hvdWxkIGJlICQyIGJ1dCBpcyAkcHZfc3RhdGUiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojCiMgQ3JlYXRlIGRpcmVjdG9yeSBpbiBzcGVjaWZpZWQgZmlsZSBzaGFyZQojICQxIC0gbmFtZSBvZiBkaXJlY3RvcnkKIyAkMiAtIG5hbWUgb2YgZmlsZSBzaGFyZQojICQzIC0gbmFtZSBvZiBzdG9yYWdlIGFjY291bnQKIyAkNCAtIHNhcyB0b2tlbgpmdW5jdGlvbiB1dGlsaXR5X2NyZWF0ZV9kaXJlY3RvcnlfdG9fZmlsZXNoYXJlKCkgewogICAgcmV0PSQoYXogc3RvcmFnZSBkaXJlY3RvcnkgZXhpc3RzIC0tbmFtZSAkMSAtLXNoYXJlLW5hbWUgJDIgLS1hY2NvdW50LW5hbWUgJDMgLS1zYXMtdG9rZW4gJHs0fSB8IGpxICcuZXhpc3RzJykKICAgIGlmIFtbICIke3JldCwsfSIgPT0gImZhbHNlIiBdXTsgdGhlbgogICAgICAgIGF6IHN0b3JhZ2UgZGlyZWN0b3J5IGNyZWF0ZSAtLW5hbWUgJDEgLS1zaGFyZS1uYW1lICQyIC0tYWNjb3VudC1uYW1lICQzIC0tc2FzLXRva2VuICR7NH0gLS10aW1lb3V0IDMwCiAgICBmaQoKICAgIGlmIFsgJD8gIT0gMCBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBjcmVhdGUgZGlyZWN0b3J5ICR7MX0gaW4gZmlsZSBzaGFyZSAkezN9LyR7Mn0iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojCiMgVXBsb2FkIGZpbGUgdG8gZmlsZSBzaGFyZQojICQxIC0gbmFtZSBvZiBmaWxlIHNoYXJlCiMgJDIgLSBuYW1lIG9mIHN0b3JhZ2UgYWNjb3VudAojICQzIC0gcGF0aCBvZiBmaWxlCiMgJDQgLSBzb3VyY2UgcGF0aCBvZiBmaWxlCiMgJDUgLSBzYXMgdG9rZW4KZnVuY3Rpb24gdXRpbGl0eV91cGxvYWRfZmlsZV90b19maWxlc2hhcmUoKSB7CiAgICBheiBzdG9yYWdlIGZpbGUgdXBsb2FkIC0tc2hhcmUtbmFtZSAkezF9IC0tYWNjb3VudC1uYW1lICR7Mn0gLS1wYXRoICR7M30gLS1zb3VyY2UgJHs0fSAtLXNhcy10b2tlbiAkezV9IC0tdGltZW91dCA2MAogICAgaWYgWyAkPyAhPSAwIF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHVwbG9hZCAkezN9IHRvIGZpbGUgc2hhcmUgJHsyfS8kezF9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQoKIwojIE1ha2Ugc3VyZSBhbGwgdGhlIGFwcGxpY2F0aW9ucyBhcmUgcnVubmluZwojIEV4aXQgd2l0aCBlcnJvciBpZiB0aGVyZSBpcyBpbmFjdGl2ZSBhcHBsaWNhdGlvbi4KIyAkMSAtIG5hbWVzcGFjZSBvZiB0aGUgZG9tYWluCiMgJDIgLSBDbHVzdGVySVAgc2VydmljZSBuYW1lIG9mIGFkbWluIHNlcnZlcgojICQzIC0gZG9tYWluIHVzZXIKIyAkNCAtIGRvbWFpbiBwYXNzd29yZAojICQ1IC0gcGF0aCBvZiBweXRob24gc2NyaXB0IHdoaWNoIGNoZWNrcyBhcHBsaWNhdGlvbiBzdGF0dXMsIHRoZSBzY3JpcHQgd2lsbCBydW4gb24gYWRtaW4gc2VydmVyIHBvZC4KZnVuY3Rpb24gdXRpbGl0eV92YWxpZGF0ZV9hcHBsaWNhdGlvbl9zdGF0dXMoKSB7CiAgICBsb2NhbCB3bHNEb21haW5OUz0kMQogICAgbG9jYWwgd2xzQWRtaW5TdmNOYW1lPSQyCiAgICBsb2NhbCB3bHNVc2VyPSQzCiAgICBsb2NhbCB3bHNQYXNzd29yZD0kNAogICAgbG9jYWwgcHlTY3JpcHRQYXRoPSQ1CgogICAgbG9jYWwgcG9kTmFtZT0kKGt1YmVjdGwgLW4gJHt3bHNEb21haW5OU30gZ2V0IHBvZCAtbCB3ZWJsb2dpYy5zZXJ2ZXJOYW1lPWFkbWluLXNlcnZlciAtbyBqc29uIHwKICAgICAgICBqcSAnLml0ZW1zWzBdIHwgLm1ldGFkYXRhLm5hbWUnIHwKICAgICAgICB0ciAtZCAiXCIiKQoKICAgICMgZ2V0IG5vbi1zc2wgcG9ydAogICAgbG9jYWwgYWRtaW5UYXJnZXRQb3J0PSQoa3ViZWN0bCBnZXQgc3ZjICR7d2xzQWRtaW5TdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwganEgJy5zcGVjLnBvcnRzW10gfCBzZWxlY3QoLm5hbWU9PSJpbnRlcm5hbC10MyIpIHwgLnBvcnQnKQogICAgbG9jYWwgdDNDaGFubmVsQWRkcmVzcz0iJHtwb2ROYW1lfS4ke3dsc0RvbWFpbk5TfSIKCiAgICBsb2NhbCB0YXJnZXRGaWxlUGF0aD0vdG1wL2NoZWNrQXBwbGljYXRpb25TdGF0dXMucHkKICAgIGVjaG8gImNvcHkgJHtweVNjcmlwdFBhdGh9IHRvICR7dGFyZ2V0RmlsZVBhdGh9IgogICAga3ViZWN0bCBjcCAke3B5U2NyaXB0UGF0aH0gLW4gJHt3bHNEb21haW5OU30gJHtwb2ROYW1lfToke3RhcmdldEZpbGVQYXRofQogICAga3ViZWN0bCBleGVjIC1pdCAke3BvZE5hbWV9IC1uICR7d2xzRG9tYWluTlN9IC1jICJ3ZWJsb2dpYy1zZXJ2ZXIiIFwKICAgICAgICAtLSBiYXNoIC1jICJ3bHN0LnNoICR7dGFyZ2V0RmlsZVBhdGh9IC11c2VyICR7d2xzVXNlcn0gLXBhc3N3b3JkICR7d2xzUGFzc3dvcmR9IC10M0NoYW5uZWxBZGRyZXNzICR7dDNDaGFubmVsQWRkcmVzc30gLXQzQ2hhbm5lbFBvcnQgJHthZG1pblRhcmdldFBvcnR9IiB8CiAgICAgICAgZ3JlcCAiU3VtbWFyeTogYWxsIGFwcGxpY2F0aW9ucyBhcmUgYWN0aXZlIgoKICAgIGlmIFsgJD8gPT0gMSBdOyB0aGVuCiAgICAgICAgZWNob19zdGRlcnIgIkZhaWxlZCB0byBkZXBsb3kgYXBwbGljYXRpb24gdG8gV0xTIGNsdXN0ZXIuIFBsZWFzZSBtYWtlIHN1cmUgdGhlIGNvbmZpZ3VyYXRpb25zIGFyZSBjb3JyZWN0LiIKICAgICAgICBleGl0IDEKICAgIGZpCn0KCiMgQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIG1ha2Ugc3VyZSBwb2RzIG9mIGEgZG9tYWluIGFyZSBydW5uaW5nLgojICAgKiBNYWtlIHN1cmUgdGhlIGFkbWluIHNlcnZlciBwb2QgaXMgcnVubmluZwojICAgKiBNYWtlIHN1cmUgYWxsIHRoZSBtYW5hZ2VkIHNlcnZlciBwb2RzIGFyZSBydW5uaW5nCiMgQXNzdW1pbmcgdGhlcmUgaXMgb25seSBvbmUgY2x1c3RlciBpbiB0aGUgZG9tYWluCiMgUGFyYW1ldGVyczoKIyAgICogYXBwUmVwbGljYXM6IHJlcGxpY2FzIG9mIHRoZSBtYW5hZ2VkIHNlcnZlcgojICAgKiB3bHNEb21haW5OUzogbmFtZSBzcGFjZQojICAgKiBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM6IG1heCBhdHRlbXB0cyB0byBxdWVyeSB0aGUgcG9kcyBzdGF0dXMgaWYgdGhleSBhcmUgbm90IGFsbCBydW5uaW5nLgojICAgKiBjaGVja1BvZFN0YXR1c0ludGVydmFsOiBpbnRlcnZhbCBvZiBxdWVyeSB0aGUgcG9kcyBzdGF0dXMKZnVuY3Rpb24gdXRpbGl0eV93YWl0X2Zvcl9wb2RfY29tcGxldGVkKCkgewogICAgYXBwUmVwbGljYXM9JDEKICAgIHdsc0RvbWFpbk5TPSQyCiAgICBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM9JDMKICAgIGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw9JDQKCiAgICBlY2hvICJXYWl0aW5nIGZvciAkKChhcHBSZXBsaWNhcyArIDEpKSBwb2RzIGFyZSBydW5uaW5nLiIKCiAgICByZWFkeVBvZE51bT0wCiAgICBhdHRlbXB0PTAKICAgIHdoaWxlIFtbICR7cmVhZHlQb2ROdW19IC1sZSAke2FwcFJlcGxpY2FzfSAmJiAkYXR0ZW1wdCAtbGUgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF1dOyBkbwogICAgICAgIHJldD0kKGt1YmVjdGwgZ2V0IHBvZHMgLW4gJHt3bHNEb21haW5OU30gLW8ganNvbiB8CiAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zdGF0dXMucGhhc2UnIHwKICAgICAgICAgICAgZ3JlcCAiUnVubmluZyIpCiAgICAgICAgaWYgWyAteiAiJHtyZXR9IiBdOyB0aGVuCiAgICAgICAgICAgIHJlYWR5UG9kTnVtPTAKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlYWR5UG9kTnVtPSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zdGF0dXMucGhhc2UnIHwKICAgICAgICAgICAgICAgIGdyZXAgLWMgIlJ1bm5pbmciKQogICAgICAgIGZpCiAgICAgICAgZWNobyAiTnVtYmVyIG9mIG5ldyBydW5uaW5nIHBvZDogJHtyZWFkeVBvZE51bX0iCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiSXQgdGFrZXMgdG9vIGxvbmcgdG8gd2FpdCBmb3IgYWxsIHRoZSBwb2RzIHRvIHJlYWNoIHJ1bm5pbmcgc3RhdGUsIHBsZWFzZSByZWZlciB0byBodHRwczovL2FrYS5tcy93bHMtYWtzLXRyb3VibGVzaG9vdGluZy4iCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgcG9kcyBvZiBhIGRvbWFpbiBhcmUgdXBkYXRlZCB3aXRoIGV4cGVjdGVkIGltYWdlLgojICAgKiBNYWtlIHN1cmUgdGhlIGFkbWluIHNlcnZlciBwb2QgaXMgdXBkYXRlZCB3aXRoIGV4cGVjdGVkIGltYWdlCiMgICAqIE1ha2Ugc3VyZSBhbGwgdGhlIG1hbmFnZWQgc2VydmVyIHBvZHMgYXJlIHVwZGF0ZWQgd2l0aCBleHBlY3RlZCBpbWFnZQojIEFzc3VtaW5nIHRoZXJlIGlzIG9ubHkgb25lIGNsdXN0ZXIgaW4gdGhlIGRvbWFpbgojIFBhcmFtZXRlcnM6CiMgICAqIGFjckltYWdlUGF0aDogaW1hZ2UgcGF0aAojICAgKiBhcHBSZXBsaWNhczogcmVwbGljYXMgb2YgdGhlIG1hbmFnZWQgc2VydmVyCiMgICAqIHdsc0RvbWFpbk5TOiBuYW1lIHNwYWNlCiMgICAqIGNoZWNrUG9kU3RhdHVzTWF4QXR0ZW1wczogbWF4IGF0dGVtcHRzIHRvIHF1ZXJ5IHRoZSBwb2RzIHN0YXR1cyBpZiB0aGV5IGFyZSBub3QgYWxsIHJ1bm5pbmcuCiMgICAqIGNoZWNrUG9kU3RhdHVzSW50ZXJ2YWw6IGludGVydmFsIG9mIHF1ZXJ5IHRoZSBwb2RzIHN0YXR1cwpmdW5jdGlvbiB1dGlsaXR5X3dhaXRfZm9yX2ltYWdlX3VwZGF0ZV9jb21wbGV0ZWQoKSB7CiAgICAjIE1ha2Ugc3VyZSBhbGwgb2YgdGhlIHBvZHMgYXJlIHVwZGF0ZWQgd2l0aCBuZXcgaW1hZ2UuCiAgICAjIEFzc3VtcHRpb246IHdlIGhhdmUgb25seSBvbmUgY2x1c3RlciBjdXJyZW50bHkuCiAgICBhY3JJbWFnZVBhdGg9JDEKICAgIGFwcFJlcGxpY2FzPSQyCiAgICB3bHNEb21haW5OUz0kMwogICAgY2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzPSQ0CiAgICBjaGVja1BvZFN0YXR1c0ludGVydmFsPSQ1CgogICAgZWNobyAiV2FpdGluZyBmb3IgJCgoYXBwUmVwbGljYXMgKyAxKSkgbmV3IHBvZHMgY3JlYXRlZCB3aXRoIGltYWdlICR7YWNySW1hZ2VQYXRofSIKCiAgICB1cGRhdGVkUG9kTnVtPTAKICAgIGF0dGVtcHQ9MAogICAgd2hpbGUgWyAke3VwZGF0ZWRQb2ROdW19IC1sZSAke2FwcFJlcGxpY2FzfSBdICYmIFsgJGF0dGVtcHQgLWxlICR7Y2hlY2tQb2RTdGF0dXNNYXhBdHRlbXBzfSBdOyBkbwogICAgICAgIGVjaG8gImF0dGVtcHRzICR7YXR0ZW1wdH0iCiAgICAgICAgcmV0PSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5pdGVtc1tdIHwgLnNwZWMgfCAuY29udGFpbmVyc1tdIHwgc2VsZWN0KC5uYW1lID09ICJ3ZWJsb2dpYy1zZXJ2ZXIiKSB8IC5pbWFnZScgfAogICAgICAgICAgICBncmVwICIke2FjckltYWdlUGF0aH0iKQoKICAgICAgICBpZiBbIC16ICIke3JldH0iIF07IHRoZW4KICAgICAgICAgICAgdXBkYXRlZFBvZE51bT0wCiAgICAgICAgZWxzZQogICAgICAgICAgICB1cGRhdGVkUG9kTnVtPSQoa3ViZWN0bCBnZXQgcG9kcyAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5zcGVjIHwgLmNvbnRhaW5lcnNbXSB8IHNlbGVjdCgubmFtZSA9PSAid2VibG9naWMtc2VydmVyIikgfCAuaW1hZ2UnIHwKICAgICAgICAgICAgICAgIGdyZXAgLWMgIiR7YWNySW1hZ2VQYXRofSIpCiAgICAgICAgZmkKICAgICAgICBlY2hvICJOdW1iZXIgb2YgbmV3IHBvZDogJHt1cGRhdGVkUG9kTnVtfSIKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHVwZGF0ZSBpbWFnZSAke2FjckltYWdlUGF0aH0gdG8gYWxsIHdlYmxvZ2ljIHNlcnZlciBwb2RzLiAiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgcG9kcyBvZiBhIGRvbWFpbiBhcmUgcmVzdGFydGVkLgojIEFzc3VtaW5nIHRoZXJlIGlzIG9ubHkgb25lIGNsdXN0ZXIgaW4gdGhlIGRvbWFpbgojIFBhcmFtZXRlcnM6CiMgICAqIGJhc2VUaW1lOiB0aW1lIHN0YW1wIHRoYXQgc2hvdWxkIGJlIGVhcmxpZXIgdGhlbiBwb2QgcmVzdGFydHMKIyAgICogYXBwUmVwbGljYXM6IHJlcGxpY2FzIG9mIHRoZSBtYW5hZ2VkIHNlcnZlcgojICAgKiB3bHNEb21haW5OUzogbmFtZSBzcGFjZQojICAgKiBjaGVja1BvZFN0YXR1c01heEF0dGVtcHM6IG1heCBhdHRlbXB0cyB0byBxdWVyeSB0aGUgcG9kcyBzdGF0dXMgaWYgdGhleSBhcmUgbm90IGFsbCBydW5uaW5nLgojICAgKiBjaGVja1BvZFN0YXR1c0ludGVydmFsOiBpbnRlcnZhbCBvZiBxdWVyeSB0aGUgcG9kcyBzdGF0dXMKZnVuY3Rpb24gdXRpbGl0eV93YWl0X2Zvcl9wb2RfcmVzdGFydGVkKCkgewogICAgYmFzZVRpbWU9JDEKICAgIGFwcFJlcGxpY2FzPSQyCiAgICB3bHNEb21haW5VSUQ9JDMKICAgIGNoZWNrUG9kU3RhdHVzTWF4QXR0ZW1wcz0kNAogICAgY2hlY2tQb2RTdGF0dXNJbnRlcnZhbD0kNQoKICAgIHdsc0RvbWFpbk5TPSR7d2xzRG9tYWluVUlEfS1ucwoKICAgIHVwZGF0ZWRQb2ROdW09MAogICAgYXR0ZW1wdD0wCiAgICB3aGlsZSBbICR7dXBkYXRlZFBvZE51bX0gLWxlICR7YXBwUmVwbGljYXN9IF0gJiYgWyAkYXR0ZW1wdCAtbGUgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IGRvCiAgICAgICAgZWNobyAiYXR0ZW1wdHMgJHthdHRlbXB0fSIKICAgICAgICByZXQ9JChrdWJlY3RsIGdldCBwb2RzIC1uICR7d2xzRG9tYWluTlN9IC1sIHdlYmxvZ2ljLmRvbWFpblVJRD0ke3dsc0RvbWFpblVJRH0gLW8ganNvbiB8CiAgICAgICAgICAgIGpxICcuaXRlbXNbXSB8IC5tZXRhZGF0YS5jcmVhdGlvblRpbWVzdGFtcCcgfCB0ciAtZCAiXCIiKQoKICAgICAgICBjb3VudGVyPTAKICAgICAgICBmb3IgaXRlbSBpbiAkcmV0OyBkbwogICAgICAgICAgICAjIGNvbnZlciB0aGUgdGltZSBmb3JtYXQgZnJvbSBZWVlZLU1NLUREVGhoOm1tOnNzWiB0byBZWVlZLk1NLkRELWhoOm1tOnNzCiAgICAgICAgICAgIGFscGluZUl0ZW09JChlY2hvICIke2l0ZW19IiB8IHNlZCAtZSAicy8tLy4vZztzL1QvLS9nO3MvWi8vZyIpCiAgICAgICAgICAgIHBvZENyZWF0ZVRpbWVTdGFtcD0kKGRhdGUgLXUgLWQgIiR7YWxwaW5lSXRlbX0iICsiJXMiKQogICAgICAgICAgICBlY2hvICJwb2QgY3JlYXRlIHRpbWU6ICRwb2RDcmVhdGVUaW1lU3RhbXAsIGJhc2UgdGltZTogJHtiYXNlVGltZX0iCiAgICAgICAgICAgIGlmIFsgJHtwb2RDcmVhdGVUaW1lU3RhbXB9IC1ndCAke2Jhc2VUaW1lfSBdOyB0aGVuCiAgICAgICAgICAgICAgICBjb3VudGVyPSQoKGNvdW50ZXIgKyAxKSkKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCgogICAgICAgIHVwZGF0ZWRQb2ROdW09JGNvdW50ZXIKICAgICAgICBlY2hvICJOdW1iZXIgb2YgbmV3IHBvZDogJHt1cGRhdGVkUG9kTnVtfSIKCiAgICAgICAgYXR0ZW1wdD0kKChhdHRlbXB0ICsgMSkpCiAgICAgICAgc2xlZXAgJHtjaGVja1BvZFN0YXR1c0ludGVydmFsfQogICAgZG9uZQoKICAgIGlmIFsgJHthdHRlbXB0fSAtZ3QgJHtjaGVja1BvZFN0YXR1c01heEF0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIHJlc3RhcnQgYWxsIHdlYmxvZ2ljIHNlcnZlciBwb2RzLiAiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojIENhbGwgdGhpcyBmdW5jdGlvbiB0byBtYWtlIHN1cmUgdGhlIGxiIHNlcnZpY2UgaXMgYXZhbGlhYmxlLgpmdW5jdGlvbiB1dGlsaXR5X3dhaXRmb3JfbGJfc3ZjX2NvbXBsZXRlZCgpIHsKICAgIHN2Y05hbWU9JDEKICAgIHdsc0RvbWFpbk5TPSQyCiAgICBwZXJmU1ZDQXR0ZW1wcz0kMwogICAgcGVyZlJldHJ5SW50ZXJ2YWw9JDQKCiAgICBhdHRlbXB0cz0wCiAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgIHdoaWxlIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWx0ICR7cGVyZlNWQ0F0dGVtcHN9IF07IGRvCiAgICAgICAgc3ZjU3RhdGU9ImNvbXBsZXRlZCIKICAgICAgICBhdHRlbXB0cz0kKChhdHRlbXB0cyArIDEpKQogICAgICAgIGVjaG8gV2FpdGluZyBmb3Igam9iIGNvbXBsZXRlZC4uLiR7YXR0ZW1wdHN9CiAgICAgICAgc2xlZXAgJHtwZXJmUmV0cnlJbnRlcnZhbH0KCiAgICAgICAgaXA9JChrdWJlY3RsIGdldCBzdmMgJHtzdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5zdGF0dXMubG9hZEJhbGFuY2VyLmluZ3Jlc3NbMF0uaXAnKQogICAgICAgIGVjaG8gImlwOiAke2lwfSIKICAgICAgICBpZiBbWyAiJHtpcH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgICAgICBmaQogICAgZG9uZQoKICAgIGlmIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWdlICR7cGVyZlNWQ0F0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGNyZWF0ZSBzZXJ2aWNlOiAke3N2Y05hbWV9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQoKIyBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gbWFrZSBzdXJlIHRoZSBpbmdyZXNzIGlzIGF2YWxpYWJsZS4KZnVuY3Rpb24gdXRpbGl0eV93YWl0Zm9yX2luZ3Jlc3NfY29tcGxldGVkKCkgewogICAgc3ZjTmFtZT0kMQogICAgd2xzRG9tYWluTlM9JDIKICAgIHBlcmZTVkNBdHRlbXBzPSQzCiAgICBwZXJmUmV0cnlJbnRlcnZhbD0kNAoKICAgIGF0dGVtcHRzPTAKICAgIHN2Y1N0YXRlPSJydW5uaW5nIgogICAgd2hpbGUgWyAiJHN2Y1N0YXRlIiA9PSAicnVubmluZyIgXSAmJiBbICRhdHRlbXB0cyAtbHQgJHtwZXJmU1ZDQXR0ZW1wc30gXTsgZG8KICAgICAgICBzdmNTdGF0ZT0iY29tcGxldGVkIgogICAgICAgIGF0dGVtcHRzPSQoKGF0dGVtcHRzICsgMSkpCiAgICAgICAgZWNobyBXYWl0aW5nIGZvciBqb2IgY29tcGxldGVkLi4uJHthdHRlbXB0c30KICAgICAgICBzbGVlcCAke3BlcmZSZXRyeUludGVydmFsfQoKICAgICAgICBpcD0kKGt1YmVjdGwgZ2V0IGluZ3Jlc3MgJHtzdmNOYW1lfSAtbiAke3dsc0RvbWFpbk5TfSAtbyBqc29uIHwKICAgICAgICAgICAganEgJy5zdGF0dXMubG9hZEJhbGFuY2VyLmluZ3Jlc3NbMF0uaXAnKQogICAgICAgIGVjaG8gImlwOiAke2lwfSIKICAgICAgICBpZiBbWyAiJHtpcH0iID09ICJudWxsIiBdXTsgdGhlbgogICAgICAgICAgICBzdmNTdGF0ZT0icnVubmluZyIKICAgICAgICBmaQogICAgZG9uZQoKICAgIGlmIFsgIiRzdmNTdGF0ZSIgPT0gInJ1bm5pbmciIF0gJiYgWyAkYXR0ZW1wdHMgLWdlICR7cGVyZlNWQ0F0dGVtcHN9IF07IHRoZW4KICAgICAgICBlY2hvX3N0ZGVyciAiRmFpbGVkIHRvIGNyZWF0ZSBzZXJ2aWNlOiAke3N2Y05hbWV9IgogICAgICAgIGV4aXQgMQogICAgZmkKfQo=",
                    "const_deploymentName": "ds-validate-agic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[variables('const_deploymentName')]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "scriptContent": "[format('{0}\r\n\r\n{1}\r\n\r\n{2}', base64ToString(variables('base64_common')), base64ToString(variables('base64_utility')), base64ToString(variables('base64_enableAgic')))]",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_RG_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "CURRENT_RG_NAME",
                            "value": "[resourceGroup().name]"
                          }
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'allow-agic-access-current-resource-group')]"
              ]
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "ds-networking-deployment-yes-appgw",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "appgwName": {
                    "value": "[parameters('appGatewayName')]"
                  },
                  "appgwAlias": {
                    "value": "[parameters('appGatewayAlias')]"
                  },
                  "appgwForAdminServer": {
                    "value": "[parameters('appgwForAdminServer')]"
                  },
                  "appgwForRemoteConsole": {
                    "value": "[parameters('appgwForRemoteConsole')]"
                  },
                  "appgwSslCert": {
                    "value": "[parameters('appGatewaySslCert')]"
                  },
                  "appgwTrustedRootCert": {
                    "value": "[parameters('appGatewayTrustedRootCert')]"
                  },
                  "appgwUsePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "createAKSCluster": {
                    "value": "[parameters('createAKSCluster')]"
                  },
                  "dnszoneAdminConsoleLabel": {
                    "value": "[parameters('dnszoneAdminConsoleLabel')]"
                  },
                  "dnszoneAdminT3ChannelLabel": {
                    "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                  },
                  "dnszoneClusterLabel": {
                    "value": "[parameters('dnszoneClusterLabel')]"
                  },
                  "dnszoneClusterT3ChannelLabel": {
                    "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                  },
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  },
                  "dnszoneRGName": {
                    "value": "[if(parameters('createDNSZone'), resourceGroup().name, parameters('dnszoneRGName'))]"
                  },
                  "enableAppGWIngress": {
                    "value": "[parameters('enableAppGWIngress')]"
                  },
                  "enableCookieBasedAffinity": {
                    "value": "[parameters('enableCookieBasedAffinity')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableDNSConfiguration": {
                    "value": "[parameters('enableDNSConfiguration')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "lbSvcValues": {
                    "value": "[parameters('lbSvcValues')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "useInternalLB": {
                    "value": "[parameters('useInternalLB')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1990448863142664793"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "appgwAlias": {
                      "type": "string",
                      "defaultValue": "appgw-contoso-alias"
                    },
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "appgwForAdminServer": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Three scenarios we support for deploying app gateway"
                      }
                    },
                    "appgwForRemoteConsole": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwSslCert": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appgwTrustedRootCert": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appgwUsePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": "aks-contoso-rg"
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": "aks-contoso"
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "createAKSCluster": {
                      "type": "bool"
                    },
                    "dnszoneAdminConsoleLabel": {
                      "type": "string",
                      "defaultValue": "admin"
                    },
                    "dnszoneAdminT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "admin-t3"
                    },
                    "dnszoneClusterLabel": {
                      "type": "string",
                      "defaultValue": "www"
                    },
                    "dnszoneClusterT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "cluster-t3"
                    },
                    "dnszoneName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz"
                    },
                    "dnszoneRGName": {
                      "type": "string",
                      "defaultValue": "dns-contoso-rg"
                    },
                    "enableAppGWIngress": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCookieBasedAffinity": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableDNSConfiguration": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "lbSvcValues": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "location": {
                      "type": "string"
                    },
                    "useInternalLB": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    }
                  },
                  "variables": {
                    "const_commonScript": "common.sh",
                    "const_createDnsRecordScript": "createDnsRecord.sh",
                    "const_createLbSvcScript": "createLbSvc.sh",
                    "const_createGatewayIngressSvcScript": "createAppGatewayIngress.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_primaryScript": "setupNetworking.sh",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-networking-deployment",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_RG_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "APPGW_SSL_CERT_NAME",
                            "value": "[parameters('appgwSslCert')]"
                          },
                          {
                            "name": "APPGW_TRUSTED_ROOT_CERT_NAME",
                            "value": "[parameters('appgwTrustedRootCert')]"
                          },
                          {
                            "name": "APPGW_NAME",
                            "value": "[parameters('appgwName')]"
                          },
                          {
                            "name": "APPGW_USE_PRIVATE_IP",
                            "value": "[string(parameters('appgwUsePrivateIP'))]"
                          },
                          {
                            "name": "APPGW_FOR_ADMIN_SERVER",
                            "value": "[string(parameters('appgwForAdminServer'))]"
                          },
                          {
                            "name": "APPGW_FOR_REMOTE_CONSOLE",
                            "value": "[string(parameters('appgwForRemoteConsole'))]"
                          },
                          {
                            "name": "APPGW_ALIAS",
                            "value": "[parameters('appgwAlias')]"
                          },
                          {
                            "name": "CREATE_AKS_CLUSTER",
                            "value": "[string(parameters('createAKSCluster'))]"
                          },
                          {
                            "name": "CURRENT_RG_NAME",
                            "value": "[resourceGroup().name]"
                          },
                          {
                            "name": "DNS_ZONE_NAME",
                            "value": "[parameters('dnszoneName')]"
                          },
                          {
                            "name": "DNS_ZONE_RG_NAME",
                            "value": "[parameters('dnszoneRGName')]"
                          },
                          {
                            "name": "DNS_ADMIN_LABEL",
                            "value": "[parameters('dnszoneAdminConsoleLabel')]"
                          },
                          {
                            "name": "DNS_CLUSTER_LABEL",
                            "value": "[parameters('dnszoneClusterLabel')]"
                          },
                          {
                            "name": "DNS_ADMIN_T3_LABEL",
                            "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                          },
                          {
                            "name": "DNS_CLUSTER_T3_LABEL",
                            "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                          },
                          {
                            "name": "ENABLE_DNS_CONFIGURATION",
                            "value": "[string(parameters('enableDNSConfiguration'))]"
                          },
                          {
                            "name": "ENABLE_AGIC",
                            "value": "[string(parameters('enableAppGWIngress'))]"
                          },
                          {
                            "name": "ENABLE_CUSTOM_SSL",
                            "value": "[string(parameters('enableCustomSSL'))]"
                          },
                          {
                            "name": "ENABLE_COOKIE_BASED_AFFINITY",
                            "value": "[string(parameters('enableCookieBasedAffinity'))]"
                          },
                          {
                            "name": "LB_SVC_VALUES",
                            "value": "[string(parameters('lbSvcValues'))]"
                          },
                          {
                            "name": "USE_INTERNAL_LB",
                            "value": "[string(parameters('useInternalLB'))]"
                          },
                          {
                            "name": "WLS_DOMAIN_NAME",
                            "value": "[parameters('wlsDomainName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_UID",
                            "value": "[parameters('wlsDomainUID')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_primaryScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createDnsRecordScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createLbSvcScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createGatewayIngressSvcScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "adminConsoleLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint, 'null'))), format('http://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminConsoleLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint, 'null'))), format('https://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminServerT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminServerT3Endpoint, 'null'))), reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminServerT3Endpoint, '')]"
                    },
                    "adminRemoteEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint, 'null'))), format('http://{0}', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "adminRemoteSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint, 'null'))), format('https://{0}', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "clusterLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint, 'null'))), format('http://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint, 'null'))), format('https://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterT3Endpoint, 'null'))), reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterT3Endpoint, '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'dnszone-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'validate-agic')]"
              ]
            },
            {
              "condition": "[not(parameters('enableAppGWIngress'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "ds-networking-deployment-no-appgw",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "appgwName": {
                    "value": "null"
                  },
                  "appgwAlias": {
                    "value": "null"
                  },
                  "appgwForAdminServer": {
                    "value": "[parameters('appgwForAdminServer')]"
                  },
                  "appgwForRemoteConsole": {
                    "value": "[parameters('appgwForRemoteConsole')]"
                  },
                  "appgwSslCert": {
                    "value": "[parameters('appGatewaySslCert')]"
                  },
                  "appgwTrustedRootCert": {
                    "value": "[parameters('appGatewayTrustedRootCert')]"
                  },
                  "appgwUsePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "createAKSCluster": {
                    "value": "[parameters('createAKSCluster')]"
                  },
                  "dnszoneAdminConsoleLabel": {
                    "value": "[parameters('dnszoneAdminConsoleLabel')]"
                  },
                  "dnszoneAdminT3ChannelLabel": {
                    "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                  },
                  "dnszoneClusterLabel": {
                    "value": "[parameters('dnszoneClusterLabel')]"
                  },
                  "dnszoneClusterT3ChannelLabel": {
                    "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                  },
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  },
                  "dnszoneRGName": {
                    "value": "[if(parameters('createDNSZone'), resourceGroup().name, parameters('dnszoneRGName'))]"
                  },
                  "enableAppGWIngress": {
                    "value": "[parameters('enableAppGWIngress')]"
                  },
                  "enableCookieBasedAffinity": {
                    "value": "[parameters('enableCookieBasedAffinity')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableDNSConfiguration": {
                    "value": "[parameters('enableDNSConfiguration')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "lbSvcValues": {
                    "value": "[parameters('lbSvcValues')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "useInternalLB": {
                    "value": "[parameters('useInternalLB')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "1990448863142664793"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "appgwAlias": {
                      "type": "string",
                      "defaultValue": "appgw-contoso-alias"
                    },
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "appgwForAdminServer": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Three scenarios we support for deploying app gateway"
                      }
                    },
                    "appgwForRemoteConsole": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwSslCert": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appgwTrustedRootCert": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appgwUsePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": "aks-contoso-rg"
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": "aks-contoso"
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "createAKSCluster": {
                      "type": "bool"
                    },
                    "dnszoneAdminConsoleLabel": {
                      "type": "string",
                      "defaultValue": "admin"
                    },
                    "dnszoneAdminT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "admin-t3"
                    },
                    "dnszoneClusterLabel": {
                      "type": "string",
                      "defaultValue": "www"
                    },
                    "dnszoneClusterT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "cluster-t3"
                    },
                    "dnszoneName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz"
                    },
                    "dnszoneRGName": {
                      "type": "string",
                      "defaultValue": "dns-contoso-rg"
                    },
                    "enableAppGWIngress": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCookieBasedAffinity": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableDNSConfiguration": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "lbSvcValues": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "location": {
                      "type": "string"
                    },
                    "useInternalLB": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    }
                  },
                  "variables": {
                    "const_commonScript": "common.sh",
                    "const_createDnsRecordScript": "createDnsRecord.sh",
                    "const_createLbSvcScript": "createLbSvc.sh",
                    "const_createGatewayIngressSvcScript": "createAppGatewayIngress.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_primaryScript": "setupNetworking.sh",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-networking-deployment",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_RG_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "APPGW_SSL_CERT_NAME",
                            "value": "[parameters('appgwSslCert')]"
                          },
                          {
                            "name": "APPGW_TRUSTED_ROOT_CERT_NAME",
                            "value": "[parameters('appgwTrustedRootCert')]"
                          },
                          {
                            "name": "APPGW_NAME",
                            "value": "[parameters('appgwName')]"
                          },
                          {
                            "name": "APPGW_USE_PRIVATE_IP",
                            "value": "[string(parameters('appgwUsePrivateIP'))]"
                          },
                          {
                            "name": "APPGW_FOR_ADMIN_SERVER",
                            "value": "[string(parameters('appgwForAdminServer'))]"
                          },
                          {
                            "name": "APPGW_FOR_REMOTE_CONSOLE",
                            "value": "[string(parameters('appgwForRemoteConsole'))]"
                          },
                          {
                            "name": "APPGW_ALIAS",
                            "value": "[parameters('appgwAlias')]"
                          },
                          {
                            "name": "CREATE_AKS_CLUSTER",
                            "value": "[string(parameters('createAKSCluster'))]"
                          },
                          {
                            "name": "CURRENT_RG_NAME",
                            "value": "[resourceGroup().name]"
                          },
                          {
                            "name": "DNS_ZONE_NAME",
                            "value": "[parameters('dnszoneName')]"
                          },
                          {
                            "name": "DNS_ZONE_RG_NAME",
                            "value": "[parameters('dnszoneRGName')]"
                          },
                          {
                            "name": "DNS_ADMIN_LABEL",
                            "value": "[parameters('dnszoneAdminConsoleLabel')]"
                          },
                          {
                            "name": "DNS_CLUSTER_LABEL",
                            "value": "[parameters('dnszoneClusterLabel')]"
                          },
                          {
                            "name": "DNS_ADMIN_T3_LABEL",
                            "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                          },
                          {
                            "name": "DNS_CLUSTER_T3_LABEL",
                            "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                          },
                          {
                            "name": "ENABLE_DNS_CONFIGURATION",
                            "value": "[string(parameters('enableDNSConfiguration'))]"
                          },
                          {
                            "name": "ENABLE_AGIC",
                            "value": "[string(parameters('enableAppGWIngress'))]"
                          },
                          {
                            "name": "ENABLE_CUSTOM_SSL",
                            "value": "[string(parameters('enableCustomSSL'))]"
                          },
                          {
                            "name": "ENABLE_COOKIE_BASED_AFFINITY",
                            "value": "[string(parameters('enableCookieBasedAffinity'))]"
                          },
                          {
                            "name": "LB_SVC_VALUES",
                            "value": "[string(parameters('lbSvcValues'))]"
                          },
                          {
                            "name": "USE_INTERNAL_LB",
                            "value": "[string(parameters('useInternalLB'))]"
                          },
                          {
                            "name": "WLS_DOMAIN_NAME",
                            "value": "[parameters('wlsDomainName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_UID",
                            "value": "[parameters('wlsDomainUID')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_primaryScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createDnsRecordScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createLbSvcScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createGatewayIngressSvcScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "adminConsoleLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint, 'null'))), format('http://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminConsoleLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint, 'null'))), format('https://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminServerT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminServerT3Endpoint, 'null'))), reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminServerT3Endpoint, '')]"
                    },
                    "adminRemoteEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint, 'null'))), format('http://{0}', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "adminRemoteSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint, 'null'))), format('https://{0}', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "clusterLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint, 'null'))), format('http://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint, 'null'))), format('https://{0}/', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterT3Endpoint, 'null'))), reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-networking-deployment')).outputs.clusterT3Endpoint, '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'dnszone-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'validate-agic')]"
              ]
            },
            {
              "condition": "[variables('const_enableLbService')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-loadbalancer-service-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidLbEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw')]",
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw')]"
              ]
            },
            {
              "condition": "[parameters('enableDNSConfiguration')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-dns-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidDnsEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw')]",
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "pid-networking-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidNetworkingEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-dns-end-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'pid-loadbalancer-service-end-deployment')]"
              ]
            }
          ],
          "outputs": {
            "adminConsoleExternalEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('http://{0}console', variables('const_appgwAdminCustomDNSAlias')), format('http://{0}/console', parameters('appGatewayAlias'))), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).adminConsoleLBEndpoint.value)]"
            },
            "adminConsoleExternalSecuredEndpoint": {
              "type": "string",
              "value": "[if(and(and(parameters('enableAppGWIngress'), parameters('enableCustomSSL')), parameters('enableDNSConfiguration')), format('https://{0}console', variables('const_appgwAdminCustomDNSAlias')), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).adminConsoleLBSecuredEndpoint.value)]"
            },
            "adminRemoteConsoleEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('http://{0}remoteconsole', variables('const_appgwAdminCustomDNSAlias')), format('http://{0}/remoteconsole', parameters('appGatewayAlias'))), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).adminRemoteEndpoint.value)]"
            },
            "adminRemoteConsoleSecuredEndpoint": {
              "type": "string",
              "value": "[if(and(and(parameters('enableAppGWIngress'), parameters('enableCustomSSL')), parameters('enableDNSConfiguration')), format('https://{0}remoteconsole', variables('const_appgwAdminCustomDNSAlias')), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).adminRemoteSecuredEndpoint.value)]"
            },
            "adminServerT3ChannelEndpoint": {
              "type": "string",
              "value": "[format('{0}://{1}', if(parameters('enableCustomSSL'), 't3s', 't3'), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).adminServerT3LBEndpoint.value)]"
            },
            "clusterExternalEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('http://{0}', variables('const_appgwCustomDNSAlias')), parameters('appGatewayURL')), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).clusterLBEndpoint.value)]"
            },
            "clusterExternalSecuredEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('https://{0}', variables('const_appgwCustomDNSAlias')), parameters('appGatewaySecuredURL')), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).clusterLBSecuredEndpoint.value)]"
            },
            "clusterT3ChannelEndpoint": {
              "type": "string",
              "value": "[format('{0}://{1}', if(parameters('enableCustomSSL'), 't3s', 't3'), if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-yes-appgw'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-no-appgw'), '2020-10-01').outputs).clusterT3LBEndpoint.value)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'application-gateway-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled')]"
      ]
    },
    {
      "condition": "[and(parameters('enableDB'), not(parameters('enablePswlessConnection')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "datasource-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.dbEnd.value]"
          },
          "_pidStart": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.dbStart.value]"
          },
          "aksClusterRGName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "databaseType": {
            "value": "[parameters('databaseType')]"
          },
          "dbConfigurationType": {
            "value": "[parameters('dbConfigurationType')]"
          },
          "dbDriverName": {
            "value": "[parameters('dbDriverName')]"
          },
          "dbGlobalTranPro": {
            "value": "[parameters('dbGlobalTranPro')]"
          },
          "dbPassword": {
            "value": "[parameters('dbPassword')]"
          },
          "dbTestTableName": {
            "value": "[parameters('dbTestTableName')]"
          },
          "dbUser": {
            "value": "[parameters('dbUser')]"
          },
          "dsConnectionURL": {
            "value": "[parameters('dsConnectionURL')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "jdbcDataSourceName": {
            "value": "[parameters('jdbcDataSourceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "13319573757545505890"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": ""
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": ""
            },
            "_pidOtherDb": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "databaseType": {
              "type": "string",
              "defaultValue": "oracle",
              "metadata": {
                "description": "One of the supported database types"
              }
            },
            "dbConfigurationType": {
              "type": "string",
              "defaultValue": "createOrUpdate",
              "allowedValues": [
                "createOrUpdate",
                "delete"
              ]
            },
            "dbDriverName": {
              "type": "string",
              "defaultValue": "org.contoso.Driver",
              "metadata": {
                "description": "Datasource driver name"
              }
            },
            "dbGlobalTranPro": {
              "type": "string",
              "defaultValue": "EmulateTwoPhaseCommit",
              "metadata": {
                "description": "Determines the transaction protocol (global transaction processing behavior) for the data source."
              }
            },
            "dbPassword": {
              "type": "secureString",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Password for Database"
              }
            },
            "dbTestTableName": {
              "type": "string",
              "defaultValue": "Null",
              "metadata": {
                "description": "The name of the database table to use when testing physical database connections. This name is required when you specify a Test Frequency and enable Test Reserved Connections."
              }
            },
            "dbUser": {
              "type": "string",
              "defaultValue": "contosoDbUser",
              "metadata": {
                "description": "User id of Database"
              }
            },
            "dsConnectionURL": {
              "type": "string",
              "defaultValue": "jdbc:postgresql://contoso.postgres.database.azure.com:5432/postgres",
              "metadata": {
                "description": "JDBC Connection String"
              }
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "jdbcDataSourceName": {
              "type": "string",
              "defaultValue": "jdbc/contoso",
              "metadata": {
                "description": "JNDI Name for JDBC Datasource"
              }
            },
            "location": {
              "type": "string"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-db-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[equals(parameters('databaseType'), 'otherdb')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-other-db-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidOtherDb')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "create-update-datasource",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "databaseType": {
                    "value": "[parameters('databaseType')]"
                  },
                  "dbConfigurationType": {
                    "value": "[parameters('dbConfigurationType')]"
                  },
                  "dbDriverName": {
                    "value": "[parameters('dbDriverName')]"
                  },
                  "dbGlobalTranPro": {
                    "value": "[parameters('dbGlobalTranPro')]"
                  },
                  "dbPassword": {
                    "value": "[parameters('dbPassword')]"
                  },
                  "dbTestTableName": {
                    "value": "[parameters('dbTestTableName')]"
                  },
                  "dbUser": {
                    "value": "[parameters('dbUser')]"
                  },
                  "dsConnectionURL": {
                    "value": "[parameters('dsConnectionURL')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "jdbcDataSourceName": {
                    "value": "[parameters('jdbcDataSourceName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "10182943380952579731"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string"
                    },
                    "aksClusterRGName": {
                      "type": "string"
                    },
                    "databaseType": {
                      "type": "string",
                      "defaultValue": "oracle"
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "dbConfigurationType": {
                      "type": "string",
                      "defaultValue": "createOrUpdate"
                    },
                    "dbDriverName": {
                      "type": "string",
                      "defaultValue": "org.contoso.Driver"
                    },
                    "dbGlobalTranPro": {
                      "type": "string",
                      "defaultValue": "EmulateTwoPhaseCommit"
                    },
                    "dbPassword": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "dbTestTableName": {
                      "type": "string",
                      "defaultValue": "Null"
                    },
                    "dbUser": {
                      "type": "string"
                    },
                    "dsConnectionURL": {
                      "type": "string"
                    },
                    "enablePswlessConnection": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "jdbcDataSourceName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic",
                      "metadata": {
                        "description": "User name for WebLogic Administrator."
                      }
                    }
                  },
                  "variables": {
                    "const_commonScript": "common.sh",
                    "const_datasourceScript": "setupDBConnections.sh",
                    "const_datasourceModelScript": "genDatasourceModel.sh",
                    "const_dbUtilityScript": "dbUtility.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-wls-db-connection",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "environmentVariables": [
                          {
                            "name": "AKS_RESOURCE_GROUP_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "AKS_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "DATABASE_TYPE",
                            "value": "[parameters('databaseType')]"
                          },
                          {
                            "name": "DB_CONFIGURATION_TYPE",
                            "value": "[parameters('dbConfigurationType')]"
                          },
                          {
                            "name": "DB_PASSWORD",
                            "secureValue": "[parameters('dbPassword')]"
                          },
                          {
                            "name": "DB_USER",
                            "value": "[parameters('dbUser')]"
                          },
                          {
                            "name": "DB_CONNECTION_STRING",
                            "value": "[parameters('dsConnectionURL')]"
                          },
                          {
                            "name": "DB_DRIVER_NAME",
                            "value": "[parameters('dbDriverName')]"
                          },
                          {
                            "name": "ENABLE_PASSWORDLESS_CONNECTION",
                            "value": "[string(parameters('enablePswlessConnection'))]"
                          },
                          {
                            "name": "GLOBAL_TRANSATION_PROTOCOL",
                            "value": "[parameters('dbGlobalTranPro')]"
                          },
                          {
                            "name": "JDBC_DATASOURCE_NAME",
                            "value": "[parameters('jdbcDataSourceName')]"
                          },
                          {
                            "name": "TEST_TABLE_NAME",
                            "value": "[parameters('dbTestTableName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_UID",
                            "value": "[parameters('wlsDomainUID')]"
                          },
                          {
                            "name": "WLS_DOMAIN_USER",
                            "value": "[parameters('wlsUserName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_PASSWORD",
                            "secureValue": "[parameters('wlsPassword')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_datasourceScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_dbUtilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_datasourceModelScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-other-db-pid-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-db-start-pid-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-db-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'create-update-datasource')]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'networking-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled')]"
      ]
    },
    {
      "condition": "[and(parameters('enableDB'), parameters('enablePswlessConnection'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "passwordless-datasource-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.pswlessDbEnd.value]"
          },
          "_pidStart": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'initialization')).outputs.pswlessDbStart.value]"
          },
          "aksClusterRGName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value]"
          },
          "aksNodeRGName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksNodeRgName.value]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "databaseType": {
            "value": "[parameters('databaseType')]"
          },
          "dbConfigurationType": {
            "value": "[parameters('dbConfigurationType')]"
          },
          "dbGlobalTranPro": {
            "value": "[parameters('dbGlobalTranPro')]"
          },
          "dbUser": {
            "value": "[parameters('dbUser')]"
          },
          "dbIdentity": {
            "value": "[parameters('dbIdentity')]"
          },
          "dsConnectionURL": {
            "value": "[parameters('dsConnectionURL')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "jdbcDataSourceName": {
            "value": "[parameters('jdbcDataSourceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "10907201912948894591"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": ""
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksNodeRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "databaseType": {
              "type": "string",
              "defaultValue": "oracle",
              "metadata": {
                "description": "One of the supported database types"
              }
            },
            "dbConfigurationType": {
              "type": "string",
              "defaultValue": "createOrUpdate",
              "allowedValues": [
                "createOrUpdate",
                "delete"
              ]
            },
            "dbGlobalTranPro": {
              "type": "string",
              "defaultValue": "EmulateTwoPhaseCommit",
              "metadata": {
                "description": "Determines the transaction protocol (global transaction processing behavior) for the data source."
              }
            },
            "dbUser": {
              "type": "string",
              "defaultValue": "contosoDbUser",
              "metadata": {
                "description": "User id of Database"
              }
            },
            "dbIdentity": {
              "type": "object",
              "defaultValue": {}
            },
            "dsConnectionURL": {
              "type": "string",
              "defaultValue": "jdbc:postgresql://contoso.postgres.database.azure.com:5432/postgres",
              "metadata": {
                "description": "JDBC Connection String"
              }
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "jdbcDataSourceName": {
              "type": "string",
              "defaultValue": "jdbc/contoso",
              "metadata": {
                "description": "JNDI Name for JDBC Datasource"
              }
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "variables": {
            "const_connectionString": "[if(and(equals(parameters('databaseType'), 'sqlserver'), equals(last(parameters('dsConnectionURL')), ';')), take(parameters('dsConnectionURL'), sub(length(parameters('dsConnectionURL')), 1)), parameters('dsConnectionURL'))]",
            "const_identityAPIVersion": "2022-01-31-PREVIEW",
            "const_roleDefinitionIdOfVMContributor": "9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
            "const_podIdentitySelector": "db-pod-identity",
            "name_dbIdentityName": "[split(items(parameters('dbIdentity').userAssignedIdentities)[0].key, '/')[8]]",
            "array_msiClientId": {
              "mysql": "azure.clientId",
              "postgresql": "azure.clientId",
              "sqlserver": "msiClientId"
            },
            "name_jdbcPlugins": {
              "mysql": "defaultAuthenticationPlugin=com.azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin&authenticationPlugins=com.azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin",
              "postgresql": "authenticationPluginClassName=com.azure.identity.extensions.jdbc.postgresql.AzurePostgresqlAuthenticationPlugin",
              "sqlserver": "authentication=ActiveDirectoryMSI"
            },
            "array_urlJoiner": {
              "mysql": "&",
              "postgresql": "&",
              "sqlserver": ";"
            },
            "name_podIdentity": "[format('{0}-pod-identity-{1}', parameters('databaseType'), toLower(parameters('utcValue')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-db-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "assign-db-identity-vm-contributor-role",
              "resourceGroup": "[parameters('aksNodeRGName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "identity": {
                    "value": "[parameters('dbIdentity')]"
                  },
                  "roleDefinitionId": {
                    "value": "[variables('const_roleDefinitionIdOfVMContributor')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "15877732958113299874"
                    }
                  },
                  "parameters": {
                    "roleDefinitionId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "const_identityAPIVersion": "2022-01-31-PREVIEW",
                    "name_roleAssignmentName": "[guid(format('{0}{1}Role assignment in resource group scope', subscription().id, parameters('utcValue')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[variables('name_roleAssignmentName')]",
                      "properties": {
                        "description": "Assign resource group scope role to User Assigned Managed Identity ",
                        "principalId": "[reference(items(parameters('identity').userAssignedIdentities)[0].key, variables('const_identityAPIVersion'), 'full').properties.principalId]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "grant-aks-cluster-mio-role-over-db-identity",
              "resourceGroup": "[split(items(parameters('dbIdentity').userAssignedIdentities)[0].key, '/')[4]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "clusterIdentityPrincipalId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aksClusterRGName')), 'Microsoft.ContainerService/managedClusters', parameters('aksClusterName')), '2023-08-01', 'full').identity.principalId]"
                  },
                  "dbIdentityName": {
                    "value": "[variables('name_dbIdentityName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "13933712269558829928"
                    }
                  },
                  "parameters": {
                    "clusterIdentityPrincipalId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "dbIdentityName": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "const_roleDefinitionIdOfManagedIdentityOperator": "f1a07417-d97a-45cb-824c-7a7467783830",
                    "name_roleAssignmentName": "[guid(format('{0}{1}Role assignment in resource scope', subscription().id, parameters('clusterIdentityPrincipalId')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.ManagedIdentity/userAssignedIdentities/{0}', parameters('dbIdentityName'))]",
                      "name": "[variables('name_roleAssignmentName')]",
                      "properties": {
                        "description": "Assign Managed Identity Operator role to AKS Cluster over DB Identity ",
                        "principalId": "[parameters('clusterIdentityPrincipalId')]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('const_roleDefinitionIdOfManagedIdentityOperator'))]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('const_roleDefinitionIdOfManagedIdentityOperator'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aksNodeRGName')), 'Microsoft.Resources/deployments', 'assign-db-identity-vm-contributor-role')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "configure-pod-identity",
              "resourceGroup": "[parameters('aksClusterRGName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "dbIdentity": {
                    "value": "[parameters('dbIdentity')]"
                  },
                  "namespace": {
                    "value": "[format('{0}-ns', parameters('wlsDomainUID'))]"
                  },
                  "podIdentityName": {
                    "value": "[variables('name_podIdentity')]"
                  },
                  "podIdentitySelector": {
                    "value": "[variables('const_podIdentitySelector')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "306869444955753012"
                    }
                  },
                  "parameters": {
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "dbIdentity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "namespace": {
                      "type": "string",
                      "defaultValue": "sample-domain1-ns"
                    },
                    "podIdentityName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "podIdentitySelector": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "const_APIVersion": "2022-01-31-PREVIEW"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2023-08-01",
                      "name": "[parameters('aksClusterName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "podIdentityProfile": {
                          "allowNetworkPluginKubenet": false,
                          "enabled": true,
                          "userAssignedIdentities": [
                            {
                              "bindingSelector": "[parameters('podIdentitySelector')]",
                              "identity": {
                                "clientId": "[reference(items(parameters('dbIdentity').userAssignedIdentities)[0].key, variables('const_APIVersion'), 'full').properties.clientId]",
                                "objectId": "[reference(items(parameters('dbIdentity').userAssignedIdentities)[0].key, variables('const_APIVersion'), 'full').properties.principalId]",
                                "resourceId": "[items(parameters('dbIdentity').userAssignedIdentities)[0].key]"
                              },
                              "name": "[parameters('podIdentityName')]",
                              "namespace": "[parameters('namespace')]"
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, split(items(parameters('dbIdentity').userAssignedIdentities)[0].key, '/')[4]), 'Microsoft.Resources/deployments', 'grant-aks-cluster-mio-role-over-db-identity')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "create-update-datasource",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "azCliVersion": {
                    "value": "[parameters('azCliVersion')]"
                  },
                  "databaseType": {
                    "value": "[parameters('databaseType')]"
                  },
                  "dbConfigurationType": {
                    "value": "[parameters('dbConfigurationType')]"
                  },
                  "dbGlobalTranPro": {
                    "value": "[parameters('dbGlobalTranPro')]"
                  },
                  "dbUser": {
                    "value": "[parameters('dbUser')]"
                  },
                  "dsConnectionURL": {
                    "value": "[uri(format('{0}{4}{1}{4}{3}={2}', variables('const_connectionString'), variables('name_jdbcPlugins')[parameters('databaseType')], reference(items(parameters('dbIdentity').userAssignedIdentities)[0].key, variables('const_identityAPIVersion'), 'full').properties.clientId, variables('array_msiClientId')[parameters('databaseType')], variables('array_urlJoiner')[parameters('databaseType')]), '')]"
                  },
                  "enablePswlessConnection": {
                    "value": true
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "jdbcDataSourceName": {
                    "value": "[parameters('jdbcDataSourceName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "10182943380952579731"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string"
                    },
                    "aksClusterRGName": {
                      "type": "string"
                    },
                    "databaseType": {
                      "type": "string",
                      "defaultValue": "oracle"
                    },
                    "azCliVersion": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "dbConfigurationType": {
                      "type": "string",
                      "defaultValue": "createOrUpdate"
                    },
                    "dbDriverName": {
                      "type": "string",
                      "defaultValue": "org.contoso.Driver"
                    },
                    "dbGlobalTranPro": {
                      "type": "string",
                      "defaultValue": "EmulateTwoPhaseCommit"
                    },
                    "dbPassword": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "dbTestTableName": {
                      "type": "string",
                      "defaultValue": "Null"
                    },
                    "dbUser": {
                      "type": "string"
                    },
                    "dsConnectionURL": {
                      "type": "string"
                    },
                    "enablePswlessConnection": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "jdbcDataSourceName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic",
                      "metadata": {
                        "description": "User name for WebLogic Administrator."
                      }
                    }
                  },
                  "variables": {
                    "const_commonScript": "common.sh",
                    "const_datasourceScript": "setupDBConnections.sh",
                    "const_datasourceModelScript": "genDatasourceModel.sh",
                    "const_dbUtilityScript": "dbUtility.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "ds-wls-db-connection",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[parameters('azCliVersion')]",
                        "environmentVariables": [
                          {
                            "name": "AKS_RESOURCE_GROUP_NAME",
                            "value": "[parameters('aksClusterRGName')]"
                          },
                          {
                            "name": "AKS_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "DATABASE_TYPE",
                            "value": "[parameters('databaseType')]"
                          },
                          {
                            "name": "DB_CONFIGURATION_TYPE",
                            "value": "[parameters('dbConfigurationType')]"
                          },
                          {
                            "name": "DB_PASSWORD",
                            "secureValue": "[parameters('dbPassword')]"
                          },
                          {
                            "name": "DB_USER",
                            "value": "[parameters('dbUser')]"
                          },
                          {
                            "name": "DB_CONNECTION_STRING",
                            "value": "[parameters('dsConnectionURL')]"
                          },
                          {
                            "name": "DB_DRIVER_NAME",
                            "value": "[parameters('dbDriverName')]"
                          },
                          {
                            "name": "ENABLE_PASSWORDLESS_CONNECTION",
                            "value": "[string(parameters('enablePswlessConnection'))]"
                          },
                          {
                            "name": "GLOBAL_TRANSATION_PROTOCOL",
                            "value": "[parameters('dbGlobalTranPro')]"
                          },
                          {
                            "name": "JDBC_DATASOURCE_NAME",
                            "value": "[parameters('jdbcDataSourceName')]"
                          },
                          {
                            "name": "TEST_TABLE_NAME",
                            "value": "[parameters('dbTestTableName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_UID",
                            "value": "[parameters('wlsDomainUID')]"
                          },
                          {
                            "name": "WLS_DOMAIN_USER",
                            "value": "[parameters('wlsUserName')]"
                          },
                          {
                            "name": "WLS_DOMAIN_PASSWORD",
                            "secureValue": "[parameters('wlsPassword')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_datasourceScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_dbUtilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_datasourceModelScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aksClusterRGName')), 'Microsoft.Resources/deployments', 'configure-pod-identity')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "wls-aks-db-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "2583726336413374107"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.11.1.770",
                              "templateHash": "1770112025391142865"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "customCertForAppgw": {
                      "type": "string",
                      "value": "b80f52c3-dddd-5286-915e-e4cc64be3093"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "otherDb": {
                      "type": "string",
                      "value": "fceccc86-531c-5e44-99fd-9f1250f8e409"
                    },
                    "pswlessDbEnd": {
                      "type": "string",
                      "value": "972084b9-2b2d-5eb9-aa37-80448a77fbe1"
                    },
                    "pswlessDbStart": {
                      "type": "string",
                      "value": "7190b263-7825-5ae3-bc56-7294df936d4a"
                    },
                    "sslEnd": {
                      "type": "string",
                      "value": "6738fb2b-4383-520e-bf8a-b4e00162b692"
                    },
                    "sslStart": {
                      "type": "string",
                      "value": "29953382-5f6a-5bcf-9453-0bb82475951c"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'create-update-datasource')]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'networking-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled')]"
      ]
    },
    {
      "condition": "[parameters('validateApplications')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "validate-wls-application-status",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "aksClusterRGName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "8957651364457390209"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": ""
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1"
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "variables": {
            "const_pyCheckAppStatusScript": "checkApplicationStatus.py",
            "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
            "const_validateAppScript": "validateApplications.sh",
            "const_utilityScript": "utility.sh"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "ds-wls-validate-applications",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[parameters('azCliVersion')]",
                "environmentVariables": [
                  {
                    "name": "AKS_RESOURCE_GROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  {
                    "name": "AKS_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "WLS_DOMAIN_UID",
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  {
                    "name": "WLS_DOMAIN_USER",
                    "value": "[parameters('wlsUserName')]"
                  },
                  {
                    "name": "WLS_DOMAIN_PASSWORD",
                    "secureValue": "[parameters('wlsPassword')]"
                  }
                ],
                "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_validateAppScript'), parameters('_artifactsLocationSasToken')))]",
                "supportingScriptUris": [
                  "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                  "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pyCheckAppStatusScript'), parameters('_artifactsLocationSasToken')))]"
                ],
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'datasource-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'passwordless-datasource-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "query-wls-domain-configurations",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aksClusterRGName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value]"
          },
          "azCliVersion": {
            "value": "[variables('const_azcliVersion')]"
          },
          "identity": {
            "value": {
              "type": "UserAssigned",
              "userAssignedIdentities": {
                "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'uami-deployment')).outputs.uamiIdForDeploymentScript.value)]": {}
              }
            }
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsClusterName": {
            "value": "[variables('const_wlsClusterName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "3224267314517980406"
            }
          },
          "parameters": {
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": ""
            },
            "azCliVersion": {
              "type": "string",
              "defaultValue": ""
            },
            "identity": {
              "type": "object",
              "defaultValue": {}
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsClusterName": {
              "type": "string",
              "defaultValue": "cluster-1"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1"
            }
          },
          "variables": {
            "base64_queryDomainConfigurations": "IyBDb3B5cmlnaHQgKGMpIDIwMjEsIE9yYWNsZSBDb3Jwb3JhdGlvbiBhbmQvb3IgaXRzIGFmZmlsaWF0ZXMuCiMgTGljZW5zZWQgdW5kZXIgdGhlIFVuaXZlcnNhbCBQZXJtaXNzaXZlIExpY2Vuc2UgdiAxLjAgYXMgc2hvd24gYXQgaHR0cHM6Ly9vc3Mub3JhY2xlLmNvbS9saWNlbnNlcy91cGwuCiMgVGhpcyBzY3JpcHQgcnVucyBvbiBBenVyZSBDb250YWluZXIgSW5zdGFuY2Ugd2l0aCBBbHBpbmUgTGludXggdGhhdCBBenVyZSBEZXBsb3ltZW50IHNjcmlwdCBjcmVhdGVzLgojCiMgZW52IGlucHV0czoKIyBBS1NfQ0xVU1RFUl9OQU1FCiMgQUtTX0NMVVNURVJfUkVTT1VSQ0VHUk9VUF9OQU1FCiMgV0xTX0NMVVNURVJfTkFNRQojIFdMU19ET01BSU5fVUlECgojIE1haW4gc2NyaXB0Cndsc0NvbnRhaW5lck5hbWU9IndlYmxvZ2ljLXNlcnZlciIKCmVjaG8gImluc3RhbGwga3ViZWN0bCIKYXogYWtzIGluc3RhbGwtY2xpCgplY2hvICJDb25uZWN0IEFLUyIKYXogYWtzIGdldC1jcmVkZW50aWFscyBcCiAgICAtLXJlc291cmNlLWdyb3VwICR7QUtTX0NMVVNURVJfUkVTT1VSQ0VHUk9VUF9OQU1FfSBcCiAgICAtLW5hbWUgJHtBS1NfQ0xVU1RFUl9OQU1FfSBcCiAgICAtLW92ZXJ3cml0ZS1leGlzdGluZwoKd2xzRG9tYWluTlM9IiR7V0xTX0RPTUFJTl9VSUR9LW5zIgoKZG9tYWluQ29uZmlndXJhdGlvbllhbWw9L3RtcC9kb21haW4ueWFtbApybSAtZiAke2RvbWFpbkNvbmZpZ3VyYXRpb25ZYW1sfQprdWJlY3RsIGdldCBkb21haW4gJHtXTFNfRE9NQUlOX1VJRH0gLW4gJHt3bHNEb21haW5OU30gLW8geWFtbCA+JHtkb21haW5Db25maWd1cmF0aW9uWWFtbH0KCnBvZE51bT0kKGt1YmVjdGwgLW4gJHt3bHNEb21haW5OU30gZ2V0IHBvZCAtbCB3ZWJsb2dpYy5jbHVzdGVyTmFtZT0ke1dMU19DTFVTVEVSX05BTUV9IC1vIGpzb24gfCBqcSAnLml0ZW1zfCBsZW5ndGgnKQogICAgaWYgWyAke3BvZE51bX0gLWxlIDAgXTsgdGhlbgogICAgICAgIGVjaG9fc3RkZXJyICJFbnN1cmUgeW91ciBjbHVzdGVyIGhhcyBhdCBsZWFzdCBvbmUgcG9kLiIKICAgICAgICBleGl0IDEKICAgIGZpCgpwb2ROYW1lPSQoa3ViZWN0bCAtbiAke3dsc0RvbWFpbk5TfSBnZXQgcG9kIC1sIHdlYmxvZ2ljLmNsdXN0ZXJOYW1lPSR7V0xTX0NMVVNURVJfTkFNRX0gLW8ganNvbiBcCiAgICB8IGpxICcuaXRlbXNbMF0gfCAubWV0YWRhdGEubmFtZScgXAogICAgfCB0ciAtZCAiXCIiKQoKZWNobyAiQ29weSBtb2RlbC55YW1sIGZyb20gL3UwMS93ZHQvbW9kZWxzIgp0YXJnZXRNb2RlbFlhbWw9L3RtcC9tb2RlbC55YW1sCnJtIC1mICR7dGFyZ2V0TW9kZWxZYW1sfQprdWJlY3RsIGNwIC1uICR7d2xzRG9tYWluTlN9IC1jICR7d2xzQ29udGFpbmVyTmFtZX0gJHtwb2ROYW1lfTovdTAxL3dkdC9tb2RlbHMvbW9kZWwueWFtbCAke3RhcmdldE1vZGVsWWFtbH0KaWYgWyAkPyAhPSAwIF07IHRoZW4KICAgIGVjaG8gPiYyICJGYWlsIHRvIGNvcHkgJHtwb2ROYW1lfTovdTAxL3dkdC9tb2RlbHMvbW9kZWwueWFtbC4iCiAgICBleGl0IDEKZmkKCmVjaG8gIkNvcHkgbW9kZWwucHJvcGVydGllcyBmcm9tIGZyb20gL3UwMS93ZHQvbW9kZWxzIgp0YXJnZXRNb2RlbFByb3BlcnRpZXM9L3RtcC9tb2RlbC5wcm9wZXJ0aWVzCnJtIC1mICR7dGFyZ2V0TW9kZWxQcm9wZXJ0aWVzfQprdWJlY3RsIGNwIC1uICR7d2xzRG9tYWluTlN9IC1jICR7d2xzQ29udGFpbmVyTmFtZX0gJHtwb2ROYW1lfTovdTAxL3dkdC9tb2RlbHMvbW9kZWwucHJvcGVydGllcyAke3RhcmdldE1vZGVsUHJvcGVydGllc30KaWYgWyAkPyAhPSAwIF07IHRoZW4KICAgIGVjaG8gPiYyICJGYWlsIHRvIGNvcHkgJHtwb2ROYW1lfTovdTAxL3dkdC9tb2RlbHMvbW9kZWwucHJvcGVydGllcy4iCiAgICBleGl0IDEKZmkKCmVjaG8gIlF1ZXJ5IFdlYkxvZ2ljIHZlcnNpb24gYW5kIHBhdGNoIG51bWJlcnMiCnRhcmdldEZpbGU0VmVyc2lvbnM9L3RtcC92ZXJzaW9uLmluZm8Ka3ViZWN0bCBleGVjIC1pdCAke3BvZE5hbWV9IC1uICR7d2xzRG9tYWluTlN9IC1jICR7d2xzQ29udGFpbmVyTmFtZX0gXAogICAgLS0gYmFzaCAtYyAnc291cmNlICRPUkFDTEVfSE9NRS93bHNlcnZlci9zZXJ2ZXIvYmluL3NldFdMU0Vudi5zaCA+IC9kZXYvbnVsbCAyPiYxICYmIGphdmEgd2VibG9naWMudmVyc2lvbiAtdmVyYm9zZSA+Iicke3RhcmdldEZpbGU0VmVyc2lvbnN9JyInCmlmIFsgJD8gIT0gMCBdOyB0aGVuCiAgICBlY2hvID4mMiAiRmFpbCB0byBydW4gamF2YSB3ZWJsb2dpYy52ZXJzaW9uLiIKICAgIGV4aXQgMQpmaQpybSAtZiAke3RhcmdldEZpbGU0VmVyc2lvbnN9Cmt1YmVjdGwgY3AgLW4gJHt3bHNEb21haW5OU30gLWMgJHt3bHNDb250YWluZXJOYW1lfSAke3BvZE5hbWV9OiR7dGFyZ2V0RmlsZTRWZXJzaW9uc30gJHt0YXJnZXRGaWxlNFZlcnNpb25zfQppZiBbICQ/ICE9IDAgXTsgdGhlbgogICAgZWNobyA+JjIgIkZhaWwgdG8gY29weSAke3BvZE5hbWV9OiR7dGFyZ2V0RmlsZTRWZXJzaW9uc30uIgogICAgZXhpdCAxCmZpCgpiYXNlNjRvZkRvbWFpbllhbWw9JChjYXQgJHtkb21haW5Db25maWd1cmF0aW9uWWFtbH0gfCBiYXNlNjQpCmJhc2U2NG9mTW9kZWxZYW1sPSQoY2F0ICR7dGFyZ2V0TW9kZWxZYW1sfSB8IGJhc2U2NCkKYmFzZTY0b2ZNb2RlbFByb3BlcnRpZXM9JChjYXQgJHt0YXJnZXRNb2RlbFByb3BlcnRpZXN9IHwgYmFzZTY0KQpiYXNlNjRvZldMU1ZlcnNpb25EZXRhaWxzPSQoY2F0ICR7dGFyZ2V0RmlsZTRWZXJzaW9uc30gfCBiYXNlNjQpCgpyZXN1bHQ9JChqcSAtbiAtYyBcCiAgICAtLWFyZyBkb21haW5EZXBsb3ltZW50WWFtbCAiJGJhc2U2NG9mRG9tYWluWWFtbCIgXAogICAgLS1hcmcgd2xzSW1hZ2VNb2RlbFlhbWwgIiRiYXNlNjRvZk1vZGVsWWFtbCIgXAogICAgLS1hcmcgd2xzSW1hZ2VQcm9wZXJ0aWVzICIkYmFzZTY0b2ZNb2RlbFByb3BlcnRpZXMiIFwKICAgIC0tYXJnIHdsc1ZlcnNpb25EZXRhaWxzICIke2Jhc2U2NG9mV0xTVmVyc2lvbkRldGFpbHN9IiBcCiAgICAne2RvbWFpbkRlcGxveW1lbnRZYW1sOiAkZG9tYWluRGVwbG95bWVudFlhbWwsIHdsc0ltYWdlTW9kZWxZYW1sOiAkd2xzSW1hZ2VNb2RlbFlhbWwsIHdsc0ltYWdlUHJvcGVydGllczogJHdsc0ltYWdlUHJvcGVydGllcywgd2xzVmVyc2lvbkRldGFpbHM6ICR3bHNWZXJzaW9uRGV0YWlsc30nKQplY2hvICJyZXN1bHQgaXM6ICRyZXN1bHQiCmVjaG8gJHJlc3VsdCA+JEFaX1NDUklQVFNfT1VUUFVUX1BBVEgK"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "ds-query-wls-configurations",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[parameters('azCliVersion')]",
                "environmentVariables": [
                  {
                    "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "WLS_CLUSTER_NAME",
                    "value": "[parameters('wlsClusterName')]"
                  },
                  {
                    "name": "WLS_DOMAIN_UID",
                    "value": "[parameters('wlsDomainUID')]"
                  }
                ],
                "scriptContent": "[base64ToString(variables('base64_queryDomainConfigurations'))]",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ],
          "outputs": {
            "shellCmdtoOutputWlsDomainYaml": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > domain.yaml', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-query-wls-configurations')).outputs.domainDeploymentYaml)]"
            },
            "shellCmdtoOutputWlsImageModelYaml": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > model.yaml', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-query-wls-configurations')).outputs.wlsImageModelYaml)]"
            },
            "shellCmdtoOutputWlsImageProperties": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > model.properties', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-query-wls-configurations')).outputs.wlsImageProperties)]"
            },
            "shellCmdtoOutputWlsVersions": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > version.info', reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-query-wls-configurations')).outputs.wlsVersionDetails)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'uami-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'validate-wls-application-status')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled')]"
      ]
    }
  ],
  "outputs": {
    "aksClusterName": {
      "type": "string",
      "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value]"
    },
    "adminConsoleInternalUrl": {
      "type": "string",
      "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).adminServerEndpoint.value]"
    },
    "adminConsoleExternalUrl": {
      "type": "string",
      "value": "[if(variables('const_showAdminConsoleExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.adminConsoleExternalEndpoint.value, '')]"
    },
    "adminConsoleExternalSecuredUrl": {
      "type": "string",
      "value": "[if(variables('const_showAdminConsoleExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.adminConsoleExternalSecuredEndpoint.value, '')]"
    },
    "adminRemoteConsoleUrl": {
      "type": "string",
      "value": "[if(variables('const_showRemoteAdminConsoleExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.adminRemoteConsoleEndpoint.value, '')]"
    },
    "adminRemoteConsoleSecuredUrl": {
      "type": "string",
      "value": "[if(variables('const_showRemoteAdminConsoleSecuredExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.adminRemoteConsoleSecuredEndpoint.value, '')]"
    },
    "adminServerT3InternalUrl": {
      "type": "string",
      "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).adminServerT3InternalEndpoint.value]"
    },
    "adminServerT3ExternalUrl": {
      "type": "string",
      "value": "[if(and(parameters('enableAdminT3Tunneling'), variables('const_enableNetworking')), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.adminServerT3ChannelEndpoint.value, '')]"
    },
    "clusterInternalUrl": {
      "type": "string",
      "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).clusterEndpoint.value]"
    },
    "clusterExternalUrl": {
      "type": "string",
      "value": "[if(variables('const_enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.clusterExternalEndpoint.value, '')]"
    },
    "clusterExternalSecuredUrl": {
      "type": "string",
      "value": "[if(variables('const_enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.clusterExternalSecuredEndpoint.value, '')]"
    },
    "clusterT3InternalUrl": {
      "type": "string",
      "value": "[if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).clusterT3InternalEndpoint.value]"
    },
    "clusterT3ExternalEndpoint": {
      "type": "string",
      "value": "[if(and(parameters('enableClusterT3Tunneling'), variables('const_enableNetworking')), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2020-10-01').outputs.clusterT3ChannelEndpoint.value, '')]"
    },
    "shellCmdtoConnectAks": {
      "type": "string",
      "value": "[format('az account set --subscription {0}; az aks get-credentials --resource-group {1} --name {2}', split(subscription().id, '/')[2], if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterRGName.value, if(variables('_enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled'), '2020-10-01').outputs, reference(resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster'), '2020-10-01').outputs).aksClusterName.value)]"
    },
    "shellCmdtoOutputWlsDomainYaml": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations')).outputs.shellCmdtoOutputWlsDomainYaml.value]"
    },
    "shellCmdtoOutputWlsImageModelYaml": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations')).outputs.shellCmdtoOutputWlsImageModelYaml.value]"
    },
    "shellCmdtoOutputWlsImageProperties": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations')).outputs.shellCmdtoOutputWlsImageProperties.value]"
    },
    "shellCmdtoOutputWlsVersionsandPatches": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations')).outputs.shellCmdtoOutputWlsVersions.value]"
    }
  }
}